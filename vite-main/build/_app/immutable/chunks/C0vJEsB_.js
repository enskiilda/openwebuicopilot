const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./kq2ZDxMK.js","./CQrtv1eE.js","./WJl3ipnu.js","./jYw9A-wU.js","./DKem_M_z.js","./DwLkIEu4.js","./CeeO0C0-.js","./BxIY6ir7.js","./ByqEASoO.js","./BRmGPDvq.js","./BvQ5O7-v.js","./cBADewWV.js","./CAbo1QWi.js","./BoSuMvtf.js","./2Yg1sHDo.js","./DQ9UxF7k.js","./kXiCYuyj.js","./DXUPjZLs.js","./CZEGIGsR.js","./BHXWufQb.js","./D16JuV5t.js","./bQFTtKkZ.js","./1ZyFFfaT.js","./CEm4CpfJ.js","./CDrwCZBb.js","./7WfxZx5Q.js","./C2A39Ney.js","./6_T3Ulvi.js","./DmcjPXfa.js","./7_HZMPNF.js","./BccDN__m.js","../assets/Toaster.VD1H7yn_.css","./Bh-hrM1w.js","./OO7lCI-F.js","./BgG6Mq7m.js","./CUUSX84-.js","./B81XwWpr.js","./CmCtXIhy.js","../assets/RichTextInput.BfAx0He_.css","./DQmZL-p0.js","./B3nUhwYU.js","./-ZmPojHm.js","../assets/Overview.DXcfvYBA.css"])))=>i.map(i=>d[i]);
var __defProp = Object.defineProperty;
var __defNormalProp = (obj, key2, value) => key2 in obj ? __defProp(obj, key2, { enumerable: true, configurable: true, writable: true, value }) : obj[key2] = value;
var __publicField = (obj, key2, value) => __defNormalProp(obj, typeof key2 !== "symbol" ? key2 + "" : key2, value);
import "./DKem_M_z.js";
import "./DwLkIEu4.js";
import { x as hydrating, y as hydrate_next, aH as is_runes, z as block, bu as is_promise, ad as HYDRATION_START_ELSE, a5 as set_hydrate_node, ae as skip_nodes, a4 as set_hydrating, C as queue_micro_task, ag as internal_set, F as source, m as mutable_source, bv as capture, a_ as Batch, bw as unset_context, bx as is_flushing_sync, v as flushSync, bn as UNINITIALIZED, p as push, n as createEventDispatcher, o as onMount, s as set, b as get, h as derived_safe_equal, a as pop, t as template_effect, g as getContext, k as tick, f as first_child, u as untrack, c as child, r as reset, i as deep_read_state, e as sibling, l as legacy_pre_effect, j as legacy_pre_effect_reset, aF as mutate, ay as onDestroy, aE as invalidate_inner_signals, q as next, aG as remove_textarea_child, d as deferred_template_effect, $ as $document } from "./BxIY6ir7.js";
import { s as set_text, e as event } from "./cBADewWV.js";
import { b as from_svg, a as append, c as comment, f as from_html, t as text } from "./CAbo1QWi.js";
import { B as BranchManager, i as if_block } from "./BoSuMvtf.js";
import { h as head } from "./Cb8chUSZ.js";
import { a as set_attribute, s as set_class, c as clsx, r as remove_input_defaults, d as bind_select_value, h as set_style } from "./kXiCYuyj.js";
import { t as transition } from "./B3nUhwYU.js";
import { b as bind_this } from "./D16JuV5t.js";
import { i as init } from "./ByqEASoO.js";
import { p as prop } from "./BRmGPDvq.js";
import { s as setup_stores, a as store_get } from "./BvQ5O7-v.js";
import { t as toast } from "./BccDN__m.js";
import { C as Clip, a as Camera, g as getSuggestionRenderer, b as CommandSuggestionList, I as InputVariablesModal, c as Pane, d as Pane_resizer, P as Pane_group } from "./B3I5jJr1.js";
import { a as fly, f as fade } from "./BNZI2i79.js";
import { g as goto } from "./h-B6Md2q.js";
import { p as page } from "./CrvggIeO.js";
import { a as WEBUI_API_BASE_URL$1, P as PASTED_TEXT_CHARACTER_LIMIT, b as WEBUI_BASE_URL } from "./DQ9UxF7k.js";
import { q as tags, e as chatId, k as knowledge, b as settings, u as user, c as config, D as chats, t as tools, F as toolServers, a as models, B as temporaryChatEnabled, m as mobile, T as TTSWorker, G as showCallOverlay, r as showControls, z as showOverview, y as showArtifacts, v as showEmbeds, H as artifactContents, E as folders$1, s as showSidebar, I as banners, g as showArchivedChats, f as functions, x as artifactCode, w as embed, J as selectedFolder, C as currentChatPage, A as audioQueue, K as chatTitle, j as socket, W as WEBUI_NAME, L as pinnedChats } from "./2Yg1sHDo.js";
import { x as v4, M as decodeString, K as isValidHttpUrl, J as isYoutubeUrl, y as extractCurlyBraceWords, a as getUserPosition, n as getAge, o as getFormattedDate, p as getFormattedTime, q as getCurrentDateTime, r as getUserTimezone, t as getWeekday, u as extractInputVariables, v as convertHeicToJpeg, N as extractContentFromFile, w as compressImage, b as createMessagesList, m as marked, i as copyToClipboard, D as blobToFile, l as localizedFormat, g as getTimeRange, A as sanitizeResponseContent, O as processDetails, P as getPromptVariables, Q as getCodeBlockContents, I as getMessageContentParts, H as removeAllDetails, d as convertMessagesToHistory } from "./Bh-hrM1w.js";
import { h as getTagsById, i as addTagById, u as updateChatById, j as getAllTags, k as deleteTagById, f as getChatList, a as getChatById, l as getChatListByFolderId, m as getChatsByFolderId, n as createNewChat, o as updateChatFolderIdById, p as getPinnedChatList } from "./17j0UIT7.js";
import { g as generateOpenAIChatCompletion } from "./Bm2W_wlw.js";
import { p as processYoutubeVideo, a as processWeb } from "./KnVGb4qV.js";
import { h as updateUserSettings, i as getAndUpdateUserLocation } from "./Bi6Hlb5b.js";
import { e as generateAutoCompletion, f as generateEmoji, h as getTaskIdsByChatId, i as chatCompleted, j as chatAction, k as generateMoACompletion, s as stopTask } from "./DtDmpg9G.js";
import { g as getTools, e as getUserValvesById, f as getUserValvesSpecById, b as updateUserValvesById } from "./DloK8TH_.js";
import { P as PageEdit, D as Database, c as DocumentPage, u as uploadFile, F as FileItem, b as Folder } from "./P5gA3V2-.js";
import { e as getUserValvesById$1, f as getUserValvesSpecById$1, g as getFunctions, b as updateUserValvesById$1 } from "./CZmOTAge.js";
import { S as ShareChatModal, F as FolderModal, a as FolderMenu, u as updateFolderById, g as getFolderById, d as deleteFolderById } from "./CicxgGfq.js";
import purify from "./bQFTtKkZ.js";
import { e as each, i as index } from "./7_HZMPNF.js";
import { k as key } from "./CmeGWm0r.js";
import { h as html } from "./tLAl1VVg.js";
import { b as bind_value, a as bind_files, c as bind_checked } from "./DVLuwGai.js";
import { b as bind_prop } from "./B81XwWpr.js";
import { p as preventDefault } from "./CGgk3ROl.js";
import { _ as __vitePreload } from "./CQrtv1eE.js";
import { g as getSessionUser } from "./GdVmBnqS.js";
import { s as slot } from "./CZEGIGsR.js";
import "./C2A39Ney.js";
import { b as Menu_content, c as Menu_item } from "./DQmZL-p0.js";
import { f as flyAndScale } from "./BuLNlPfL.js";
import { g as getKnowledgeBases } from "./C_BzFfir.js";
import { D as Dropdown } from "./NbBmD2S8.js";
import { T as Tooltip } from "./BHXWufQb.js";
import { C as ChevronRight } from "./CS8GUXml.js";
import { C as ChevronLeft } from "./cSMfCVGw.js";
import { d as dayjs2 } from "./OO7lCI-F.js";
import { S as Spinner } from "./CtnI4RVL.js";
import { L as Loader } from "./Bne0qWmB.js";
import { a as getNoteList } from "./BInTu4eC.js";
import { M as Modal } from "./DF6V1elH.js";
import { X as XMark } from "./CUUSX84-.js";
import { G as GlobeAlt } from "./C7Mz867p.js";
import { V as VoiceRecording, R as RichTextInput } from "./DmcjPXfa.js";
import { F as FilesOverlay } from "./CQWizoxB.js";
import { C as Collapsible, I as Image, e as Clipboard, S as SVGPanZoom, F as FullHeightIframe } from "./BgD15ug2.js";
import { S as Sparkles } from "./CsQKPwST.js";
import { g as getOAuthClientAuthorizationUrl } from "./DkfueU7Q.js";
import { S as Switch_1 } from "./CakJ276w.js";
import { K as KokoroWorker, M as Messages, S as Suggestions } from "./C0LRR2ef.js";
import { V as ValvesModal, a as Valves } from "./DDLm17_q.js";
import { S as Selector } from "./DVIuCRaU.js";
import { M as Menu_sub, a as Menu_sub_trigger, b as Menu_sub_content } from "./DIObiElu.js";
import { f as fileSaver } from "./DRcZXQDn.js";
import { T as Tags } from "./BXKRkMSz.js";
import { M as Map$1, A as ArchiveBox, U as UserMenu, a as UserGroup } from "./B4U2oVkx.js";
import { S as Share } from "./BK4529jj.js";
import { D as Download } from "./Dm1xcaSj.js";
import { B as Banner } from "./CkX7EQxC.js";
import { S as Sidebar } from "./CIfNu5Bq.js";
import { E as EllipsisHorizontal } from "./BC-suBaL.js";
import { A as AdvancedParams } from "./Ap_nRVJv.js";
import { s as synthesizeOpenAISpeech, t as transcribeAudio } from "./BgG6Mq7m.js";
import { D as Drawer } from "./CfhMM1S2.js";
import { C as ConfirmDialog } from "./DhVOSDv1.js";
import { E as EyeSlash } from "./B0PhibVT.js";
import { C as ChevronUp } from "./DTpd_r3Z.js";
import { C as ChevronDown } from "./CUFupyOK.js";
import { E as Emoji } from "./D1wUrbJE.js";
import { E as EmojiPicker } from "./DHQbCHk-.js";
const PENDING = 0;
const THEN = 1;
function await_block(node, get_input, pending_fn, then_fn, catch_fn) {
  if (hydrating) {
    hydrate_next();
  }
  var runes = is_runes();
  var v = (
    /** @type {V} */
    UNINITIALIZED
  );
  var value = runes ? source(v) : mutable_source(v, false, false);
  var error = runes ? source(v) : mutable_source(v, false, false);
  var branches = new BranchManager(node);
  block(() => {
    var input = get_input();
    var destroyed = false;
    let mismatch = hydrating && is_promise(input) === (node.data === HYDRATION_START_ELSE);
    if (mismatch) {
      set_hydrate_node(skip_nodes());
      set_hydrating(false);
    }
    if (is_promise(input)) {
      var restore = capture();
      var resolved = false;
      const resolve = (fn) => {
        if (destroyed) return;
        resolved = true;
        restore(false);
        Batch.ensure();
        if (hydrating) {
          set_hydrating(false);
        }
        try {
          fn();
        } finally {
          unset_context();
          if (!is_flushing_sync) flushSync();
        }
      };
      input.then(
        (v2) => {
          resolve(() => {
            internal_set(value, v2);
            branches.ensure(THEN, then_fn && ((target) => then_fn(target, value)));
          });
        },
        (e) => {
          resolve(() => {
            internal_set(error, e);
            branches.ensure(THEN, catch_fn && ((target) => catch_fn(target, error)));
            if (!catch_fn) {
              throw error.v;
            }
          });
        }
      );
      if (hydrating) {
        branches.ensure(PENDING, pending_fn);
      } else {
        queue_micro_task(() => {
          if (!resolved) {
            resolve(() => {
              branches.ensure(PENDING, pending_fn);
            });
          }
        });
      }
    } else {
      internal_set(value, input);
      branches.ensure(THEN, then_fn && ((target) => then_fn(target, value)));
    }
    if (mismatch) {
      set_hydrating(true);
    }
    return () => {
      destroyed = true;
    };
  });
}
function Tags_1($$anchor, $$props) {
  push($$props, false);
  const $_tags = () => store_get(tags, "$_tags", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const dispatch = createEventDispatcher();
  let chatId2 = prop($$props, "chatId", 8, "");
  let tags$1 = mutable_source([]);
  const getTags = async () => {
    return await getTagsById(localStorage.token, chatId2()).catch(async (error) => {
      return [];
    });
  };
  const addTag = async (tagName) => {
    const res = await addTagById(localStorage.token, chatId2(), tagName).catch(async (error) => {
      toast.error(`${error}`);
      return null;
    });
    if (!res) {
      return;
    }
    set(tags$1, await getTags());
    await updateChatById(localStorage.token, chatId2(), { tags: get(tags$1) });
    await tags.set(await getAllTags(localStorage.token));
    dispatch("add", { name: tagName });
  };
  const deleteTag = async (tagName) => {
    await deleteTagById(localStorage.token, chatId2(), tagName);
    set(tags$1, await getTags());
    await updateChatById(localStorage.token, chatId2(), { tags: get(tags$1) });
    await tags.set(await getAllTags(localStorage.token));
    dispatch("delete", { name: tagName });
  };
  onMount(async () => {
    if (chatId2()) {
      set(tags$1, await getTags());
    }
  });
  init();
  {
    let $0 = derived_safe_equal(() => $_tags() ?? []);
    Tags($$anchor, {
      get tags() {
        return get(tags$1);
      },
      get suggestionTags() {
        return get($0);
      },
      $$events: {
        delete: (e) => {
          deleteTag(e.detail);
        },
        add: (e) => {
          addTag(e.detail);
        }
      }
    });
  }
  pop();
  $$cleanup();
}
function createParser(onParse) {
  let isFirstChunk;
  let buffer;
  let startingPosition;
  let startingFieldLength;
  let eventId;
  let eventName;
  let data;
  reset2();
  return {
    feed,
    reset: reset2
  };
  function reset2() {
    isFirstChunk = true;
    buffer = "";
    startingPosition = 0;
    startingFieldLength = -1;
    eventId = void 0;
    eventName = void 0;
    data = "";
  }
  function feed(chunk) {
    buffer = buffer ? buffer + chunk : chunk;
    if (isFirstChunk && hasBom(buffer)) {
      buffer = buffer.slice(BOM.length);
    }
    isFirstChunk = false;
    const length = buffer.length;
    let position = 0;
    let discardTrailingNewline = false;
    while (position < length) {
      if (discardTrailingNewline) {
        if (buffer[position] === "\n") {
          ++position;
        }
        discardTrailingNewline = false;
      }
      let lineLength = -1;
      let fieldLength = startingFieldLength;
      let character;
      for (let index2 = startingPosition; lineLength < 0 && index2 < length; ++index2) {
        character = buffer[index2];
        if (character === ":" && fieldLength < 0) {
          fieldLength = index2 - position;
        } else if (character === "\r") {
          discardTrailingNewline = true;
          lineLength = index2 - position;
        } else if (character === "\n") {
          lineLength = index2 - position;
        }
      }
      if (lineLength < 0) {
        startingPosition = length - position;
        startingFieldLength = fieldLength;
        break;
      } else {
        startingPosition = 0;
        startingFieldLength = -1;
      }
      parseEventStreamLine(buffer, position, fieldLength, lineLength);
      position += lineLength + 1;
    }
    if (position === length) {
      buffer = "";
    } else if (position > 0) {
      buffer = buffer.slice(position);
    }
  }
  function parseEventStreamLine(lineBuffer, index2, fieldLength, lineLength) {
    if (lineLength === 0) {
      if (data.length > 0) {
        onParse({
          type: "event",
          id: eventId,
          event: eventName || void 0,
          data: data.slice(0, -1)
          // remove trailing newline
        });
        data = "";
        eventId = void 0;
      }
      eventName = void 0;
      return;
    }
    const noValue = fieldLength < 0;
    const field = lineBuffer.slice(index2, index2 + (noValue ? lineLength : fieldLength));
    let step = 0;
    if (noValue) {
      step = lineLength;
    } else if (lineBuffer[index2 + fieldLength + 1] === " ") {
      step = fieldLength + 2;
    } else {
      step = fieldLength + 1;
    }
    const position = index2 + step;
    const valueLength = lineLength - step;
    const value = lineBuffer.slice(position, position + valueLength).toString();
    if (field === "data") {
      data += value ? "".concat(value, "\n") : "\n";
    } else if (field === "event") {
      eventName = value;
    } else if (field === "id" && !value.includes("\0")) {
      eventId = value;
    } else if (field === "retry") {
      const retry = parseInt(value, 10);
      if (!Number.isNaN(retry)) {
        onParse({
          type: "reconnect-interval",
          value: retry
        });
      }
    }
  }
}
const BOM = [239, 187, 191];
function hasBom(buffer) {
  return BOM.every((charCode, index2) => buffer.charCodeAt(index2) === charCode);
}
class EventSourceParserStream extends TransformStream {
  constructor() {
    let parser;
    super({
      start(controller) {
        parser = createParser((event2) => {
          if (event2.type === "event") {
            controller.enqueue(event2);
          }
        });
      },
      transform(chunk) {
        parser.feed(chunk);
      }
    });
  }
}
async function createOpenAITextStream(responseBody, splitLargeDeltas) {
  const eventStream = responseBody.pipeThrough(new TextDecoderStream()).pipeThrough(new EventSourceParserStream()).getReader();
  let iterator = openAIStreamToIterator(eventStream);
  if (splitLargeDeltas) {
    iterator = streamLargeDeltasAsRandomChunks(iterator);
  }
  return iterator;
}
async function* openAIStreamToIterator(reader) {
  var _a, _b, _c;
  while (true) {
    const { value, done } = await reader.read();
    if (done) {
      yield { done: true, value: "" };
      break;
    }
    if (!value) {
      continue;
    }
    const data = value.data;
    if (data.startsWith("[DONE]")) {
      yield { done: true, value: "" };
      break;
    }
    try {
      const parsedData = JSON.parse(data);
      console.log(parsedData);
      if (parsedData.error) {
        yield { done: true, value: "", error: parsedData.error };
        break;
      }
      if (parsedData.sources) {
        yield { done: false, value: "", sources: parsedData.sources };
        continue;
      }
      if (parsedData.selected_model_id) {
        yield { done: false, value: "", selectedModelId: parsedData.selected_model_id };
        continue;
      }
      if (parsedData.usage) {
        yield { done: false, value: "", usage: parsedData.usage };
        continue;
      }
      yield {
        done: false,
        value: ((_c = (_b = (_a = parsedData.choices) == null ? void 0 : _a[0]) == null ? void 0 : _b.delta) == null ? void 0 : _c.content) ?? ""
      };
    } catch (e) {
      console.error("Error extracting delta from SSE event:", e);
    }
  }
}
async function* streamLargeDeltasAsRandomChunks(iterator) {
  for await (const textStreamUpdate of iterator) {
    if (textStreamUpdate.done) {
      yield textStreamUpdate;
      return;
    }
    if (textStreamUpdate.error) {
      yield textStreamUpdate;
      continue;
    }
    if (textStreamUpdate.sources) {
      yield textStreamUpdate;
      continue;
    }
    if (textStreamUpdate.selectedModelId) {
      yield textStreamUpdate;
      continue;
    }
    if (textStreamUpdate.usage) {
      yield textStreamUpdate;
      continue;
    }
    let content = textStreamUpdate.value;
    if (content.length < 5) {
      yield { done: false, value: content };
      continue;
    }
    while (content != "") {
      const chunkSize = Math.min(Math.floor(Math.random() * 3) + 1, content.length);
      const chunk = content.slice(0, chunkSize);
      yield { done: false, value: chunk };
      if ((document == null ? void 0 : document.visibilityState) !== "hidden") {
        await sleep(5);
      }
      content = content.slice(chunkSize);
    }
  }
}
const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
var root$o = from_svg(`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 7.5-9-5.25L3 7.5m18 0-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9"></path></svg>`);
function Cube($$anchor, $$props) {
  let className = prop($$props, "className", 8, "size-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "2");
  var svg = root$o();
  template_effect(() => {
    set_attribute(svg, "stroke-width", strokeWidth());
    set_class(svg, 0, clsx(className()));
  });
  append($$anchor, svg);
}
class AudioQueue {
  constructor(audioElement) {
    this.audio = audioElement;
    this.queue = [];
    this.current = null;
    this.id = null;
    this._onEnded = () => this.next();
    this.audio.addEventListener("ended", this._onEnded);
    this.onStopped = null;
  }
  setId(newId) {
    console.log("Setting audio queue ID to:", newId);
    if (this.id !== newId) {
      this.stop();
      this.id = newId;
      if (this.onStopped) this.onStopped({ event: "id-change", id: newId });
    }
  }
  setPlaybackRate(rate) {
    console.log("Setting audio playback rate to:", rate);
    this.audio.playbackRate = rate;
  }
  enqueue(url) {
    console.log("Enqueuing audio URL:", url);
    this.queue.push(url);
    if (this.audio.paused && !this.current) {
      this.next();
    }
  }
  play() {
    if (!this.current && this.queue.length > 0) {
      this.next();
    } else {
      this.audio.play();
    }
  }
  next() {
    this.current = this.queue.shift();
    if (this.current) {
      this.audio.src = this.current;
      this.audio.play();
      console.log("Playing audio URL:", this.current);
    } else {
      this.stop();
      if (this.onStopped) this.onStopped({ event: "empty-queue", id: this.id });
    }
  }
  stop() {
    this.audio.pause();
    this.audio.currentTime = 0;
    this.audio.src = "";
    this.queue = [];
    this.current = null;
    if (this.onStopped) this.onStopped({ event: "stop", id: this.id });
  }
  destroy() {
    this.audio.removeEventListener("ended", this._onEnded);
    this.stop();
    this.onStopped = null;
    this.audio = null;
  }
}
let API_KEY = "";
let CLIENT_ID = "";
async function getCredentials() {
  var _a, _b;
  const response = await fetch("/api/config");
  if (!response.ok) {
    throw new Error("Failed to fetch Google Drive credentials");
  }
  const config2 = await response.json();
  API_KEY = (_a = config2.google_drive) == null ? void 0 : _a.api_key;
  CLIENT_ID = (_b = config2.google_drive) == null ? void 0 : _b.client_id;
  if (!API_KEY || !CLIENT_ID) {
    throw new Error("Google Drive API credentials not configured");
  }
}
const SCOPE = [
  "https://www.googleapis.com/auth/drive.readonly",
  "https://www.googleapis.com/auth/drive.file"
];
const validateCredentials = () => {
  if (!API_KEY || !CLIENT_ID) {
    throw new Error("Google Drive API credentials not configured");
  }
  if (API_KEY === "" || CLIENT_ID === "") {
    throw new Error("Please configure valid Google Drive API credentials");
  }
};
let oauthToken = null;
let initialized = false;
const loadGoogleDriveApi = () => {
  return new Promise((resolve, reject) => {
    if (typeof gapi === "undefined") {
      const script = document.createElement("script");
      script.src = "https://apis.google.com/js/api.js";
      script.onload = () => {
        gapi.load("picker", () => {
          resolve(true);
        });
      };
      script.onerror = reject;
      document.body.appendChild(script);
    } else {
      gapi.load("picker", () => {
        resolve(true);
      });
    }
  });
};
const loadGoogleAuthApi = () => {
  return new Promise((resolve, reject) => {
    if (typeof google === "undefined") {
      const script = document.createElement("script");
      script.src = "https://accounts.google.com/gsi/client";
      script.onload = resolve;
      script.onerror = reject;
      document.body.appendChild(script);
    } else {
      resolve(true);
    }
  });
};
const getAuthToken = async () => {
  if (!oauthToken) {
    return new Promise((resolve, reject) => {
      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPE.join(" "),
        callback: (response) => {
          if (response.access_token) {
            oauthToken = response.access_token;
            resolve(oauthToken);
          } else {
            reject(new Error("Failed to get access token"));
          }
        },
        error_callback: (error) => {
          reject(new Error(error.message || "OAuth error occurred"));
        }
      });
      tokenClient.requestAccessToken();
    });
  }
  return oauthToken;
};
const initialize = async () => {
  if (!initialized) {
    await getCredentials();
    validateCredentials();
    await Promise.all([loadGoogleDriveApi(), loadGoogleAuthApi()]);
    initialized = true;
  }
};
const createPicker = () => {
  return new Promise(async (resolve, reject) => {
    try {
      console.log("Initializing Google Drive Picker...");
      await initialize();
      console.log("Getting auth token...");
      const token2 = await getAuthToken();
      if (!token2) {
        console.error("Failed to get OAuth token");
        throw new Error("Unable to get OAuth token");
      }
      console.log("Auth token obtained successfully");
      const picker = new google.picker.PickerBuilder().enableFeature(google.picker.Feature.NAV_HIDDEN).enableFeature(google.picker.Feature.MULTISELECT_ENABLED).addView(
        new google.picker.DocsView().setIncludeFolders(false).setSelectFolderEnabled(false).setMimeTypes(
          "application/pdf,text/plain,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.google-apps.document,application/vnd.google-apps.spreadsheet,application/vnd.google-apps.presentation"
        )
      ).setOAuthToken(token2).setDeveloperKey(API_KEY).setCallback(async (data) => {
        if (data[google.picker.Response.ACTION] === google.picker.Action.PICKED) {
          try {
            const doc = data[google.picker.Response.DOCUMENTS][0];
            const fileId = doc[google.picker.Document.ID];
            const fileName = doc[google.picker.Document.NAME];
            const fileUrl = doc[google.picker.Document.URL];
            if (!fileId || !fileName) {
              throw new Error("Required file details missing");
            }
            const mimeType = doc[google.picker.Document.MIME_TYPE];
            let downloadUrl;
            let exportFormat;
            if (mimeType.includes("google-apps")) {
              if (mimeType.includes("document")) {
                exportFormat = "text/plain";
              } else if (mimeType.includes("spreadsheet")) {
                exportFormat = "text/csv";
              } else if (mimeType.includes("presentation")) {
                exportFormat = "text/plain";
              } else {
                exportFormat = "application/pdf";
              }
              downloadUrl = `https://www.googleapis.com/drive/v3/files/${fileId}/export?mimeType=${encodeURIComponent(exportFormat)}`;
            } else {
              downloadUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
            }
            const response = await fetch(downloadUrl, {
              headers: {
                Authorization: `Bearer ${token2}`,
                Accept: "*/*"
              }
            });
            if (!response.ok) {
              const errorText = await response.text();
              console.error("Download failed:", {
                status: response.status,
                statusText: response.statusText,
                error: errorText
              });
              throw new Error(`Failed to download file (${response.status}): ${errorText}`);
            }
            const blob = await response.blob();
            const result = {
              id: fileId,
              name: fileName,
              url: downloadUrl,
              blob,
              headers: {
                Authorization: `Bearer ${token2}`,
                Accept: "*/*"
              }
            };
            resolve(result);
          } catch (error) {
            reject(error);
          }
        } else if (data[google.picker.Response.ACTION] === google.picker.Action.CANCEL) {
          resolve(null);
        }
      }).build();
      picker.setVisible(true);
    } catch (error) {
      console.error("Google Drive Picker error:", error);
      reject(error);
    }
  });
};
const _OneDriveConfig = class _OneDriveConfig {
  constructor() {
    __publicField(this, "clientIdPersonal", "");
    __publicField(this, "clientIdBusiness", "");
    __publicField(this, "sharepointUrl", "");
    __publicField(this, "sharepointTenantId", "");
    __publicField(this, "msalInstance", null);
    __publicField(this, "currentAuthorityType", "personal");
  }
  static getInstance() {
    if (!_OneDriveConfig.instance) {
      _OneDriveConfig.instance = new _OneDriveConfig();
    }
    return _OneDriveConfig.instance;
  }
  async initialize(authorityType) {
    if (authorityType && this.currentAuthorityType !== authorityType) {
      this.currentAuthorityType = authorityType;
      this.msalInstance = null;
    }
    await this.getCredentials();
  }
  async ensureInitialized(authorityType) {
    await this.initialize(authorityType);
  }
  async getCredentials() {
    var _a, _b, _c, _d;
    const response = await fetch("/api/config", {
      headers: {
        "Content-Type": "application/json"
      },
      credentials: "include"
    });
    if (!response.ok) {
      throw new Error("Failed to fetch OneDrive credentials");
    }
    const config2 = await response.json();
    this.clientIdPersonal = (_a = config2.onedrive) == null ? void 0 : _a.client_id_personal;
    this.clientIdBusiness = (_b = config2.onedrive) == null ? void 0 : _b.client_id_business;
    this.sharepointUrl = (_c = config2.onedrive) == null ? void 0 : _c.sharepoint_url;
    this.sharepointTenantId = (_d = config2.onedrive) == null ? void 0 : _d.sharepoint_tenant_id;
    if (!this.clientIdPersonal && !this.clientIdBusiness) {
      throw new Error("OneDrive personal or business client ID not configured");
    }
  }
  async getMsalInstance(authorityType) {
    await this.ensureInitialized(authorityType);
    if (!this.msalInstance) {
      const authorityEndpoint = this.currentAuthorityType === "organizations" ? this.sharepointTenantId || "common" : "consumers";
      const clientId = this.currentAuthorityType === "organizations" ? this.clientIdBusiness : this.clientIdPersonal;
      if (!clientId) {
        throw new Error("OneDrive client ID not configured");
      }
      const msalParams = {
        auth: {
          authority: `https://login.microsoftonline.com/${authorityEndpoint}`,
          clientId
        }
      };
      const { PublicClientApplication } = await __vitePreload(async () => {
        const { PublicClientApplication: PublicClientApplication2 } = await import("./CK7Et90Q.js");
        return { PublicClientApplication: PublicClientApplication2 };
      }, true ? [] : void 0, import.meta.url);
      this.msalInstance = new PublicClientApplication(msalParams);
      if (this.msalInstance.initialize) {
        await this.msalInstance.initialize();
      }
    }
    return this.msalInstance;
  }
  getAuthorityType() {
    return this.currentAuthorityType;
  }
  getSharepointUrl() {
    return this.sharepointUrl;
  }
  getSharepointTenantId() {
    return this.sharepointTenantId;
  }
  getBaseUrl() {
    if (this.currentAuthorityType === "organizations") {
      if (!this.sharepointUrl || this.sharepointUrl === "") {
        throw new Error("Sharepoint URL not configured");
      }
      let sharePointBaseUrl = this.sharepointUrl.replace(/^https?:\/\//, "");
      sharePointBaseUrl = sharePointBaseUrl.replace(/\/$/, "");
      return `https://${sharePointBaseUrl}`;
    } else {
      return "https://onedrive.live.com/picker";
    }
  }
};
__publicField(_OneDriveConfig, "instance");
let OneDriveConfig = _OneDriveConfig;
async function getToken(resource, authorityType) {
  const config2 = OneDriveConfig.getInstance();
  await config2.ensureInitialized(authorityType);
  const currentAuthorityType = config2.getAuthorityType();
  const scopes = currentAuthorityType === "organizations" ? [`${resource || config2.getBaseUrl()}/.default`] : ["OneDrive.ReadWrite"];
  const authParams = { scopes };
  let accessToken = "";
  try {
    const msalInstance = await config2.getMsalInstance(authorityType);
    const resp = await msalInstance.acquireTokenSilent(authParams);
    accessToken = resp.accessToken;
  } catch {
    const msalInstance = await config2.getMsalInstance(authorityType);
    try {
      const resp = await msalInstance.loginPopup(authParams);
      msalInstance.setActiveAccount(resp.account);
      if (resp.idToken) {
        const resp2 = await msalInstance.acquireTokenSilent(authParams);
        accessToken = resp2.accessToken;
      }
    } catch (popupError) {
      throw new Error(
        "Failed to login: " + (popupError instanceof Error ? popupError.message : String(popupError))
      );
    }
  }
  if (!accessToken) {
    throw new Error("Failed to acquire access token");
  }
  return accessToken;
}
function getPickerParams() {
  var _a;
  const channelId = v4();
  const config2 = OneDriveConfig.getInstance();
  const params = {
    sdk: "8.0",
    entry: {
      oneDrive: {}
    },
    authentication: {},
    messaging: {
      origin: ((_a = window == null ? void 0 : window.location) == null ? void 0 : _a.origin) || "",
      channelId
    },
    search: {
      enabled: true
    },
    typesAndSources: {
      mode: "files",
      pivots: {
        oneDrive: true,
        recent: true,
        myOrganization: config2.getAuthorityType() === "organizations"
      }
    }
  };
  if (config2.getAuthorityType() !== "organizations") {
    params.entry.oneDrive = { files: {} };
  }
  return params;
}
async function downloadOneDriveFile(fileInfo, authorityType) {
  const accessToken = await getToken(void 0, authorityType);
  if (!accessToken) {
    throw new Error("Unable to retrieve OneDrive access token.");
  }
  const fileInfoUrl = `${fileInfo["@sharePoint.endpoint"]}/drives/${fileInfo.parentReference.driveId}/items/${fileInfo.id}`;
  const response = await fetch(fileInfoUrl, {
    headers: {
      Authorization: `Bearer ${accessToken}`
    }
  });
  if (!response.ok) {
    throw new Error(`Failed to fetch file information: ${response.status} ${response.statusText}`);
  }
  const fileData = await response.json();
  const downloadUrl = fileData["@content.downloadUrl"];
  if (!downloadUrl) {
    throw new Error("Download URL not found in file data");
  }
  const downloadResponse = await fetch(downloadUrl);
  if (!downloadResponse.ok) {
    throw new Error(
      `Failed to download file: ${downloadResponse.status} ${downloadResponse.statusText}`
    );
  }
  return await downloadResponse.blob();
}
async function openOneDrivePicker(authorityType) {
  if (typeof window === "undefined") {
    throw new Error("Not in browser environment");
  }
  const config2 = OneDriveConfig.getInstance();
  await config2.initialize(authorityType);
  return new Promise((resolve, reject) => {
    let pickerWindow = null;
    let channelPort = null;
    const params = getPickerParams();
    const baseUrl = config2.getBaseUrl();
    const handleWindowMessage = (event2) => {
      var _a;
      if (event2.source !== pickerWindow) return;
      const message = event2.data;
      if ((message == null ? void 0 : message.type) === "initialize" && (message == null ? void 0 : message.channelId) === params.messaging.channelId) {
        channelPort = (_a = event2.ports) == null ? void 0 : _a[0];
        if (!channelPort) return;
        channelPort.addEventListener("message", handlePortMessage);
        channelPort.start();
        channelPort.postMessage({ type: "activate" });
      }
    };
    const handlePortMessage = async (portEvent) => {
      const portData = portEvent.data;
      switch (portData.type) {
        case "notification":
          break;
        case "command": {
          channelPort == null ? void 0 : channelPort.postMessage({ type: "acknowledge", id: portData.id });
          const command = portData.data;
          switch (command.command) {
            case "authenticate": {
              try {
                const resource = config2.getAuthorityType() === "organizations" ? command.resource : void 0;
                const newToken = await getToken(resource, authorityType);
                if (newToken) {
                  channelPort == null ? void 0 : channelPort.postMessage({
                    type: "result",
                    id: portData.id,
                    data: { result: "token", token: newToken }
                  });
                } else {
                  throw new Error("Could not retrieve auth token");
                }
              } catch {
                channelPort == null ? void 0 : channelPort.postMessage({
                  type: "result",
                  id: portData.id,
                  data: {
                    result: "error",
                    error: { code: "tokenError", message: "Failed to get token" }
                  }
                });
              }
              break;
            }
            case "close": {
              cleanup();
              resolve(null);
              break;
            }
            case "pick": {
              channelPort == null ? void 0 : channelPort.postMessage({
                type: "result",
                id: portData.id,
                data: { result: "success" }
              });
              cleanup();
              resolve(command);
              break;
            }
            default: {
              channelPort == null ? void 0 : channelPort.postMessage({
                result: "error",
                error: { code: "unsupportedCommand", message: command.command },
                isExpected: true
              });
              break;
            }
          }
          break;
        }
      }
    };
    function cleanup() {
      window.removeEventListener("message", handleWindowMessage);
      if (channelPort) {
        channelPort.removeEventListener("message", handlePortMessage);
      }
      if (pickerWindow) {
        pickerWindow.close();
        pickerWindow = null;
      }
    }
    const initializePicker = async () => {
      try {
        const authToken = await getToken(void 0, authorityType);
        if (!authToken) {
          return reject(new Error("Failed to acquire access token"));
        }
        pickerWindow = window.open("", "OneDrivePicker", "width=800,height=600");
        if (!pickerWindow) {
          return reject(new Error("Failed to open OneDrive picker window"));
        }
        const queryString = new URLSearchParams({
          filePicker: JSON.stringify(params)
        });
        let url = "";
        if (config2.getAuthorityType() === "organizations") {
          url = baseUrl + `/_layouts/15/FilePicker.aspx?${queryString}`;
        } else {
          url = baseUrl + `?${queryString}`;
        }
        const form = pickerWindow.document.createElement("form");
        form.setAttribute("action", url);
        form.setAttribute("method", "POST");
        const input = pickerWindow.document.createElement("input");
        input.setAttribute("type", "hidden");
        input.setAttribute("name", "access_token");
        input.setAttribute("value", authToken);
        form.appendChild(input);
        pickerWindow.document.body.appendChild(form);
        form.submit();
        window.addEventListener("message", handleWindowMessage);
      } catch (err) {
        if (pickerWindow) {
          pickerWindow.close();
        }
        reject(err);
      }
    };
    initializePicker();
  });
}
async function pickAndDownloadFile(authorityType) {
  const pickerResult = await openOneDrivePicker(authorityType);
  if (!pickerResult || !pickerResult.items || pickerResult.items.length === 0) {
    return null;
  }
  const selectedFile = pickerResult.items[0];
  const blob = await downloadOneDriveFile(selectedFile, authorityType);
  return { blob, name: selectedFile.name };
}
var root$n = from_svg(`<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" fill="none" viewBox="0 0 24 24"><path d="M12 6L12 12L18 12" stroke-linecap="round" stroke-linejoin="round"></path><path d="M21.8883 10.5C21.1645 5.68874 17.013 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C16.1006 22 19.6248 19.5318 21.1679 16" stroke-linecap="round" stroke-linejoin="round"></path><path d="M17 16H21.4C21.7314 16 22 16.2686 22 16.6V21" stroke-linecap="round" stroke-linejoin="round"></path></svg>`);
function ClockRotateRight($$anchor, $$props) {
  let className = prop($$props, "className", 8, "w-4 h-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "1.5");
  var svg = root$n();
  template_effect(() => {
    set_class(svg, 0, clsx(className()));
    set_attribute(svg, "stroke-width", strokeWidth());
  });
  append($$anchor, svg);
}
var root_2$f = from_html(`<div class="text-center text-xs text-gray-500 py-3"> </div>`);
var root_5$b = from_html(`<div class="line-clamp-1 flex-1"> </div>`);
var root_4$7 = from_html(`<button type="button"><div class="text-black dark:text-gray-100 flex items-center gap-1.5"><!></div></button>`);
var root_7$c = from_html(`<div class="w-full flex justify-center py-4 text-xs animate-pulse items-center gap-2"><!> <div class=" "> </div></div>`);
var root_3$e = from_html(`<div class="flex flex-col gap-0.5"><!> <!></div>`);
var root_8$7 = from_html(`<div class="py-4.5"><!></div>`);
function Chats($$anchor, $$props) {
  push($$props, false);
  const $chatId = () => store_get(chatId, "$chatId", $$stores);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const i18n = getContext("i18n");
  let onSelect = prop($$props, "onSelect", 8, (e) => {
  });
  let loaded = mutable_source(false);
  let items = mutable_source([]);
  let selectedIdx = mutable_source(0);
  let page2 = 1;
  let itemsLoading = mutable_source(false);
  let allItemsLoaded = mutable_source(false);
  const loadMoreItems = async () => {
    if (get(allItemsLoaded)) return;
    page2 += 1;
    await getItemsPage();
  };
  const getItemsPage = async () => {
    set(itemsLoading, true);
    let res = await getChatList(localStorage.token, page2, true, true).catch(() => {
      return [];
    });
    if ((res ?? []).length === 0) {
      set(allItemsLoaded, true);
    } else {
      set(allItemsLoaded, false);
    }
    set(items, [
      ...get(items),
      ...res.filter((item) => (item == null ? void 0 : item.id) !== $chatId()).map((item) => {
        return {
          ...item,
          type: "chat",
          name: item.title,
          description: dayjs2(item.updated_at * 1e3).fromNow()
        };
      })
    ]);
    set(itemsLoading, false);
    return res;
  };
  onMount(async () => {
    await getItemsPage();
    await tick();
    set(loaded, true);
  });
  init();
  var fragment = comment();
  var node = first_child(fragment);
  {
    var consequent_2 = ($$anchor2) => {
      var fragment_1 = comment();
      var node_1 = first_child(fragment_1);
      {
        var consequent = ($$anchor3) => {
          var div = root_2$f();
          var text2 = child(div, true);
          reset(div);
          template_effect(($0) => set_text(text2, $0), [
            () => ($i18n(), untrack(() => $i18n().t("No chats found")))
          ]);
          append($$anchor3, div);
        };
        var alternate = ($$anchor3) => {
          var div_1 = root_3$e();
          var node_2 = child(div_1);
          each(node_2, 1, () => get(items), index, ($$anchor4, item, idx) => {
            var button = root_4$7();
            var div_2 = child(button);
            var node_3 = child(div_2);
            {
              let $0 = derived_safe_equal(() => (get(item), deep_read_state(decodeString), untrack(() => {
                var _a;
                return get(item).description || decodeString((_a = get(item)) == null ? void 0 : _a.name);
              })));
              Tooltip(node_3, {
                get content() {
                  return get($0);
                },
                placement: "top-start",
                children: ($$anchor5, $$slotProps) => {
                  var div_3 = root_5$b();
                  var text_1 = child(div_3, true);
                  reset(div_3);
                  template_effect(($02) => set_text(text_1, $02), [
                    () => (deep_read_state(decodeString), get(item), untrack(() => {
                      var _a;
                      return decodeString((_a = get(item)) == null ? void 0 : _a.name);
                    }))
                  ]);
                  append($$anchor5, div_3);
                },
                $$slots: { default: true }
              });
            }
            reset(div_2);
            reset(button);
            template_effect(() => {
              set_class(button, 1, ` px-2.5 py-1 rounded-xl w-full text-left flex justify-between items-center text-sm ${idx === get(selectedIdx) ? " bg-gray-50 dark:bg-gray-800 dark:text-gray-100 selected-command-option-button" : ""}`);
              set_attribute(button, "data-selected", idx === get(selectedIdx));
            });
            event("click", button, () => {
              onSelect()(get(item));
            });
            event("mousemove", button, () => {
              set(selectedIdx, idx);
            });
            event("mouseleave", button, () => {
              if (idx === 0) {
                set(selectedIdx, -1);
              }
            });
            append($$anchor4, button);
          });
          var node_4 = sibling(node_2, 2);
          {
            var consequent_1 = ($$anchor4) => {
              Loader($$anchor4, {
                $$events: {
                  visible: (e) => {
                    if (!get(itemsLoading)) {
                      loadMoreItems();
                    }
                  }
                },
                children: ($$anchor5, $$slotProps) => {
                  var div_4 = root_7$c();
                  var node_5 = child(div_4);
                  Spinner(node_5, { className: " size-4" });
                  var div_5 = sibling(node_5, 2);
                  var text_2 = child(div_5, true);
                  reset(div_5);
                  reset(div_4);
                  template_effect(($0) => set_text(text_2, $0), [() => ($i18n(), untrack(() => $i18n().t("Loading...")))]);
                  append($$anchor5, div_4);
                },
                $$slots: { default: true }
              });
            };
            if_block(node_4, ($$render) => {
              if (!get(allItemsLoaded)) $$render(consequent_1);
            });
          }
          reset(div_1);
          append($$anchor3, div_1);
        };
        if_block(node_1, ($$render) => {
          if (get(items), untrack(() => get(items).length === 0)) $$render(consequent);
          else $$render(alternate, false);
        });
      }
      append($$anchor2, fragment_1);
    };
    var alternate_1 = ($$anchor2) => {
      var div_6 = root_8$7();
      var node_6 = child(div_6);
      Spinner(node_6, {});
      reset(div_6);
      append($$anchor2, div_6);
    };
    if_block(node, ($$render) => {
      if (get(loaded)) $$render(consequent_2);
      else $$render(alternate_1, false);
    });
  }
  append($$anchor, fragment);
  pop();
  $$cleanup();
}
var root_2$e = from_html(`<div class="text-center text-xs text-gray-500 py-3"> </div>`);
var root_6$e = from_html(`<div class="line-clamp-1 flex-1"> </div>`);
var root_4$6 = from_html(`<button type="button"><div class="text-black dark:text-gray-100 flex items-center gap-1.5"><!> <!></div></button>`);
var root_8$6 = from_html(`<div class="w-full flex justify-center py-4 text-xs animate-pulse items-center gap-2"><!> <div class=" "> </div></div>`);
var root_3$d = from_html(`<div class="flex flex-col gap-0.5"><!> <!></div>`);
var root_9$5 = from_html(`<div class="py-4.5"><!></div>`);
function Notes($$anchor, $$props) {
  push($$props, false);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const i18n = getContext("i18n");
  let onSelect = prop($$props, "onSelect", 8, (e) => {
  });
  let loaded = mutable_source(false);
  let items = mutable_source([]);
  let selectedIdx = mutable_source(0);
  let page2 = 1;
  let itemsLoading = mutable_source(false);
  let allItemsLoaded = mutable_source(false);
  const loadMoreItems = async () => {
    if (get(allItemsLoaded)) return;
    page2 += 1;
    await getItemsPage();
  };
  const getItemsPage = async () => {
    set(itemsLoading, true);
    let res = await getNoteList(localStorage.token, page2).catch(() => {
      return [];
    });
    if ((res ?? []).length === 0) {
      set(allItemsLoaded, true);
    } else {
      set(allItemsLoaded, false);
    }
    set(items, [
      ...get(items),
      ...res.map((note) => {
        return {
          ...note,
          type: "note",
          name: note.title,
          description: dayjs2(note.updated_at / 1e6).fromNow()
        };
      })
    ]);
    set(itemsLoading, false);
    return res;
  };
  onMount(async () => {
    await getItemsPage();
    await tick();
    set(loaded, true);
  });
  init();
  var fragment = comment();
  var node = first_child(fragment);
  {
    var consequent_2 = ($$anchor2) => {
      var fragment_1 = comment();
      var node_1 = first_child(fragment_1);
      {
        var consequent = ($$anchor3) => {
          var div = root_2$e();
          var text2 = child(div, true);
          reset(div);
          template_effect(($0) => set_text(text2, $0), [
            () => ($i18n(), untrack(() => $i18n().t("No notes found")))
          ]);
          append($$anchor3, div);
        };
        var alternate = ($$anchor3) => {
          var div_1 = root_3$d();
          var node_2 = child(div_1);
          each(node_2, 1, () => get(items), index, ($$anchor4, item, idx) => {
            var button = root_4$6();
            var div_2 = child(button);
            var node_3 = child(div_2);
            {
              let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Note"))));
              Tooltip(node_3, {
                get content() {
                  return get($0);
                },
                placement: "top",
                children: ($$anchor5, $$slotProps) => {
                  PageEdit($$anchor5, { className: "size-4" });
                },
                $$slots: { default: true }
              });
            }
            var node_4 = sibling(node_3, 2);
            {
              let $0 = derived_safe_equal(() => (get(item), deep_read_state(decodeString), untrack(() => {
                var _a;
                return get(item).description || decodeString((_a = get(item)) == null ? void 0 : _a.name);
              })));
              Tooltip(node_4, {
                get content() {
                  return get($0);
                },
                placement: "top-start",
                children: ($$anchor5, $$slotProps) => {
                  var div_3 = root_6$e();
                  var text_1 = child(div_3, true);
                  reset(div_3);
                  template_effect(($02) => set_text(text_1, $02), [
                    () => (deep_read_state(decodeString), get(item), untrack(() => {
                      var _a;
                      return decodeString((_a = get(item)) == null ? void 0 : _a.name);
                    }))
                  ]);
                  append($$anchor5, div_3);
                },
                $$slots: { default: true }
              });
            }
            reset(div_2);
            reset(button);
            template_effect(() => {
              set_class(button, 1, ` px-2.5 py-1 rounded-xl w-full text-left flex justify-between items-center text-sm ${idx === get(selectedIdx) ? " bg-gray-50 dark:bg-gray-800 dark:text-gray-100 selected-command-option-button" : ""}`);
              set_attribute(button, "data-selected", idx === get(selectedIdx));
            });
            event("click", button, () => {
              onSelect()(get(item));
            });
            event("mousemove", button, () => {
              set(selectedIdx, idx);
            });
            event("mouseleave", button, () => {
              if (idx === 0) {
                set(selectedIdx, -1);
              }
            });
            append($$anchor4, button);
          });
          var node_5 = sibling(node_2, 2);
          {
            var consequent_1 = ($$anchor4) => {
              Loader($$anchor4, {
                $$events: {
                  visible: (e) => {
                    if (!get(itemsLoading)) {
                      loadMoreItems();
                    }
                  }
                },
                children: ($$anchor5, $$slotProps) => {
                  var div_4 = root_8$6();
                  var node_6 = child(div_4);
                  Spinner(node_6, { className: " size-4" });
                  var div_5 = sibling(node_6, 2);
                  var text_2 = child(div_5, true);
                  reset(div_5);
                  reset(div_4);
                  template_effect(($0) => set_text(text_2, $0), [() => ($i18n(), untrack(() => $i18n().t("Loading...")))]);
                  append($$anchor5, div_4);
                },
                $$slots: { default: true }
              });
            };
            if_block(node_5, ($$render) => {
              if (!get(allItemsLoaded)) $$render(consequent_1);
            });
          }
          reset(div_1);
          append($$anchor3, div_1);
        };
        if_block(node_1, ($$render) => {
          if (get(items), untrack(() => get(items).length === 0)) $$render(consequent);
          else $$render(alternate, false);
        });
      }
      append($$anchor2, fragment_1);
    };
    var alternate_1 = ($$anchor2) => {
      var div_6 = root_9$5();
      var node_7 = child(div_6);
      Spinner(node_7, {});
      reset(div_6);
      append($$anchor2, div_6);
    };
    if_block(node, ($$render) => {
      if (get(loaded)) $$render(consequent_2);
      else $$render(alternate_1, false);
    });
  }
  append($$anchor, fragment);
  pop();
  $$cleanup();
}
var root_6$d = from_html(`<div class="line-clamp-1 flex-1"> </div>`);
var root_2$d = from_html(`<button type="button"><div class="  text-black dark:text-gray-100 flex items-center gap-1"><!> <!></div></button>`);
var root_1$d = from_html(`<div class="flex flex-col gap-0.5"></div>`);
var root_7$b = from_html(`<div class="py-4.5"><!></div>`);
function Knowledge($$anchor, $$props) {
  push($$props, false);
  const $knowledge = () => store_get(knowledge, "$knowledge", $$stores);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const i18n = getContext("i18n");
  let onSelect = prop($$props, "onSelect", 8, (e) => {
  });
  let loaded = mutable_source(false);
  let items = mutable_source([]);
  let selectedIdx = mutable_source(0);
  onMount(async () => {
    if ($knowledge() === null) {
      await knowledge.set(await getKnowledgeBases(localStorage.token));
    }
    let legacy_documents = $knowledge().filter((item) => {
      var _a;
      return (_a = item == null ? void 0 : item.meta) == null ? void 0 : _a.document;
    }).map((item) => ({ ...item, type: "file" }));
    let legacy_collections = legacy_documents.length > 0 ? [
      {
        name: "All Documents",
        legacy: true,
        type: "collection",
        description: "Deprecated (legacy collection), please create a new knowledge base.",
        title: $i18n().t("All Documents"),
        collection_names: legacy_documents.map((item) => item.id)
      },
      ...legacy_documents.reduce(
        (a, item) => {
          var _a;
          return [
            .../* @__PURE__ */ new Set([...a, ...(((_a = item == null ? void 0 : item.meta) == null ? void 0 : _a.tags) ?? []).map((tag) => tag.name)])
          ];
        },
        []
      ).map((tag) => ({
        name: tag,
        legacy: true,
        type: "collection",
        description: "Deprecated (legacy collection), please create a new knowledge base.",
        collection_names: legacy_documents.filter((item) => {
          var _a;
          return (((_a = item == null ? void 0 : item.meta) == null ? void 0 : _a.tags) ?? []).map((tag2) => tag2.name).includes(tag);
        }).map((item) => item.id)
      }))
    ] : [];
    let collections = $knowledge().filter((item) => {
      var _a;
      return !((_a = item == null ? void 0 : item.meta) == null ? void 0 : _a.document);
    }).map((item) => ({ ...item, type: "collection" }));
    let collection_files = $knowledge().length > 0 ? [
      ...$knowledge().reduce(
        (a, item) => {
          return [
            .../* @__PURE__ */ new Set([
              ...a,
              ...((item == null ? void 0 : item.files) ?? []).map((file) => ({
                ...file,
                collection: { name: item.name, description: item.description }
                // DO NOT REMOVE, USED IN FILE DESCRIPTION/ATTACHMENT
              }))
            ])
          ];
        },
        []
      ).map((file) => {
        var _a, _b, _c;
        return {
          ...file,
          name: (_a = file == null ? void 0 : file.meta) == null ? void 0 : _a.name,
          description: `${(_b = file == null ? void 0 : file.collection) == null ? void 0 : _b.name} - ${(_c = file == null ? void 0 : file.collection) == null ? void 0 : _c.description}`,
          knowledge: true,
          // DO NOT REMOVE, USED TO INDICATE KNOWLEDGE BASE FILE
          type: "file"
        };
      })
    ] : [];
    set(items, [
      ...collections,
      ...collection_files,
      ...legacy_collections,
      ...legacy_documents
    ].map((item) => {
      var _a, _b;
      return {
        ...item,
        ...(item == null ? void 0 : item.legacy) || ((_a = item == null ? void 0 : item.meta) == null ? void 0 : _a.legacy) || ((_b = item == null ? void 0 : item.meta) == null ? void 0 : _b.document) ? { legacy: true } : {}
      };
    }));
    await tick();
    set(loaded, true);
  });
  init();
  var fragment = comment();
  var node = first_child(fragment);
  {
    var consequent_1 = ($$anchor2) => {
      var div = root_1$d();
      each(div, 5, () => get(items), index, ($$anchor3, item, idx) => {
        var button = root_2$d();
        var div_1 = child(button);
        var node_1 = child(div_1);
        {
          let $0 = derived_safe_equal(() => (get(item), $i18n(), untrack(() => {
            var _a, _b, _c;
            return ((_a = get(item)) == null ? void 0 : _a.legacy) ? $i18n().t("Legacy") : ((_b = get(item)) == null ? void 0 : _b.type) === "file" ? $i18n().t("File") : ((_c = get(item)) == null ? void 0 : _c.type) === "collection" ? $i18n().t("Collection") : "";
          })));
          Tooltip(node_1, {
            get content() {
              return get($0);
            },
            placement: "top",
            children: ($$anchor4, $$slotProps) => {
              var fragment_1 = comment();
              var node_2 = first_child(fragment_1);
              {
                var consequent = ($$anchor5) => {
                  Database($$anchor5, { className: "size-4" });
                };
                var alternate = ($$anchor5) => {
                  DocumentPage($$anchor5, { className: "size-4" });
                };
                if_block(node_2, ($$render) => {
                  if (get(item), untrack(() => {
                    var _a;
                    return ((_a = get(item)) == null ? void 0 : _a.type) === "collection";
                  })) $$render(consequent);
                  else $$render(alternate, false);
                });
              }
              append($$anchor4, fragment_1);
            },
            $$slots: { default: true }
          });
        }
        var node_3 = sibling(node_1, 2);
        {
          let $0 = derived_safe_equal(() => (get(item), deep_read_state(decodeString), untrack(() => {
            var _a;
            return get(item).description || decodeString((_a = get(item)) == null ? void 0 : _a.name);
          })));
          Tooltip(node_3, {
            get content() {
              return get($0);
            },
            placement: "top-start",
            children: ($$anchor4, $$slotProps) => {
              var div_2 = root_6$d();
              var text2 = child(div_2, true);
              reset(div_2);
              template_effect(($02) => set_text(text2, $02), [
                () => (deep_read_state(decodeString), get(item), untrack(() => {
                  var _a;
                  return decodeString((_a = get(item)) == null ? void 0 : _a.name);
                }))
              ]);
              append($$anchor4, div_2);
            },
            $$slots: { default: true }
          });
        }
        reset(div_1);
        reset(button);
        template_effect(() => {
          set_class(button, 1, ` px-2.5 py-1 rounded-xl w-full text-left flex justify-between items-center text-sm ${idx === get(selectedIdx) ? " bg-gray-50 dark:bg-gray-800 dark:text-gray-100 selected-command-option-button" : ""}`);
          set_attribute(button, "data-selected", idx === get(selectedIdx));
        });
        event("click", button, () => {
          console.log(get(item));
          onSelect()(get(item));
        });
        event("mousemove", button, () => {
          set(selectedIdx, idx);
        });
        event("mouseleave", button, () => {
          if (idx === 0) {
            set(selectedIdx, -1);
          }
        });
        append($$anchor3, button);
      });
      reset(div);
      append($$anchor2, div);
    };
    var alternate_1 = ($$anchor2) => {
      var div_3 = root_7$b();
      var node_4 = child(div_3);
      Spinner(node_4, {});
      reset(div_3);
      append($$anchor2, div_3);
    };
    if_block(node, ($$render) => {
      if (get(loaded)) $$render(consequent_1);
      else $$render(alternate_1, false);
    });
  }
  append($$anchor, fragment);
  pop();
  $$cleanup();
}
var root_1$c = from_html(`<div class="flex flex-col h-full"><div class="flex justify-between items-center dark:text-gray-100 px-5 pt-4 pb-1.5"><h1 class="text-lg font-medium self-center font-primary"> </h1> <button class="self-center"><!></button></div> <div class="px-5 pb-4"><form><div class="flex justify-between mb-0.5"><label for="webpage-url"> </label></div> <input id="webpage-url" type="text" autocomplete="off" required/> <div class="flex justify-end gap-2 pt-3 bg-gray-50 dark:bg-gray-900/50"><button class="px-3.5 py-1.5 text-sm font-medium bg-black hover:bg-gray-800 text-white dark:bg-white dark:text-black dark:hover:bg-gray-200 transition rounded-full" type="submit"> </button></div></form></div></div>`);
function AttachWebpageModal($$anchor, $$props) {
  push($$props, false);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const $settings = () => store_get(settings, "$settings", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const i18n = getContext("i18n");
  let show2 = prop($$props, "show", 12, false);
  let onSubmit = prop($$props, "onSubmit", 8);
  let url = mutable_source("");
  const submitHandler = () => {
    if (isValidHttpUrl(get(url))) {
      onSubmit()({
        type: isYoutubeUrl(get(url)) ? "youtube" : "web",
        data: get(url)
      });
      show2(false);
      set(url, "");
    } else {
      toast.error($i18n().t("Please enter a valid URL."));
    }
  };
  init();
  Modal($$anchor, {
    size: "sm",
    get show() {
      return show2();
    },
    set show($$value) {
      show2($$value);
    },
    children: ($$anchor2, $$slotProps) => {
      var div = root_1$c();
      var div_1 = child(div);
      var h1 = child(div_1);
      var text2 = child(h1, true);
      reset(h1);
      var button = sibling(h1, 2);
      var node = child(button);
      XMark(node, { className: "size-5" });
      reset(button);
      reset(div_1);
      var div_2 = sibling(div_1, 2);
      var form = child(div_2);
      var div_3 = child(form);
      var label = child(div_3);
      var text_1 = child(label, true);
      reset(label);
      reset(div_3);
      var input = sibling(div_3, 2);
      remove_input_defaults(input);
      set_attribute(input, "placeholder", "https://example.com");
      var div_4 = sibling(input, 2);
      var button_1 = child(div_4);
      var text_2 = child(button_1, true);
      reset(button_1);
      reset(div_4);
      reset(form);
      reset(div_2);
      reset(div);
      template_effect(
        ($0, $1, $2, $3) => {
          set_text(text2, $0);
          set_attribute(button, "aria-label", $1);
          set_class(label, 1, ($settings(), untrack(() => {
            var _a;
            return `text-xs ${((_a = $settings()) == null ? void 0 : _a.highContrastMode) ?? false ? "text-gray-800 dark:text-gray-100" : "text-gray-500"}`;
          })));
          set_text(text_1, $2);
          set_class(input, 1, ($settings(), untrack(() => {
            var _a;
            return `w-full flex-1 text-sm bg-transparent ${((_a = $settings()) == null ? void 0 : _a.highContrastMode) ?? false ? "placeholder:text-gray-700 dark:placeholder:text-gray-100" : "outline-hidden placeholder:text-gray-300 dark:placeholder:text-gray-700"}`;
          })));
          set_text(text_2, $3);
        },
        [
          () => ($i18n(), untrack(() => $i18n().t("Attach Webpage"))),
          () => ($i18n(), untrack(() => $i18n().t("Close modal"))),
          () => ($i18n(), untrack(() => $i18n().t("Webpage URL"))),
          () => ($i18n(), untrack(() => $i18n().t("Add")))
        ]
      );
      event("click", button, () => {
        show2(false);
      });
      bind_value(input, () => get(url), ($$value) => set(url, $$value));
      event("submit", form, (e) => {
        e.preventDefault();
        submitHandler();
      });
      append($$anchor2, div);
    },
    $$slots: { default: true },
    $$legacy: true
  });
  pop();
  $$cleanup();
}
var root_7$a = from_html(`<!> <div class="line-clamp-1"> </div>`, 1);
var root_9$4 = from_html(`<!> <div class=" line-clamp-1"> </div>`, 1);
var root_11$8 = from_html(`<!> <div class="line-clamp-1"> </div>`, 1);
var root_13$6 = from_html(`<button><!> <div class="flex items-center w-full justify-between"><div class=" line-clamp-1"> </div> <div class="text-gray-500"><!></div></div></button>`);
var root_15$5 = from_html(`<button><!> <div class="flex items-center w-full justify-between"><div class=" line-clamp-1"> </div> <div class="text-gray-500"><!></div></div></button>`);
var root_17$5 = from_html(`<button><!> <div class="flex items-center w-full justify-between"><div class=" line-clamp-1"> </div> <div class="text-gray-500"><!></div></div></button>`);
var root_20$2 = from_html(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 87.3 78" class="w-4"><path d="m6.6 66.85 3.85 6.65c.8 1.4 1.95 2.5 3.3 3.3l13.75-23.8h-27.5c0 1.55.4 3.1 1.2 4.5z" fill="#0066da"></path><path d="m43.65 25-13.75-23.8c-1.35.8-2.5 1.9-3.3 3.3l-25.4 44a9.06 9.06 0 0 0 -1.2 4.5h27.5z" fill="#00ac47"></path><path d="m73.55 76.8c1.35-.8 2.5-1.9 3.3-3.3l1.6-2.75 7.65-13.25c.8-1.4 1.2-2.95 1.2-4.5h-27.502l5.852 11.5z" fill="#ea4335"></path><path d="m43.65 25 13.75-23.8c-1.35-.8-2.9-1.2-4.5-1.2h-18.5c-1.6 0-3.15.45-4.5 1.2z" fill="#00832d"></path><path d="m59.8 53h-32.3l-13.75 23.8c1.35.8 2.9 1.2 4.5 1.2h50.8c1.6 0 3.15-.45 4.5-1.2z" fill="#2684fc"></path><path d="m73.4 26.5-12.7-22c-.8-1.4-1.95-2.5-3.3-3.3l-13.75 23.8 16.15 28h27.45c0-1.55-.4-3.1-1.2-4.5z" fill="#ffba00"></path></svg> <div class="line-clamp-1"> </div>`, 1);
var root_21$3 = from_html(`<button><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" class="size-4" fill="none"><mask id="mask0_87_7796" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="6" width="32" height="20"><path d="M7.82979 26C3.50549 26 0 22.5675 0 18.3333C0 14.1921 3.35322 10.8179 7.54613 10.6716C9.27535 7.87166 12.4144 6 16 6C20.6308 6 24.5169 9.12183 25.5829 13.3335C29.1316 13.3603 32 16.1855 32 19.6667C32 23.0527 29 26 25.8723 25.9914L7.82979 26Z" fill="#C4C4C4"></path></mask><g mask="url(#mask0_87_7796)"><path d="M7.83017 26.0001C5.37824 26.0001 3.18957 24.8966 1.75391 23.1691L18.0429 16.3335L30.7089 23.4647C29.5926 24.9211 27.9066 26.0001 26.0004 25.9915C23.1254 26.0001 12.0629 26.0001 7.83017 26.0001Z" fill="url(#paint0_linear_87_7796)"></path><path d="M25.5785 13.3149L18.043 16.3334L30.709 23.4647C31.5199 22.4065 32.0004 21.0916 32.0004 19.6669C32.0004 16.1857 29.1321 13.3605 25.5833 13.3337C25.5817 13.3274 25.5801 13.3212 25.5785 13.3149Z" fill="url(#paint1_linear_87_7796)"></path><path d="M7.06445 10.7028L18.0423 16.3333L25.5779 13.3148C24.5051 9.11261 20.6237 6 15.9997 6C12.4141 6 9.27508 7.87166 7.54586 10.6716C7.3841 10.6773 7.22358 10.6877 7.06445 10.7028Z" fill="url(#paint2_linear_87_7796)"></path><path d="M1.7535 23.1687L18.0425 16.3331L7.06471 10.7026C3.09947 11.0792 0 14.3517 0 18.3331C0 20.1665 0.657197 21.8495 1.7535 23.1687Z" fill="url(#paint3_linear_87_7796)"></path></g><defs><linearGradient id="paint0_linear_87_7796" x1="4.42591" y1="24.6668" x2="27.2309" y2="23.2764" gradientUnits="userSpaceOnUse"><stop stop-color="#2086B8"></stop><stop offset="1" stop-color="#46D3F6"></stop></linearGradient><linearGradient id="paint1_linear_87_7796" x1="23.8302" y1="19.6668" x2="30.2108" y2="15.2082" gradientUnits="userSpaceOnUse"><stop stop-color="#1694DB"></stop><stop offset="1" stop-color="#62C3FE"></stop></linearGradient><linearGradient id="paint2_linear_87_7796" x1="8.51037" y1="7.33333" x2="23.3335" y2="15.9348" gradientUnits="userSpaceOnUse"><stop stop-color="#0D3D78"></stop><stop offset="1" stop-color="#063B83"></stop></linearGradient><linearGradient id="paint3_linear_87_7796" x1="-0.340429" y1="19.9998" x2="14.5634" y2="14.4649" gradientUnits="userSpaceOnUse"><stop stop-color="#16589B"></stop><stop offset="1" stop-color="#1464B7"></stop></linearGradient></defs></svg> <div class="flex items-center w-full justify-between"><div class=" line-clamp-1"> </div> <div class="text-gray-500"><!></div></div></button>`);
var root_18$2 = from_html(`<!> <!>`, 1);
var root_5$a = from_html(`<div><!> <!> <!> <!> <!> <!> <!></div>`);
var root_23$2 = from_html(`<div><button class="flex w-full justify-between gap-2 items-center px-3 py-1.5 text-sm cursor-pointer rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50"><!> <div class="flex items-center w-full justify-between"><div> </div></div></button> <!></div>`);
var root_25$2 = from_html(`<div><button class="flex w-full justify-between gap-2 items-center px-3 py-1.5 text-sm cursor-pointer rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50"><!> <div class="flex items-center w-full justify-between"><div> </div></div></button> <!></div>`);
var root_27$1 = from_html(`<div><button class="flex w-full justify-between gap-2 items-center px-3 py-1.5 text-sm cursor-pointer rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50"><!> <div class="flex items-center w-full justify-between"><div> </div></div></button> <!></div>`);
var root_31 = from_html(`<div class="flex flex-col"><div class="line-clamp-1"> </div></div>`);
var root_33$1 = from_html(`<div class="flex flex-col"><div class="line-clamp-1"> </div> <div class="text-xs text-gray-500"> </div></div>`);
var root_29$1 = from_html(`<div><button class="flex w-full justify-between gap-2 items-center px-3 py-1.5 text-sm cursor-pointer rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50"><!> <div class="flex items-center w-full justify-between"><div> </div></div></button> <!> <!></div>`);
var root_3$c = from_html(`<div slot="content"><!></div>`);
var root$m = from_html(`<!> <input id="camera-input" type="file" accept="image/*" capture="environment" style="display: none;"/> <!>`, 1);
function InputMenu($$anchor, $$props) {
  push($$props, false);
  const $user = () => store_get(user, "$user", $$stores);
  const $knowledge = () => store_get(knowledge, "$knowledge", $$stores);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const $config = () => store_get(config, "$config", $$stores);
  const $chats = () => store_get(chats, "$chats", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const i18n = getContext("i18n");
  let files = prop($$props, "files", 28, () => []);
  let selectedModels = prop($$props, "selectedModels", 24, () => []);
  let fileUploadCapableModels = prop($$props, "fileUploadCapableModels", 24, () => []);
  let screenCaptureHandler = prop($$props, "screenCaptureHandler", 8);
  let uploadFilesHandler = prop($$props, "uploadFilesHandler", 8);
  let inputFilesHandler = prop($$props, "inputFilesHandler", 8);
  let uploadGoogleDriveHandler = prop($$props, "uploadGoogleDriveHandler", 8);
  let uploadOneDriveHandler = prop($$props, "uploadOneDriveHandler", 8);
  let onUpload = prop($$props, "onUpload", 8);
  let onClose = prop($$props, "onClose", 8);
  let show2 = mutable_source(false);
  let tab = mutable_source("");
  let showAttachWebpageModal = mutable_source(false);
  let fileUploadEnabled = mutable_source(true);
  const detectMobile = () => {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    return /android|iphone|ipad|ipod|windows phone/i.test(userAgent);
  };
  const handleFileChange = (event2) => {
    var _a;
    const inputFiles = Array.from((_a = event2.target) == null ? void 0 : _a.files);
    if (inputFiles && inputFiles.length > 0) {
      console.log(inputFiles);
      inputFilesHandler()(inputFiles);
    }
  };
  const init$1 = async () => {
    if ($knowledge() === null) {
      await knowledge.set(await getKnowledgeBases(localStorage.token));
    }
  };
  const onSelect = (item) => {
    if (files().find((f) => f.id === item.id)) {
      return;
    }
    files([...files(), { ...item, status: "processed" }]);
    set(show2, false);
  };
  legacy_pre_effect(
    () => (deep_read_state(fileUploadCapableModels()), deep_read_state(selectedModels()), $user()),
    () => {
      var _a, _b, _c, _d;
      set(fileUploadEnabled, fileUploadCapableModels().length === selectedModels().length && (((_a = $user()) == null ? void 0 : _a.role) === "admin" || ((_d = (_c = (_b = $user()) == null ? void 0 : _b.permissions) == null ? void 0 : _c.chat) == null ? void 0 : _d.file_upload)));
    }
  );
  legacy_pre_effect(() => (get(fileUploadEnabled), deep_read_state(files())), () => {
    if (!get(fileUploadEnabled) && files().length > 0) {
      files([]);
    }
  });
  legacy_pre_effect(() => get(show2), () => {
    if (get(show2)) {
      init$1();
    }
  });
  legacy_pre_effect_reset();
  init();
  var fragment = root$m();
  var node = first_child(fragment);
  AttachWebpageModal(node, {
    onSubmit: (e) => {
      onUpload()(e);
    },
    get show() {
      return get(showAttachWebpageModal);
    },
    set show($$value) {
      set(showAttachWebpageModal, $$value);
    },
    $$legacy: true
  });
  var input = sibling(node, 2);
  var node_1 = sibling(input, 2);
  Dropdown(node_1, {
    get show() {
      return get(show2);
    },
    set show($$value) {
      set(show2, $$value);
    },
    $$events: {
      change: (e) => {
        if (e.detail === false) {
          onClose()();
        }
      }
    },
    children: ($$anchor2, $$slotProps) => {
      {
        let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("More"))));
        Tooltip($$anchor2, {
          get content() {
            return get($0);
          },
          children: ($$anchor3, $$slotProps2) => {
            var fragment_2 = comment();
            var node_2 = first_child(fragment_2);
            slot(node_2, $$props, "default", {}, null);
            append($$anchor3, fragment_2);
          },
          $$slots: { default: true }
        });
      }
    },
    $$slots: {
      default: true,
      content: ($$anchor2, $$slotProps) => {
        var div = root_3$c();
        var node_3 = child(div);
        Menu_content(node_3, {
          class: "w-full max-w-70 rounded-2xl px-1 py-1  border border-gray-100  dark:border-gray-800 z-50 bg-white dark:bg-gray-850 dark:text-white shadow-lg max-h-72 overflow-y-auto overflow-x-hidden scrollbar-thin transition",
          sideOffset: 4,
          alignOffset: -6,
          side: "bottom",
          align: "start",
          get transition() {
            return flyAndScale;
          },
          children: ($$anchor3, $$slotProps2) => {
            var fragment_3 = comment();
            var node_4 = first_child(fragment_3);
            {
              var consequent_6 = ($$anchor4) => {
                var div_1 = root_5$a();
                var node_5 = child(div_1);
                {
                  let $0 = derived_safe_equal(() => (deep_read_state(fileUploadCapableModels()), deep_read_state(selectedModels()), $i18n(), get(fileUploadEnabled), untrack(() => fileUploadCapableModels().length !== selectedModels().length ? $i18n().t("Model(s) do not support file upload") : !get(fileUploadEnabled) ? $i18n().t("You do not have permission to upload files.") : "")));
                  Tooltip(node_5, {
                    get content() {
                      return get($0);
                    },
                    className: "w-full",
                    children: ($$anchor5, $$slotProps3) => {
                      {
                        let $02 = derived_safe_equal(() => !get(fileUploadEnabled) ? "opacity-50" : "");
                        Menu_item($$anchor5, {
                          get class() {
                            return `flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-xl ${get($02) ?? ""}`;
                          },
                          $$events: {
                            click: () => {
                              if (get(fileUploadEnabled)) {
                                uploadFilesHandler()();
                              }
                            }
                          },
                          children: ($$anchor6, $$slotProps4) => {
                            var fragment_5 = root_7$a();
                            var node_6 = first_child(fragment_5);
                            Clip(node_6, {});
                            var div_2 = sibling(node_6, 2);
                            var text2 = child(div_2, true);
                            reset(div_2);
                            template_effect(($03) => set_text(text2, $03), [() => ($i18n(), untrack(() => $i18n().t("Upload Files")))]);
                            append($$anchor6, fragment_5);
                          },
                          $$slots: { default: true }
                        });
                      }
                    },
                    $$slots: { default: true }
                  });
                }
                var node_7 = sibling(node_5, 2);
                {
                  let $0 = derived_safe_equal(() => (deep_read_state(fileUploadCapableModels()), deep_read_state(selectedModels()), $i18n(), get(fileUploadEnabled), untrack(() => fileUploadCapableModels().length !== selectedModels().length ? $i18n().t("Model(s) do not support file upload") : !get(fileUploadEnabled) ? $i18n().t("You do not have permission to upload files.") : "")));
                  Tooltip(node_7, {
                    get content() {
                      return get($0);
                    },
                    className: "w-full",
                    children: ($$anchor5, $$slotProps3) => {
                      {
                        let $02 = derived_safe_equal(() => !get(fileUploadEnabled) ? "opacity-50" : "");
                        Menu_item($$anchor5, {
                          get class() {
                            return `flex gap-2 items-center px-3 py-1.5 text-sm  cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50  rounded-xl ${get($02) ?? ""}`;
                          },
                          $$events: {
                            click: () => {
                              if (get(fileUploadEnabled)) {
                                if (!detectMobile()) {
                                  screenCaptureHandler()();
                                } else {
                                  const cameraInputElement = document.getElementById("camera-input");
                                  if (cameraInputElement) {
                                    cameraInputElement.click();
                                  }
                                }
                              }
                            }
                          },
                          children: ($$anchor6, $$slotProps4) => {
                            var fragment_7 = root_9$4();
                            var node_8 = first_child(fragment_7);
                            Camera(node_8, {});
                            var div_3 = sibling(node_8, 2);
                            var text_1 = child(div_3, true);
                            reset(div_3);
                            template_effect(($03) => set_text(text_1, $03), [() => ($i18n(), untrack(() => $i18n().t("Capture")))]);
                            append($$anchor6, fragment_7);
                          },
                          $$slots: { default: true }
                        });
                      }
                    },
                    $$slots: { default: true }
                  });
                }
                var node_9 = sibling(node_7, 2);
                {
                  let $0 = derived_safe_equal(() => (deep_read_state(fileUploadCapableModels()), deep_read_state(selectedModels()), $i18n(), get(fileUploadEnabled), untrack(() => fileUploadCapableModels().length !== selectedModels().length ? $i18n().t("Model(s) do not support file upload") : !get(fileUploadEnabled) ? $i18n().t("You do not have permission to upload files.") : "")));
                  Tooltip(node_9, {
                    get content() {
                      return get($0);
                    },
                    className: "w-full",
                    children: ($$anchor5, $$slotProps3) => {
                      {
                        let $02 = derived_safe_equal(() => !get(fileUploadEnabled) ? "opacity-50" : "");
                        Menu_item($$anchor5, {
                          get class() {
                            return `flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl ${get($02) ?? ""}`;
                          },
                          $$events: {
                            click: () => {
                              if (get(fileUploadEnabled)) {
                                set(showAttachWebpageModal, true);
                              }
                            }
                          },
                          children: ($$anchor6, $$slotProps4) => {
                            var fragment_9 = root_11$8();
                            var node_10 = first_child(fragment_9);
                            GlobeAlt(node_10, {});
                            var div_4 = sibling(node_10, 2);
                            var text_2 = child(div_4, true);
                            reset(div_4);
                            template_effect(($03) => set_text(text_2, $03), [
                              () => ($i18n(), untrack(() => $i18n().t("Attach Webpage")))
                            ]);
                            append($$anchor6, fragment_9);
                          },
                          $$slots: { default: true }
                        });
                      }
                    },
                    $$slots: { default: true }
                  });
                }
                var node_11 = sibling(node_9, 2);
                {
                  var consequent = ($$anchor5) => {
                    {
                      let $0 = derived_safe_equal(() => (deep_read_state(fileUploadCapableModels()), deep_read_state(selectedModels()), $i18n(), get(fileUploadEnabled), untrack(() => fileUploadCapableModels().length !== selectedModels().length ? $i18n().t("Model(s) do not support file upload") : !get(fileUploadEnabled) ? $i18n().t("You do not have permission to upload files.") : "")));
                      Tooltip($$anchor5, {
                        get content() {
                          return get($0);
                        },
                        className: "w-full",
                        children: ($$anchor6, $$slotProps3) => {
                          var button = root_13$6();
                          var node_12 = child(button);
                          PageEdit(node_12, {});
                          var div_5 = sibling(node_12, 2);
                          var div_6 = child(div_5);
                          var text_3 = child(div_6, true);
                          reset(div_6);
                          var div_7 = sibling(div_6, 2);
                          var node_13 = child(div_7);
                          ChevronRight(node_13, {});
                          reset(div_7);
                          reset(div_5);
                          reset(button);
                          template_effect(
                            ($02) => {
                              set_class(button, 1, `flex gap-2 w-full items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-xl ${!get(fileUploadEnabled) ? "opacity-50" : ""}`);
                              set_text(text_3, $02);
                            },
                            [() => ($i18n(), untrack(() => $i18n().t("Attach Notes")))]
                          );
                          event("click", button, () => {
                            set(tab, "notes");
                          });
                          append($$anchor6, button);
                        },
                        $$slots: { default: true }
                      });
                    }
                  };
                  if_block(node_11, ($$render) => {
                    if ($config(), untrack(() => {
                      var _a, _b;
                      return ((_b = (_a = $config()) == null ? void 0 : _a.features) == null ? void 0 : _b.enable_notes) ?? false;
                    })) $$render(consequent);
                  });
                }
                var node_14 = sibling(node_11, 2);
                {
                  var consequent_1 = ($$anchor5) => {
                    {
                      let $0 = derived_safe_equal(() => (deep_read_state(fileUploadCapableModels()), deep_read_state(selectedModels()), $i18n(), get(fileUploadEnabled), untrack(() => fileUploadCapableModels().length !== selectedModels().length ? $i18n().t("Model(s) do not support file upload") : !get(fileUploadEnabled) ? $i18n().t("You do not have permission to upload files.") : "")));
                      Tooltip($$anchor5, {
                        get content() {
                          return get($0);
                        },
                        className: "w-full",
                        children: ($$anchor6, $$slotProps3) => {
                          var button_1 = root_15$5();
                          var node_15 = child(button_1);
                          Database(node_15, {});
                          var div_8 = sibling(node_15, 2);
                          var div_9 = child(div_8);
                          var text_4 = child(div_9, true);
                          reset(div_9);
                          var div_10 = sibling(div_9, 2);
                          var node_16 = child(div_10);
                          ChevronRight(node_16, {});
                          reset(div_10);
                          reset(div_8);
                          reset(button_1);
                          template_effect(
                            ($02) => {
                              set_class(button_1, 1, `flex gap-2 w-full items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-xl ${!get(fileUploadEnabled) ? "opacity-50" : ""}`);
                              set_text(text_4, $02);
                            },
                            [
                              () => ($i18n(), untrack(() => $i18n().t("Attach Knowledge")))
                            ]
                          );
                          event("click", button_1, () => {
                            set(tab, "knowledge");
                          });
                          append($$anchor6, button_1);
                        },
                        $$slots: { default: true }
                      });
                    }
                  };
                  if_block(node_14, ($$render) => {
                    if ($knowledge(), untrack(() => ($knowledge() ?? []).length > 0)) $$render(consequent_1);
                  });
                }
                var node_17 = sibling(node_14, 2);
                {
                  var consequent_2 = ($$anchor5) => {
                    {
                      let $0 = derived_safe_equal(() => (deep_read_state(fileUploadCapableModels()), deep_read_state(selectedModels()), $i18n(), get(fileUploadEnabled), untrack(() => fileUploadCapableModels().length !== selectedModels().length ? $i18n().t("Model(s) do not support file upload") : !get(fileUploadEnabled) ? $i18n().t("You do not have permission to upload files.") : "")));
                      Tooltip($$anchor5, {
                        get content() {
                          return get($0);
                        },
                        className: "w-full",
                        children: ($$anchor6, $$slotProps3) => {
                          var button_2 = root_17$5();
                          var node_18 = child(button_2);
                          ClockRotateRight(node_18, {});
                          var div_11 = sibling(node_18, 2);
                          var div_12 = child(div_11);
                          var text_5 = child(div_12, true);
                          reset(div_12);
                          var div_13 = sibling(div_12, 2);
                          var node_19 = child(div_13);
                          ChevronRight(node_19, {});
                          reset(div_13);
                          reset(div_11);
                          reset(button_2);
                          template_effect(
                            ($02) => {
                              set_class(button_2, 1, `flex gap-2 w-full items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-xl ${!get(fileUploadEnabled) ? "opacity-50" : ""}`);
                              set_text(text_5, $02);
                            },
                            [
                              () => ($i18n(), untrack(() => $i18n().t("Reference Chats")))
                            ]
                          );
                          event("click", button_2, () => {
                            set(tab, "chats");
                          });
                          append($$anchor6, button_2);
                        },
                        $$slots: { default: true }
                      });
                    }
                  };
                  if_block(node_17, ($$render) => {
                    if ($chats(), untrack(() => ($chats() ?? []).length > 0)) $$render(consequent_2);
                  });
                }
                var node_20 = sibling(node_17, 2);
                {
                  var consequent_5 = ($$anchor5) => {
                    var fragment_13 = root_18$2();
                    var node_21 = first_child(fragment_13);
                    {
                      var consequent_3 = ($$anchor6) => {
                        Menu_item($$anchor6, {
                          class: "flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-xl",
                          $$events: {
                            click: () => {
                              uploadGoogleDriveHandler()();
                            }
                          },
                          children: ($$anchor7, $$slotProps3) => {
                            var fragment_15 = root_20$2();
                            var div_14 = sibling(first_child(fragment_15), 2);
                            var text_6 = child(div_14, true);
                            reset(div_14);
                            template_effect(($0) => set_text(text_6, $0), [() => ($i18n(), untrack(() => $i18n().t("Google Drive")))]);
                            append($$anchor7, fragment_15);
                          },
                          $$slots: { default: true }
                        });
                      };
                      if_block(node_21, ($$render) => {
                        if ($config(), untrack(() => {
                          var _a, _b;
                          return (_b = (_a = $config()) == null ? void 0 : _a.features) == null ? void 0 : _b.enable_google_drive_integration;
                        })) $$render(consequent_3);
                      });
                    }
                    var node_22 = sibling(node_21, 2);
                    {
                      var consequent_4 = ($$anchor6) => {
                        var button_3 = root_21$3();
                        var div_15 = sibling(child(button_3), 2);
                        var div_16 = child(div_15);
                        var text_7 = child(div_16, true);
                        reset(div_16);
                        var div_17 = sibling(div_16, 2);
                        var node_23 = child(div_17);
                        ChevronRight(node_23, {});
                        reset(div_17);
                        reset(div_15);
                        reset(button_3);
                        template_effect(
                          ($0) => {
                            set_class(button_3, 1, `flex gap-2 w-full items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-xl ${!get(fileUploadEnabled) ? "opacity-50" : ""}`);
                            set_text(text_7, $0);
                          },
                          [
                            () => ($i18n(), untrack(() => $i18n().t("Microsoft OneDrive")))
                          ]
                        );
                        event("click", button_3, () => {
                          set(tab, "microsoft_onedrive");
                        });
                        append($$anchor6, button_3);
                      };
                      if_block(node_22, ($$render) => {
                        if ($config(), untrack(() => {
                          var _a, _b, _c, _d, _e, _f;
                          return ((_b = (_a = $config()) == null ? void 0 : _a.features) == null ? void 0 : _b.enable_onedrive_integration) && (((_d = (_c = $config()) == null ? void 0 : _c.features) == null ? void 0 : _d.enable_onedrive_personal) || ((_f = (_e = $config()) == null ? void 0 : _e.features) == null ? void 0 : _f.enable_onedrive_business));
                        })) $$render(consequent_4);
                      });
                    }
                    append($$anchor5, fragment_13);
                  };
                  if_block(node_20, ($$render) => {
                    if (get(fileUploadEnabled)) $$render(consequent_5);
                  });
                }
                reset(div_1);
                transition(1, div_1, () => fly, () => ({ x: -20, duration: 150 }));
                append($$anchor4, div_1);
              };
              var alternate_3 = ($$anchor4) => {
                var fragment_16 = comment();
                var node_24 = first_child(fragment_16);
                {
                  var consequent_7 = ($$anchor5) => {
                    var div_18 = root_23$2();
                    var button_4 = child(div_18);
                    var node_25 = child(button_4);
                    ChevronLeft(node_25, {});
                    var div_19 = sibling(node_25, 2);
                    var div_20 = child(div_19);
                    var text_8 = child(div_20, true);
                    reset(div_20);
                    reset(div_19);
                    reset(button_4);
                    var node_26 = sibling(button_4, 2);
                    Knowledge(node_26, { onSelect });
                    reset(div_18);
                    template_effect(($0) => set_text(text_8, $0), [() => ($i18n(), untrack(() => $i18n().t("Knowledge")))]);
                    event("click", button_4, () => {
                      set(tab, "");
                    });
                    transition(1, div_18, () => fly, () => ({ x: 20, duration: 150 }));
                    append($$anchor5, div_18);
                  };
                  var alternate_2 = ($$anchor5) => {
                    var fragment_17 = comment();
                    var node_27 = first_child(fragment_17);
                    {
                      var consequent_8 = ($$anchor6) => {
                        var div_21 = root_25$2();
                        var button_5 = child(div_21);
                        var node_28 = child(button_5);
                        ChevronLeft(node_28, {});
                        var div_22 = sibling(node_28, 2);
                        var div_23 = child(div_22);
                        var text_9 = child(div_23, true);
                        reset(div_23);
                        reset(div_22);
                        reset(button_5);
                        var node_29 = sibling(button_5, 2);
                        Notes(node_29, { onSelect });
                        reset(div_21);
                        template_effect(($0) => set_text(text_9, $0), [() => ($i18n(), untrack(() => $i18n().t("Notes")))]);
                        event("click", button_5, () => {
                          set(tab, "");
                        });
                        transition(1, div_21, () => fly, () => ({ x: 20, duration: 150 }));
                        append($$anchor6, div_21);
                      };
                      var alternate_1 = ($$anchor6) => {
                        var fragment_18 = comment();
                        var node_30 = first_child(fragment_18);
                        {
                          var consequent_9 = ($$anchor7) => {
                            var div_24 = root_27$1();
                            var button_6 = child(div_24);
                            var node_31 = child(button_6);
                            ChevronLeft(node_31, {});
                            var div_25 = sibling(node_31, 2);
                            var div_26 = child(div_25);
                            var text_10 = child(div_26, true);
                            reset(div_26);
                            reset(div_25);
                            reset(button_6);
                            var node_32 = sibling(button_6, 2);
                            Chats(node_32, { onSelect });
                            reset(div_24);
                            template_effect(($0) => set_text(text_10, $0), [() => ($i18n(), untrack(() => $i18n().t("Chats")))]);
                            event("click", button_6, () => {
                              set(tab, "");
                            });
                            transition(1, div_24, () => fly, () => ({ x: 20, duration: 150 }));
                            append($$anchor7, div_24);
                          };
                          var alternate = ($$anchor7) => {
                            var fragment_19 = comment();
                            var node_33 = first_child(fragment_19);
                            {
                              var consequent_12 = ($$anchor8) => {
                                var div_27 = root_29$1();
                                var button_7 = child(div_27);
                                var node_34 = child(button_7);
                                ChevronLeft(node_34, {});
                                var div_28 = sibling(node_34, 2);
                                var div_29 = child(div_28);
                                var text_11 = child(div_29, true);
                                reset(div_29);
                                reset(div_28);
                                reset(button_7);
                                var node_35 = sibling(button_7, 2);
                                {
                                  var consequent_10 = ($$anchor9) => {
                                    Menu_item($$anchor9, {
                                      class: "flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-xl text-left",
                                      $$events: {
                                        click: () => {
                                          uploadOneDriveHandler()("personal");
                                        }
                                      },
                                      children: ($$anchor10, $$slotProps3) => {
                                        var div_30 = root_31();
                                        var div_31 = child(div_30);
                                        var text_12 = child(div_31, true);
                                        reset(div_31);
                                        reset(div_30);
                                        template_effect(($0) => set_text(text_12, $0), [
                                          () => ($i18n(), untrack(() => $i18n().t("Microsoft OneDrive (personal)")))
                                        ]);
                                        append($$anchor10, div_30);
                                      },
                                      $$slots: { default: true }
                                    });
                                  };
                                  if_block(node_35, ($$render) => {
                                    if ($config(), untrack(() => {
                                      var _a, _b;
                                      return (_b = (_a = $config()) == null ? void 0 : _a.features) == null ? void 0 : _b.enable_onedrive_personal;
                                    })) $$render(consequent_10);
                                  });
                                }
                                var node_36 = sibling(node_35, 2);
                                {
                                  var consequent_11 = ($$anchor9) => {
                                    Menu_item($$anchor9, {
                                      class: "flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-xl text-left",
                                      $$events: {
                                        click: () => {
                                          uploadOneDriveHandler()("organizations");
                                        }
                                      },
                                      children: ($$anchor10, $$slotProps3) => {
                                        var div_32 = root_33$1();
                                        var div_33 = child(div_32);
                                        var text_13 = child(div_33, true);
                                        reset(div_33);
                                        var div_34 = sibling(div_33, 2);
                                        var text_14 = child(div_34, true);
                                        reset(div_34);
                                        reset(div_32);
                                        template_effect(
                                          ($0, $1) => {
                                            set_text(text_13, $0);
                                            set_text(text_14, $1);
                                          },
                                          [
                                            () => ($i18n(), untrack(() => $i18n().t("Microsoft OneDrive (work/school)"))),
                                            () => ($i18n(), untrack(() => $i18n().t("Includes SharePoint")))
                                          ]
                                        );
                                        append($$anchor10, div_32);
                                      },
                                      $$slots: { default: true }
                                    });
                                  };
                                  if_block(node_36, ($$render) => {
                                    if ($config(), untrack(() => {
                                      var _a, _b;
                                      return (_b = (_a = $config()) == null ? void 0 : _a.features) == null ? void 0 : _b.enable_onedrive_business;
                                    })) $$render(consequent_11);
                                  });
                                }
                                reset(div_27);
                                template_effect(($0) => set_text(text_11, $0), [
                                  () => ($i18n(), untrack(() => $i18n().t("Microsoft OneDrive")))
                                ]);
                                event("click", button_7, () => {
                                  set(tab, "");
                                });
                                transition(1, div_27, () => fly, () => ({ x: 20, duration: 150 }));
                                append($$anchor8, div_27);
                              };
                              if_block(
                                node_33,
                                ($$render) => {
                                  if (get(tab) === "microsoft_onedrive") $$render(consequent_12);
                                },
                                true
                              );
                            }
                            append($$anchor7, fragment_19);
                          };
                          if_block(
                            node_30,
                            ($$render) => {
                              if (get(tab) === "chats") $$render(consequent_9);
                              else $$render(alternate, false);
                            },
                            true
                          );
                        }
                        append($$anchor6, fragment_18);
                      };
                      if_block(
                        node_27,
                        ($$render) => {
                          if (get(tab) === "notes") $$render(consequent_8);
                          else $$render(alternate_1, false);
                        },
                        true
                      );
                    }
                    append($$anchor5, fragment_17);
                  };
                  if_block(
                    node_24,
                    ($$render) => {
                      if (get(tab) === "knowledge") $$render(consequent_7);
                      else $$render(alternate_2, false);
                    },
                    true
                  );
                }
                append($$anchor4, fragment_16);
              };
              if_block(node_4, ($$render) => {
                if (get(tab) === "") $$render(consequent_6);
                else $$render(alternate_3, false);
              });
            }
            append($$anchor3, fragment_3);
          },
          $$slots: { default: true }
        });
        reset(div);
        append($$anchor2, div);
      }
    },
    $$legacy: true
  });
  event("change", input, handleFileChange);
  append($$anchor, fragment);
  pop();
  $$cleanup();
}
var root_3$b = from_html(`<div class=" flex justify-between dark:text-gray-300 px-5 pb-1"><div class=" text-base font-medium self-center"> </div></div>`);
var root_6$c = from_html(`<div class="text-xs text-gray-500"> </div>`);
var root_5$9 = from_html(`<div class="truncate"><div class="text-sm font-medium dark:text-gray-100 text-gray-800 truncate"> </div> <!></div>`);
var root_2$c = from_html(`<!> <div class="px-5 pb-3 w-full flex flex-col justify-center"><div class=" text-sm dark:text-gray-300 mb-1"></div></div>`, 1);
var root_9$3 = from_html(`<div><div class="text-sm font-medium dark:text-gray-100 text-gray-800"> </div> <div class="text-xs text-gray-500"> </div> <div class="text-xs text-gray-500"> </div></div>`);
var root_11$7 = from_html(`<div class="my-1"><div class="font-medium text-gray-800 dark:text-gray-100"> </div> <div> </div></div>`);
var root_10$5 = from_html(`<div slot="content"></div>`);
var root_7$9 = from_html(`<div class=" flex justify-between dark:text-gray-300 px-5 pb-0.5"><div class=" text-base font-medium self-center"> </div></div> <div class="px-5 pb-5 w-full flex flex-col justify-center"><div class=" text-xs text-gray-600 dark:text-gray-300 mb-2"> <br/><a class="underline" href="https://github.com/open-webui/openapi-servers" target="_blank"> </a></div> <div class=" text-sm dark:text-gray-300 mb-1"></div></div>`, 1);
var root_1$b = from_html(`<div><div class=" flex justify-between dark:text-gray-300 px-5 pt-4 pb-0.5"><div class=" text-lg font-medium self-center"> </div> <button class="self-center"><!></button></div> <!> <!></div>`);
function ToolServersModal($$anchor, $$props) {
  push($$props, false);
  const $tools = () => store_get(tools, "$tools", $$stores);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const $toolServers = () => store_get(toolServers, "$toolServers", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  let show2 = prop($$props, "show", 12, false);
  let selectedToolIds = prop($$props, "selectedToolIds", 24, () => []);
  let selectedTools = mutable_source([]);
  const i18n = getContext("i18n");
  legacy_pre_effect(() => ($tools(), deep_read_state(selectedToolIds())), () => {
    set(selectedTools, ($tools() ?? []).filter((tool) => selectedToolIds().includes(tool.id)));
  });
  legacy_pre_effect_reset();
  init();
  Modal($$anchor, {
    size: "md",
    get show() {
      return show2();
    },
    set show($$value) {
      show2($$value);
    },
    children: ($$anchor2, $$slotProps) => {
      var div = root_1$b();
      var div_1 = child(div);
      var div_2 = child(div_1);
      var text2 = child(div_2, true);
      reset(div_2);
      var button = sibling(div_2, 2);
      var node = child(button);
      XMark(node, { className: "size-5" });
      reset(button);
      reset(div_1);
      var node_1 = sibling(div_1, 2);
      {
        var consequent_2 = ($$anchor3) => {
          var fragment_1 = root_2$c();
          var node_2 = first_child(fragment_1);
          {
            var consequent = ($$anchor4) => {
              var div_3 = root_3$b();
              var div_4 = child(div_3);
              var text_1 = child(div_4, true);
              reset(div_4);
              reset(div_3);
              template_effect(($0) => set_text(text_1, $0), [() => ($i18n(), untrack(() => $i18n().t("Tools")))]);
              append($$anchor4, div_3);
            };
            if_block(node_2, ($$render) => {
              if ($toolServers(), untrack(() => $toolServers().length > 0)) $$render(consequent);
            });
          }
          var div_5 = sibling(node_2, 2);
          var div_6 = child(div_5);
          each(div_6, 5, () => get(selectedTools), index, ($$anchor4, tool) => {
            Collapsible($$anchor4, {
              buttonClassName: "w-full mb-0.5",
              children: ($$anchor5, $$slotProps2) => {
                var div_7 = root_5$9();
                var div_8 = child(div_7);
                var text_2 = child(div_8, true);
                reset(div_8);
                var node_3 = sibling(div_8, 2);
                {
                  var consequent_1 = ($$anchor6) => {
                    var div_9 = root_6$c();
                    var text_3 = child(div_9, true);
                    reset(div_9);
                    template_effect(() => set_text(text_3, (get(tool), untrack(() => {
                      var _a, _b;
                      return (_b = (_a = get(tool)) == null ? void 0 : _a.meta) == null ? void 0 : _b.description;
                    }))));
                    append($$anchor6, div_9);
                  };
                  if_block(node_3, ($$render) => {
                    if (get(tool), untrack(() => {
                      var _a, _b;
                      return (_b = (_a = get(tool)) == null ? void 0 : _a.meta) == null ? void 0 : _b.description;
                    })) $$render(consequent_1);
                  });
                }
                reset(div_7);
                template_effect(() => set_text(text_2, (get(tool), untrack(() => {
                  var _a;
                  return (_a = get(tool)) == null ? void 0 : _a.name;
                }))));
                append($$anchor5, div_7);
              },
              $$slots: { default: true }
            });
          });
          reset(div_6);
          reset(div_5);
          append($$anchor3, fragment_1);
        };
        if_block(node_1, ($$render) => {
          if (get(selectedTools), untrack(() => get(selectedTools).length > 0)) $$render(consequent_2);
        });
      }
      var node_4 = sibling(node_1, 2);
      {
        var consequent_3 = ($$anchor3) => {
          var fragment_3 = root_7$9();
          var div_10 = first_child(fragment_3);
          var div_11 = child(div_10);
          var text_4 = child(div_11, true);
          reset(div_11);
          reset(div_10);
          var div_12 = sibling(div_10, 2);
          var div_13 = child(div_12);
          var text_5 = child(div_13);
          var a = sibling(text_5, 2);
          var text_6 = child(a, true);
          reset(a);
          reset(div_13);
          var div_14 = sibling(div_13, 2);
          each(div_14, 5, $toolServers, index, ($$anchor4, toolServer) => {
            Collapsible($$anchor4, {
              buttonClassName: "w-full",
              chevron: true,
              children: ($$anchor5, $$slotProps2) => {
                var div_15 = root_9$3();
                var div_16 = child(div_15);
                var text_7 = child(div_16);
                reset(div_16);
                var div_17 = sibling(div_16, 2);
                var text_8 = child(div_17, true);
                reset(div_17);
                var div_18 = sibling(div_17, 2);
                var text_9 = child(div_18, true);
                reset(div_18);
                reset(div_15);
                template_effect(() => {
                  set_text(text_7, `${(get(toolServer), untrack(() => {
                    var _a, _b, _c;
                    return (_c = (_b = (_a = get(toolServer)) == null ? void 0 : _a.openapi) == null ? void 0 : _b.info) == null ? void 0 : _c.title;
                  })) ?? ""} - v${(get(toolServer), untrack(() => {
                    var _a, _b, _c;
                    return (_c = (_b = (_a = get(toolServer)) == null ? void 0 : _a.openapi) == null ? void 0 : _b.info) == null ? void 0 : _c.version;
                  })) ?? ""}`);
                  set_text(text_8, (get(toolServer), untrack(() => {
                    var _a, _b, _c;
                    return (_c = (_b = (_a = get(toolServer)) == null ? void 0 : _a.openapi) == null ? void 0 : _b.info) == null ? void 0 : _c.description;
                  })));
                  set_text(text_9, (get(toolServer), untrack(() => {
                    var _a;
                    return (_a = get(toolServer)) == null ? void 0 : _a.url;
                  })));
                });
                append($$anchor5, div_15);
              },
              $$slots: {
                default: true,
                content: ($$anchor5, $$slotProps2) => {
                  var div_19 = root_10$5();
                  each(
                    div_19,
                    5,
                    () => (get(toolServer), untrack(() => {
                      var _a;
                      return ((_a = get(toolServer)) == null ? void 0 : _a.specs) ?? [];
                    })),
                    index,
                    ($$anchor6, tool_spec) => {
                      var div_20 = root_11$7();
                      var div_21 = child(div_20);
                      var text_10 = child(div_21, true);
                      reset(div_21);
                      var div_22 = sibling(div_21, 2);
                      var text_11 = child(div_22, true);
                      reset(div_22);
                      reset(div_20);
                      template_effect(() => {
                        set_text(text_10, (get(tool_spec), untrack(() => {
                          var _a;
                          return (_a = get(tool_spec)) == null ? void 0 : _a.name;
                        })));
                        set_text(text_11, (get(tool_spec), untrack(() => {
                          var _a;
                          return (_a = get(tool_spec)) == null ? void 0 : _a.description;
                        })));
                      });
                      append($$anchor6, div_20);
                    }
                  );
                  reset(div_19);
                  append($$anchor5, div_19);
                }
              }
            });
          });
          reset(div_14);
          reset(div_12);
          template_effect(
            ($0, $1, $2) => {
              set_text(text_4, $0);
              set_text(text_5, `${$1 ?? ""} `);
              set_text(text_6, $2);
            },
            [
              () => ($i18n(), untrack(() => $i18n().t("Tool Servers"))),
              () => ($i18n(), untrack(() => $i18n().t("Open WebUI can use tools provided by any OpenAPI server."))),
              () => ($i18n(), untrack(() => $i18n().t("Learn more about OpenAPI tool servers.")))
            ]
          );
          append($$anchor3, fragment_3);
        };
        if_block(node_4, ($$render) => {
          if ($toolServers(), untrack(() => $toolServers().length > 0)) $$render(consequent_3);
        });
      }
      reset(div);
      template_effect(($0) => set_text(text2, $0), [
        () => ($i18n(), untrack(() => $i18n().t("Available Tools")))
      ]);
      event("click", button, () => {
        show2(false);
      });
      append($$anchor2, div);
    },
    $$slots: { default: true },
    $$legacy: true
  });
  pop();
  $$cleanup();
}
var root$l = from_svg(`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path d="M21 7.6V20.4C21 20.7314 20.7314 21 20.4 21H7.6C7.26863 21 7 20.7314 7 20.4V7.6C7 7.26863 7.26863 7 7.6 7H20.4C20.7314 7 21 7.26863 21 7.6Z" stroke-linecap="round" stroke-linejoin="round"></path><path d="M18 4H4.6C4.26863 4 4 4.26863 4 4.6V18" stroke-linecap="round" stroke-linejoin="round"></path><path d="M7 16.8L12.4444 15L21 18" stroke-linecap="round" stroke-linejoin="round"></path><path d="M16.5 13C15.6716 13 15 12.3284 15 11.5C15 10.6716 15.6716 10 16.5 10C17.3284 10 18 10.6716 18 11.5C18 12.3284 17.3284 13 16.5 13Z" stroke-linecap="round" stroke-linejoin="round"></path></svg>`);
function Photo($$anchor, $$props) {
  let className = prop($$props, "className", 8, "size-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "1.5");
  var svg = root$l();
  template_effect(() => {
    set_attribute(svg, "stroke-width", strokeWidth());
    set_class(svg, 0, clsx(className()));
  });
  append($$anchor, svg);
}
var root$k = from_svg(`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75a4.5 4.5 0 0 1-4.884 4.484c-1.076-.091-2.264.071-2.95.904l-7.152 8.684a2.548 2.548 0 1 1-3.586-3.586l8.684-7.152c.833-.686.995-1.874.904-2.95a4.5 4.5 0 0 1 6.336-4.486l-3.276 3.276a3.004 3.004 0 0 0 2.25 2.25l3.276-3.276c.256.565.398 1.192.398 1.852Z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M4.867 19.125h.008v.008h-.008v-.008Z"></path></svg>`);
function Wrench($$anchor, $$props) {
  let className = prop($$props, "className", 8, "w-4 h-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "1.5");
  var svg = root$k();
  template_effect(() => {
    set_attribute(svg, "stroke-width", strokeWidth());
    set_class(svg, 0, clsx(className()));
  });
  append($$anchor, svg);
}
var root$j = from_svg(`<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 4L12 20" stroke-linecap="round" stroke-linejoin="round"></path><path d="M8 9L8 15" stroke-linecap="round" stroke-linejoin="round"></path><path d="M20 10L20 14" stroke-linecap="round" stroke-linejoin="round"></path><path d="M4 10L4 14" stroke-linecap="round" stroke-linejoin="round"></path><path d="M16 7L16 17" stroke-linecap="round" stroke-linejoin="round"></path></svg>`);
function Voice($$anchor, $$props) {
  let className = prop($$props, "className", 8, "w-4 h-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "1.5");
  var svg = root$j();
  template_effect(() => {
    set_attribute(svg, "stroke-width", strokeWidth());
    set_class(svg, 0, clsx(className()));
  });
  append($$anchor, svg);
}
var root$i = from_svg(`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path d="M13 16H18" stroke-linecap="round" stroke-linejoin="round"></path><path d="M6 8L10 12L6 16" stroke-linecap="round" stroke-linejoin="round"></path><path d="M2 18V6C2 4.89543 2.89543 4 4 4H20C21.1046 4 22 4.89543 22 6V18C22 19.1046 21.1046 20 20 20H4C2.89543 20 2 19.1046 2 18Z" stroke-linecap="round" stroke-linejoin="round"></path></svg>`);
function Terminal($$anchor, $$props) {
  let className = prop($$props, "className", 8, "w-4 h-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "1.5");
  var svg = root$i();
  template_effect(() => {
    set_attribute(svg, "stroke-width", strokeWidth());
    set_class(svg, 0, clsx(className()));
  });
  append($$anchor, svg);
}
var root$h = from_svg(`<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75"></path></svg>`);
function Knobs($$anchor, $$props) {
  let className = prop($$props, "className", 8, "w-4 h-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "1.5");
  var svg = root$h();
  template_effect(() => {
    set_class(svg, 0, clsx(className()));
    set_attribute(svg, "stroke-width", strokeWidth());
  });
  append($$anchor, svg);
}
var root_7$8 = from_html(`<button class="flex w-full justify-between gap-2 items-center px-3 py-1.5 text-sm cursor-pointer rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50"><!> <div class="flex items-center w-full justify-between"><div class=" line-clamp-1"> <span class="ml-0.5 text-gray-500"> </span></div> <div class="text-gray-500"><!></div></div></button>`);
var root_8$5 = from_html(`<div class="py-4"><!></div>`);
var root_12$3 = from_html(`<div class="size-4 items-center flex justify-center"><img style="fill: currentColor;"/></div>`);
var root_15$4 = from_html(`<button class="self-center w-fit text-sm text-gray-600 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 transition rounded-full" type="button"><!></button>`);
var root_14$4 = from_html(`<div class=" shrink-0"><!></div>`);
var root_11$6 = from_html(`<button class="flex w-full justify-between gap-2 items-center px-3 py-1.5 text-sm cursor-pointer rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50"><div class="flex-1 truncate"><div class="flex flex-1 gap-2 items-center"><div class="shrink-0"><!></div> <div class=" truncate"> </div></div></div> <!> <div class=" shrink-0"><!></div></button>`);
var root_17$4 = from_html(`<button class="flex w-full justify-between gap-2 items-center px-3 py-1.5 text-sm cursor-pointer rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50"><div class="flex-1 truncate"><div class="flex flex-1 gap-2 items-center"><div class="shrink-0"><!></div> <div class=" truncate"> </div></div></div> <div class=" shrink-0"><!></div></button>`);
var root_19$3 = from_html(`<button class="flex w-full justify-between gap-2 items-center px-3 py-1.5 text-sm cursor-pointer rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50"><div class="flex-1 truncate"><div class="flex flex-1 gap-2 items-center"><div class="shrink-0"><!></div> <div class=" truncate"> </div></div></div> <div class=" shrink-0"><!></div></button>`);
var root_21$2 = from_html(`<button class="flex w-full justify-between gap-2 items-center px-3 py-1.5 text-sm cursor-pointer rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50"><div class="flex-1 truncate"><div class="flex flex-1 gap-2 items-center"><div class="shrink-0"><!></div> <div class=" truncate"> </div></div></div> <div class=" shrink-0"><!></div></button>`);
var root_5$8 = from_html(`<div><!> <!> <!> <!> <!></div>`);
var root_25$1 = from_html(`<div class="absolute inset-0 opacity-50 rounded-xl cursor-pointer z-10"></div>`);
var root_26$2 = from_html(`<div class="shrink-0"><!></div>`);
var root_27 = from_html(`<div class=" truncate"> </div>`);
var root_29 = from_html(`<button class="self-center w-fit text-sm text-gray-600 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 transition rounded-full" type="button"><!></button>`);
var root_28$1 = from_html(`<div class=" shrink-0"><!></div>`);
var root_24 = from_html(`<button class="relative flex w-full justify-between gap-2 items-center px-3 py-1.5 text-sm cursor-pointer rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50"><!> <div class="flex-1 truncate"><div class="flex flex-1 gap-2 items-center"><!> <!></div></div> <!> <div class=" shrink-0"><!></div></button>`);
var root_23$1 = from_html(`<div><button class="flex w-full justify-between gap-2 items-center px-3 py-1.5 text-sm cursor-pointer rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800/50"><!> <div class="flex items-center w-full justify-between"><div> <span class="ml-0.5 text-gray-500"> </span></div></div></button> <!></div>`);
var root_3$a = from_html(`<div slot="content"><!></div>`);
function IntegrationsMenu($$anchor, $$props) {
  push($$props, false);
  const $user = () => store_get(user, "$user", $$stores);
  const $_tools = () => store_get(tools, "$_tools", $$stores);
  const $toolServers = () => store_get(toolServers, "$toolServers", $$stores);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const i18n = getContext("i18n");
  let selectedToolIds = prop($$props, "selectedToolIds", 28, () => []);
  let selectedModels = prop($$props, "selectedModels", 24, () => []);
  let fileUploadCapableModels = prop($$props, "fileUploadCapableModels", 24, () => []);
  let toggleFilters = prop($$props, "toggleFilters", 24, () => []);
  let selectedFilterIds = prop($$props, "selectedFilterIds", 28, () => []);
  let showWebSearchButton = prop($$props, "showWebSearchButton", 8, false);
  let webSearchEnabled = prop($$props, "webSearchEnabled", 12, false);
  let showImageGenerationButton = prop($$props, "showImageGenerationButton", 8, false);
  let imageGenerationEnabled = prop($$props, "imageGenerationEnabled", 12, false);
  let showCodeInterpreterButton = prop($$props, "showCodeInterpreterButton", 8, false);
  let codeInterpreterEnabled = prop($$props, "codeInterpreterEnabled", 12, false);
  let onShowValves = prop($$props, "onShowValves", 8);
  let onClose = prop($$props, "onClose", 8);
  prop($$props, "closeOnOutsideClick", 8, true);
  let show2 = mutable_source(false);
  let tab = mutable_source("");
  let tools$1 = mutable_source(null);
  let fileUploadEnabled = mutable_source(true);
  const init$1 = async () => {
    var _a;
    if ($_tools() === null) {
      await tools.set(await getTools(localStorage.token));
    }
    if ($_tools()) {
      set(tools$1, $_tools().reduce(
        (a, tool, i, arr) => {
          a[tool.id] = {
            name: tool.name,
            description: tool.meta.description,
            enabled: selectedToolIds().includes(tool.id),
            ...tool
          };
          return a;
        },
        {}
      ));
    }
    if ($toolServers()) {
      for (const serverIdx in $toolServers()) {
        const server = $toolServers()[serverIdx];
        if (server.info) {
          mutate(tools$1, get(tools$1)[`direct_server:${serverIdx}`] = {
            name: ((_a = server == null ? void 0 : server.info) == null ? void 0 : _a.title) ?? server.url,
            description: server.info.description ?? "",
            enabled: selectedToolIds().includes(`direct_server:${serverIdx}`)
          });
        }
      }
    }
    selectedToolIds(selectedToolIds().filter((id) => Object.keys(get(tools$1)).includes(id)));
  };
  legacy_pre_effect(() => get(show2), () => {
    if (get(show2)) {
      init$1();
    }
  });
  legacy_pre_effect(
    () => (deep_read_state(fileUploadCapableModels()), deep_read_state(selectedModels()), $user()),
    () => {
      var _a, _b, _c, _d;
      set(fileUploadEnabled, fileUploadCapableModels().length === selectedModels().length && (((_a = $user()) == null ? void 0 : _a.role) === "admin" || ((_d = (_c = (_b = $user()) == null ? void 0 : _b.permissions) == null ? void 0 : _c.chat) == null ? void 0 : _d.file_upload)));
    }
  );
  legacy_pre_effect_reset();
  init();
  Dropdown($$anchor, {
    get show() {
      return get(show2);
    },
    set show($$value) {
      set(show2, $$value);
    },
    $$events: {
      change: (e) => {
        if (e.detail === false) {
          onClose()();
        }
      }
    },
    children: ($$anchor2, $$slotProps) => {
      {
        let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Integrations"))));
        Tooltip($$anchor2, {
          get content() {
            return get($0);
          },
          placement: "top",
          children: ($$anchor3, $$slotProps2) => {
            var fragment_2 = comment();
            var node = first_child(fragment_2);
            slot(node, $$props, "default", {}, null);
            append($$anchor3, fragment_2);
          },
          $$slots: { default: true }
        });
      }
    },
    $$slots: {
      default: true,
      content: ($$anchor2, $$slotProps) => {
        var div = root_3$a();
        var node_1 = child(div);
        Menu_content(node_1, {
          class: "w-full max-w-70 rounded-2xl px-1 py-1  border border-gray-100  dark:border-gray-800 z-50 bg-white dark:bg-gray-850 dark:text-white shadow-lg max-h-72 overflow-y-auto overflow-x-hidden scrollbar-thin",
          sideOffset: 4,
          alignOffset: -6,
          side: "bottom",
          align: "start",
          get transition() {
            return flyAndScale;
          },
          children: ($$anchor3, $$slotProps2) => {
            var fragment_3 = comment();
            var node_2 = first_child(fragment_3);
            {
              var consequent_8 = ($$anchor4) => {
                var div_1 = root_5$8();
                var node_3 = child(div_1);
                {
                  var consequent_1 = ($$anchor5) => {
                    var fragment_4 = comment();
                    var node_4 = first_child(fragment_4);
                    {
                      var consequent = ($$anchor6) => {
                        var button = root_7$8();
                        var node_5 = child(button);
                        Wrench(node_5, {});
                        var div_2 = sibling(node_5, 2);
                        var div_3 = child(div_2);
                        var text2 = child(div_3);
                        var span = sibling(text2);
                        var text_1 = child(span, true);
                        reset(span);
                        reset(div_3);
                        var div_4 = sibling(div_3, 2);
                        var node_6 = child(div_4);
                        ChevronRight(node_6, {});
                        reset(div_4);
                        reset(div_2);
                        reset(button);
                        template_effect(
                          ($0, $1) => {
                            set_text(text2, `${$0 ?? ""} `);
                            set_text(text_1, $1);
                          },
                          [
                            () => ($i18n(), untrack(() => $i18n().t("Tools"))),
                            () => (get(tools$1), untrack(() => Object.keys(get(tools$1)).length))
                          ]
                        );
                        event("click", button, () => {
                          set(tab, "tools");
                        });
                        append($$anchor6, button);
                      };
                      if_block(node_4, ($$render) => {
                        if (get(tools$1), untrack(() => Object.keys(get(tools$1)).length > 0)) $$render(consequent);
                      });
                    }
                    append($$anchor5, fragment_4);
                  };
                  var alternate = ($$anchor5) => {
                    var div_5 = root_8$5();
                    var node_7 = child(div_5);
                    Spinner(node_7, {});
                    reset(div_5);
                    append($$anchor5, div_5);
                  };
                  if_block(node_3, ($$render) => {
                    if (get(tools$1)) $$render(consequent_1);
                    else $$render(alternate, false);
                  });
                }
                var node_8 = sibling(node_3, 2);
                {
                  var consequent_4 = ($$anchor5) => {
                    var fragment_5 = comment();
                    var node_9 = first_child(fragment_5);
                    each(
                      node_9,
                      3,
                      () => (deep_read_state(toggleFilters()), untrack(() => toggleFilters().sort((a, b) => a.name.localeCompare(b.name, void 0, { sensitivity: "base" })))),
                      (filter) => filter.id,
                      ($$anchor6, filter) => {
                        {
                          let $0 = derived_safe_equal(() => (get(filter), untrack(() => {
                            var _a;
                            return (_a = get(filter)) == null ? void 0 : _a.description;
                          })));
                          Tooltip($$anchor6, {
                            get content() {
                              return get($0);
                            },
                            placement: "top-start",
                            children: ($$anchor7, $$slotProps3) => {
                              var button_1 = root_11$6();
                              var div_6 = child(button_1);
                              var div_7 = child(div_6);
                              var div_8 = child(div_7);
                              var node_10 = child(div_8);
                              {
                                var consequent_2 = ($$anchor8) => {
                                  var div_9 = root_12$3();
                                  var img = child(div_9);
                                  reset(div_9);
                                  template_effect(
                                    ($02) => {
                                      set_attribute(img, "src", (get(filter), untrack(() => get(filter).icon)));
                                      set_class(img, 1, `size-3.5 ${$02 ?? ""}`);
                                      set_attribute(img, "alt", (get(filter), untrack(() => get(filter).name)));
                                    },
                                    [
                                      () => (get(filter), untrack(() => get(filter).icon.includes("svg") ? "dark:invert-[80%]" : ""))
                                    ]
                                  );
                                  append($$anchor8, div_9);
                                };
                                var alternate_1 = ($$anchor8) => {
                                  Sparkles($$anchor8, { className: "size-4", strokeWidth: "1.75" });
                                };
                                if_block(node_10, ($$render) => {
                                  if (get(filter), untrack(() => {
                                    var _a;
                                    return (_a = get(filter)) == null ? void 0 : _a.icon;
                                  })) $$render(consequent_2);
                                  else $$render(alternate_1, false);
                                });
                              }
                              reset(div_8);
                              var div_10 = sibling(div_8, 2);
                              var text_2 = child(div_10, true);
                              reset(div_10);
                              reset(div_7);
                              reset(div_6);
                              var node_11 = sibling(div_6, 2);
                              {
                                var consequent_3 = ($$anchor8) => {
                                  var div_11 = root_14$4();
                                  var node_12 = child(div_11);
                                  {
                                    let $02 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Valves"))));
                                    Tooltip(node_12, {
                                      get content() {
                                        return get($02);
                                      },
                                      children: ($$anchor9, $$slotProps4) => {
                                        var button_2 = root_15$4();
                                        var node_13 = child(button_2);
                                        Knobs(node_13, {});
                                        reset(button_2);
                                        event("click", button_2, (e) => {
                                          e.stopPropagation();
                                          e.preventDefault();
                                          onShowValves()({ type: "function", id: get(filter).id });
                                        });
                                        append($$anchor9, button_2);
                                      },
                                      $$slots: { default: true }
                                    });
                                  }
                                  reset(div_11);
                                  append($$anchor8, div_11);
                                };
                                if_block(node_11, ($$render) => {
                                  if (get(filter), untrack(() => {
                                    var _a;
                                    return (_a = get(filter)) == null ? void 0 : _a.has_user_valves;
                                  })) $$render(consequent_3);
                                });
                              }
                              var div_12 = sibling(node_11, 2);
                              var node_14 = child(div_12);
                              {
                                let $02 = derived_safe_equal(() => (deep_read_state(selectedFilterIds()), get(filter), untrack(() => selectedFilterIds().includes(get(filter).id))));
                                Switch_1(node_14, {
                                  get state() {
                                    return get($02);
                                  },
                                  $$events: {
                                    change: async (e) => {
                                      e.detail;
                                      await tick();
                                    }
                                  }
                                });
                              }
                              reset(div_12);
                              reset(button_1);
                              template_effect(() => set_text(text_2, (get(filter), untrack(() => {
                                var _a;
                                return (_a = get(filter)) == null ? void 0 : _a.name;
                              }))));
                              event("click", button_1, () => {
                                if (selectedFilterIds().includes(get(filter).id)) {
                                  selectedFilterIds(selectedFilterIds().filter((id) => id !== get(filter).id));
                                } else {
                                  selectedFilterIds([...selectedFilterIds(), get(filter).id]);
                                }
                              });
                              append($$anchor7, button_1);
                            },
                            $$slots: { default: true }
                          });
                        }
                      }
                    );
                    append($$anchor5, fragment_5);
                  };
                  if_block(node_8, ($$render) => {
                    if (deep_read_state(toggleFilters()), untrack(() => toggleFilters() && toggleFilters().length > 0)) $$render(consequent_4);
                  });
                }
                var node_15 = sibling(node_8, 2);
                {
                  var consequent_5 = ($$anchor5) => {
                    {
                      let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Search the internet"))));
                      Tooltip($$anchor5, {
                        get content() {
                          return get($0);
                        },
                        placement: "top-start",
                        children: ($$anchor6, $$slotProps3) => {
                          var button_3 = root_17$4();
                          var div_13 = child(button_3);
                          var div_14 = child(div_13);
                          var div_15 = child(div_14);
                          var node_16 = child(div_15);
                          GlobeAlt(node_16, {});
                          reset(div_15);
                          var div_16 = sibling(div_15, 2);
                          var text_3 = child(div_16, true);
                          reset(div_16);
                          reset(div_14);
                          reset(div_13);
                          var div_17 = sibling(div_13, 2);
                          var node_17 = child(div_17);
                          Switch_1(node_17, {
                            get state() {
                              return webSearchEnabled();
                            },
                            $$events: {
                              change: async (e) => {
                                e.detail;
                                await tick();
                              }
                            }
                          });
                          reset(div_17);
                          reset(button_3);
                          template_effect(($02) => set_text(text_3, $02), [() => ($i18n(), untrack(() => $i18n().t("Web Search")))]);
                          event("click", button_3, () => {
                            webSearchEnabled(!webSearchEnabled());
                          });
                          append($$anchor6, button_3);
                        },
                        $$slots: { default: true }
                      });
                    }
                  };
                  if_block(node_15, ($$render) => {
                    if (showWebSearchButton()) $$render(consequent_5);
                  });
                }
                var node_18 = sibling(node_15, 2);
                {
                  var consequent_6 = ($$anchor5) => {
                    {
                      let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Generate an image"))));
                      Tooltip($$anchor5, {
                        get content() {
                          return get($0);
                        },
                        placement: "top-start",
                        children: ($$anchor6, $$slotProps3) => {
                          var button_4 = root_19$3();
                          var div_18 = child(button_4);
                          var div_19 = child(div_18);
                          var div_20 = child(div_19);
                          var node_19 = child(div_20);
                          Photo(node_19, { className: "size-4", strokeWidth: "1.5" });
                          reset(div_20);
                          var div_21 = sibling(div_20, 2);
                          var text_4 = child(div_21, true);
                          reset(div_21);
                          reset(div_19);
                          reset(div_18);
                          var div_22 = sibling(div_18, 2);
                          var node_20 = child(div_22);
                          Switch_1(node_20, {
                            get state() {
                              return imageGenerationEnabled();
                            },
                            $$events: {
                              change: async (e) => {
                                e.detail;
                                await tick();
                              }
                            }
                          });
                          reset(div_22);
                          reset(button_4);
                          template_effect(($02) => set_text(text_4, $02), [() => ($i18n(), untrack(() => $i18n().t("Image")))]);
                          event("click", button_4, () => {
                            imageGenerationEnabled(!imageGenerationEnabled());
                          });
                          append($$anchor6, button_4);
                        },
                        $$slots: { default: true }
                      });
                    }
                  };
                  if_block(node_18, ($$render) => {
                    if (showImageGenerationButton()) $$render(consequent_6);
                  });
                }
                var node_21 = sibling(node_18, 2);
                {
                  var consequent_7 = ($$anchor5) => {
                    {
                      let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Execute code for analysis"))));
                      Tooltip($$anchor5, {
                        get content() {
                          return get($0);
                        },
                        placement: "top-start",
                        children: ($$anchor6, $$slotProps3) => {
                          var button_5 = root_21$2();
                          var div_23 = child(button_5);
                          var div_24 = child(div_23);
                          var div_25 = child(div_24);
                          var node_22 = child(div_25);
                          Terminal(node_22, { className: "size-3.5", strokeWidth: "1.75" });
                          reset(div_25);
                          var div_26 = sibling(div_25, 2);
                          var text_5 = child(div_26, true);
                          reset(div_26);
                          reset(div_24);
                          reset(div_23);
                          var div_27 = sibling(div_23, 2);
                          var node_23 = child(div_27);
                          Switch_1(node_23, {
                            get state() {
                              return codeInterpreterEnabled();
                            },
                            $$events: {
                              change: async (e) => {
                                e.detail;
                                await tick();
                              }
                            }
                          });
                          reset(div_27);
                          reset(button_5);
                          template_effect(
                            ($02, $1) => {
                              set_attribute(button_5, "aria-pressed", codeInterpreterEnabled());
                              set_attribute(button_5, "aria-label", $02);
                              set_text(text_5, $1);
                            },
                            [
                              () => (deep_read_state(codeInterpreterEnabled()), $i18n(), untrack(() => codeInterpreterEnabled() ? $i18n().t("Disable Code Interpreter") : $i18n().t("Enable Code Interpreter"))),
                              () => ($i18n(), untrack(() => $i18n().t("Code Interpreter")))
                            ]
                          );
                          event("click", button_5, () => {
                            codeInterpreterEnabled(!codeInterpreterEnabled());
                          });
                          append($$anchor6, button_5);
                        },
                        $$slots: { default: true }
                      });
                    }
                  };
                  if_block(node_21, ($$render) => {
                    if (showCodeInterpreterButton()) $$render(consequent_7);
                  });
                }
                reset(div_1);
                transition(1, div_1, () => fly, () => ({ x: -20, duration: 150 }));
                append($$anchor4, div_1);
              };
              var alternate_2 = ($$anchor4) => {
                var fragment_11 = comment();
                var node_24 = first_child(fragment_11);
                {
                  var consequent_11 = ($$anchor5) => {
                    var div_28 = root_23$1();
                    var button_6 = child(div_28);
                    var node_25 = child(button_6);
                    ChevronLeft(node_25, {});
                    var div_29 = sibling(node_25, 2);
                    var div_30 = child(div_29);
                    var text_6 = child(div_30);
                    var span_1 = sibling(text_6);
                    var text_7 = child(span_1, true);
                    reset(span_1);
                    reset(div_30);
                    reset(div_29);
                    reset(button_6);
                    var node_26 = sibling(button_6, 2);
                    each(node_26, 1, () => (get(tools$1), untrack(() => Object.keys(get(tools$1)))), index, ($$anchor6, toolId) => {
                      var button_7 = root_24();
                      var node_27 = child(button_7);
                      {
                        var consequent_9 = ($$anchor7) => {
                          var div_31 = root_25$1();
                          append($$anchor7, div_31);
                        };
                        if_block(node_27, ($$render) => {
                          if (get(tools$1), get(toolId), untrack(() => {
                            var _a;
                            return !(((_a = get(tools$1)[get(toolId)]) == null ? void 0 : _a.authenticated) ?? true);
                          })) $$render(consequent_9);
                        });
                      }
                      var div_32 = sibling(node_27, 2);
                      var div_33 = child(div_32);
                      var node_28 = child(div_33);
                      {
                        let $0 = derived_safe_equal(() => (get(tools$1), get(toolId), untrack(() => {
                          var _a;
                          return ((_a = get(tools$1)[get(toolId)]) == null ? void 0 : _a.name) ?? "";
                        })));
                        Tooltip(node_28, {
                          get content() {
                            return get($0);
                          },
                          placement: "top",
                          children: ($$anchor7, $$slotProps3) => {
                            var div_34 = root_26$2();
                            var node_29 = child(div_34);
                            Wrench(node_29, {});
                            reset(div_34);
                            append($$anchor7, div_34);
                          },
                          $$slots: { default: true }
                        });
                      }
                      var node_30 = sibling(node_28, 2);
                      {
                        let $0 = derived_safe_equal(() => (get(tools$1), get(toolId), untrack(() => {
                          var _a;
                          return ((_a = get(tools$1)[get(toolId)]) == null ? void 0 : _a.description) ?? "";
                        })));
                        Tooltip(node_30, {
                          get content() {
                            return get($0);
                          },
                          placement: "top-start",
                          children: ($$anchor7, $$slotProps3) => {
                            var div_35 = root_27();
                            var text_8 = child(div_35, true);
                            reset(div_35);
                            template_effect(() => set_text(text_8, (get(tools$1), get(toolId), untrack(() => get(tools$1)[get(toolId)].name))));
                            append($$anchor7, div_35);
                          },
                          $$slots: { default: true }
                        });
                      }
                      reset(div_33);
                      reset(div_32);
                      var node_31 = sibling(div_32, 2);
                      {
                        var consequent_10 = ($$anchor7) => {
                          var div_36 = root_28$1();
                          var node_32 = child(div_36);
                          {
                            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Valves"))));
                            Tooltip(node_32, {
                              get content() {
                                return get($0);
                              },
                              children: ($$anchor8, $$slotProps3) => {
                                var button_8 = root_29();
                                var node_33 = child(button_8);
                                Knobs(node_33, {});
                                reset(button_8);
                                event("click", button_8, (e) => {
                                  e.stopPropagation();
                                  e.preventDefault();
                                  onShowValves()({ type: "tool", id: get(toolId) });
                                });
                                append($$anchor8, button_8);
                              },
                              $$slots: { default: true }
                            });
                          }
                          reset(div_36);
                          append($$anchor7, div_36);
                        };
                        if_block(node_31, ($$render) => {
                          if (get(tools$1), get(toolId), untrack(() => {
                            var _a;
                            return (_a = get(tools$1)[get(toolId)]) == null ? void 0 : _a.has_user_valves;
                          })) $$render(consequent_10);
                        });
                      }
                      var div_37 = sibling(node_31, 2);
                      var node_34 = child(div_37);
                      Switch_1(node_34, {
                        get state() {
                          return get(tools$1), get(toolId), untrack(() => get(tools$1)[get(toolId)].enabled);
                        }
                      });
                      reset(div_37);
                      reset(button_7);
                      event("click", button_7, async (e) => {
                        var _a;
                        if (!(((_a = get(tools$1)[get(toolId)]) == null ? void 0 : _a.authenticated) ?? true)) {
                          e.preventDefault();
                          let parts = get(toolId).split(":");
                          let serverId = (parts == null ? void 0 : parts.at(-1)) ?? get(toolId);
                          const authUrl = getOAuthClientAuthorizationUrl(serverId, "mcp");
                          window.open(authUrl, "_self", "noopener");
                        } else {
                          mutate(tools$1, get(tools$1)[get(toolId)].enabled = !get(tools$1)[get(toolId)].enabled);
                          const state = get(tools$1)[get(toolId)].enabled;
                          await tick();
                          if (state) {
                            selectedToolIds([...selectedToolIds(), get(toolId)]);
                          } else {
                            selectedToolIds(selectedToolIds().filter((id) => id !== get(toolId)));
                          }
                        }
                      });
                      append($$anchor6, button_7);
                    });
                    reset(div_28);
                    template_effect(
                      ($0, $1) => {
                        set_text(text_6, `${$0 ?? ""} `);
                        set_text(text_7, $1);
                      },
                      [
                        () => ($i18n(), untrack(() => $i18n().t("Tools"))),
                        () => (get(tools$1), untrack(() => Object.keys(get(tools$1)).length))
                      ]
                    );
                    event("click", button_6, () => {
                      set(tab, "");
                    });
                    transition(1, div_28, () => fly, () => ({ x: 20, duration: 150 }));
                    append($$anchor5, div_28);
                  };
                  if_block(
                    node_24,
                    ($$render) => {
                      if (get(tab) === "tools" && get(tools$1)) $$render(consequent_11);
                    },
                    true
                  );
                }
                append($$anchor4, fragment_11);
              };
              if_block(node_2, ($$render) => {
                if (get(tab) === "") $$render(consequent_8);
                else $$render(alternate_2, false);
              });
            }
            append($$anchor3, fragment_3);
          },
          $$slots: { default: true }
        });
        reset(div);
        append($$anchor2, div);
      }
    },
    $$legacy: true
  });
  pop();
  $$cleanup();
}
var root$g = from_svg(`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M5.21173 15.1113L2.52473 12.4243C2.29041 12.1899 2.29041 11.8101 2.52473 11.5757L5.21173 8.88873C5.44605 8.65442 5.82595 8.65442 6.06026 8.88873L8.74727 11.5757C8.98158 11.8101 8.98158 12.1899 8.74727 12.4243L6.06026 15.1113C5.82595 15.3456 5.44605 15.3456 5.21173 15.1113Z"></path><path d="M11.5757 21.475L8.88874 18.788C8.65443 18.5537 8.65443 18.1738 8.88874 17.9395L11.5757 15.2525C11.8101 15.0182 12.19 15.0182 12.4243 15.2525L15.1113 17.9395C15.3456 18.1738 15.3456 18.5537 15.1113 18.788L12.4243 21.475C12.19 21.7094 11.8101 21.7094 11.5757 21.475Z"></path><path d="M11.5757 8.7475L8.88874 6.06049C8.65443 5.82618 8.65443 5.44628 8.88874 5.21197L11.5757 2.52496C11.8101 2.29065 12.19 2.29065 12.4243 2.52496L15.1113 5.21197C15.3456 5.44628 15.3456 5.82618 15.1113 6.06049L12.4243 8.7475C12.19 8.98181 11.8101 8.98181 11.5757 8.7475Z"></path><path d="M17.9396 15.1113L15.2526 12.4243C15.0183 12.1899 15.0183 11.8101 15.2526 11.5757L17.9396 8.88873C18.174 8.65442 18.5539 8.65442 18.7882 8.88873L21.4752 11.5757C21.7095 11.8101 21.7095 12.1899 21.4752 12.4243L18.7882 15.1113C18.5539 15.3456 18.174 15.3456 17.9396 15.1113Z"></path></svg>`);
function Component($$anchor, $$props) {
  let className = prop($$props, "className", 8, "size-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "1.5");
  var svg = root$g();
  template_effect(() => {
    set_attribute(svg, "stroke-width", strokeWidth());
    set_class(svg, 0, clsx(className()));
  });
  append($$anchor, svg);
}
var root$f = from_svg(`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M6 12H12M18 12H12M12 12V6M12 12V18" stroke-linecap="round" stroke-linejoin="round"></path></svg>`);
function PlusAlt($$anchor, $$props) {
  let className = prop($$props, "className", 8, "size-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "1.5");
  var svg = root$f();
  template_effect(() => {
    set_attribute(svg, "stroke-width", strokeWidth());
    set_class(svg, 0, clsx(className()));
  });
  append($$anchor, svg);
}
var root_2$b = from_html(`<div class=" absolute -top-12 left-0 right-0 flex justify-center z-30 pointer-events-none"><button class=" bg-white border border-gray-100 dark:border-none dark:bg-white/20 p-1.5 rounded-full pointer-events-auto"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v10.638l3.96-4.158a.75.75 0 111.08 1.04l-5.25 5.5a.75.75 0 01-1.08 0l-5.25-5.5a.75.75 0 111.08-1.04l3.96 4.158V3.75A.75.75 0 0110 3z" clip-rule="evenodd"></path></svg></button></div>`);
var root_3$9 = from_html(`<div class="px-3 pt-3 text-left w-full flex flex-col z-10"><div class="flex items-center justify-between w-full"><div class="pl-[1px] flex items-center gap-2 text-sm dark:text-gray-500"><img alt="model profile" class="size-3.5 max-w-[28px] object-cover rounded-full"/> <div class="translate-y-[0.5px]"><span> </span></div></div> <div><button class="flex items-center dark:text-gray-500"><!></button></div></div></div>`);
var root_8$4 = from_svg(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" class="size-4 fill-yellow-300"><path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75Zm0 8.25a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd"></path></svg>`);
var root_6$b = from_html(`<div class=" relative group"><div class="relative flex items-center"><!> <!></div> <div class=" absolute -top-1 -right-1"><button type="button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true" class="size-4"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"></path></svg></button></div></div>`);
var root_4$5 = from_html(`<div class="mx-2 mt-2.5 pb-1.5 flex items-center flex-wrap gap-2"></div>`);
var root_13$5 = from_html(`<div id="input-menu-button" class="bg-transparent hover:bg-gray-100 text-gray-700 dark:text-white dark:hover:bg-gray-800 rounded-full size-8 flex justify-center items-center outline-hidden focus:outline-hidden"><!></div>`);
var root_15$3 = from_html(`<div id="integration-menu-button" class="bg-transparent hover:bg-gray-100 text-gray-700 dark:text-white dark:hover:bg-gray-800 rounded-full size-8 flex justify-center items-center outline-hidden focus:outline-hidden"><!></div>`);
var root_14$3 = from_html(`<div class="flex self-center w-[1px] h-4 mx-1 bg-gray-200/50 dark:bg-gray-800/50"></div> <!>`, 1);
var root_17$3 = from_html(`<button id="model-valves-button" class="bg-transparent hover:bg-gray-100 text-gray-700 dark:text-white dark:hover:bg-gray-800 rounded-full size-8 flex justify-center items-center outline-hidden focus:outline-hidden"><!></button>`);
var root_16$2 = from_html(`<div class="ml-1 flex gap-1.5"><!></div>`);
var root_19$2 = from_html(`<button class="translate-y-[0.5px] px-1 flex gap-1 items-center text-gray-600 dark:text-gray-300 hover:text-gray-700 dark:hover:text-gray-200 rounded-lg self-center transition" aria-label="Available Tools" type="button"><!> <span class="text-sm"> </span></button>`);
var root_23 = from_html(`<div class="size-4 items-center flex justify-center"><img style="fill: currentColor;"/></div>`);
var root_22$1 = from_html(`<button type="button"><!> <div class="hidden group-hover:block"><!></div></button>`);
var root_26$1 = from_html(`<button type="button"><!> <div class="hidden group-hover:block"><!></div></button>`);
var root_28 = from_html(`<button type="button"><!> <div class="hidden group-hover:block"><!></div></button>`);
var root_30 = from_html(`<button type="button"><!> <div class="hidden group-hover:block"><!></div></button>`);
var root_32 = from_html(`<button id="voice-input-button" class=" text-gray-600 dark:text-gray-300 hover:text-gray-700 dark:hover:text-gray-200 transition rounded-full p-1.5 mr-0.5 self-center" type="button" aria-label="Voice Input"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 translate-y-[0.5px]"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"></path><path d="M5.5 9.643a.75.75 0 00-1.5 0V10c0 3.06 2.29 5.585 5.25 5.954V17.5h-1.5a.75.75 0 000 1.5h4.5a.75.75 0 000-1.5h-1.5v-1.546A6.001 6.001 0 0016 10v-.357a.75.75 0 00-1.5 0V10a4.5 4.5 0 01-9 0v-.357z"></path></svg></button>`);
var root_34 = from_html(`<button class="bg-white hover:bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-800 transition rounded-full p-1.5"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm6-2.438c0-.724.588-1.312 1.313-1.312h4.874c.725 0 1.313.588 1.313 1.313v4.874c0 .725-.588 1.313-1.313 1.313H9.564a1.312 1.312 0 01-1.313-1.313V9.564z" clip-rule="evenodd"></path></svg></button>`);
var root_33 = from_html(`<div class=" flex items-center"><!></div>`);
var root_37 = from_html(`<button class=" bg-black text-white hover:bg-gray-900 dark:bg-white dark:text-black dark:hover:bg-gray-100 transition rounded-full p-1.5 self-center" type="button"><!></button>`);
var root_36 = from_html(`<div class=" flex items-center"><!></div>`);
var root_39 = from_html(`<button id="send-message-button" type="submit"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M8 14a.75.75 0 0 1-.75-.75V4.56L4.03 7.78a.75.75 0 0 1-1.06-1.06l4.5-4.5a.75.75 0 0 1 1.06 0l4.5 4.5a.75.75 0 0 1-1.06 1.06L8.75 4.56v8.69A.75.75 0 0 1 8 14Z" clip-rule="evenodd"></path></svg></button>`);
var root_38 = from_html(`<div class=" flex items-center"><!></div>`);
var root_40 = from_html(`<div class=" text-xs text-gray-500 text-center line-clamp-1 marked"><!></div>`);
var root_41 = from_html(`<div class="mb-1"></div>`);
var root_1$a = from_html(`<div class="w-full font-primary"><div class=" mx-auto inset-x-0 bg-transparent flex justify-center"><div><div class="relative"><!></div></div></div> <div class="bg-transparent"><div><div><input type="file" hidden="" multiple/> <div><!></div> <form><button id="generate-message-pair-button" class="hidden"></button> <div id="message-input-container"><!> <!> <div class="px-2.5"><div id="chat-input-container"><!></div></div> <div class=" flex justify-between mt-0.5 mb-2.5 mx-0.5 max-w-full" dir="ltr"><div class="ml-1 self-end flex items-center flex-1 max-w-[80%]"><!> <!> <!> <div class="ml-1 flex gap-1.5"><!> <!> <!> <!> <!></div></div> <div class="self-end flex space-x-1 mr-1 shrink-0"><!> <!></div></div></div> <!></form></div></div></div></div>`);
var root$e = from_html(`<!> <!> <!> <!> <!>`, 1);
function MessageInput($$anchor, $$props) {
  push($$props, false);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const $models = () => store_get(models, "$models", $$stores);
  const $tools = () => store_get(tools, "$tools", $$stores);
  const $toolServers = () => store_get(toolServers, "$toolServers", $$stores);
  const $config = () => store_get(config, "$config", $$stores);
  const $_user = () => store_get(user, "$_user", $$stores);
  const $temporaryChatEnabled = () => store_get(temporaryChatEnabled, "$temporaryChatEnabled", $$stores);
  const $settings = () => store_get(settings, "$settings", $$stores);
  const $mobile = () => store_get(mobile, "$mobile", $$stores);
  const $TTSWorker = () => store_get(TTSWorker, "$TTSWorker", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const dispatch = createEventDispatcher();
  const i18n = getContext("i18n");
  let onChange = prop($$props, "onChange", 8, () => {
  });
  let createMessagePair = prop($$props, "createMessagePair", 8);
  let stopResponse = prop($$props, "stopResponse", 8);
  let autoScroll = prop($$props, "autoScroll", 12, false);
  let generating = prop($$props, "generating", 8, false);
  let atSelectedModel = prop($$props, "atSelectedModel", 12, void 0);
  let selectedModels = prop($$props, "selectedModels", 8);
  let selectedModelIds = mutable_source([]);
  let history = prop($$props, "history", 8);
  let taskIds = prop($$props, "taskIds", 8, null);
  let prompt = prop($$props, "prompt", 12, "");
  let files = prop($$props, "files", 28, () => []);
  let selectedToolIds = prop($$props, "selectedToolIds", 28, () => []);
  let selectedFilterIds = prop($$props, "selectedFilterIds", 28, () => []);
  let imageGenerationEnabled = prop($$props, "imageGenerationEnabled", 12, false);
  let webSearchEnabled = prop($$props, "webSearchEnabled", 12, false);
  let codeInterpreterEnabled = prop($$props, "codeInterpreterEnabled", 12, false);
  let showInputVariablesModal = mutable_source(false);
  let inputVariablesModalCallback = mutable_source((variableValues) => {
  });
  let inputVariables = mutable_source({});
  let inputVariableValues = {};
  let showValvesModal = mutable_source(false);
  let selectedValvesType = mutable_source(
    "tool"
    // 'tool' or 'function'
  );
  let selectedValvesItemId = mutable_source(null);
  let integrationsMenuCloseOnOutsideClick = mutable_source(true);
  const inputVariableHandler = async (text2) => {
    set(inputVariables, extractInputVariables(text2));
    if (Object.keys(get(inputVariables)).length === 0) {
      return text2;
    }
    set(showInputVariablesModal, true);
    return await new Promise((resolve) => {
      set(inputVariablesModalCallback, (variableValues) => {
        inputVariableValues = { ...inputVariableValues, ...variableValues };
        replaceVariables(inputVariableValues);
        set(showInputVariablesModal, false);
        resolve(text2);
      });
    });
  };
  const textVariableHandler = async (text2) => {
    if (text2.includes("{{CLIPBOARD}}")) {
      const clipboardText = await navigator.clipboard.readText().catch((err) => {
        toast.error($i18n().t("Failed to read clipboard contents"));
        return "{{CLIPBOARD}}";
      });
      const clipboardItems = await navigator.clipboard.read().catch((err) => {
        console.error("Failed to read clipboard items:", err);
        return [];
      });
      for (const item of clipboardItems) {
        for (const type of item.types) {
          if (type.startsWith("image/")) {
            const blob = await item.getType(type);
            const reader = new FileReader();
            reader.onload = (event2) => {
              files([...files(), { type: "image", url: event2.target.result }]);
            };
            reader.readAsDataURL(blob);
          }
        }
      }
      text2 = text2.replaceAll("{{CLIPBOARD}}", clipboardText);
    }
    if (text2.includes("{{USER_LOCATION}}")) {
      let location2;
      try {
        location2 = await getUserPosition();
      } catch (error) {
        toast.error($i18n().t("Location access not allowed"));
        location2 = "LOCATION_UNKNOWN";
      }
      text2 = text2.replaceAll("{{USER_LOCATION}}", String(location2));
    }
    const sessionUser = await getSessionUser(localStorage.token);
    if (text2.includes("{{USER_NAME}}")) {
      const name = (sessionUser == null ? void 0 : sessionUser.name) || "User";
      text2 = text2.replaceAll("{{USER_NAME}}", name);
    }
    if (text2.includes("{{USER_BIO}}")) {
      const bio = (sessionUser == null ? void 0 : sessionUser.bio) || "";
      if (bio) {
        text2 = text2.replaceAll("{{USER_BIO}}", bio);
      }
    }
    if (text2.includes("{{USER_GENDER}}")) {
      const gender = (sessionUser == null ? void 0 : sessionUser.gender) || "";
      if (gender) {
        text2 = text2.replaceAll("{{USER_GENDER}}", gender);
      }
    }
    if (text2.includes("{{USER_BIRTH_DATE}}")) {
      const birthDate = (sessionUser == null ? void 0 : sessionUser.date_of_birth) || "";
      if (birthDate) {
        text2 = text2.replaceAll("{{USER_BIRTH_DATE}}", birthDate);
      }
    }
    if (text2.includes("{{USER_AGE}}")) {
      const birthDate = (sessionUser == null ? void 0 : sessionUser.date_of_birth) || "";
      if (birthDate) {
        const age = getAge(birthDate);
        text2 = text2.replaceAll("{{USER_AGE}}", age);
      }
    }
    if (text2.includes("{{USER_LANGUAGE}}")) {
      const language = localStorage.getItem("locale") || "en-US";
      text2 = text2.replaceAll("{{USER_LANGUAGE}}", language);
    }
    if (text2.includes("{{CURRENT_DATE}}")) {
      const date = getFormattedDate();
      text2 = text2.replaceAll("{{CURRENT_DATE}}", date);
    }
    if (text2.includes("{{CURRENT_TIME}}")) {
      const time = getFormattedTime();
      text2 = text2.replaceAll("{{CURRENT_TIME}}", time);
    }
    if (text2.includes("{{CURRENT_DATETIME}}")) {
      const dateTime = getCurrentDateTime();
      text2 = text2.replaceAll("{{CURRENT_DATETIME}}", dateTime);
    }
    if (text2.includes("{{CURRENT_TIMEZONE}}")) {
      const timezone = getUserTimezone();
      text2 = text2.replaceAll("{{CURRENT_TIMEZONE}}", timezone);
    }
    if (text2.includes("{{CURRENT_WEEKDAY}}")) {
      const weekday = getWeekday();
      text2 = text2.replaceAll("{{CURRENT_WEEKDAY}}", weekday);
    }
    return text2;
  };
  const replaceVariables = (variables) => {
    console.log("Replacing variables:", variables);
    const chatInput = document.getElementById("chat-input");
    if (chatInput) {
      get(chatInputElement).replaceVariables(variables);
      get(chatInputElement).focus();
    }
  };
  const setText = async (text2, cb) => {
    var _a, _b;
    const chatInput = document.getElementById("chat-input");
    if (chatInput) {
      if (text2 !== "") {
        text2 = await textVariableHandler(text2 || "");
      }
      (_a = get(chatInputElement)) == null ? void 0 : _a.setText(text2);
      (_b = get(chatInputElement)) == null ? void 0 : _b.focus();
      if (text2 !== "") {
        text2 = await inputVariableHandler(text2);
      }
      await tick();
      if (cb) await cb(text2);
    }
  };
  const getCommand = () => {
    var _a;
    const chatInput = document.getElementById("chat-input");
    let word = "";
    if (chatInput) {
      word = (_a = get(chatInputElement)) == null ? void 0 : _a.getWordAtDocPos();
    }
    return word;
  };
  const replaceCommandWithText = (text2) => {
    var _a;
    const chatInput = document.getElementById("chat-input");
    if (!chatInput) return;
    (_a = get(chatInputElement)) == null ? void 0 : _a.replaceCommandWithText(text2);
  };
  const insertTextAtCursor = async (text2) => {
    var _a;
    const chatInput = document.getElementById("chat-input");
    if (!chatInput) return;
    text2 = await textVariableHandler(text2);
    if (get(command)) {
      replaceCommandWithText(text2);
    } else {
      (_a = get(chatInputElement)) == null ? void 0 : _a.insertContent(text2);
    }
    await tick();
    text2 = await inputVariableHandler(text2);
    await tick();
    const chatInputContainer = document.getElementById("chat-input-container");
    if (chatInputContainer) {
      chatInputContainer.scrollTop = chatInputContainer.scrollHeight;
    }
    await tick();
    if (chatInput) {
      chatInput.focus();
      chatInput.dispatchEvent(new Event("input"));
      const words = extractCurlyBraceWords(prompt());
      if (words.length > 0) {
        words.at(0);
        await tick();
      } else {
        chatInput.scrollTop = chatInput.scrollHeight;
      }
    }
  };
  let command = mutable_source("");
  let showCommands = prop($$props, "showCommands", 12, false);
  let suggestions = mutable_source(null);
  let showTools = mutable_source(false);
  let loaded = mutable_source(false);
  let recording = mutable_source(false);
  let isComposing = mutable_source(false);
  let compositionEndedAt = mutable_source(-2e8);
  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  function inOrNearComposition(event2) {
    if (get(isComposing)) {
      return true;
    }
    if (isSafari && Math.abs(event2.timeStamp - get(compositionEndedAt)) < 500) {
      set(compositionEndedAt, -2e8);
      return true;
    }
    return false;
  }
  let chatInputElement = mutable_source();
  let filesInputElement = mutable_source();
  let inputFiles = mutable_source();
  let dragged = mutable_source(false);
  let shiftKey = mutable_source(false);
  let placeholder = prop($$props, "placeholder", 8, "");
  let visionCapableModels = mutable_source([]);
  let fileUploadCapableModels = mutable_source([]);
  let webSearchCapableModels = mutable_source([]);
  let imageGenerationCapableModels = mutable_source([]);
  let codeInterpreterCapableModels = mutable_source([]);
  let toggleFilters = mutable_source([]);
  let showToolsButton = mutable_source(false);
  let showWebSearchButton = mutable_source(false);
  let showImageGenerationButton = mutable_source(false);
  let showCodeInterpreterButton = mutable_source(false);
  const scrollToBottom = () => {
    const element = document.getElementById("messages-container");
    element.scrollTo({ top: element.scrollHeight, behavior: "smooth" });
  };
  const screenCaptureHandler = async () => {
    try {
      const mediaStream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "never" }, audio: false });
      const video = document.createElement("video");
      video.srcObject = mediaStream;
      await video.play();
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const context = canvas.getContext("2d");
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      mediaStream.getTracks().forEach((track) => track.stop());
      window.focus();
      const imageUrl = canvas.toDataURL("image/png");
      files([...files(), { type: "image", url: imageUrl }]);
      video.srcObject = null;
    } catch (error) {
      console.error("Error capturing screen:", error);
    }
  };
  const uploadFileHandler = async (file, fullContext = false) => {
    var _a, _b, _c, _d, _e, _f, _g, _h, _i, _j, _k, _l;
    if (((_a = $_user()) == null ? void 0 : _a.role) !== "admin" && !(((_d = (_c = (_b = $_user()) == null ? void 0 : _b.permissions) == null ? void 0 : _c.chat) == null ? void 0 : _d.file_upload) ?? true)) {
      toast.error($i18n().t("You do not have permission to upload files."));
      return null;
    }
    if (get(fileUploadCapableModels).length !== selectedModels().length) {
      toast.error($i18n().t("Model(s) do not support file upload"));
      return null;
    }
    const tempItemId = v4();
    const fileItem = {
      type: "file",
      file: "",
      id: null,
      url: "",
      name: file.name,
      collection_name: "",
      status: "uploading",
      size: file.size,
      error: "",
      itemId: tempItemId,
      ...fullContext ? { context: "full" } : {}
    };
    if (fileItem.size == 0) {
      toast.error($i18n().t("You cannot upload an empty file."));
      return null;
    }
    files([...files(), fileItem]);
    if (!$temporaryChatEnabled()) {
      try {
        let metadata = null;
        if ((file.type.startsWith("audio/") || file.type.startsWith("video/")) && ((_g = (_f = (_e = $settings()) == null ? void 0 : _e.audio) == null ? void 0 : _f.stt) == null ? void 0 : _g.language)) {
          metadata = { language: (_j = (_i = (_h = $settings()) == null ? void 0 : _h.audio) == null ? void 0 : _i.stt) == null ? void 0 : _j.language };
        }
        const uploadedFile = await uploadFile(localStorage.token, file, metadata);
        if (uploadedFile) {
          console.log("File upload completed:", {
            id: uploadedFile.id,
            name: fileItem.name,
            collection: (_k = uploadedFile == null ? void 0 : uploadedFile.meta) == null ? void 0 : _k.collection_name
          });
          if (uploadedFile.error) {
            console.warn("File upload warning:", uploadedFile.error);
            toast.warning(uploadedFile.error);
          }
          fileItem.status = "uploaded";
          fileItem.file = uploadedFile;
          fileItem.id = uploadedFile.id;
          fileItem.collection_name = ((_l = uploadedFile == null ? void 0 : uploadedFile.meta) == null ? void 0 : _l.collection_name) || (uploadedFile == null ? void 0 : uploadedFile.collection_name);
          fileItem.url = `${WEBUI_API_BASE_URL$1}/files/${uploadedFile.id}`;
          files(files());
        } else {
          files(files().filter((item) => (item == null ? void 0 : item.itemId) !== tempItemId));
        }
      } catch (e) {
        toast.error(`${e}`);
        files(files().filter((item) => (item == null ? void 0 : item.itemId) !== tempItemId));
      }
    } else {
      const content = await extractContentFromFile(file).catch((error) => {
        toast.error($i18n().t("Failed to extract content from the file: {{error}}", { error }));
        return null;
      });
      if (content === null) {
        toast.error($i18n().t("Failed to extract content from the file."));
        files(files().filter((item) => (item == null ? void 0 : item.itemId) !== tempItemId));
        return null;
      } else {
        console.log("Extracted content from file:", { name: file.name, size: file.size, content });
        fileItem.status = "uploaded";
        fileItem.type = "text";
        fileItem.content = content;
        fileItem.id = v4();
        files(files());
      }
    }
  };
  const inputFilesHandler = async (inputFiles2) => {
    var _a, _b, _c, _d, _e, _f;
    console.log("Input files handler called with:", inputFiles2);
    if ((((_b = (_a = $config()) == null ? void 0 : _a.file) == null ? void 0 : _b.max_count) ?? null) !== null && files().length + inputFiles2.length > ((_d = (_c = $config()) == null ? void 0 : _c.file) == null ? void 0 : _d.max_count)) {
      toast.error($i18n().t(`You can only chat with a maximum of {{maxCount}} file(s) at a time.`, { maxCount: (_f = (_e = $config()) == null ? void 0 : _e.file) == null ? void 0 : _f.max_count }));
      return;
    }
    inputFiles2.forEach(async (file) => {
      var _a2, _b2, _c2, _d2, _e2, _f2, _g, _h;
      console.log("Processing file:", {
        name: file.name,
        type: file.type,
        size: file.size,
        extension: file.name.split(".").at(-1)
      });
      if ((((_b2 = (_a2 = $config()) == null ? void 0 : _a2.file) == null ? void 0 : _b2.max_size) ?? null) !== null && file.size > (((_d2 = (_c2 = $config()) == null ? void 0 : _c2.file) == null ? void 0 : _d2.max_size) ?? 0) * 1024 * 1024) {
        console.log("File exceeds max size limit:", {
          fileSize: file.size,
          maxSize: (((_f2 = (_e2 = $config()) == null ? void 0 : _e2.file) == null ? void 0 : _f2.max_size) ?? 0) * 1024 * 1024
        });
        toast.error($i18n().t(`File size should not exceed {{maxSize}} MB.`, { maxSize: (_h = (_g = $config()) == null ? void 0 : _g.file) == null ? void 0 : _h.max_size }));
        return;
      }
      if (file["type"].startsWith("image/")) {
        if (get(visionCapableModels).length === 0) {
          toast.error($i18n().t("Selected model(s) do not support image inputs"));
          return;
        }
        const compressImageHandler = async (imageUrl, settings2 = {}, config2 = {}) => {
          var _a3, _b3, _c3, _d3, _e3, _f3;
          const settingsCompression = (settings2 == null ? void 0 : settings2.imageCompression) ?? false;
          const configWidth = ((_b3 = (_a3 = config2 == null ? void 0 : config2.file) == null ? void 0 : _a3.image_compression) == null ? void 0 : _b3.width) ?? null;
          const configHeight = ((_d3 = (_c3 = config2 == null ? void 0 : config2.file) == null ? void 0 : _c3.image_compression) == null ? void 0 : _d3.height) ?? null;
          if (!settingsCompression && !configWidth && !configHeight) {
            return imageUrl;
          }
          let width = null;
          let height = null;
          if (settingsCompression) {
            width = ((_e3 = settings2 == null ? void 0 : settings2.imageCompressionSize) == null ? void 0 : _e3.width) ?? null;
            height = ((_f3 = settings2 == null ? void 0 : settings2.imageCompressionSize) == null ? void 0 : _f3.height) ?? null;
          }
          if (configWidth && (width === null || width > configWidth)) {
            width = configWidth;
          }
          if (configHeight && (height === null || height > configHeight)) {
            height = configHeight;
          }
          if (width || height) {
            return await compressImage(imageUrl, width, height);
          }
          return imageUrl;
        };
        let reader = new FileReader();
        reader.onload = async (event2) => {
          let imageUrl = event2.target.result;
          imageUrl = await compressImageHandler(imageUrl, $settings(), $config());
          files([...files(), { type: "image", url: `${imageUrl}` }]);
        };
        reader.readAsDataURL(file["type"] === "image/heic" ? await convertHeicToJpeg(file) : file);
      } else {
        uploadFileHandler(file);
      }
    });
  };
  const onDragOver = (e) => {
    var _a, _b;
    e.preventDefault();
    if ((_b = (_a = e.dataTransfer) == null ? void 0 : _a.types) == null ? void 0 : _b.includes("Files")) {
      set(dragged, true);
    } else {
      set(dragged, false);
    }
  };
  const onDragLeave = () => {
    set(dragged, false);
  };
  const onDrop = async (e) => {
    var _a, _b;
    e.preventDefault();
    console.log(e);
    if ((_a = e.dataTransfer) == null ? void 0 : _a.files) {
      const inputFiles2 = Array.from((_b = e.dataTransfer) == null ? void 0 : _b.files);
      if (inputFiles2 && inputFiles2.length > 0) {
        console.log(inputFiles2);
        inputFilesHandler(inputFiles2);
      }
    }
    set(dragged, false);
  };
  const onKeyDown = (e) => {
    if (e.key === "Shift") {
      set(shiftKey, true);
    }
    if (e.key === "Escape") {
      console.log("Escape");
      set(dragged, false);
    }
  };
  const onKeyUp = (e) => {
    if (e.key === "Shift") {
      set(shiftKey, false);
    }
  };
  const onFocus = () => {
  };
  const onBlur = () => {
    set(shiftKey, false);
  };
  onMount(async () => {
    set(suggestions, [
      {
        char: "@",
        render: getSuggestionRenderer(CommandSuggestionList, {
          i18n,
          onSelect: (e) => {
            var _a;
            const { type, data } = e;
            if (type === "model") {
              atSelectedModel(data);
            }
            (_a = document.getElementById("chat-input")) == null ? void 0 : _a.focus();
          },
          insertTextHandler: insertTextAtCursor,
          onUpload: (e) => {
            const { type, data } = e;
            if (type === "file") {
              if (files().find((f) => f.id === data.id)) {
                return;
              }
              files([...files(), { ...data, status: "processed" }]);
            } else {
              dispatch("upload", e);
            }
          }
        })
      },
      {
        char: "/",
        render: getSuggestionRenderer(CommandSuggestionList, {
          i18n,
          onSelect: (e) => {
            var _a;
            const { type, data } = e;
            if (type === "model") {
              atSelectedModel(data);
            }
            (_a = document.getElementById("chat-input")) == null ? void 0 : _a.focus();
          },
          insertTextHandler: insertTextAtCursor,
          onUpload: (e) => {
            const { type, data } = e;
            if (type === "file") {
              if (files().find((f) => f.id === data.id)) {
                return;
              }
              files([...files(), { ...data, status: "processed" }]);
            } else {
              dispatch("upload", e);
            }
          }
        })
      },
      {
        char: "#",
        render: getSuggestionRenderer(CommandSuggestionList, {
          i18n,
          onSelect: (e) => {
            var _a;
            const { type, data } = e;
            if (type === "model") {
              atSelectedModel(data);
            }
            (_a = document.getElementById("chat-input")) == null ? void 0 : _a.focus();
          },
          insertTextHandler: insertTextAtCursor,
          onUpload: (e) => {
            const { type, data } = e;
            if (type === "file") {
              if (files().find((f) => f.id === data.id)) {
                return;
              }
              files([...files(), { ...data, status: "processed" }]);
            } else {
              dispatch("upload", e);
            }
          }
        })
      }
    ]);
    set(loaded, true);
    window.setTimeout(
      () => {
        const chatInput = document.getElementById("chat-input");
        chatInput == null ? void 0 : chatInput.focus();
      },
      0
    );
    window.addEventListener("keydown", onKeyDown);
    window.addEventListener("keyup", onKeyUp);
    window.addEventListener("focus", onFocus);
    window.addEventListener("blur", onBlur);
    await tick();
    const dropzoneElement = document.getElementById("chat-container");
    dropzoneElement == null ? void 0 : dropzoneElement.addEventListener("dragover", onDragOver);
    dropzoneElement == null ? void 0 : dropzoneElement.addEventListener("drop", onDrop);
    dropzoneElement == null ? void 0 : dropzoneElement.addEventListener("dragleave", onDragLeave);
    await tools.set(await getTools(localStorage.token));
  });
  onDestroy(() => {
    console.log("destroy");
    window.removeEventListener("keydown", onKeyDown);
    window.removeEventListener("keyup", onKeyUp);
    window.removeEventListener("focus", onFocus);
    window.removeEventListener("blur", onBlur);
    const dropzoneElement = document.getElementById("chat-container");
    if (dropzoneElement) {
      dropzoneElement == null ? void 0 : dropzoneElement.removeEventListener("dragover", onDragOver);
      dropzoneElement == null ? void 0 : dropzoneElement.removeEventListener("drop", onDrop);
      dropzoneElement == null ? void 0 : dropzoneElement.removeEventListener("dragleave", onDragLeave);
    }
  });
  legacy_pre_effect(
    () => (deep_read_state(atSelectedModel()), deep_read_state(selectedModels())),
    () => {
      set(selectedModelIds, atSelectedModel() !== void 0 ? [atSelectedModel().id] : selectedModels());
    }
  );
  legacy_pre_effect(() => get(showValvesModal), () => {
    if (!get(showValvesModal)) {
      set(integrationsMenuCloseOnOutsideClick, true);
    }
  });
  legacy_pre_effect(
    () => (deep_read_state(onChange()), deep_read_state(prompt()), deep_read_state(files()), deep_read_state(selectedToolIds()), deep_read_state(selectedFilterIds()), deep_read_state(imageGenerationEnabled()), deep_read_state(webSearchEnabled()), deep_read_state(codeInterpreterEnabled())),
    () => {
      onChange()({
        prompt: prompt(),
        files: files().filter((file) => file.type !== "image").map((file) => {
          return { ...file, user: void 0, access_control: void 0 };
        }),
        selectedToolIds: selectedToolIds(),
        selectedFilterIds: selectedFilterIds(),
        imageGenerationEnabled: imageGenerationEnabled(),
        webSearchEnabled: webSearchEnabled(),
        codeInterpreterEnabled: codeInterpreterEnabled()
      });
    }
  );
  legacy_pre_effect(() => get(command), () => {
    var _a, _b;
    showCommands(["/", "#", "@"].includes((_a = get(command)) == null ? void 0 : _a.charAt(0)) || "\\#" === ((_b = get(command)) == null ? void 0 : _b.slice(0, 2)));
  });
  legacy_pre_effect(
    () => (deep_read_state(atSelectedModel()), deep_read_state(selectedModels()), $models()),
    () => {
      var _a;
      set(visionCapableModels, (((_a = atSelectedModel()) == null ? void 0 : _a.id) ? [atSelectedModel().id] : selectedModels()).filter((model) => {
        var _a2, _b, _c, _d;
        return ((_d = (_c = (_b = (_a2 = $models().find((m) => m.id === model)) == null ? void 0 : _a2.info) == null ? void 0 : _b.meta) == null ? void 0 : _c.capabilities) == null ? void 0 : _d.vision) ?? true;
      }));
    }
  );
  legacy_pre_effect(
    () => (deep_read_state(atSelectedModel()), deep_read_state(selectedModels()), $models()),
    () => {
      var _a;
      set(fileUploadCapableModels, (((_a = atSelectedModel()) == null ? void 0 : _a.id) ? [atSelectedModel().id] : selectedModels()).filter((model) => {
        var _a2, _b, _c, _d;
        return ((_d = (_c = (_b = (_a2 = $models().find((m) => m.id === model)) == null ? void 0 : _a2.info) == null ? void 0 : _b.meta) == null ? void 0 : _c.capabilities) == null ? void 0 : _d.file_upload) ?? true;
      }));
    }
  );
  legacy_pre_effect(
    () => (deep_read_state(atSelectedModel()), deep_read_state(selectedModels()), $models()),
    () => {
      var _a;
      set(webSearchCapableModels, (((_a = atSelectedModel()) == null ? void 0 : _a.id) ? [atSelectedModel().id] : selectedModels()).filter((model) => {
        var _a2, _b, _c, _d;
        return ((_d = (_c = (_b = (_a2 = $models().find((m) => m.id === model)) == null ? void 0 : _a2.info) == null ? void 0 : _b.meta) == null ? void 0 : _c.capabilities) == null ? void 0 : _d.web_search) ?? true;
      }));
    }
  );
  legacy_pre_effect(
    () => (deep_read_state(atSelectedModel()), deep_read_state(selectedModels()), $models()),
    () => {
      var _a;
      set(imageGenerationCapableModels, (((_a = atSelectedModel()) == null ? void 0 : _a.id) ? [atSelectedModel().id] : selectedModels()).filter((model) => {
        var _a2, _b, _c, _d;
        return ((_d = (_c = (_b = (_a2 = $models().find((m) => m.id === model)) == null ? void 0 : _a2.info) == null ? void 0 : _b.meta) == null ? void 0 : _c.capabilities) == null ? void 0 : _d.image_generation) ?? true;
      }));
    }
  );
  legacy_pre_effect(
    () => (deep_read_state(atSelectedModel()), deep_read_state(selectedModels()), $models()),
    () => {
      var _a;
      set(codeInterpreterCapableModels, (((_a = atSelectedModel()) == null ? void 0 : _a.id) ? [atSelectedModel().id] : selectedModels()).filter((model) => {
        var _a2, _b, _c, _d;
        return ((_d = (_c = (_b = (_a2 = $models().find((m) => m.id === model)) == null ? void 0 : _a2.info) == null ? void 0 : _b.meta) == null ? void 0 : _c.capabilities) == null ? void 0 : _d.code_interpreter) ?? true;
      }));
    }
  );
  legacy_pre_effect(
    () => (deep_read_state(atSelectedModel()), deep_read_state(selectedModels()), $models()),
    () => {
      var _a;
      set(toggleFilters, (((_a = atSelectedModel()) == null ? void 0 : _a.id) ? [atSelectedModel().id] : selectedModels()).map((id) => {
        var _a2;
        return ((_a2 = $models().find((model) => model.id === id) || {}) == null ? void 0 : _a2.filters) ?? [];
      }).reduce((acc, filters) => acc.filter((f1) => filters.some((f2) => f2.id === f1.id))));
    }
  );
  legacy_pre_effect(() => ($tools(), $toolServers()), () => {
    set(showToolsButton, ($tools() ?? []).length > 0 || ($toolServers() ?? []).length > 0);
  });
  legacy_pre_effect(
    () => (deep_read_state(atSelectedModel()), deep_read_state(selectedModels()), get(webSearchCapableModels), $config(), $_user()),
    () => {
      var _a, _b, _c, _d, _e, _f;
      set(showWebSearchButton, (((_a = atSelectedModel()) == null ? void 0 : _a.id) ? [atSelectedModel().id] : selectedModels()).length === get(webSearchCapableModels).length && ((_c = (_b = $config()) == null ? void 0 : _b.features) == null ? void 0 : _c.enable_web_search) && ($_user().role === "admin" || ((_f = (_e = (_d = $_user()) == null ? void 0 : _d.permissions) == null ? void 0 : _e.features) == null ? void 0 : _f.web_search)));
    }
  );
  legacy_pre_effect(
    () => (deep_read_state(atSelectedModel()), deep_read_state(selectedModels()), get(imageGenerationCapableModels), $config(), $_user()),
    () => {
      var _a, _b, _c, _d, _e, _f;
      set(showImageGenerationButton, (((_a = atSelectedModel()) == null ? void 0 : _a.id) ? [atSelectedModel().id] : selectedModels()).length === get(imageGenerationCapableModels).length && ((_c = (_b = $config()) == null ? void 0 : _b.features) == null ? void 0 : _c.enable_image_generation) && ($_user().role === "admin" || ((_f = (_e = (_d = $_user()) == null ? void 0 : _d.permissions) == null ? void 0 : _e.features) == null ? void 0 : _f.image_generation)));
    }
  );
  legacy_pre_effect(
    () => (deep_read_state(atSelectedModel()), deep_read_state(selectedModels()), get(codeInterpreterCapableModels), $config(), $_user()),
    () => {
      var _a, _b, _c, _d, _e, _f;
      set(showCodeInterpreterButton, (((_a = atSelectedModel()) == null ? void 0 : _a.id) ? [atSelectedModel().id] : selectedModels()).length === get(codeInterpreterCapableModels).length && ((_c = (_b = $config()) == null ? void 0 : _b.features) == null ? void 0 : _c.enable_code_interpreter) && ($_user().role === "admin" || ((_f = (_e = (_d = $_user()) == null ? void 0 : _d.permissions) == null ? void 0 : _e.features) == null ? void 0 : _f.code_interpreter)));
    }
  );
  legacy_pre_effect_reset();
  var $$exports = { setText };
  init();
  var fragment = root$e();
  var node = first_child(fragment);
  FilesOverlay(node, {
    get show() {
      return get(dragged);
    }
  });
  var node_1 = sibling(node, 2);
  ToolServersModal(node_1, {
    get selectedToolIds() {
      return selectedToolIds();
    },
    get show() {
      return get(showTools);
    },
    set show($$value) {
      set(showTools, $$value);
    },
    $$legacy: true
  });
  var node_2 = sibling(node_1, 2);
  InputVariablesModal(node_2, {
    get variables() {
      return get(inputVariables);
    },
    get onSave() {
      return get(inputVariablesModalCallback);
    },
    get show() {
      return get(showInputVariablesModal);
    },
    set show($$value) {
      set(showInputVariablesModal, $$value);
    },
    $$legacy: true
  });
  var node_3 = sibling(node_2, 2);
  {
    let $0 = derived_safe_equal(() => get(selectedValvesItemId) ?? null);
    ValvesModal(node_3, {
      userValves: true,
      get type() {
        return get(selectedValvesType);
      },
      get id() {
        return get($0);
      },
      get show() {
        return get(showValvesModal);
      },
      set show($$value) {
        set(showValvesModal, $$value);
      },
      $$events: {
        save: async () => {
          await tick();
        },
        close: () => {
          set(integrationsMenuCloseOnOutsideClick, true);
        }
      },
      $$legacy: true
    });
  }
  var node_4 = sibling(node_3, 2);
  {
    var consequent_18 = ($$anchor2) => {
      var div = root_1$a();
      var div_1 = child(div);
      var div_2 = child(div_1);
      var div_3 = child(div_2);
      var node_5 = child(div_3);
      {
        var consequent = ($$anchor3) => {
          var div_4 = root_2$b();
          var button = child(div_4);
          reset(div_4);
          event("click", button, () => {
            autoScroll(true);
            scrollToBottom();
          });
          append($$anchor3, div_4);
        };
        if_block(node_5, ($$render) => {
          if (deep_read_state(autoScroll()), deep_read_state(history()), untrack(() => {
            var _a;
            return autoScroll() === false && ((_a = history()) == null ? void 0 : _a.currentId);
          })) $$render(consequent);
        });
      }
      reset(div_3);
      reset(div_2);
      reset(div_1);
      var div_5 = sibling(div_1, 2);
      var div_6 = child(div_5);
      var div_7 = child(div_6);
      var input = child(div_7);
      bind_this(input, ($$value) => set(filesInputElement, $$value), () => get(filesInputElement));
      var div_8 = sibling(input, 2);
      var node_6 = child(div_8);
      VoiceRecording(node_6, {
        onCancel: async () => {
          var _a;
          set(recording, false);
          await tick();
          (_a = document.getElementById("chat-input")) == null ? void 0 : _a.focus();
        },
        onConfirm: async (data) => {
          var _a, _b;
          const { text: text2, filename } = data;
          set(recording, false);
          await tick();
          await insertTextAtCursor(`${text2}`);
          await tick();
          (_a = document.getElementById("chat-input")) == null ? void 0 : _a.focus();
          if (((_b = $settings()) == null ? void 0 : _b.speechAutoSend) ?? false) {
            dispatch("submit", prompt());
          }
        },
        get recording() {
          return get(recording);
        },
        set recording($$value) {
          set(recording, $$value);
        },
        $$legacy: true
      });
      reset(div_8);
      var form = sibling(div_8, 2);
      var button_1 = child(form);
      var div_9 = sibling(button_1, 2);
      var node_7 = child(div_9);
      {
        var consequent_1 = ($$anchor3) => {
          var div_10 = root_3$9();
          var div_11 = child(div_10);
          var div_12 = child(div_11);
          var img = child(div_12);
          var div_13 = sibling(img, 2);
          var span = child(div_13);
          var text_1 = child(span, true);
          reset(span);
          reset(div_13);
          reset(div_12);
          var div_14 = sibling(div_12, 2);
          var button_2 = child(div_14);
          var node_8 = child(button_2);
          XMark(node_8, {});
          reset(button_2);
          reset(div_14);
          reset(div_11);
          reset(div_10);
          template_effect(
            ($0) => {
              set_attribute(img, "src", $0);
              set_text(text_1, (deep_read_state(atSelectedModel()), untrack(() => atSelectedModel().name)));
            },
            [
              () => (deep_read_state(WEBUI_API_BASE_URL$1), $models(), deep_read_state(atSelectedModel()), $i18n(), untrack(() => `${WEBUI_API_BASE_URL$1}/models/model/profile/image?id=${$models().find((model) => model.id === atSelectedModel().id).id}&lang=${$i18n().language}`))
            ]
          );
          event("click", button_2, () => {
            atSelectedModel(void 0);
          });
          append($$anchor3, div_10);
        };
        if_block(node_7, ($$render) => {
          if (atSelectedModel() !== void 0) $$render(consequent_1);
        });
      }
      var node_9 = sibling(node_7, 2);
      {
        var consequent_4 = ($$anchor3) => {
          var div_15 = root_4$5();
          each(div_15, 5, files, index, ($$anchor4, file, fileIdx) => {
            var fragment_1 = comment();
            var node_10 = first_child(fragment_1);
            {
              var consequent_3 = ($$anchor5) => {
                var div_16 = root_6$b();
                var div_17 = child(div_16);
                var node_11 = child(div_17);
                Image(node_11, {
                  get src() {
                    return get(file), untrack(() => get(file).url);
                  },
                  alt: "",
                  imageClassName: " size-10 rounded-xl object-cover"
                });
                var node_12 = sibling(node_11, 2);
                {
                  var consequent_2 = ($$anchor6) => {
                    {
                      let $0 = derived_safe_equal(() => ($i18n(), deep_read_state(atSelectedModel()), deep_read_state(selectedModels()), get(visionCapableModels), untrack(() => $i18n().t("{{ models }}", {
                        models: [
                          ...atSelectedModel() ? [atSelectedModel()] : selectedModels()
                        ].filter((id) => !get(visionCapableModels).includes(id)).join(", ")
                      }))));
                      Tooltip($$anchor6, {
                        className: " absolute top-1 left-1",
                        get content() {
                          return get($0);
                        },
                        children: ($$anchor7, $$slotProps) => {
                          var svg = root_8$4();
                          append($$anchor7, svg);
                        },
                        $$slots: { default: true }
                      });
                    }
                  };
                  if_block(node_12, ($$render) => {
                    if (deep_read_state(atSelectedModel()), get(visionCapableModels), deep_read_state(selectedModels()), untrack(() => atSelectedModel() ? get(visionCapableModels).length === 0 : selectedModels().length !== get(visionCapableModels).length)) $$render(consequent_2);
                  });
                }
                reset(div_17);
                var div_18 = sibling(div_17, 2);
                var button_3 = child(div_18);
                reset(div_18);
                reset(div_16);
                template_effect(
                  ($0) => {
                    set_class(button_3, 1, ` bg-white text-black border border-white rounded-full ${($settings(), untrack(() => {
                      var _a;
                      return ((_a = $settings()) == null ? void 0 : _a.highContrastMode) ?? false ? "" : "outline-hidden focus:outline-hidden group-hover:visible invisible transition";
                    })) ?? ""}`);
                    set_attribute(button_3, "aria-label", $0);
                  },
                  [() => ($i18n(), untrack(() => $i18n().t("Remove file")))]
                );
                event("click", button_3, () => {
                  files().splice(fileIdx, 1);
                  files(files());
                });
                append($$anchor5, div_16);
              };
              var alternate = ($$anchor5) => {
                {
                  let $0 = derived_safe_equal(() => (get(file), untrack(() => {
                    var _a;
                    return (_a = get(file)) == null ? void 0 : _a.size;
                  })));
                  let $1 = derived_safe_equal(() => (get(file), untrack(() => get(file).status === "uploading")));
                  let $2 = derived_safe_equal(() => (get(file), untrack(() => {
                    var _a;
                    return ["file", "collection"].includes((_a = get(file)) == null ? void 0 : _a.type);
                  })));
                  FileItem($$anchor5, {
                    get item() {
                      return get(file);
                    },
                    get name() {
                      return get(file), untrack(() => get(file).name);
                    },
                    get type() {
                      return get(file), untrack(() => get(file).type);
                    },
                    get size() {
                      return get($0);
                    },
                    get loading() {
                      return get($1);
                    },
                    dismissible: true,
                    edit: true,
                    small: true,
                    get modal() {
                      return get($2);
                    },
                    $$events: {
                      dismiss: async () => {
                        files().splice(fileIdx, 1);
                        files(files());
                      },
                      click: () => {
                        console.log(get(file));
                      }
                    }
                  });
                }
              };
              if_block(node_10, ($$render) => {
                if (get(file), untrack(() => get(file).type === "image")) $$render(consequent_3);
                else $$render(alternate, false);
              });
            }
            append($$anchor4, fragment_1);
          });
          reset(div_15);
          append($$anchor3, div_15);
        };
        if_block(node_9, ($$render) => {
          if (deep_read_state(files()), untrack(() => files().length > 0)) $$render(consequent_4);
        });
      }
      var div_19 = sibling(node_9, 2);
      var div_20 = child(div_19);
      var node_13 = child(div_20);
      {
        var consequent_5 = ($$anchor3) => {
          var fragment_4 = comment();
          var node_14 = first_child(fragment_4);
          key(
            node_14,
            () => ($settings(), untrack(() => {
              var _a;
              return ((_a = $settings()) == null ? void 0 : _a.richTextInput) ?? true;
            })),
            ($$anchor4) => {
              var fragment_5 = comment();
              var node_15 = first_child(fragment_5);
              key(
                node_15,
                () => ($settings(), untrack(() => {
                  var _a;
                  return ((_a = $settings()) == null ? void 0 : _a.showFormattingToolbar) ?? false;
                })),
                ($$anchor5) => {
                  {
                    let $0 = derived_safe_equal(() => ($settings(), untrack(() => {
                      var _a;
                      return ((_a = $settings()) == null ? void 0 : _a.richTextInput) ?? true;
                    })));
                    let $1 = derived_safe_equal(() => ($settings(), untrack(() => {
                      var _a;
                      return ((_a = $settings()) == null ? void 0 : _a.showFormattingToolbar) ?? false;
                    })));
                    let $2 = derived_safe_equal(() => ($settings(), untrack(() => {
                      var _a;
                      return ((_a = $settings()) == null ? void 0 : _a.insertPromptAsRichText) ?? false;
                    })));
                    let $3 = derived_safe_equal(() => ($settings(), $mobile(), untrack(() => {
                      var _a;
                      return !(((_a = $settings()) == null ? void 0 : _a.ctrlEnterToSend) ?? false) && !$mobile() && !("ontouchstart" in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0);
                    })));
                    let $4 = derived_safe_equal(() => (deep_read_state(placeholder()), $i18n(), untrack(() => placeholder() ? placeholder() : $i18n().t("Send a Message"))));
                    let $5 = derived_safe_equal(() => ($settings(), get(shiftKey), untrack(() => {
                      var _a;
                      return (((_a = $settings()) == null ? void 0 : _a.largeTextAsFile) ?? false) && !get(shiftKey);
                    })));
                    let $6 = derived_safe_equal(() => ($config(), $settings(), untrack(() => {
                      var _a, _b, _c;
                      return ((_b = (_a = $config()) == null ? void 0 : _a.features) == null ? void 0 : _b.enable_autocomplete_generation) && (((_c = $settings()) == null ? void 0 : _c.promptAutocomplete) ?? false);
                    })));
                    bind_this(
                      RichTextInput($$anchor5, {
                        id: "chat-input",
                        onChange: (e) => {
                          prompt(e.md);
                          set(command, getCommand());
                        },
                        json: true,
                        get richText() {
                          return get($0);
                        },
                        messageInput: true,
                        get showFormattingToolbar() {
                          return get($1);
                        },
                        floatingMenuPlacement: "top-start",
                        get insertPromptAsRichText() {
                          return get($2);
                        },
                        get shiftEnter() {
                          return get($3);
                        },
                        get placeholder() {
                          return get($4);
                        },
                        get largeTextAsFile() {
                          return get($5);
                        },
                        get autocomplete() {
                          return get($6);
                        },
                        generateAutoCompletion: async (text2) => {
                          var _a;
                          if (get(selectedModelIds).length === 0 || !get(selectedModelIds).at(0)) {
                            toast.error($i18n().t("Please select a model first."));
                          }
                          const res = await generateAutoCompletion(localStorage.token, get(selectedModelIds).at(0), text2, ((_a = history()) == null ? void 0 : _a.currentId) ? createMessagesList(history(), history().currentId) : null).catch((error) => {
                            console.log(error);
                            return null;
                          });
                          console.log(res);
                          return res;
                        },
                        get suggestions() {
                          return get(suggestions);
                        },
                        oncompositionstart: () => set(isComposing, true),
                        oncompositionend: (e) => {
                          set(compositionEndedAt, e.timeStamp);
                          set(isComposing, false);
                        },
                        $$events: {
                          keydown: async (e) => {
                            var _a, _b, _c;
                            e = e.detail.event;
                            const isCtrlPressed = e.ctrlKey || e.metaKey;
                            const suggestionsContainerElement = document.getElementById("suggestions-container");
                            if (e.key === "Escape") {
                              stopResponse()();
                            }
                            if (prompt() === "" && e.key == "ArrowUp") {
                              e.preventDefault();
                              const userMessageElement = (_a = [...document.getElementsByClassName("user-message")]) == null ? void 0 : _a.at(-1);
                              if (userMessageElement) {
                                userMessageElement.scrollIntoView({ block: "center" });
                                const editButton = (_b = [
                                  ...document.getElementsByClassName("edit-user-message-button")
                                ]) == null ? void 0 : _b.at(-1);
                                editButton == null ? void 0 : editButton.click();
                              }
                            }
                            if (!suggestionsContainerElement) {
                              if (!$mobile() || !("ontouchstart" in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0)) {
                                if (inOrNearComposition(e)) {
                                  return;
                                }
                                const enterPressed = ((_c = $settings()) == null ? void 0 : _c.ctrlEnterToSend) ?? false ? (e.key === "Enter" || e.keyCode === 13) && isCtrlPressed : (e.key === "Enter" || e.keyCode === 13) && !e.shiftKey;
                                if (enterPressed) {
                                  e.preventDefault();
                                  if (prompt() !== "" || files().length > 0) {
                                    dispatch("submit", prompt());
                                  }
                                }
                              }
                            }
                            if (e.key === "Escape") {
                              console.log("Escape");
                              atSelectedModel(void 0);
                              selectedToolIds([]);
                              selectedFilterIds([]);
                              webSearchEnabled(false);
                              imageGenerationEnabled(false);
                              codeInterpreterEnabled(false);
                            }
                          },
                          paste: async (e) => {
                            var _a;
                            e = e.detail.event;
                            console.log(e);
                            const clipboardData = e.clipboardData || window.clipboardData;
                            if (clipboardData && clipboardData.items) {
                              for (const item of clipboardData.items) {
                                if (item.type.indexOf("image") !== -1) {
                                  const blob = item.getAsFile();
                                  const reader = new FileReader();
                                  reader.onload = function(e2) {
                                    files([...files(), { type: "image", url: `${e2.target.result}` }]);
                                  };
                                  reader.readAsDataURL(blob);
                                } else if ((item == null ? void 0 : item.kind) === "file") {
                                  const file = item.getAsFile();
                                  if (file) {
                                    const _files = [file];
                                    await inputFilesHandler(_files);
                                    e.preventDefault();
                                  }
                                } else if (item.type === "text/plain") {
                                  if ((((_a = $settings()) == null ? void 0 : _a.largeTextAsFile) ?? false) && !get(shiftKey)) {
                                    const text2 = clipboardData.getData("text/plain");
                                    if (text2.length > PASTED_TEXT_CHARACTER_LIMIT) {
                                      e.preventDefault();
                                      const blob = new Blob([text2], { type: "text/plain" });
                                      const file = new File([blob], `Pasted_Text_${Date.now()}.txt`, { type: "text/plain" });
                                      await uploadFileHandler(file, true);
                                    }
                                  }
                                }
                              }
                            }
                          }
                        },
                        $$legacy: true
                      }),
                      ($$value) => set(chatInputElement, $$value),
                      () => get(chatInputElement)
                    );
                  }
                }
              );
              append($$anchor4, fragment_5);
            }
          );
          append($$anchor3, fragment_4);
        };
        if_block(node_13, ($$render) => {
          if (get(suggestions)) $$render(consequent_5);
        });
      }
      reset(div_20);
      reset(div_19);
      var div_21 = sibling(div_19, 2);
      var div_22 = child(div_21);
      var node_16 = child(div_22);
      {
        let $0 = derived_safe_equal(() => (deep_read_state(atSelectedModel()), deep_read_state(selectedModels()), untrack(() => atSelectedModel() ? [atSelectedModel().id] : selectedModels())));
        InputMenu(node_16, {
          get selectedModels() {
            return get($0);
          },
          get fileUploadCapableModels() {
            return get(fileUploadCapableModels);
          },
          screenCaptureHandler,
          inputFilesHandler,
          uploadFilesHandler: () => {
            get(filesInputElement).click();
          },
          uploadGoogleDriveHandler: async () => {
            try {
              const fileData = await createPicker();
              if (fileData) {
                const file = new File([fileData.blob], fileData.name, { type: fileData.blob.type });
                await uploadFileHandler(file);
              } else {
                console.log("No file was selected from Google Drive");
              }
            } catch (error) {
              console.error("Google Drive Error:", error);
              toast.error($i18n().t("Error accessing Google Drive: {{error}}", { error: error.message }));
            }
          },
          uploadOneDriveHandler: async (authorityType) => {
            try {
              const fileData = await pickAndDownloadFile(authorityType);
              if (fileData) {
                const file = new File([fileData.blob], fileData.name, { type: fileData.blob.type || "application/octet-stream" });
                await uploadFileHandler(file);
              } else {
                console.log("No file was selected from OneDrive");
              }
            } catch (error) {
              console.error("OneDrive Error:", error);
            }
          },
          onUpload: async (e) => {
            dispatch("upload", e);
          },
          onClose: async () => {
            await tick();
            const chatInput = document.getElementById("chat-input");
            chatInput == null ? void 0 : chatInput.focus();
          },
          get files() {
            return files();
          },
          set files($$value) {
            files($$value);
          },
          children: ($$anchor3, $$slotProps) => {
            var div_23 = root_13$5();
            var node_17 = child(div_23);
            PlusAlt(node_17, { className: "size-5.5" });
            reset(div_23);
            append($$anchor3, div_23);
          },
          $$slots: { default: true },
          $$legacy: true
        });
      }
      var node_18 = sibling(node_16, 2);
      {
        var consequent_6 = ($$anchor3) => {
          var fragment_7 = root_14$3();
          var node_19 = sibling(first_child(fragment_7), 2);
          {
            let $0 = derived_safe_equal(() => (deep_read_state(atSelectedModel()), deep_read_state(selectedModels()), untrack(() => atSelectedModel() ? [atSelectedModel().id] : selectedModels())));
            IntegrationsMenu(node_19, {
              get selectedModels() {
                return get($0);
              },
              get toggleFilters() {
                return get(toggleFilters);
              },
              get showWebSearchButton() {
                return get(showWebSearchButton);
              },
              get showImageGenerationButton() {
                return get(showImageGenerationButton);
              },
              get showCodeInterpreterButton() {
                return get(showCodeInterpreterButton);
              },
              get closeOnOutsideClick() {
                return get(integrationsMenuCloseOnOutsideClick);
              },
              onShowValves: (e) => {
                const { type, id } = e;
                set(selectedValvesType, type);
                set(selectedValvesItemId, id);
                set(showValvesModal, true);
                set(integrationsMenuCloseOnOutsideClick, false);
              },
              onClose: async () => {
                await tick();
                const chatInput = document.getElementById("chat-input");
                chatInput == null ? void 0 : chatInput.focus();
              },
              get selectedToolIds() {
                return selectedToolIds();
              },
              set selectedToolIds($$value) {
                selectedToolIds($$value);
              },
              get selectedFilterIds() {
                return selectedFilterIds();
              },
              set selectedFilterIds($$value) {
                selectedFilterIds($$value);
              },
              get webSearchEnabled() {
                return webSearchEnabled();
              },
              set webSearchEnabled($$value) {
                webSearchEnabled($$value);
              },
              get imageGenerationEnabled() {
                return imageGenerationEnabled();
              },
              set imageGenerationEnabled($$value) {
                imageGenerationEnabled($$value);
              },
              get codeInterpreterEnabled() {
                return codeInterpreterEnabled();
              },
              set codeInterpreterEnabled($$value) {
                codeInterpreterEnabled($$value);
              },
              children: ($$anchor4, $$slotProps) => {
                var div_24 = root_15$3();
                var node_20 = child(div_24);
                Component(node_20, { className: "size-4.5", strokeWidth: "1.5" });
                reset(div_24);
                append($$anchor4, div_24);
              },
              $$slots: { default: true },
              $$legacy: true
            });
          }
          append($$anchor3, fragment_7);
        };
        if_block(node_18, ($$render) => {
          if (get(showWebSearchButton), get(showImageGenerationButton), get(showCodeInterpreterButton), get(showToolsButton), get(toggleFilters), untrack(() => get(showWebSearchButton) || get(showImageGenerationButton) || get(showCodeInterpreterButton) || get(showToolsButton) || get(toggleFilters) && get(toggleFilters).length > 0)) $$render(consequent_6);
        });
      }
      var node_21 = sibling(node_18, 2);
      {
        var consequent_7 = ($$anchor3) => {
          var div_25 = root_16$2();
          var node_22 = child(div_25);
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Valves"))));
            Tooltip(node_22, {
              get content() {
                return get($0);
              },
              placement: "top",
              children: ($$anchor4, $$slotProps) => {
                var button_4 = root_17$3();
                var node_23 = child(button_4);
                Knobs(node_23, { className: "size-4", strokeWidth: "1.5" });
                reset(button_4);
                event("click", button_4, () => {
                  var _a;
                  set(selectedValvesType, "function");
                  set(selectedValvesItemId, (_a = get(selectedModelIds)[0]) == null ? void 0 : _a.split(".")[0]);
                  set(showValvesModal, true);
                });
                append($$anchor4, button_4);
              },
              $$slots: { default: true }
            });
          }
          reset(div_25);
          append($$anchor3, div_25);
        };
        if_block(node_21, ($$render) => {
          if (get(selectedModelIds), $models(), untrack(() => {
            var _a;
            return get(selectedModelIds).length === 1 && ((_a = $models().find((m) => m.id === get(selectedModelIds)[0])) == null ? void 0 : _a.has_user_valves);
          })) $$render(consequent_7);
        });
      }
      var div_26 = sibling(node_21, 2);
      var node_24 = child(div_26);
      {
        var consequent_8 = ($$anchor3) => {
          {
            let $0 = derived_safe_equal(() => ($i18n(), deep_read_state(selectedToolIds()), untrack(() => $i18n().t("{{COUNT}} Available Tools", { COUNT: selectedToolIds().length }))));
            Tooltip($$anchor3, {
              get content() {
                return get($0);
              },
              children: ($$anchor4, $$slotProps) => {
                var button_5 = root_19$2();
                var node_25 = child(button_5);
                Wrench(node_25, { className: "size-4", strokeWidth: "1.75" });
                var span_1 = sibling(node_25, 2);
                var text_2 = child(span_1, true);
                reset(span_1);
                reset(button_5);
                template_effect(() => set_text(text_2, (deep_read_state(selectedToolIds()), untrack(() => selectedToolIds().length))));
                event("click", button_5, () => {
                  set(showTools, !get(showTools));
                });
                append($$anchor4, button_5);
              },
              $$slots: { default: true }
            });
          }
        };
        if_block(node_24, ($$render) => {
          if (deep_read_state(selectedToolIds()), untrack(() => (selectedToolIds() ?? []).length > 0)) $$render(consequent_8);
        });
      }
      var node_26 = sibling(node_24, 2);
      each(node_26, 1, selectedFilterIds, index, ($$anchor3, filterId) => {
        const filter = derived_safe_equal(() => (get(toggleFilters), get(filterId), untrack(() => get(toggleFilters).find((f) => f.id === get(filterId)))));
        var fragment_9 = comment();
        var node_27 = first_child(fragment_9);
        {
          var consequent_10 = ($$anchor4) => {
            {
              let $0 = derived_safe_equal(() => (deep_read_state(get(filter)), untrack(() => {
                var _a;
                return (_a = get(filter)) == null ? void 0 : _a.name;
              })));
              Tooltip($$anchor4, {
                get content() {
                  return get($0);
                },
                placement: "top",
                children: ($$anchor5, $$slotProps) => {
                  var button_6 = root_22$1();
                  var node_28 = child(button_6);
                  {
                    var consequent_9 = ($$anchor6) => {
                      var div_27 = root_23();
                      var img_1 = child(div_27);
                      reset(div_27);
                      template_effect(
                        ($02) => {
                          set_attribute(img_1, "src", (deep_read_state(get(filter)), untrack(() => get(filter).icon)));
                          set_class(img_1, 1, `size-3.5 ${$02 ?? ""}`);
                          set_attribute(img_1, "alt", (deep_read_state(get(filter)), untrack(() => get(filter).name)));
                        },
                        [
                          () => (deep_read_state(get(filter)), untrack(() => get(filter).icon.includes("svg") ? "dark:invert-[80%]" : ""))
                        ]
                      );
                      append($$anchor6, div_27);
                    };
                    var alternate_1 = ($$anchor6) => {
                      Sparkles($$anchor6, { className: "size-4", strokeWidth: "1.75" });
                    };
                    if_block(node_28, ($$render) => {
                      if (deep_read_state(get(filter)), untrack(() => {
                        var _a;
                        return (_a = get(filter)) == null ? void 0 : _a.icon;
                      })) $$render(consequent_9);
                      else $$render(alternate_1, false);
                    });
                  }
                  var div_28 = sibling(node_28, 2);
                  var node_29 = child(div_28);
                  XMark(node_29, { className: "size-4", strokeWidth: "1.75" });
                  reset(div_28);
                  reset(button_6);
                  template_effect(($02) => set_class(button_6, 1, `group p-[7px] flex gap-1.5 items-center text-sm rounded-full transition-colors duration-300 focus:outline-hidden max-w-full overflow-hidden ${$02 ?? ""} capitalize`), [
                    () => (deep_read_state(selectedFilterIds()), get(filterId), untrack(() => selectedFilterIds().includes(get(filterId)) ? "text-sky-500 dark:text-sky-300 bg-sky-50 hover:bg-sky-100 dark:bg-sky-400/10 dark:hover:bg-sky-600/10 border border-sky-200/40 dark:border-sky-500/20" : "bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 "))
                  ]);
                  event("click", button_6, preventDefault(() => {
                    selectedFilterIds(selectedFilterIds().filter((id) => id !== get(filterId)));
                  }));
                  append($$anchor5, button_6);
                },
                $$slots: { default: true }
              });
            }
          };
          if_block(node_27, ($$render) => {
            if (get(filter)) $$render(consequent_10);
          });
        }
        append($$anchor3, fragment_9);
      });
      var node_30 = sibling(node_26, 2);
      {
        var consequent_11 = ($$anchor3) => {
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Web Search"))));
            Tooltip($$anchor3, {
              get content() {
                return get($0);
              },
              placement: "top",
              children: ($$anchor4, $$slotProps) => {
                var button_7 = root_26$1();
                var node_31 = child(button_7);
                GlobeAlt(node_31, { className: "size-4", strokeWidth: "1.75" });
                var div_29 = sibling(node_31, 2);
                var node_32 = child(div_29);
                XMark(node_32, { className: "size-4", strokeWidth: "1.75" });
                reset(div_29);
                reset(button_7);
                template_effect(() => set_class(button_7, 1, `group p-[7px] flex gap-1.5 items-center text-sm rounded-full transition-colors duration-300 focus:outline-hidden max-w-full overflow-hidden ${(deep_read_state(webSearchEnabled()), $settings(), untrack(() => {
                  var _a;
                  return webSearchEnabled() || (((_a = $settings()) == null ? void 0 : _a.webSearch) ?? false) === "always" ? " text-sky-500 dark:text-sky-300 bg-sky-50 hover:bg-sky-100 dark:bg-sky-400/10 dark:hover:bg-sky-600/10 border border-sky-200/40 dark:border-sky-500/20" : "bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 ";
                })) ?? ""}`));
                event("click", button_7, preventDefault(() => webSearchEnabled(!webSearchEnabled())));
                append($$anchor4, button_7);
              },
              $$slots: { default: true }
            });
          }
        };
        if_block(node_30, ($$render) => {
          if (webSearchEnabled()) $$render(consequent_11);
        });
      }
      var node_33 = sibling(node_30, 2);
      {
        var consequent_12 = ($$anchor3) => {
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Image"))));
            Tooltip($$anchor3, {
              get content() {
                return get($0);
              },
              placement: "top",
              children: ($$anchor4, $$slotProps) => {
                var button_8 = root_28();
                var node_34 = child(button_8);
                Photo(node_34, { className: "size-4", strokeWidth: "1.75" });
                var div_30 = sibling(node_34, 2);
                var node_35 = child(div_30);
                XMark(node_35, { className: "size-4", strokeWidth: "1.75" });
                reset(div_30);
                reset(button_8);
                template_effect(() => set_class(button_8, 1, `group p-[7px] flex gap-1.5 items-center text-sm rounded-full transition-colors duration-300 focus:outline-hidden max-w-full overflow-hidden ${imageGenerationEnabled() ? " text-sky-500 dark:text-sky-300 bg-sky-50 hover:bg-sky-100 dark:bg-sky-400/10 dark:hover:bg-sky-700/10 border border-sky-200/40 dark:border-sky-500/20" : "bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 "}`));
                event("click", button_8, preventDefault(() => imageGenerationEnabled(!imageGenerationEnabled())));
                append($$anchor4, button_8);
              },
              $$slots: { default: true }
            });
          }
        };
        if_block(node_33, ($$render) => {
          if (imageGenerationEnabled()) $$render(consequent_12);
        });
      }
      var node_36 = sibling(node_33, 2);
      {
        var consequent_13 = ($$anchor3) => {
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Code Interpreter"))));
            Tooltip($$anchor3, {
              get content() {
                return get($0);
              },
              placement: "top",
              children: ($$anchor4, $$slotProps) => {
                var button_9 = root_30();
                var node_37 = child(button_9);
                Terminal(node_37, { className: "size-3.5", strokeWidth: "2" });
                var div_31 = sibling(node_37, 2);
                var node_38 = child(div_31);
                XMark(node_38, { className: "size-4", strokeWidth: "1.75" });
                reset(div_31);
                reset(button_9);
                template_effect(
                  ($02) => {
                    set_attribute(button_9, "aria-label", $02);
                    set_attribute(button_9, "aria-pressed", codeInterpreterEnabled());
                    set_class(button_9, 1, ` group p-[7px] flex gap-1.5 items-center text-sm transition-colors duration-300 max-w-full overflow-hidden ${codeInterpreterEnabled() ? " text-sky-500 dark:text-sky-300 bg-sky-50 hover:bg-sky-100 dark:bg-sky-400/10 dark:hover:bg-sky-700/10 border border-sky-200/40 dark:border-sky-500/20" : "bg-transparent text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 "} ${($settings(), untrack(() => {
                      var _a;
                      return ((_a = $settings()) == null ? void 0 : _a.highContrastMode) ?? false ? "m-1" : "focus:outline-hidden rounded-full";
                    })) ?? ""}`);
                  },
                  [
                    () => (deep_read_state(codeInterpreterEnabled()), $i18n(), untrack(() => codeInterpreterEnabled() ? $i18n().t("Disable Code Interpreter") : $i18n().t("Enable Code Interpreter")))
                  ]
                );
                event("click", button_9, preventDefault(() => codeInterpreterEnabled(!codeInterpreterEnabled())));
                append($$anchor4, button_9);
              },
              $$slots: { default: true }
            });
          }
        };
        if_block(node_36, ($$render) => {
          if (codeInterpreterEnabled()) $$render(consequent_13);
        });
      }
      reset(div_26);
      reset(div_22);
      var div_32 = sibling(div_22, 2);
      var node_39 = child(div_32);
      {
        var consequent_14 = ($$anchor3) => {
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Dictate"))));
            Tooltip($$anchor3, {
              get content() {
                return get($0);
              },
              children: ($$anchor4, $$slotProps) => {
                var button_10 = root_32();
                event("click", button_10, async () => {
                  try {
                    let stream = await navigator.mediaDevices.getUserMedia({ audio: true }).catch(function(err) {
                      toast.error($i18n().t(`Permission denied when accessing microphone: {{error}}`, { error: err }));
                      return null;
                    });
                    if (stream) {
                      set(recording, true);
                      const tracks = stream.getTracks();
                      tracks.forEach((track) => track.stop());
                    }
                    stream = null;
                  } catch {
                    toast.error($i18n().t("Permission denied when accessing microphone"));
                  }
                });
                append($$anchor4, button_10);
              },
              $$slots: { default: true }
            });
          }
        };
        if_block(node_39, ($$render) => {
          if (deep_read_state(history()), $_user(), untrack(() => {
            var _a, _b, _c, _d, _e, _f;
            return (!((_a = history()) == null ? void 0 : _a.currentId) || ((_b = history().messages[history().currentId]) == null ? void 0 : _b.done) == true) && (((_c = $_user()) == null ? void 0 : _c.role) === "admin" || (((_f = (_e = (_d = $_user()) == null ? void 0 : _d.permissions) == null ? void 0 : _e.chat) == null ? void 0 : _f.stt) ?? true));
          })) $$render(consequent_14);
        });
      }
      var node_40 = sibling(node_39, 2);
      {
        var consequent_15 = ($$anchor3) => {
          var div_33 = root_33();
          var node_41 = child(div_33);
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Stop"))));
            Tooltip(node_41, {
              get content() {
                return get($0);
              },
              children: ($$anchor4, $$slotProps) => {
                var button_11 = root_34();
                event("click", button_11, () => {
                  stopResponse()();
                });
                append($$anchor4, button_11);
              },
              $$slots: { default: true }
            });
          }
          reset(div_33);
          append($$anchor3, div_33);
        };
        var alternate_3 = ($$anchor3) => {
          var fragment_16 = comment();
          var node_42 = first_child(fragment_16);
          {
            var consequent_16 = ($$anchor4) => {
              var div_34 = root_36();
              var node_43 = child(div_34);
              {
                let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Voice mode"))));
                Tooltip(node_43, {
                  get content() {
                    return get($0);
                  },
                  children: ($$anchor5, $$slotProps) => {
                    var button_12 = root_37();
                    var node_44 = child(button_12);
                    Voice(node_44, { className: "size-5", strokeWidth: "2.5" });
                    reset(button_12);
                    template_effect(($02) => set_attribute(button_12, "aria-label", $02), [() => ($i18n(), untrack(() => $i18n().t("Voice mode")))]);
                    event("click", button_12, async () => {
                      var _a, _b, _c, _d, _e;
                      if (selectedModels().length > 1) {
                        toast.error($i18n().t("Select only one model to call"));
                        return;
                      }
                      if ($config().audio.stt.engine === "web") {
                        toast.error($i18n().t("Call feature is not supported when using Web STT engine"));
                        return;
                      }
                      try {
                        let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        if (stream) {
                          const tracks = stream.getTracks();
                          tracks.forEach((track) => track.stop());
                        }
                        stream = null;
                        if (((_b = (_a = $settings().audio) == null ? void 0 : _a.tts) == null ? void 0 : _b.engine) === "browser-kokoro") {
                          if (!$TTSWorker()) {
                            await TTSWorker.set(new KokoroWorker({ dtype: ((_e = (_d = (_c = $settings().audio) == null ? void 0 : _c.tts) == null ? void 0 : _d.engineConfig) == null ? void 0 : _e.dtype) ?? "fp32" }));
                            await $TTSWorker().init();
                          }
                        }
                        showCallOverlay.set(true);
                        showControls.set(true);
                      } catch (err) {
                        toast.error($i18n().t("Permission denied when accessing media devices"));
                      }
                    });
                    append($$anchor5, button_12);
                  },
                  $$slots: { default: true }
                });
              }
              reset(div_34);
              append($$anchor4, div_34);
            };
            var alternate_2 = ($$anchor4) => {
              var div_35 = root_38();
              var node_45 = child(div_35);
              {
                let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Send message"))));
                Tooltip(node_45, {
                  get content() {
                    return get($0);
                  },
                  children: ($$anchor5, $$slotProps) => {
                    var button_13 = root_39();
                    template_effect(() => {
                      set_class(button_13, 1, `${(deep_read_state(prompt()), deep_read_state(files()), untrack(() => !(prompt() === "" && files().length === 0) ? "bg-black text-white hover:bg-gray-900 dark:bg-white dark:text-black dark:hover:bg-gray-100 " : "text-white bg-gray-200 dark:text-gray-900 dark:bg-gray-700 disabled")) ?? ""} transition rounded-full p-1.5 self-center`);
                      button_13.disabled = (deep_read_state(prompt()), deep_read_state(files()), untrack(() => prompt() === "" && files().length === 0));
                    });
                    append($$anchor5, button_13);
                  },
                  $$slots: { default: true }
                });
              }
              reset(div_35);
              append($$anchor4, div_35);
            };
            if_block(
              node_42,
              ($$render) => {
                if (deep_read_state(prompt()), deep_read_state(files()), $_user(), untrack(() => {
                  var _a, _b, _c, _d;
                  return prompt() === "" && files().length === 0 && (((_a = $_user()) == null ? void 0 : _a.role) === "admin" || (((_d = (_c = (_b = $_user()) == null ? void 0 : _b.permissions) == null ? void 0 : _c.chat) == null ? void 0 : _d.call) ?? true));
                })) $$render(consequent_16);
                else $$render(alternate_2, false);
              },
              true
            );
          }
          append($$anchor3, fragment_16);
        };
        if_block(node_40, ($$render) => {
          if (deep_read_state(taskIds()), deep_read_state(history()), deep_read_state(generating()), untrack(() => {
            var _a;
            return taskIds() && taskIds().length > 0 || history().currentId && ((_a = history().messages[history().currentId]) == null ? void 0 : _a.done) != true || generating();
          })) $$render(consequent_15);
          else $$render(alternate_3, false);
        });
      }
      reset(div_32);
      reset(div_21);
      reset(div_9);
      var node_46 = sibling(div_9, 2);
      {
        var consequent_17 = ($$anchor3) => {
          var div_36 = root_40();
          var node_47 = child(div_36);
          html(node_47, () => (deep_read_state(purify), deep_read_state(marked), $config(), untrack(() => {
            var _a, _b;
            return purify.sanitize(marked((_b = (_a = $config()) == null ? void 0 : _a.license_metadata) == null ? void 0 : _b.input_footer));
          })));
          reset(div_36);
          append($$anchor3, div_36);
        };
        var alternate_4 = ($$anchor3) => {
          var div_37 = root_41();
          append($$anchor3, div_37);
        };
        if_block(node_46, ($$render) => {
          if ($config(), untrack(() => {
            var _a, _b;
            return (_b = (_a = $config()) == null ? void 0 : _a.license_metadata) == null ? void 0 : _b.input_footer;
          })) $$render(consequent_17);
          else $$render(alternate_4, false);
        });
      }
      reset(form);
      reset(div_7);
      reset(div_6);
      reset(div_5);
      reset(div);
      template_effect(() => {
        set_class(div_2, 1, `flex flex-col px-3 ${($settings(), untrack(() => {
          var _a;
          return ((_a = $settings()) == null ? void 0 : _a.widescreenMode) ?? null ? "max-w-full" : "max-w-6xl";
        })) ?? ""} w-full`);
        set_class(div_6, 1, `${($settings(), untrack(() => {
          var _a;
          return ((_a = $settings()) == null ? void 0 : _a.widescreenMode) ?? null ? "max-w-full" : "max-w-6xl";
        })) ?? ""} px-2.5 mx-auto inset-x-0`);
        set_class(div_8, 1, clsx(get(recording) ? "" : "hidden"));
        set_class(form, 1, `w-full flex flex-col gap-1.5 ${get(recording) ? "hidden" : ""}`);
        set_class(div_9, 1, `flex-1 flex flex-col relative w-full shadow-lg rounded-3xl border ${$temporaryChatEnabled() ? "border-dashed border-gray-100 dark:border-gray-800 hover:border-gray-200 focus-within:border-gray-200 hover:dark:border-gray-700 focus-within:dark:border-gray-700" : " border-gray-100 dark:border-gray-850 hover:border-gray-200 focus-within:border-gray-100 hover:dark:border-gray-800 focus-within:dark:border-gray-800"}  transition px-1 bg-white/5 dark:bg-gray-500/5 backdrop-blur-sm dark:text-gray-100`);
        set_attribute(div_9, "dir", ($settings(), untrack(() => {
          var _a;
          return ((_a = $settings()) == null ? void 0 : _a.chatDirection) ?? "auto";
        })));
        set_class(div_20, 1, `scrollbar-hidden rtl:text-right ltr:text-left bg-transparent dark:text-gray-100 outline-hidden w-full pb-1 px-1 resize-none h-fit max-h-96 overflow-auto ${(deep_read_state(files()), deep_read_state(atSelectedModel()), untrack(() => files().length === 0 ? atSelectedModel() !== void 0 ? "pt-1.5" : "pt-2.5" : "")) ?? ""}`);
        div_21.dir = div_21.dir;
        div_9.dir = div_9.dir;
      });
      bind_files(input, () => get(inputFiles), ($$value) => set(inputFiles, $$value));
      event("change", input, async () => {
        if (get(inputFiles) && get(inputFiles).length > 0) {
          const _inputFiles = Array.from(get(inputFiles));
          inputFilesHandler(_inputFiles);
        } else {
          toast.error($i18n().t(`File not found.`));
        }
        mutate(filesInputElement, get(filesInputElement).value = "");
      });
      event(
        "click",
        button_1,
        // check if selectedModels support image input
        () => createMessagePair()(prompt())
      );
      event("submit", form, preventDefault(() => {
        dispatch("submit", prompt());
      }));
      append($$anchor2, div);
    };
    if_block(node_4, ($$render) => {
      if (get(loaded)) $$render(consequent_18);
    });
  }
  append($$anchor, fragment);
  bind_prop($$props, "setText", setText);
  var $$pop = pop($$exports);
  $$cleanup();
  return $$pop;
}
var root_4$4 = from_html(`<button class=" " aria-label="Add Model"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="size-3.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6"></path></svg></button>`);
var root_3$8 = from_html(`<div class="  self-center mx-1 disabled:text-gray-600 disabled:hover:text-gray-600 -translate-y-[0.5px]"><!></div>`);
var root_6$a = from_html(`<button aria-label="Remove Model"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="size-3"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15"></path></svg></button>`);
var root_5$7 = from_html(`<div class="  self-center mx-1 disabled:text-gray-600 disabled:hover:text-gray-600 -translate-y-[0.5px]"><!></div>`);
var root_1$9 = from_html(`<div class="flex w-full max-w-fit"><div class="overflow-hidden w-full"><div><!></div></div> <!></div>`);
var root_7$7 = from_html(`<div class="relative text-left mt-[1px] ml-1 text-[0.7rem] text-gray-600 dark:text-gray-400 font-primary"><button> </button></div>`);
var root$d = from_html(`<div class="flex flex-col w-full items-start"></div> <!>`, 1);
function ModelSelector($$anchor, $$props) {
  push($$props, false);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const $settings = () => store_get(settings, "$settings", $$stores);
  const $models = () => store_get(models, "$models", $$stores);
  const $user = () => store_get(user, "$user", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const i18n = getContext("i18n");
  let selectedModels = prop($$props, "selectedModels", 28, () => [""]);
  let disabled = prop($$props, "disabled", 8, false);
  let showSetDefault = prop($$props, "showSetDefault", 8, true);
  const saveDefaultModel = async () => {
    const hasEmptyModel = selectedModels().filter((it) => it === "");
    if (hasEmptyModel.length) {
      toast.error($i18n().t("Choose a model before saving..."));
      return;
    }
    settings.set({ ...$settings(), models: selectedModels() });
    await updateUserSettings(localStorage.token, { ui: $settings() });
    toast.success($i18n().t("Default model updated"));
  };
  const pinModelHandler = async (modelId) => {
    var _a;
    let pinnedModels = ((_a = $settings()) == null ? void 0 : _a.pinnedModels) ?? [];
    if (pinnedModels.includes(modelId)) {
      pinnedModels = pinnedModels.filter((id) => id !== modelId);
    } else {
      pinnedModels = [.../* @__PURE__ */ new Set([...pinnedModels, modelId])];
    }
    settings.set({ ...$settings(), pinnedModels });
    await updateUserSettings(localStorage.token, { ui: $settings() });
  };
  legacy_pre_effect(() => (deep_read_state(selectedModels()), $models()), () => {
    if (selectedModels().length > 0 && $models().length > 0) {
      const _selectedModels = selectedModels().map((model) => $models().map((m) => m.id).includes(model) ? model : "");
      if (JSON.stringify(_selectedModels) !== JSON.stringify(selectedModels())) {
        selectedModels(_selectedModels);
      }
    }
  });
  legacy_pre_effect_reset();
  init();
  var fragment = root$d();
  var div = first_child(fragment);
  each(div, 5, selectedModels, index, ($$anchor2, selectedModel, selectedModelIdx) => {
    var div_1 = root_1$9();
    var div_2 = child(div_1);
    var div_3 = child(div_2);
    var node = child(div_3);
    {
      let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Select a model"))));
      let $1 = derived_safe_equal(() => ($models(), untrack(() => $models().map((model) => ({ value: model.id, label: model.name, model })))));
      Selector(node, {
        id: `${selectedModelIdx}`,
        get placeholder() {
          return get($0);
        },
        get items() {
          return get($1);
        },
        pinModelHandler,
        get value() {
          return selectedModels()[selectedModelIdx];
        },
        set value($$value) {
          selectedModels()[selectedModelIdx] = $$value, invalidate_inner_signals(() => selectedModels());
        },
        $$legacy: true
      });
    }
    reset(div_3);
    reset(div_2);
    var node_1 = sibling(div_2, 2);
    {
      var consequent_1 = ($$anchor3) => {
        var fragment_1 = comment();
        var node_2 = first_child(fragment_1);
        {
          var consequent = ($$anchor4) => {
            var div_4 = root_3$8();
            var node_3 = child(div_4);
            {
              let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Add Model"))));
              Tooltip(node_3, {
                get content() {
                  return get($0);
                },
                children: ($$anchor5, $$slotProps) => {
                  var button = root_4$4();
                  template_effect(() => button.disabled = disabled());
                  event("click", button, () => {
                    selectedModels([...selectedModels(), ""]);
                  });
                  append($$anchor5, button);
                },
                $$slots: { default: true }
              });
            }
            reset(div_4);
            append($$anchor4, div_4);
          };
          var alternate = ($$anchor4) => {
            var div_5 = root_5$7();
            var node_4 = child(div_5);
            {
              let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Remove Model"))));
              Tooltip(node_4, {
                get content() {
                  return get($0);
                },
                children: ($$anchor5, $$slotProps) => {
                  var button_1 = root_6$a();
                  template_effect(() => button_1.disabled = disabled());
                  event("click", button_1, () => {
                    selectedModels().splice(selectedModelIdx, 1);
                    selectedModels(selectedModels());
                  });
                  append($$anchor5, button_1);
                },
                $$slots: { default: true }
              });
            }
            reset(div_5);
            append($$anchor4, div_5);
          };
          if_block(node_2, ($$render) => {
            if (selectedModelIdx === 0) $$render(consequent);
            else $$render(alternate, false);
          });
        }
        append($$anchor3, fragment_1);
      };
      if_block(node_1, ($$render) => {
        if ($user(), untrack(() => {
          var _a, _b, _c, _d;
          return ((_a = $user()) == null ? void 0 : _a.role) === "admin" || (((_d = (_c = (_b = $user()) == null ? void 0 : _b.permissions) == null ? void 0 : _c.chat) == null ? void 0 : _d.multiple_models) ?? true);
        })) $$render(consequent_1);
      });
    }
    reset(div_1);
    template_effect(() => set_class(div_3, 1, `max-w-full ${($settings(), untrack(() => {
      var _a;
      return ((_a = $settings()) == null ? void 0 : _a.highContrastMode) ?? false ? "m-1" : "mr-1";
    })) ?? ""}`));
    append($$anchor2, div_1);
  });
  reset(div);
  var node_5 = sibling(div, 2);
  {
    var consequent_2 = ($$anchor2) => {
      var div_6 = root_7$7();
      var button_2 = child(div_6);
      var text2 = child(button_2, true);
      reset(button_2);
      reset(div_6);
      template_effect(($0) => set_text(text2, $0), [
        () => ($i18n(), untrack(() => $i18n().t("Set as default")))
      ]);
      event("click", button_2, saveDefaultModel);
      append($$anchor2, div_6);
    };
    if_block(node_5, ($$render) => {
      if (showSetDefault()) $$render(consequent_2);
    });
  }
  append($$anchor, fragment);
  pop();
  $$cleanup();
}
var root$c = from_svg(`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75"></path></svg>`);
function AdjustmentsHorizontal($$anchor, $$props) {
  let className = prop($$props, "className", 8, "w-4 h-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "1.5");
  var svg = root$c();
  template_effect(() => {
    set_class(svg, 0, clsx(className()));
    set_attribute(svg, "stroke-width", strokeWidth());
  });
  append($$anchor, svg);
}
var root_1$8 = from_html(`<div class="hidden w-full h-full flex-col"><div id="full-messages-container"><!></div></div>`);
var root_6$9 = from_html(`<!> <div class="flex items-center"> </div>`, 1);
var root_7$6 = from_html(`<!> <div class="flex items-center"> </div>`, 1);
var root_9$2 = from_html(`<!> <div class="flex items-center"> </div>`, 1);
var root_11$5 = from_html(`<!> <div class="flex items-center"> </div>`, 1);
var root_13$4 = from_html(`<!> <div class="flex items-center"> </div>`, 1);
var root_16$1 = from_html(`<div class="flex items-center line-clamp-1"> </div>`);
var root_17$2 = from_html(`<div class="flex items-center line-clamp-1"> </div>`);
var root_18$1 = from_html(`<div class="flex items-center line-clamp-1"> </div>`);
var root_14$2 = from_html(`<!> <!> <!>`, 1);
var root_12$2 = from_html(`<!> <!>`, 1);
var root_19$1 = from_html(`<!> <div class="flex items-center"> </div>`, 1);
var root_22 = from_html(`<!> <div class="flex items-center"> </div>`, 1);
var root_25 = from_html(`<!> <div class="flex items-center"> </div>`, 1);
var root_21$1 = from_html(`<!> <!>`, 1);
var root_26 = from_html(`<!> <div class="flex items-center"> </div>`, 1);
var root_20$1 = from_html(`<hr class="border-gray-50 dark:border-gray-800 my-1"/> <!> <!> <hr class="border-gray-50 dark:border-gray-800 my-1"/> <div class="flex p-1"><!></div>`, 1);
var root_4$3 = from_html(`<!> <!> <!> <hr class="border-gray-50 dark:border-gray-800 my-1"/> <!> <!> <!> <!>`, 1);
var root_3$7 = from_html(`<div slot="content"><!></div>`);
var root$b = from_html(`<!> <!>`, 1);
function Menu($$anchor, $$props) {
  push($$props, false);
  const $settings = () => store_get(settings, "$settings", $$stores);
  const $temporaryChatEnabled = () => store_get(temporaryChatEnabled, "$temporaryChatEnabled", $$stores);
  const $user = () => store_get(user, "$user", $$stores);
  const $mobile = () => store_get(mobile, "$mobile", $$stores);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const $artifactContents = () => store_get(artifactContents, "$artifactContents", $$stores);
  const $folders = () => store_get(folders$1, "$folders", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const { saveAs } = fileSaver;
  const i18n = getContext("i18n");
  prop($$props, "shareEnabled", 8, false);
  let shareHandler = prop($$props, "shareHandler", 8);
  let moveChatHandler = prop($$props, "moveChatHandler", 8);
  let archiveChatHandler = prop($$props, "archiveChatHandler", 8);
  let chat = prop($$props, "chat", 8);
  let onClose = prop($$props, "onClose", 8, () => {
  });
  let showFullMessages = mutable_source(false);
  const getChatAsText = async () => {
    const history = chat().chat.history;
    const messages = createMessagesList(history, history.currentId);
    const chatText = messages.reduce(
      (a, message, i, arr) => {
        return `${a}### ${message.role.toUpperCase()}
${message.content}

`;
      },
      ""
    );
    return chatText.trim();
  };
  const downloadTxt = async () => {
    const chatText = await getChatAsText();
    let blob = new Blob([chatText], { type: "text/plain" });
    saveAs(blob, `chat-${chat().chat.title}.txt`);
  };
  const downloadPdf = async () => {
    var _a;
    const [{ default: jsPDF }, { default: html2canvas }] = await Promise.all([__vitePreload(() => import("./kq2ZDxMK.js"), true ? __vite__mapDeps([0,1,2]) : void 0, import.meta.url), __vitePreload(() => import("./C8IzhQs1.js"), true ? [] : void 0, import.meta.url)]);
    if (((_a = $settings()) == null ? void 0 : _a.stylizedPdfExport) ?? true) {
      set(showFullMessages, true);
      await tick();
      const containerElement = document.getElementById("full-messages-container");
      if (containerElement) {
        try {
          const isDarkMode = document.documentElement.classList.contains("dark");
          const virtualWidth = 800;
          const clonedElement = containerElement.cloneNode(true);
          clonedElement.classList.add("text-black");
          clonedElement.classList.add("dark:text-white");
          clonedElement.style.width = `${virtualWidth}px`;
          clonedElement.style.position = "absolute";
          clonedElement.style.left = "-9999px";
          clonedElement.style.height = "auto";
          document.body.appendChild(clonedElement);
          await new Promise((r) => setTimeout(r, 100));
          const canvas = await html2canvas(clonedElement, {
            backgroundColor: isDarkMode ? "#000" : "#fff",
            useCORS: true,
            scale: 2,
            // increase resolution
            width: virtualWidth
          });
          document.body.removeChild(clonedElement);
          const pdf = new jsPDF("p", "mm", "a4");
          const pageWidthMM = 210;
          const pageHeightMM = 297;
          const pxPerMM = canvas.width / virtualWidth;
          const pxPerPDFMM = canvas.width / pageWidthMM;
          const pagePixelHeight = Math.floor(pxPerPDFMM * pageHeightMM);
          let offsetY = 0;
          let page2 = 0;
          while (offsetY < canvas.height) {
            const sliceHeight = Math.min(pagePixelHeight, canvas.height - offsetY);
            const pageCanvas = document.createElement("canvas");
            pageCanvas.width = canvas.width;
            pageCanvas.height = sliceHeight;
            const ctx = pageCanvas.getContext("2d");
            ctx.drawImage(canvas, 0, offsetY, canvas.width, sliceHeight, 0, 0, canvas.width, sliceHeight);
            const imgData = pageCanvas.toDataURL("image/jpeg", 0.7);
            const imgHeightMM = sliceHeight * pageWidthMM / canvas.width;
            if (page2 > 0) pdf.addPage();
            if (isDarkMode) {
              pdf.setFillColor(0, 0, 0);
              pdf.rect(0, 0, pageWidthMM, pageHeightMM, "F");
            }
            pdf.addImage(imgData, "JPEG", 0, 0, pageWidthMM, imgHeightMM);
            offsetY += sliceHeight;
            page2++;
          }
          pdf.save(`chat-${chat().chat.title}.pdf`);
          set(showFullMessages, false);
        } catch (error) {
          console.error("Error generating PDF", error);
        }
      }
    } else {
      console.log("Downloading PDF");
      const chatText = await getChatAsText();
      const doc = new jsPDF();
      const left = 15;
      const top = 20;
      const right = 15;
      const bottom = 20;
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const usableWidth = pageWidth - left - right;
      const fontSize = 8;
      doc.setFontSize(fontSize);
      const lineHeight = fontSize * 1;
      const paragraphs = chatText.split("\n");
      let y = top;
      for (let paragraph of paragraphs) {
        const lines = doc.splitTextToSize(paragraph, usableWidth);
        for (let line of lines) {
          if (y + lineHeight > pageHeight - bottom) {
            doc.addPage();
            y = top;
          }
          doc.text(line, left, y);
          y += lineHeight * 0.5;
        }
        y += lineHeight * 0.1;
      }
      doc.save(`chat-${chat().chat.title}.pdf`);
    }
  };
  const downloadJSONExport = async () => {
    var _a;
    if (chat().id) {
      let chatObj = null;
      if ((((_a = chat()) == null ? void 0 : _a.id) ?? "").startsWith("local") || $temporaryChatEnabled()) {
        chatObj = chat();
      } else {
        chatObj = await getChatById(localStorage.token, chat().id);
      }
      let blob = new Blob([JSON.stringify([chatObj])], { type: "application/json" });
      saveAs(blob, `chat-export-${Date.now()}.json`);
    }
  };
  init();
  var fragment = root$b();
  var node = first_child(fragment);
  {
    var consequent = ($$anchor2) => {
      var div = root_1$8();
      var div_1 = child(div);
      var node_1 = child(div_1);
      {
        let $0 = derived_safe_equal(() => (deep_read_state(chat()), untrack(() => {
          var _a;
          return `chat-preview-${((_a = chat()) == null ? void 0 : _a.id) ?? ""}`;
        })));
        Messages(node_1, {
          className: "h-full flex pt-4 pb-8 w-full",
          get chatId() {
            return get($0);
          },
          get user() {
            return $user();
          },
          readOnly: true,
          get history() {
            return deep_read_state(chat()), untrack(() => chat().chat.history);
          },
          get messages() {
            return deep_read_state(chat()), untrack(() => chat().chat.messages);
          },
          autoScroll: true,
          sendMessage: () => {
          },
          continueResponse: () => {
          },
          regenerateResponse: () => {
          },
          messagesCount: null,
          editCodeBlock: false
        });
      }
      reset(div_1);
      reset(div);
      append($$anchor2, div);
    };
    if_block(node, ($$render) => {
      if (get(showFullMessages)) $$render(consequent);
    });
  }
  var node_2 = sibling(node, 2);
  Dropdown(node_2, {
    $$events: {
      change: (e) => {
        if (e.detail === false) {
          onClose()();
        }
      }
    },
    children: ($$anchor2, $$slotProps) => {
      var fragment_1 = comment();
      var node_3 = first_child(fragment_1);
      slot(node_3, $$props, "default", {}, null);
      append($$anchor2, fragment_1);
    },
    $$slots: {
      default: true,
      content: ($$anchor2, $$slotProps) => {
        var div_2 = root_3$7();
        var node_4 = child(div_2);
        Menu_content(node_4, {
          class: "w-full max-w-[200px] rounded-2xl px-1 py-1  border border-gray-100  dark:border-gray-800 z-50 bg-white dark:bg-gray-850 dark:text-white shadow-lg transition",
          sideOffset: 8,
          side: "bottom",
          align: "end",
          get transition() {
            return flyAndScale;
          },
          children: ($$anchor3, $$slotProps2) => {
            var fragment_2 = root_4$3();
            var node_5 = first_child(fragment_2);
            {
              var consequent_1 = ($$anchor4) => {
                Menu_item($$anchor4, {
                  class: "flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl select-none w-full",
                  id: "chat-controls-button",
                  $$events: {
                    click: async () => {
                      await showControls.set(true);
                      await showOverview.set(false);
                      await showArtifacts.set(false);
                      await showEmbeds.set(false);
                    }
                  },
                  children: ($$anchor5, $$slotProps3) => {
                    var fragment_4 = root_6$9();
                    var node_6 = first_child(fragment_4);
                    AdjustmentsHorizontal(node_6, { className: " size-4", strokeWidth: "1.5" });
                    var div_3 = sibling(node_6, 2);
                    var text2 = child(div_3, true);
                    reset(div_3);
                    template_effect(($0) => set_text(text2, $0), [() => ($i18n(), untrack(() => $i18n().t("Controls")))]);
                    append($$anchor5, fragment_4);
                  },
                  $$slots: { default: true }
                });
              };
              if_block(node_5, ($$render) => {
                if ($mobile(), $user(), untrack(() => {
                  var _a, _b, _c;
                  return $mobile() && (((_a = $user()) == null ? void 0 : _a.role) === "admin" || (((_c = (_b = $user()) == null ? void 0 : _b.permissions.chat) == null ? void 0 : _c.controls) ?? true));
                })) $$render(consequent_1);
              });
            }
            var node_7 = sibling(node_5, 2);
            Menu_item(node_7, {
              class: "flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl select-none w-full",
              id: "chat-overview-button",
              $$events: {
                click: async () => {
                  await showControls.set(true);
                  await showOverview.set(true);
                  await showArtifacts.set(false);
                  await showEmbeds.set(false);
                }
              },
              children: ($$anchor4, $$slotProps3) => {
                var fragment_5 = root_7$6();
                var node_8 = first_child(fragment_5);
                Map$1(node_8, { className: " size-4", strokeWidth: "1.5" });
                var div_4 = sibling(node_8, 2);
                var text_1 = child(div_4, true);
                reset(div_4);
                template_effect(($0) => set_text(text_1, $0), [() => ($i18n(), untrack(() => $i18n().t("Overview")))]);
                append($$anchor4, fragment_5);
              },
              $$slots: { default: true }
            });
            var node_9 = sibling(node_7, 2);
            {
              var consequent_2 = ($$anchor4) => {
                Menu_item($$anchor4, {
                  class: "flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl select-none w-full",
                  id: "chat-overview-button",
                  $$events: {
                    click: async () => {
                      await showControls.set(true);
                      await showArtifacts.set(true);
                      await showOverview.set(false);
                      await showEmbeds.set(false);
                    }
                  },
                  children: ($$anchor5, $$slotProps3) => {
                    var fragment_7 = root_9$2();
                    var node_10 = first_child(fragment_7);
                    Cube(node_10, { className: " size-4", strokeWidth: "1.5" });
                    var div_5 = sibling(node_10, 2);
                    var text_2 = child(div_5, true);
                    reset(div_5);
                    template_effect(($0) => set_text(text_2, $0), [() => ($i18n(), untrack(() => $i18n().t("Artifacts")))]);
                    append($$anchor5, fragment_7);
                  },
                  $$slots: { default: true }
                });
              };
              if_block(node_9, ($$render) => {
                if ($artifactContents(), untrack(() => ($artifactContents() ?? []).length > 0)) $$render(consequent_2);
              });
            }
            var node_11 = sibling(node_9, 4);
            {
              var consequent_3 = ($$anchor4) => {
                Menu_item($$anchor4, {
                  class: "flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl select-none w-full",
                  id: "chat-share-button",
                  $$events: {
                    click: () => {
                      shareHandler()();
                    }
                  },
                  children: ($$anchor5, $$slotProps3) => {
                    var fragment_9 = root_11$5();
                    var node_12 = first_child(fragment_9);
                    Share(node_12, { strokeWidth: "1.5" });
                    var div_6 = sibling(node_12, 2);
                    var text_3 = child(div_6, true);
                    reset(div_6);
                    template_effect(($0) => set_text(text_3, $0), [() => ($i18n(), untrack(() => $i18n().t("Share")))]);
                    append($$anchor5, fragment_9);
                  },
                  $$slots: { default: true }
                });
              };
              if_block(node_11, ($$render) => {
                if ($temporaryChatEnabled(), $user(), untrack(() => {
                  var _a, _b, _c;
                  return !$temporaryChatEnabled() && (((_a = $user()) == null ? void 0 : _a.role) === "admin" || (((_c = (_b = $user().permissions) == null ? void 0 : _b.chat) == null ? void 0 : _c.share) ?? true));
                })) $$render(consequent_3);
              });
            }
            var node_13 = sibling(node_11, 2);
            Menu_sub(node_13, {
              children: ($$anchor4, $$slotProps3) => {
                var fragment_10 = root_12$2();
                var node_14 = first_child(fragment_10);
                Menu_sub_trigger(node_14, {
                  class: "flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl select-none w-full",
                  children: ($$anchor5, $$slotProps4) => {
                    var fragment_11 = root_13$4();
                    var node_15 = first_child(fragment_11);
                    Download(node_15, { strokeWidth: "1.5" });
                    var div_7 = sibling(node_15, 2);
                    var text_4 = child(div_7, true);
                    reset(div_7);
                    template_effect(($0) => set_text(text_4, $0), [() => ($i18n(), untrack(() => $i18n().t("Download")))]);
                    append($$anchor5, fragment_11);
                  },
                  $$slots: { default: true }
                });
                var node_16 = sibling(node_14, 2);
                Menu_sub_content(node_16, {
                  class: "w-full rounded-2xl p-1 z-50 bg-white dark:bg-gray-850 dark:text-white border border-gray-100  dark:border-gray-800 shadow-lg max-h-52 overflow-y-auto scrollbar-hidden",
                  get transition() {
                    return flyAndScale;
                  },
                  sideOffset: 8,
                  children: ($$anchor5, $$slotProps4) => {
                    var fragment_12 = root_14$2();
                    var node_17 = first_child(fragment_12);
                    {
                      var consequent_4 = ($$anchor6) => {
                        Menu_item($$anchor6, {
                          class: "flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl select-none w-full",
                          $$events: {
                            click: () => {
                              downloadJSONExport();
                            }
                          },
                          children: ($$anchor7, $$slotProps5) => {
                            var div_8 = root_16$1();
                            var text_5 = child(div_8, true);
                            reset(div_8);
                            template_effect(($0) => set_text(text_5, $0), [
                              () => ($i18n(), untrack(() => $i18n().t("Export chat (.json)")))
                            ]);
                            append($$anchor7, div_8);
                          },
                          $$slots: { default: true }
                        });
                      };
                      if_block(node_17, ($$render) => {
                        if ($user(), untrack(() => {
                          var _a, _b, _c;
                          return ((_a = $user()) == null ? void 0 : _a.role) === "admin" || (((_c = (_b = $user().permissions) == null ? void 0 : _b.chat) == null ? void 0 : _c.export) ?? true);
                        })) $$render(consequent_4);
                      });
                    }
                    var node_18 = sibling(node_17, 2);
                    Menu_item(node_18, {
                      class: "flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl select-none w-full",
                      $$events: {
                        click: () => {
                          downloadTxt();
                        }
                      },
                      children: ($$anchor6, $$slotProps5) => {
                        var div_9 = root_17$2();
                        var text_6 = child(div_9, true);
                        reset(div_9);
                        template_effect(($0) => set_text(text_6, $0), [
                          () => ($i18n(), untrack(() => $i18n().t("Plain text (.txt)")))
                        ]);
                        append($$anchor6, div_9);
                      },
                      $$slots: { default: true }
                    });
                    var node_19 = sibling(node_18, 2);
                    Menu_item(node_19, {
                      class: "flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl select-none w-full",
                      $$events: {
                        click: () => {
                          downloadPdf();
                        }
                      },
                      children: ($$anchor6, $$slotProps5) => {
                        var div_10 = root_18$1();
                        var text_7 = child(div_10, true);
                        reset(div_10);
                        template_effect(($0) => set_text(text_7, $0), [
                          () => ($i18n(), untrack(() => $i18n().t("PDF document (.pdf)")))
                        ]);
                        append($$anchor6, div_10);
                      },
                      $$slots: { default: true }
                    });
                    append($$anchor5, fragment_12);
                  },
                  $$slots: { default: true }
                });
                append($$anchor4, fragment_10);
              },
              $$slots: { default: true }
            });
            var node_20 = sibling(node_13, 2);
            Menu_item(node_20, {
              class: "flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl select-none w-full",
              id: "chat-copy-button",
              $$events: {
                click: async () => {
                  const res = await copyToClipboard(await getChatAsText()).catch((e) => {
                    console.error(e);
                  });
                  if (res) {
                    toast.success($i18n().t("Copied to clipboard"));
                  }
                }
              },
              children: ($$anchor4, $$slotProps3) => {
                var fragment_14 = root_19$1();
                var node_21 = first_child(fragment_14);
                Clipboard(node_21, { className: " size-4", strokeWidth: "1.5" });
                var div_11 = sibling(node_21, 2);
                var text_8 = child(div_11, true);
                reset(div_11);
                template_effect(($0) => set_text(text_8, $0), [() => ($i18n(), untrack(() => $i18n().t("Copy")))]);
                append($$anchor4, fragment_14);
              },
              $$slots: { default: true }
            });
            var node_22 = sibling(node_20, 2);
            {
              var consequent_5 = ($$anchor4) => {
                var fragment_15 = root_20$1();
                var node_23 = sibling(first_child(fragment_15), 2);
                Menu_sub(node_23, {
                  children: ($$anchor5, $$slotProps3) => {
                    var fragment_16 = root_21$1();
                    var node_24 = first_child(fragment_16);
                    Menu_sub_trigger(node_24, {
                      class: "flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl select-none w-full",
                      children: ($$anchor6, $$slotProps4) => {
                        var fragment_17 = root_22();
                        var node_25 = first_child(fragment_17);
                        Folder(node_25, { strokeWidth: "1.5" });
                        var div_12 = sibling(node_25, 2);
                        var text_9 = child(div_12, true);
                        reset(div_12);
                        template_effect(($0) => set_text(text_9, $0), [() => ($i18n(), untrack(() => $i18n().t("Move")))]);
                        append($$anchor6, fragment_17);
                      },
                      $$slots: { default: true }
                    });
                    var node_26 = sibling(node_24, 2);
                    Menu_sub_content(node_26, {
                      class: "w-full rounded-2xl p-1 z-50 bg-white dark:bg-gray-850 dark:text-white border border-gray-100  dark:border-gray-800 shadow-lg max-h-52 overflow-y-auto scrollbar-hidden",
                      get transition() {
                        return flyAndScale;
                      },
                      sideOffset: 8,
                      children: ($$anchor6, $$slotProps4) => {
                        var fragment_18 = comment();
                        var node_27 = first_child(fragment_18);
                        each(
                          node_27,
                          1,
                          () => ($folders(), untrack(() => $folders().sort((a, b) => b.updated_at - a.updated_at))),
                          index,
                          ($$anchor7, folder) => {
                            Menu_item($$anchor7, {
                              class: "flex gap-2 items-center px-3 py-1.5 text-sm cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl",
                              $$events: {
                                click: () => {
                                  var _a, _b;
                                  moveChatHandler()((_a = chat()) == null ? void 0 : _a.id, (_b = get(folder)) == null ? void 0 : _b.id);
                                }
                              },
                              children: ($$anchor8, $$slotProps5) => {
                                var fragment_20 = root_25();
                                var node_28 = first_child(fragment_20);
                                Folder(node_28, { strokeWidth: "1.5" });
                                var div_13 = sibling(node_28, 2);
                                var text_10 = child(div_13, true);
                                reset(div_13);
                                template_effect(() => set_text(text_10, (get(folder), untrack(() => {
                                  var _a;
                                  return ((_a = get(folder)) == null ? void 0 : _a.name) ?? "Folder";
                                }))));
                                append($$anchor8, fragment_20);
                              },
                              $$slots: { default: true }
                            });
                          }
                        );
                        append($$anchor6, fragment_18);
                      },
                      $$slots: { default: true }
                    });
                    append($$anchor5, fragment_16);
                  },
                  $$slots: { default: true }
                });
                var node_29 = sibling(node_23, 2);
                Menu_item(node_29, {
                  class: "flex gap-2 items-center px-3 py-1.5 text-sm  cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl",
                  $$events: {
                    click: () => {
                      archiveChatHandler()();
                    }
                  },
                  children: ($$anchor5, $$slotProps3) => {
                    var fragment_21 = root_26();
                    var node_30 = first_child(fragment_21);
                    ArchiveBox(node_30, { className: "size-4", strokeWidth: "1.5" });
                    var div_14 = sibling(node_30, 2);
                    var text_11 = child(div_14, true);
                    reset(div_14);
                    template_effect(($0) => set_text(text_11, $0), [() => ($i18n(), untrack(() => $i18n().t("Archive")))]);
                    append($$anchor5, fragment_21);
                  },
                  $$slots: { default: true }
                });
                var div_15 = sibling(node_29, 4);
                var node_31 = child(div_15);
                Tags_1(node_31, {
                  get chatId() {
                    return deep_read_state(chat()), untrack(() => chat().id);
                  }
                });
                reset(div_15);
                append($$anchor4, fragment_15);
              };
              if_block(node_22, ($$render) => {
                if ($temporaryChatEnabled(), deep_read_state(chat()), untrack(() => {
                  var _a;
                  return !$temporaryChatEnabled() && ((_a = chat()) == null ? void 0 : _a.id);
                })) $$render(consequent_5);
              });
            }
            append($$anchor3, fragment_2);
          },
          $$slots: { default: true }
        });
        reset(div_2);
        append($$anchor2, div_2);
      }
    }
  });
  append($$anchor, fragment);
  pop();
  $$cleanup();
}
var root$a = from_svg(`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.8214 2.48697 15.5291 3.33782 17L2.5 21.5L7 20.6622C8.47087 21.513 10.1786 22 12 22Z" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="2.5 3.5"></path></svg>`);
function ChatBubbleDotted($$anchor, $$props) {
  let className = prop($$props, "className", 8, "size-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "1.5");
  var svg = root$a();
  template_effect(() => {
    set_attribute(svg, "stroke-width", strokeWidth());
    set_class(svg, 0, clsx(className()));
  });
  append($$anchor, svg);
}
var root$9 = from_svg(`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M8 12L11 15L16 10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.8214 2.48697 15.5291 3.33782 17L2.5 21.5L7 20.6622C8.47087 21.513 10.1786 22 12 22Z" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="2.5 3.5"></path></svg>`);
function ChatBubbleDottedChecked($$anchor, $$props) {
  let className = prop($$props, "className", 8, "size-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "1.5");
  var svg = root$9();
  template_effect(() => {
    set_attribute(svg, "stroke-width", strokeWidth());
    set_class(svg, 0, clsx(className()));
  });
  append($$anchor, svg);
}
var root$8 = from_svg(`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 12H12M15 12H12M12 12V9M12 12V15" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.8214 2.48697 15.5291 3.33782 17L2.5 21.5L7 20.6622C8.47087 21.513 10.1786 22 12 22Z" stroke-linecap="round" stroke-linejoin="round"></path></svg>`);
function ChatPlus($$anchor, $$props) {
  let className = prop($$props, "className", 8, "w-4 h-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "1.5");
  var svg = root$8();
  template_effect(() => {
    set_attribute(svg, "stroke-width", strokeWidth());
    set_class(svg, 0, clsx(className()));
  });
  append($$anchor, svg);
}
var root$7 = from_svg(`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M8 12L11 15L16 10" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 13.8214 2.48697 15.5291 3.33782 17L2.5 21.5L7 20.6622C8.47087 21.513 10.1786 22 12 22Z" stroke-linecap="round" stroke-linejoin="round"></path></svg>`);
function ChatCheck($$anchor, $$props) {
  let className = prop($$props, "className", 8, "w-4 h-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "1.5");
  var svg = root$7();
  template_effect(() => {
    set_attribute(svg, "stroke-width", strokeWidth());
    set_class(svg, 0, clsx(className()));
  });
  append($$anchor, svg);
}
var root_2$a = from_html(`<button class=" cursor-pointer flex rounded-lg hover:bg-gray-100 dark:hover:bg-gray-850 transition"><div class=" self-center p-1.5"><!></div></button>`);
var root_1$7 = from_html(`<div class="-translate-x-0.5 mr-1 mt-1 self-start flex flex-none items-center text-gray-600 dark:text-gray-400"><!></div>`);
var root_6$8 = from_html(`<button class="flex cursor-pointer px-2 py-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-850 transition" id="temporary-chat-button"><div class=" m-auto self-center"><!></div></button>`);
var root_11$4 = from_html(`<button class="flex cursor-pointer px-2 py-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-850 transition" id="save-temporary-chat-button"><div class=" m-auto self-center"><!></div></button>`);
var root_13$3 = from_html(`<button aria-label="New Chat"><div class=" m-auto self-center"><!></div></button>`);
var root_15$2 = from_html(`<button class="flex cursor-pointer px-2 py-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-850 transition" id="chat-context-menu-button"><div class=" m-auto self-center"><!></div></button>`);
var root_17$1 = from_html(`<button class=" flex cursor-pointer px-2 py-2 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-850 transition" aria-label="Controls"><div class=" m-auto self-center"><!></div></button>`);
var root_19 = from_html(`<div class="select-none flex rounded-xl p-1.5 w-full hover:bg-gray-50 dark:hover:bg-gray-850 transition"><div class=" self-center"><span class="sr-only"> </span> <!></div></div>`);
var root_20 = from_html(`<div class=" w-full z-30 text-center"><div class="text-xs text-gray-500"> </div></div>`);
var root_21 = from_html(`<div class=" w-full z-30"><div class=" flex flex-col gap-1 w-full"><!> <!> <!></div></div>`);
var root$6 = from_html(`<!> <button id="new-chat-button" class="hidden" aria-label="New Chat"></button> <nav><div class="flex items-center w-full pl-1.5 pr-1"><div id="navbar-bg-gradient-to-b"></div> <div class=" flex max-w-full w-full mx-auto px-1.5 md:px-2 pt-0.5 bg-transparent"><div class="flex items-center w-full max-w-full"><!> <div><!></div> <div class="self-start flex flex-none items-center text-gray-600 dark:text-gray-400"><!> <!> <!> <!> <!></div></div></div></div> <!> <div class="absolute top-[100%] left-0 right-0 h-fit"><!></div></nav>`, 1);
function Navbar($$anchor, $$props) {
  push($$props, false);
  const $chatId = () => store_get(chatId, "$chatId", $$stores);
  const $mobile = () => store_get(mobile, "$mobile", $$stores);
  const $showSidebar = () => store_get(showSidebar, "$showSidebar", $$stores);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const $user = () => store_get(user, "$user", $$stores);
  const $settings = () => store_get(settings, "$settings", $$stores);
  const $temporaryChatEnabled = () => store_get(temporaryChatEnabled, "$temporaryChatEnabled", $$stores);
  const $showControls = () => store_get(showControls, "$showControls", $$stores);
  const $banners = () => store_get(banners, "$banners", $$stores);
  const $config = () => store_get(config, "$config", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const i18n = getContext("i18n");
  let initNewChat = prop($$props, "initNewChat", 8);
  let shareEnabled = prop($$props, "shareEnabled", 8, false);
  prop($$props, "scrollTop", 8, 0);
  let chat = prop($$props, "chat", 8);
  let history = prop($$props, "history", 8);
  let selectedModels = prop($$props, "selectedModels", 12);
  let showModelSelector = prop($$props, "showModelSelector", 8, true);
  let onSaveTempChat = prop($$props, "onSaveTempChat", 8);
  let archiveChatHandler = prop($$props, "archiveChatHandler", 8);
  let moveChatHandler = prop($$props, "moveChatHandler", 8);
  let closedBannerIds = mutable_source([]);
  let showShareChatModal = mutable_source(false);
  init();
  var fragment = root$6();
  var node = first_child(fragment);
  ShareChatModal(node, {
    get chatId() {
      return $chatId();
    },
    get show() {
      return get(showShareChatModal);
    },
    set show($$value) {
      set(showShareChatModal, $$value);
    },
    $$legacy: true
  });
  var button = sibling(node, 2);
  var nav = sibling(button, 2);
  var div = child(nav);
  var div_1 = child(div);
  var div_2 = sibling(div_1, 2);
  var div_3 = child(div_2);
  var node_1 = child(div_3);
  {
    var consequent = ($$anchor2) => {
      var div_4 = root_1$7();
      var node_2 = child(div_4);
      {
        let $0 = derived_safe_equal(() => ($showSidebar(), $i18n(), untrack(() => $showSidebar() ? $i18n().t("Close Sidebar") : $i18n().t("Open Sidebar"))));
        Tooltip(node_2, {
          get content() {
            return get($0);
          },
          children: ($$anchor3, $$slotProps) => {
            var button_1 = root_2$a();
            var div_5 = child(button_1);
            var node_3 = child(div_5);
            Sidebar(node_3, {});
            reset(div_5);
            reset(button_1);
            event("click", button_1, () => {
              showSidebar.set(!$showSidebar());
            });
            append($$anchor3, button_1);
          },
          $$slots: { default: true }
        });
      }
      reset(div_4);
      append($$anchor2, div_4);
    };
    if_block(node_1, ($$render) => {
      if ($mobile() && !$showSidebar()) $$render(consequent);
    });
  }
  var div_6 = sibling(node_1, 2);
  var node_4 = child(div_6);
  {
    var consequent_1 = ($$anchor2) => {
      {
        let $0 = derived_safe_equal(() => !shareEnabled());
        ModelSelector($$anchor2, {
          get showSetDefault() {
            return get($0);
          },
          get selectedModels() {
            return selectedModels();
          },
          set selectedModels($$value) {
            selectedModels($$value);
          },
          $$legacy: true
        });
      }
    };
    if_block(node_4, ($$render) => {
      if (showModelSelector()) $$render(consequent_1);
    });
  }
  reset(div_6);
  var div_7 = sibling(div_6, 2);
  var node_5 = child(div_7);
  {
    var consequent_5 = ($$anchor2) => {
      var fragment_2 = comment();
      var node_6 = first_child(fragment_2);
      {
        var consequent_3 = ($$anchor3) => {
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t(`Temporary Chat`))));
            Tooltip($$anchor3, {
              get content() {
                return get($0);
              },
              children: ($$anchor4, $$slotProps) => {
                var button_2 = root_6$8();
                var div_8 = child(button_2);
                var node_7 = child(div_8);
                {
                  var consequent_2 = ($$anchor5) => {
                    ChatBubbleDottedChecked($$anchor5, { className: " size-4.5", strokeWidth: "1.5" });
                  };
                  var alternate = ($$anchor5) => {
                    ChatBubbleDotted($$anchor5, { className: " size-4.5", strokeWidth: "1.5" });
                  };
                  if_block(node_7, ($$render) => {
                    if ($temporaryChatEnabled()) $$render(consequent_2);
                    else $$render(alternate, false);
                  });
                }
                reset(div_8);
                reset(button_2);
                event("click", button_2, async () => {
                  var _a;
                  if ((((_a = $settings()) == null ? void 0 : _a.temporaryChatByDefault) ?? false) && $temporaryChatEnabled()) {
                    await temporaryChatEnabled.set(null);
                  } else {
                    await temporaryChatEnabled.set(!$temporaryChatEnabled());
                  }
                  await goto("/");
                  if ($temporaryChatEnabled()) {
                    window.history.replaceState(null, "", "?temporary-chat=true");
                  } else {
                    window.history.replaceState(null, "", location.pathname);
                  }
                });
                append($$anchor4, button_2);
              },
              $$slots: { default: true }
            });
          }
        };
        var alternate_1 = ($$anchor3) => {
          var fragment_6 = comment();
          var node_8 = first_child(fragment_6);
          {
            var consequent_4 = ($$anchor4) => {
              {
                let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t(`Save Chat`))));
                Tooltip($$anchor4, {
                  get content() {
                    return get($0);
                  },
                  children: ($$anchor5, $$slotProps) => {
                    var button_3 = root_11$4();
                    var div_9 = child(button_3);
                    var node_9 = child(div_9);
                    ChatCheck(node_9, { className: " size-4.5", strokeWidth: "1.5" });
                    reset(div_9);
                    reset(button_3);
                    event("click", button_3, async () => {
                      onSaveTempChat()();
                    });
                    append($$anchor5, button_3);
                  },
                  $$slots: { default: true }
                });
              }
            };
            if_block(
              node_8,
              ($$render) => {
                if ($temporaryChatEnabled()) $$render(consequent_4);
              },
              true
            );
          }
          append($$anchor3, fragment_6);
        };
        if_block(node_6, ($$render) => {
          if (deep_read_state(chat()), untrack(() => {
            var _a;
            return !((_a = chat()) == null ? void 0 : _a.id);
          })) $$render(consequent_3);
          else $$render(alternate_1, false);
        });
      }
      append($$anchor2, fragment_2);
    };
    if_block(node_5, ($$render) => {
      if ($user(), untrack(() => {
        var _a, _b, _c, _d, _e, _f, _g;
        return ((_a = $user()) == null ? void 0 : _a.role) === "user" ? (((_d = (_c = (_b = $user()) == null ? void 0 : _b.permissions) == null ? void 0 : _c.chat) == null ? void 0 : _d.temporary) ?? true) && !(((_g = (_f = (_e = $user()) == null ? void 0 : _e.permissions) == null ? void 0 : _f.chat) == null ? void 0 : _g.temporary_enforced) ?? false) : true;
      })) $$render(consequent_5);
    });
  }
  var node_10 = sibling(node_5, 2);
  {
    var consequent_6 = ($$anchor2) => {
      {
        let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("New Chat"))));
        Tooltip($$anchor2, {
          get content() {
            return get($0);
          },
          children: ($$anchor3, $$slotProps) => {
            var button_4 = root_13$3();
            var div_10 = child(button_4);
            var node_11 = child(div_10);
            ChatPlus(node_11, { className: " size-4.5", strokeWidth: "1.5" });
            reset(div_10);
            reset(button_4);
            template_effect(() => set_class(button_4, 1, ` flex ${$showSidebar() ? "md:hidden" : ""} cursor-pointer px-2 py-2 rounded-xl text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-850 transition`));
            event("click", button_4, () => {
              initNewChat()();
            });
            append($$anchor3, button_4);
          },
          $$slots: { default: true }
        });
      }
    };
    if_block(node_10, ($$render) => {
      if ($mobile(), $temporaryChatEnabled(), deep_read_state(chat()), untrack(() => $mobile() && !$temporaryChatEnabled() && chat() && chat().id)) $$render(consequent_6);
    });
  }
  var node_12 = sibling(node_10, 2);
  {
    var consequent_7 = ($$anchor2) => {
      Menu($$anchor2, {
        get chat() {
          return chat();
        },
        get shareEnabled() {
          return shareEnabled();
        },
        shareHandler: () => {
          set(showShareChatModal, !get(showShareChatModal));
        },
        archiveChatHandler: () => {
          archiveChatHandler()(chat().id);
        },
        get moveChatHandler() {
          return moveChatHandler();
        },
        children: ($$anchor3, $$slotProps) => {
          var button_5 = root_15$2();
          var div_11 = child(button_5);
          var node_13 = child(div_11);
          EllipsisHorizontal(node_13, { className: " size-5", strokeWidth: "1.5" });
          reset(div_11);
          reset(button_5);
          append($$anchor3, button_5);
        },
        $$slots: { default: true }
      });
    };
    if_block(node_12, ($$render) => {
      if (deep_read_state(shareEnabled()), deep_read_state(chat()), $temporaryChatEnabled(), untrack(() => shareEnabled() && chat() && (chat().id || $temporaryChatEnabled()))) $$render(consequent_7);
    });
  }
  var node_14 = sibling(node_12, 2);
  {
    var consequent_8 = ($$anchor2) => {
      {
        let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Controls"))));
        Tooltip($$anchor2, {
          get content() {
            return get($0);
          },
          children: ($$anchor3, $$slotProps) => {
            var button_6 = root_17$1();
            var div_12 = child(button_6);
            var node_15 = child(div_12);
            Knobs(node_15, { className: " size-5", strokeWidth: "1" });
            reset(div_12);
            reset(button_6);
            event("click", button_6, async () => {
              await showControls.set(!$showControls());
            });
            append($$anchor3, button_6);
          },
          $$slots: { default: true }
        });
      }
    };
    if_block(node_14, ($$render) => {
      if ($user(), untrack(() => {
        var _a, _b, _c;
        return ((_a = $user()) == null ? void 0 : _a.role) === "admin" || (((_c = (_b = $user()) == null ? void 0 : _b.permissions.chat) == null ? void 0 : _c.controls) ?? true);
      })) $$render(consequent_8);
    });
  }
  var node_16 = sibling(node_14, 2);
  {
    var consequent_9 = ($$anchor2) => {
      {
        let $0 = derived_safe_equal(() => ($user(), untrack(() => {
          var _a;
          return (_a = $user()) == null ? void 0 : _a.role;
        })));
        UserMenu($$anchor2, {
          className: "max-w-[240px]",
          get role() {
            return get($0);
          },
          help: true,
          $$events: {
            show: (e) => {
              if (e.detail === "archived-chat") {
                showArchivedChats.set(true);
              }
            }
          },
          children: ($$anchor3, $$slotProps) => {
            var div_13 = root_19();
            var div_14 = child(div_13);
            var span = child(div_14);
            var text2 = child(span, true);
            reset(span);
            var node_17 = sibling(span, 2);
            UserGroup(node_17, { className: "w-5 h-5", strokeWidth: "1.5" });
            reset(div_14);
            reset(div_13);
            template_effect(($02) => set_text(text2, $02), [() => ($i18n(), untrack(() => $i18n().t("User menu")))]);
            append($$anchor3, div_13);
          },
          $$slots: { default: true }
        });
      }
    };
    if_block(node_16, ($$render) => {
      if ($user() !== void 0 && $user() !== null) $$render(consequent_9);
    });
  }
  reset(div_7);
  reset(div_3);
  reset(div_2);
  reset(div);
  var node_18 = sibling(div, 2);
  {
    var consequent_10 = ($$anchor2) => {
      var div_15 = root_20();
      var div_16 = child(div_15);
      var text_1 = child(div_16, true);
      reset(div_16);
      reset(div_15);
      template_effect(($0) => set_text(text_1, $0), [
        () => ($i18n(), untrack(() => $i18n().t("Temporary Chat")))
      ]);
      append($$anchor2, div_15);
    };
    if_block(node_18, ($$render) => {
      if ($temporaryChatEnabled(), $chatId(), untrack(() => $temporaryChatEnabled() && ($chatId() ?? "").startsWith("local:"))) $$render(consequent_10);
    });
  }
  var div_17 = sibling(node_18, 2);
  var node_19 = child(div_17);
  {
    var consequent_13 = ($$anchor2) => {
      var div_18 = root_21();
      var div_19 = child(div_18);
      var node_20 = child(div_19);
      {
        var consequent_11 = ($$anchor3) => {
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => ({
              type: "info",
              title: "Trial License",
              content: $i18n().t("You are currently using a trial license. Please contact support to upgrade your license.")
            }))));
            Banner($$anchor3, {
              get banner() {
                return get($0);
              }
            });
          }
        };
        if_block(node_20, ($$render) => {
          if ($config(), untrack(() => {
            var _a, _b;
            return (((_b = (_a = $config()) == null ? void 0 : _a.license_metadata) == null ? void 0 : _b.type) ?? null) === "trial";
          })) $$render(consequent_11);
        });
      }
      var node_21 = sibling(node_20, 2);
      {
        var consequent_12 = ($$anchor3) => {
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => ({
              type: "error",
              title: "License Error",
              content: $i18n().t("Exceeded the number of seats in your license. Please contact support to increase the number of seats.")
            }))));
            Banner($$anchor3, {
              get banner() {
                return get($0);
              }
            });
          }
        };
        if_block(node_21, ($$render) => {
          if ($config(), untrack(() => {
            var _a, _b, _c, _d, _e;
            return (((_b = (_a = $config()) == null ? void 0 : _a.license_metadata) == null ? void 0 : _b.seats) ?? null) !== null && ((_c = $config()) == null ? void 0 : _c.user_count) > ((_e = (_d = $config()) == null ? void 0 : _d.license_metadata) == null ? void 0 : _e.seats);
          })) $$render(consequent_12);
        });
      }
      var node_22 = sibling(node_21, 2);
      each(
        node_22,
        1,
        () => ($banners(), get(closedBannerIds), untrack(() => $banners().filter((b) => ![
          ...JSON.parse(localStorage.getItem("dismissedBannerIds") ?? "[]"),
          ...get(closedBannerIds)
        ].includes(b.id)))),
        (banner) => banner.id,
        ($$anchor3, banner) => {
          Banner($$anchor3, {
            get banner() {
              return get(banner);
            },
            $$events: {
              dismiss: (e) => {
                const bannerId = e.detail;
                if (get(banner).dismissible) {
                  localStorage.setItem("dismissedBannerIds", JSON.stringify([
                    bannerId,
                    ...JSON.parse(localStorage.getItem("dismissedBannerIds") ?? "[]")
                  ].filter((id) => $banners().find((b) => b.id === id))));
                } else {
                  set(closedBannerIds, [...get(closedBannerIds), bannerId]);
                }
              }
            }
          });
        }
      );
      reset(div_19);
      reset(div_18);
      append($$anchor2, div_18);
    };
    if_block(node_19, ($$render) => {
      if (deep_read_state(history()), $chatId(), $banners(), $config(), untrack(() => {
        var _a, _b, _c, _d, _e, _f, _g;
        return !history().currentId && !$chatId() && ($banners().length > 0 || (((_b = (_a = $config()) == null ? void 0 : _a.license_metadata) == null ? void 0 : _b.type) ?? null) === "trial" || (((_d = (_c = $config()) == null ? void 0 : _c.license_metadata) == null ? void 0 : _d.seats) ?? null) !== null && ((_e = $config()) == null ? void 0 : _e.user_count) > ((_g = (_f = $config()) == null ? void 0 : _f.license_metadata) == null ? void 0 : _g.seats));
      })) $$render(consequent_13);
    });
  }
  reset(div_17);
  reset(nav);
  template_effect(() => {
    set_class(nav, 1, `sticky top-0 z-30 w-full ${(deep_read_state(chat()), untrack(() => {
      var _a;
      return ((_a = chat()) == null ? void 0 : _a.id) ? "pt-0.5 pb-1" : "pt-1 pb-1";
    })) ?? ""} -mb-12 flex flex-col items-center drag-region`);
    set_class(div_1, 1, `${(deep_read_state(chat()), untrack(() => {
      var _a;
      return ((_a = chat()) == null ? void 0 : _a.id) ? "visible" : "invisible";
    })) ?? ""} bg-linear-to-b via-40% to-97% from-white/90 via-white/50 to-transparent dark:from-gray-900/90 dark:via-gray-900/50 dark:to-transparent pointer-events-none absolute inset-0 -bottom-10 z-[-1]`);
    set_class(div_6, 1, `flex-1 overflow-hidden max-w-full py-0.5
                        ${$showSidebar() ? "ml-1" : ""}
                        `);
  });
  event("click", button, () => {
    initNewChat()();
  });
  append($$anchor, fragment);
  pop();
  $$cleanup();
}
var root_3$6 = from_html(`<option class="bg-gray-100 dark:bg-gray-800"> </option>`);
var root_2$9 = from_html(`<option selected disabled class="bg-gray-100 dark:bg-gray-800"> </option> <!>`, 1);
var root_6$7 = from_html(`<option class="bg-gray-100 dark:bg-gray-800"> </option>`);
var root_5$6 = from_html(`<option selected disabled class="bg-gray-100 dark:bg-gray-800"> </option> <!>`, 1);
var root_7$5 = from_html(`<hr class="border-gray-50 dark:border-gray-800 my-1 w-full"/> <div class="my-2 text-xs"><!></div>`, 1);
var root_1$6 = from_html(`<form class="flex flex-col h-full justify-between space-y-3 text-sm"><div class="flex flex-col"><div class="space-y-1"><div class="flex gap-2"><div class="flex-1"><select class="  w-full rounded-sm text-xs py-2 px-1 bg-transparent outline-hidden"><option class="bg-gray-100 dark:bg-gray-800"> </option><option class="bg-gray-100 dark:bg-gray-800"> </option></select></div> <div class="flex-1"><select class="w-full rounded-sm py-2 px-1 text-xs bg-transparent outline-hidden"><!></select></div></div></div> <!></div></form>`);
function Valves_1($$anchor, $$props) {
  push($$props, false);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const $functions = () => store_get(functions, "$functions", $$stores);
  const $tools = () => store_get(tools, "$tools", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const dispatch = createEventDispatcher();
  const i18n = getContext("i18n");
  let show2 = prop($$props, "show", 8, false);
  let tab = mutable_source("tools");
  let selectedId = mutable_source("");
  let loading = mutable_source(false);
  let valvesSpec = mutable_source(null);
  let valves = mutable_source({});
  let debounceTimer;
  const debounceSubmitHandler = async () => {
    if (debounceTimer) {
      clearTimeout(debounceTimer);
    }
    debounceTimer = setTimeout(
      () => {
        submitHandler();
      },
      500
    );
  };
  const getUserValves = async () => {
    var _a;
    set(loading, true);
    if (get(tab) === "tools") {
      set(valves, await getUserValvesById(localStorage.token, get(selectedId)));
      set(valvesSpec, await getUserValvesSpecById(localStorage.token, get(selectedId)));
    } else if (get(tab) === "functions") {
      set(valves, await getUserValvesById$1(localStorage.token, get(selectedId)));
      set(valvesSpec, await getUserValvesSpecById$1(localStorage.token, get(selectedId)));
    }
    if (get(valvesSpec)) {
      for (const property in get(valvesSpec).properties) {
        if (((_a = get(valvesSpec).properties[property]) == null ? void 0 : _a.type) === "array") {
          mutate(valves, get(valves)[property] = (get(valves)[property] ?? []).join(","));
        }
      }
    }
    set(loading, false);
  };
  const submitHandler = async () => {
    var _a;
    if (get(valvesSpec)) {
      for (const property in get(valvesSpec).properties) {
        if (((_a = get(valvesSpec).properties[property]) == null ? void 0 : _a.type) === "array") {
          mutate(valves, get(valves)[property] = (get(valves)[property] ?? "").split(",").map((v) => v.trim()));
        }
      }
      if (get(tab) === "tools") {
        const res = await updateUserValvesById(localStorage.token, get(selectedId), get(valves)).catch((error) => {
          toast.error(`${error}`);
          return null;
        });
        if (res) {
          toast.success($i18n().t("Valves updated"));
          set(valves, res);
        }
      } else if (get(tab) === "functions") {
        const res = await updateUserValvesById$1(localStorage.token, get(selectedId), get(valves)).catch((error) => {
          toast.error(`${error}`);
          return null;
        });
        if (res) {
          toast.success($i18n().t("Valves updated"));
          set(valves, res);
        }
      }
    }
  };
  const init$1 = async () => {
    set(loading, true);
    if ($functions() === null) {
      functions.set(await getFunctions(localStorage.token));
    }
    if ($tools() === null) {
      tools.set(await getTools(localStorage.token));
    }
    set(loading, false);
  };
  legacy_pre_effect(() => get(tab), () => {
    if (get(tab)) {
      set(selectedId, "");
    }
  });
  legacy_pre_effect(() => get(selectedId), () => {
    if (get(selectedId)) {
      getUserValves();
    }
  });
  legacy_pre_effect(() => deep_read_state(show2()), () => {
    if (show2()) {
      init$1();
    }
  });
  legacy_pre_effect_reset();
  init();
  var fragment = comment();
  var node = first_child(fragment);
  {
    var consequent_4 = ($$anchor2) => {
      var form = root_1$6();
      var div = child(form);
      var div_1 = child(div);
      var div_2 = child(div_1);
      var div_3 = child(div_2);
      var select = child(div_3);
      template_effect(() => {
        get(tab);
        invalidate_inner_signals(() => {
          $i18n();
        });
      });
      var option = child(select);
      var text2 = child(option, true);
      reset(option);
      option.value = option.__value = "tools";
      var option_1 = sibling(option);
      var text_1 = child(option_1, true);
      reset(option_1);
      option_1.value = option_1.__value = "functions";
      reset(select);
      reset(div_3);
      var div_4 = sibling(div_3, 2);
      var select_1 = child(div_4);
      template_effect(() => {
        get(selectedId);
        invalidate_inner_signals(() => {
          get(tab);
          $i18n();
          $tools();
          $functions();
        });
      });
      var node_1 = child(select_1);
      {
        var consequent = ($$anchor3) => {
          var fragment_1 = root_2$9();
          var option_2 = first_child(fragment_1);
          var text_2 = child(option_2, true);
          reset(option_2);
          option_2.value = option_2.__value = "";
          var node_2 = sibling(option_2, 2);
          each(
            node_2,
            1,
            () => ($tools(), untrack(() => $tools().filter((tool) => {
              var _a;
              return !((_a = tool == null ? void 0 : tool.id) == null ? void 0 : _a.startsWith("server:"));
            }))),
            index,
            ($$anchor4, tool) => {
              var option_3 = root_3$6();
              var text_3 = child(option_3, true);
              reset(option_3);
              var option_3_value = {};
              template_effect(() => {
                set_text(text_3, (get(tool), untrack(() => get(tool).name)));
                if (option_3_value !== (option_3_value = (get(tool), untrack(() => get(tool).id)))) {
                  option_3.value = (option_3.__value = (get(tool), untrack(() => get(tool).id))) ?? "";
                }
              });
              append($$anchor4, option_3);
            }
          );
          template_effect(($0) => set_text(text_2, $0), [() => ($i18n(), untrack(() => $i18n().t("Select a tool")))]);
          append($$anchor3, fragment_1);
        };
        var alternate = ($$anchor3) => {
          var fragment_2 = comment();
          var node_3 = first_child(fragment_2);
          {
            var consequent_1 = ($$anchor4) => {
              var fragment_3 = root_5$6();
              var option_4 = first_child(fragment_3);
              var text_4 = child(option_4, true);
              reset(option_4);
              option_4.value = option_4.__value = "";
              var node_4 = sibling(option_4, 2);
              each(node_4, 1, $functions, index, ($$anchor5, func) => {
                var option_5 = root_6$7();
                var text_5 = child(option_5, true);
                reset(option_5);
                var option_5_value = {};
                template_effect(() => {
                  set_text(text_5, (get(func), untrack(() => get(func).name)));
                  if (option_5_value !== (option_5_value = (get(func), untrack(() => get(func).id)))) {
                    option_5.value = (option_5.__value = (get(func), untrack(() => get(func).id))) ?? "";
                  }
                });
                append($$anchor5, option_5);
              });
              template_effect(($0) => set_text(text_4, $0), [
                () => ($i18n(), untrack(() => $i18n().t("Select a function")))
              ]);
              append($$anchor4, fragment_3);
            };
            if_block(
              node_3,
              ($$render) => {
                if (get(tab) === "functions") $$render(consequent_1);
              },
              true
            );
          }
          append($$anchor3, fragment_2);
        };
        if_block(node_1, ($$render) => {
          if (get(tab) === "tools") $$render(consequent);
          else $$render(alternate, false);
        });
      }
      reset(select_1);
      reset(div_4);
      reset(div_2);
      reset(div_1);
      var node_5 = sibling(div_1, 2);
      {
        var consequent_3 = ($$anchor3) => {
          var fragment_4 = root_7$5();
          var div_5 = sibling(first_child(fragment_4), 2);
          var node_6 = child(div_5);
          {
            var consequent_2 = ($$anchor4) => {
              Valves($$anchor4, {
                get valvesSpec() {
                  return get(valvesSpec);
                },
                get valves() {
                  return get(valves);
                },
                set valves($$value) {
                  set(valves, $$value);
                },
                $$events: {
                  change: () => {
                    debounceSubmitHandler();
                  }
                },
                $$legacy: true
              });
            };
            var alternate_1 = ($$anchor4) => {
              Spinner($$anchor4, { className: "size-5" });
            };
            if_block(node_6, ($$render) => {
              if (!get(loading)) $$render(consequent_2);
              else $$render(alternate_1, false);
            });
          }
          reset(div_5);
          append($$anchor3, fragment_4);
        };
        if_block(node_5, ($$render) => {
          if (get(selectedId)) $$render(consequent_3);
        });
      }
      reset(div);
      reset(form);
      template_effect(
        ($0, $1, $2) => {
          set_attribute(select, "placeholder", $0);
          set_text(text2, $1);
          set_text(text_1, $2);
        },
        [
          () => ($i18n(), untrack(() => $i18n().t("Select"))),
          () => ($i18n(), untrack(() => $i18n().t("Tools"))),
          () => ($i18n(), untrack(() => $i18n().t("Functions")))
        ]
      );
      bind_select_value(select, () => get(tab), ($$value) => set(tab, $$value));
      bind_select_value(select_1, () => get(selectedId), ($$value) => set(selectedId, $$value));
      event("change", select_1, async () => {
        await tick();
      });
      event("submit", form, preventDefault(() => {
        submitHandler();
        dispatch("save");
      }));
      append($$anchor2, form);
    };
    var alternate_2 = ($$anchor2) => {
      Spinner($$anchor2, { className: "size-4" });
    };
    if_block(node, ($$render) => {
      if (show2() && !get(loading)) $$render(consequent_4);
      else $$render(alternate_2, false);
    });
  }
  append($$anchor, fragment);
  pop();
  $$cleanup();
}
var root_3$5 = from_html(`<div class="flex flex-col gap-1 mt-1.5" slot="content"></div>`);
var root_2$8 = from_html(`<!> <hr class="my-2 border-gray-50 dark:border-gray-700/10"/>`, 1);
var root_6$6 = from_html(`<div class="text-sm" slot="content"><!></div>`);
var root_5$5 = from_html(`<!> <hr class="my-2 border-gray-50 dark:border-gray-700/10"/>`, 1);
var root_8$3 = from_html(`<div slot="content"><textarea rows="4"></textarea></div>`);
var root_7$4 = from_html(`<!> <hr class="my-2 border-gray-50 dark:border-gray-700/10"/>`, 1);
var root_10$4 = from_html(`<div class="text-sm mt-1.5" slot="content"><div><!></div></div>`);
var root_1$5 = from_html(`<div class=" dark:text-gray-200 text-sm font-primary py-0.5 px-0.5"><!> <!> <!> <!></div>`);
var root$5 = from_html(`<div class=" dark:text-white"><div class=" flex items-center justify-between dark:text-gray-100 mb-2"><div class=" text-lg font-medium self-center font-primary"> </div> <button class="self-center"><!></button></div> <!></div>`);
function Controls($$anchor, $$props) {
  push($$props, false);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const $user = () => store_get(user, "$user", $$stores);
  const $settings = () => store_get(settings, "$settings", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const dispatch = createEventDispatcher();
  const i18n = getContext("i18n");
  prop($$props, "models", 24, () => []);
  let chatFiles = prop($$props, "chatFiles", 28, () => []);
  let params = prop($$props, "params", 28, () => ({}));
  let showValves = mutable_source(false);
  init();
  var div = root$5();
  var div_1 = child(div);
  var div_2 = child(div_1);
  var text2 = child(div_2, true);
  reset(div_2);
  var button = sibling(div_2, 2);
  var node = child(button);
  XMark(node, { className: "size-3.5" });
  reset(button);
  reset(div_1);
  var node_1 = sibling(div_1, 2);
  {
    var consequent_4 = ($$anchor2) => {
      var div_3 = root_1$5();
      var node_2 = child(div_3);
      {
        var consequent = ($$anchor3) => {
          var fragment = root_2$8();
          var node_3 = first_child(fragment);
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Files"))));
            Collapsible(node_3, {
              get title() {
                return get($0);
              },
              open: true,
              buttonClassName: "w-full",
              $$slots: {
                content: ($$anchor4, $$slotProps) => {
                  var div_4 = root_3$5();
                  each(div_4, 5, chatFiles, index, ($$anchor5, file, fileIdx) => {
                    {
                      let $02 = derived_safe_equal(() => (get(file), untrack(() => {
                        var _a;
                        return ((_a = get(file)) == null ? void 0 : _a.url) ? get(file).url : null;
                      })));
                      let $1 = derived_safe_equal(() => (get(file), untrack(() => {
                        var _a;
                        return (_a = get(file)) == null ? void 0 : _a.size;
                      })));
                      FileItem($$anchor5, {
                        className: "w-full",
                        get item() {
                          return get(file);
                        },
                        edit: true,
                        get url() {
                          return get($02);
                        },
                        get name() {
                          return get(file), untrack(() => get(file).name);
                        },
                        get type() {
                          return get(file), untrack(() => get(file).type);
                        },
                        get size() {
                          return get($1);
                        },
                        dismissible: true,
                        small: true,
                        $$events: {
                          dismiss: () => {
                            chatFiles().splice(fileIdx, 1);
                            chatFiles(chatFiles());
                          },
                          click: () => {
                            console.log(get(file));
                          }
                        }
                      });
                    }
                  });
                  reset(div_4);
                  append($$anchor4, div_4);
                }
              }
            });
          }
          next(2);
          append($$anchor3, fragment);
        };
        if_block(node_2, ($$render) => {
          if (deep_read_state(chatFiles()), untrack(() => chatFiles().length > 0)) $$render(consequent);
        });
      }
      var node_4 = sibling(node_2, 2);
      {
        var consequent_1 = ($$anchor3) => {
          var fragment_2 = root_5$5();
          var node_5 = first_child(fragment_2);
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Valves"))));
            Collapsible(node_5, {
              get title() {
                return get($0);
              },
              buttonClassName: "w-full",
              get open() {
                return get(showValves);
              },
              set open($$value) {
                set(showValves, $$value);
              },
              $$slots: {
                content: ($$anchor4, $$slotProps) => {
                  var div_5 = root_6$6();
                  var node_6 = child(div_5);
                  Valves_1(node_6, {
                    get show() {
                      return get(showValves);
                    }
                  });
                  reset(div_5);
                  append($$anchor4, div_5);
                }
              },
              $$legacy: true
            });
          }
          next(2);
          append($$anchor3, fragment_2);
        };
        if_block(node_4, ($$render) => {
          if ($user(), untrack(() => {
            var _a, _b, _c;
            return ((_a = $user()) == null ? void 0 : _a.role) === "admin" || (((_c = (_b = $user()) == null ? void 0 : _b.permissions.chat) == null ? void 0 : _c.valves) ?? true);
          })) $$render(consequent_1);
        });
      }
      var node_7 = sibling(node_4, 2);
      {
        var consequent_2 = ($$anchor3) => {
          var fragment_3 = root_7$4();
          var node_8 = first_child(fragment_3);
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("System Prompt"))));
            Collapsible(node_8, {
              get title() {
                return get($0);
              },
              open: true,
              buttonClassName: "w-full",
              $$slots: {
                content: ($$anchor4, $$slotProps) => {
                  var div_6 = root_8$3();
                  var textarea = child(div_6);
                  remove_textarea_child(textarea);
                  reset(div_6);
                  template_effect(
                    ($02) => {
                      set_class(textarea, 1, `w-full text-xs outline-hidden resize-vertical ${($settings(), untrack(() => $settings().highContrastMode ? "border-2 border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 p-2.5" : "py-1.5 bg-transparent")) ?? ""}`);
                      set_attribute(textarea, "placeholder", $02);
                    },
                    [
                      () => ($i18n(), untrack(() => $i18n().t("Enter system prompt")))
                    ]
                  );
                  bind_value(textarea, () => params().system, ($$value) => params(params().system = $$value, true));
                  append($$anchor4, div_6);
                }
              }
            });
          }
          next(2);
          append($$anchor3, fragment_3);
        };
        if_block(node_7, ($$render) => {
          if ($user(), untrack(() => {
            var _a, _b, _c;
            return ((_a = $user()) == null ? void 0 : _a.role) === "admin" || (((_c = (_b = $user()) == null ? void 0 : _b.permissions.chat) == null ? void 0 : _c.system_prompt) ?? true);
          })) $$render(consequent_2);
        });
      }
      var node_9 = sibling(node_7, 2);
      {
        var consequent_3 = ($$anchor3) => {
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Advanced Params"))));
            Collapsible($$anchor3, {
              get title() {
                return get($0);
              },
              open: true,
              buttonClassName: "w-full",
              $$slots: {
                content: ($$anchor4, $$slotProps) => {
                  var div_7 = root_10$4();
                  var div_8 = child(div_7);
                  var node_10 = child(div_8);
                  {
                    let $02 = derived_safe_equal(() => ($user(), untrack(() => {
                      var _a;
                      return ((_a = $user()) == null ? void 0 : _a.role) === "admin";
                    })));
                    AdvancedParams(node_10, {
                      get admin() {
                        return get($02);
                      },
                      custom: true,
                      get params() {
                        return params();
                      },
                      set params($$value) {
                        params($$value);
                      },
                      $$legacy: true
                    });
                  }
                  reset(div_8);
                  reset(div_7);
                  append($$anchor4, div_7);
                }
              }
            });
          }
        };
        if_block(node_9, ($$render) => {
          if ($user(), untrack(() => {
            var _a, _b, _c;
            return ((_a = $user()) == null ? void 0 : _a.role) === "admin" || (((_c = (_b = $user()) == null ? void 0 : _b.permissions.chat) == null ? void 0 : _c.params) ?? true);
          })) $$render(consequent_3);
        });
      }
      reset(div_3);
      append($$anchor2, div_3);
    };
    if_block(node_1, ($$render) => {
      if ($user(), untrack(() => {
        var _a, _b, _c;
        return ((_a = $user()) == null ? void 0 : _a.role) === "admin" || (((_c = (_b = $user()) == null ? void 0 : _b.permissions.chat) == null ? void 0 : _c.controls) ?? true);
      })) $$render(consequent_4);
    });
  }
  reset(div);
  template_effect(($0) => set_text(text2, $0), [() => ($i18n(), untrack(() => $i18n().t("Chat Controls")))]);
  event("click", button, () => {
    dispatch("close");
  });
  append($$anchor, div);
  pop();
  $$cleanup();
}
var root_5$4 = from_html(`<div class="flex items-center"><div class=" line-clamp-1"> </div></div>`);
var root_2$7 = from_html(`<div slot="content"><!></div>`);
function VideoInputMenu($$anchor, $$props) {
  push($$props, false);
  getContext("i18n");
  const dispatch = createEventDispatcher();
  let onClose = prop($$props, "onClose", 8, () => {
  });
  let devices = prop($$props, "devices", 8);
  let show2 = mutable_source(false);
  init();
  Dropdown($$anchor, {
    get show() {
      return get(show2);
    },
    set show($$value) {
      set(show2, $$value);
    },
    $$events: {
      change: (e) => {
        if (e.detail === false) {
          onClose()();
        }
      }
    },
    children: ($$anchor2, $$slotProps) => {
      var fragment_1 = comment();
      var node = first_child(fragment_1);
      slot(node, $$props, "default", {}, null);
      append($$anchor2, fragment_1);
    },
    $$slots: {
      default: true,
      content: ($$anchor2, $$slotProps) => {
        var div = root_2$7();
        var node_1 = child(div);
        Menu_content(node_1, {
          class: "w-full max-w-[180px] rounded-lg p-1 border border-gray-100  dark:border-gray-800 z-9999 bg-white dark:bg-gray-900 dark:text-white shadow-xs",
          sideOffset: 6,
          side: "top",
          align: "start",
          get transition() {
            return flyAndScale;
          },
          children: ($$anchor3, $$slotProps2) => {
            var fragment_2 = comment();
            var node_2 = first_child(fragment_2);
            each(node_2, 1, devices, index, ($$anchor4, device) => {
              Menu_item($$anchor4, {
                class: "flex gap-2 items-center px-3 py-1.5 text-sm  cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 rounded-md",
                $$events: {
                  click: () => {
                    dispatch("change", get(device).deviceId);
                  }
                },
                children: ($$anchor5, $$slotProps3) => {
                  var div_1 = root_5$4();
                  var div_2 = child(div_1);
                  var text2 = child(div_2, true);
                  reset(div_2);
                  reset(div_1);
                  template_effect(() => set_text(text2, (get(device), untrack(() => {
                    var _a;
                    return ((_a = get(device)) == null ? void 0 : _a.label) ?? "Camera";
                  }))));
                  append($$anchor5, div_1);
                },
                $$slots: { default: true }
              });
            });
            append($$anchor3, fragment_2);
          },
          $$slots: { default: true }
        });
        reset(div);
        append($$anchor2, div);
      }
    },
    $$legacy: true
  });
  pop();
}
var root_3$4 = from_html(`<div class="  transition-all rounded-full"> </div>`);
var root_5$3 = from_svg(`<svg class="size-12 text-gray-900 dark:text-gray-400" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><style>.spinner_qM83 {
								animation: spinner_8HQG 1.05s infinite;
							}
							.spinner_oXPr {
								animation-delay: 0.1s;
							}
							.spinner_ZTLf {
								animation-delay: 0.2s;
							}
							@keyframes spinner_8HQG {
								0%,
								57.14% {
									animation-timing-function: cubic-bezier(0.33, 0.66, 0.66, 1);
									transform: translate(0);
								}
								28.57% {
									animation-timing-function: cubic-bezier(0.33, 0, 0.66, 0.33);
									transform: translateY(-6px);
								}
								100% {
									transform: translate(0);
								}
							}</style><circle class="spinner_qM83" cx="4" cy="12" r="3"></circle><circle class="spinner_qM83 spinner_oXPr" cx="12" cy="12" r="3"></circle><circle class="spinner_qM83 spinner_ZTLf" cx="20" cy="12" r="3"></circle></svg>`);
var root_6$5 = from_html(`<div></div>`);
var root_2$6 = from_html(`<button type="button" class="flex justify-center items-center w-full h-20 min-h-20"><!></button>`);
var root_8$2 = from_html(`<div class="  transition-all rounded-full"> </div>`);
var root_10$3 = from_svg(`<svg class="size-44 text-gray-900 dark:text-gray-400" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><style>.spinner_qM83 {
									animation: spinner_8HQG 1.05s infinite;
								}
								.spinner_oXPr {
									animation-delay: 0.1s;
								}
								.spinner_ZTLf {
									animation-delay: 0.2s;
								}
								@keyframes spinner_8HQG {
									0%,
									57.14% {
										animation-timing-function: cubic-bezier(0.33, 0.66, 0.66, 1);
										transform: translate(0);
									}
									28.57% {
										animation-timing-function: cubic-bezier(0.33, 0, 0.66, 0.33);
										transform: translateY(-6px);
									}
									100% {
										transform: translate(0);
									}
								}</style><circle class="spinner_qM83" cx="4" cy="12" r="3"></circle><circle class="spinner_qM83 spinner_oXPr" cx="12" cy="12" r="3"></circle><circle class="spinner_qM83 spinner_ZTLf" cx="20" cy="12" r="3"></circle></svg>`);
var root_11$3 = from_html(`<div></div>`);
var root_7$3 = from_html(`<button type="button"><!></button>`);
var root_12$1 = from_html(`<div class="relative flex video-container w-full max-h-full pt-2 pb-4 md:py-6 px-2 h-full"><video id="camera-feed" autoplay class="rounded-2xl h-full min-w-full object-cover object-center" playsinline=""></video> <canvas id="camera-canvas" style="display:none;"></canvas> <div class=" absolute top-4 md:top-8 left-4"><button type="button" class="p-1.5 text-white cursor-pointer backdrop-blur-xl bg-black/10 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-6"><path d="M5.28 4.22a.75.75 0 0 0-1.06 1.06L6.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L8 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L9.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L8 6.94 5.28 4.22Z"></path></svg></button></div></div>`, 2);
var root_14$1 = from_html(`<button class=" p-3 rounded-full bg-gray-50 dark:bg-gray-900" type="button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 0 1-9.201 2.466l-.312-.311h2.433a.75.75 0 0 0 0-1.5H3.989a.75.75 0 0 0-.75.75v4.242a.75.75 0 0 0 1.5 0v-2.43l.31.31a7 7 0 0 0 11.712-3.138.75.75 0 0 0-1.449-.39Zm1.23-3.723a.75.75 0 0 0 .219-.53V2.929a.75.75 0 0 0-1.5 0V5.36l-.31-.31A7 7 0 0 0 3.239 8.188a.75.75 0 1 0 1.448.389A5.5 5.5 0 0 1 13.89 6.11l.311.31h-2.432a.75.75 0 0 0 0 1.5h4.243a.75.75 0 0 0 .53-.219Z" clip-rule="evenodd"></path></svg></button>`);
var root_16 = from_html(`<button class=" p-3 rounded-full bg-gray-50 dark:bg-gray-900" type="button"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z"></path></svg></button>`);
var root_1$4 = from_html(`<div class="max-w-lg w-full h-full max-h-[100dvh] flex flex-col justify-between p-3 md:p-6"><!> <div class="flex justify-center items-center flex-1 h-full w-full max-h-full"><!></div> <div class="flex justify-between items-center pb-2 w-full"><div><!></div> <div><button type="button"><div class=" line-clamp-1 text-sm font-medium"><!></div></button></div> <div><button class=" p-3 rounded-full bg-gray-50 dark:bg-gray-900" type="button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path d="M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z"></path></svg></button></div></div></div>`);
function CallOverlay($$anchor, $$props) {
  push($$props, false);
  const $settings = () => store_get(settings, "$settings", $$stores);
  const $showCallOverlay = () => store_get(showCallOverlay, "$showCallOverlay", $$stores);
  const $config = () => store_get(config, "$config", $$stores);
  const $TTSWorker = () => store_get(TTSWorker, "$TTSWorker", $$stores);
  const $models = () => store_get(models, "$models", $$stores);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const dispatch = createEventDispatcher();
  const i18n = getContext("i18n");
  let eventTarget = prop($$props, "eventTarget", 8);
  let submitPrompt = prop($$props, "submitPrompt", 8);
  let stopResponse = prop($$props, "stopResponse", 8);
  let files = prop($$props, "files", 12);
  let chatId2 = prop($$props, "chatId", 8);
  let modelId = prop($$props, "modelId", 8);
  let wakeLock = null;
  let model = mutable_source(null);
  let loading = mutable_source(false);
  let confirmed = false;
  let assistantSpeaking = mutable_source(false);
  let emoji = mutable_source(null);
  let camera = mutable_source(false);
  let cameraStream = mutable_source(null);
  let chatStreaming = false;
  let rmsLevel = mutable_source(0);
  let hasStartedSpeaking = false;
  let mediaRecorder;
  let audioStream = mutable_source(null);
  let audioChunks = [];
  let videoInputDevices = mutable_source([]);
  let selectedVideoInputDeviceId = mutable_source(null);
  const getVideoInputDevices = async () => {
    const devices = await navigator.mediaDevices.enumerateDevices();
    set(videoInputDevices, devices.filter((device) => device.kind === "videoinput"));
    if (!!navigator.mediaDevices.getDisplayMedia) {
      set(videoInputDevices, [
        ...get(videoInputDevices),
        { deviceId: "screen", label: "Screen Share" }
      ]);
    }
    console.log(get(videoInputDevices));
    if (get(selectedVideoInputDeviceId) === null && get(videoInputDevices).length > 0) {
      set(selectedVideoInputDeviceId, get(videoInputDevices)[0].deviceId);
    }
  };
  const startCamera = async () => {
    await getVideoInputDevices();
    if (get(cameraStream) === null) {
      set(camera, true);
      await tick();
      try {
        await startVideoStream();
      } catch (err) {
        console.error("Error accessing webcam: ", err);
      }
    }
  };
  const startVideoStream = async () => {
    const video = document.getElementById("camera-feed");
    if (video) {
      if (get(selectedVideoInputDeviceId) === "screen") {
        set(cameraStream, await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "always" }, audio: false }));
      } else {
        set(cameraStream, await navigator.mediaDevices.getUserMedia({
          video: {
            deviceId: get(selectedVideoInputDeviceId) ? { exact: get(selectedVideoInputDeviceId) } : void 0
          }
        }));
      }
      if (get(cameraStream)) {
        await getVideoInputDevices();
        video.srcObject = get(cameraStream);
        await video.play();
      }
    }
  };
  const stopVideoStream = async () => {
    if (get(cameraStream)) {
      const tracks = get(cameraStream).getTracks();
      tracks.forEach((track) => track.stop());
    }
    set(cameraStream, null);
  };
  const takeScreenshot = () => {
    const video = document.getElementById("camera-feed");
    const canvas = document.getElementById("camera-canvas");
    if (!canvas) {
      return;
    }
    const context = canvas.getContext("2d");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
    const dataURL = canvas.toDataURL("image/png");
    console.log(dataURL);
    return dataURL;
  };
  const stopCamera = async () => {
    await stopVideoStream();
    set(camera, false);
  };
  const MIN_DECIBELS = -55;
  const transcribeHandler = async (audioBlob) => {
    var _a, _b, _c;
    await tick();
    const file = blobToFile(audioBlob, "recording.wav");
    const res = await transcribeAudio(localStorage.token, file, (_c = (_b = (_a = $settings()) == null ? void 0 : _a.audio) == null ? void 0 : _b.stt) == null ? void 0 : _c.language).catch((error) => {
      toast.error(`${error}`);
      return null;
    });
    if (res) {
      console.log(res.text);
      if (res.text !== "") {
        const _responses = await submitPrompt()(res.text, { _raw: true });
        console.log(_responses);
      }
    }
  };
  const stopRecordingCallback = async (_continue = true) => {
    if ($showCallOverlay()) {
      console.log("%c%s", "color: red; font-size: 20px;", " stopRecordingCallback ");
      const _audioChunks = audioChunks.slice(0);
      audioChunks = [];
      mediaRecorder = false;
      if (_continue) {
        startRecording();
      }
      if (confirmed) {
        set(loading, true);
        set(emoji, null);
        if (get(cameraStream)) {
          const imageUrl = takeScreenshot();
          files([{ type: "image", url: imageUrl }]);
        }
        const audioBlob = new Blob(_audioChunks, { type: "audio/wav" });
        await transcribeHandler(audioBlob);
        confirmed = false;
        set(loading, false);
      }
    } else {
      audioChunks = [];
      mediaRecorder = false;
      if (get(audioStream)) {
        const tracks = get(audioStream).getTracks();
        tracks.forEach((track) => track.stop());
      }
      set(audioStream, null);
    }
  };
  const startRecording = async () => {
    if ($showCallOverlay()) {
      if (!get(audioStream)) {
        set(audioStream, await navigator.mediaDevices.getUserMedia({
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        }));
      }
      mediaRecorder = new MediaRecorder(get(audioStream));
      mediaRecorder.onstart = () => {
        console.log("Recording started");
        audioChunks = [];
      };
      mediaRecorder.ondataavailable = (event2) => {
        if (hasStartedSpeaking) {
          audioChunks.push(event2.data);
        }
      };
      mediaRecorder.onstop = (e) => {
        console.log("Recording stopped", get(audioStream), e);
        stopRecordingCallback();
      };
      analyseAudio(get(audioStream));
    }
  };
  const stopAudioStream = async () => {
    try {
      if (mediaRecorder) {
        mediaRecorder.stop();
      }
    } catch (error) {
      console.log("Error stopping audio stream:", error);
    }
    if (!get(audioStream)) return;
    get(audioStream).getAudioTracks().forEach(function(track) {
      track.stop();
    });
    set(audioStream, null);
  };
  const calculateRMS = (data) => {
    let sumSquares = 0;
    for (let i = 0; i < data.length; i++) {
      const normalizedValue = (data[i] - 128) / 128;
      sumSquares += normalizedValue * normalizedValue;
    }
    return Math.sqrt(sumSquares / data.length);
  };
  const analyseAudio = (stream) => {
    const audioContext = new AudioContext();
    const audioStreamSource = audioContext.createMediaStreamSource(stream);
    const analyser = audioContext.createAnalyser();
    analyser.minDecibels = MIN_DECIBELS;
    audioStreamSource.connect(analyser);
    const bufferLength = analyser.frequencyBinCount;
    const domainData = new Uint8Array(bufferLength);
    const timeDomainData = new Uint8Array(analyser.fftSize);
    let lastSoundTime = Date.now();
    hasStartedSpeaking = false;
    console.log(" Sound detection started", lastSoundTime, hasStartedSpeaking);
    const detectSound = () => {
      const processFrame = () => {
        var _a;
        if (!mediaRecorder || !$showCallOverlay()) {
          return;
        }
        if (get(assistantSpeaking) && !(((_a = $settings()) == null ? void 0 : _a.voiceInterruption) ?? false)) {
          analyser.maxDecibels = 0;
          analyser.minDecibels = -1;
        } else {
          analyser.minDecibels = MIN_DECIBELS;
          analyser.maxDecibels = -30;
        }
        analyser.getByteTimeDomainData(timeDomainData);
        analyser.getByteFrequencyData(domainData);
        set(rmsLevel, calculateRMS(timeDomainData));
        const hasSound = domainData.some((value) => value > 0);
        if (hasSound) {
          console.log("%c%s", "color: red; font-size: 20px;", " Sound detected");
          if (mediaRecorder && mediaRecorder.state !== "recording") {
            mediaRecorder.start();
          }
          if (!hasStartedSpeaking) {
            hasStartedSpeaking = true;
            stopAllAudio();
          }
          lastSoundTime = Date.now();
        }
        if (hasStartedSpeaking) {
          if (Date.now() - lastSoundTime > 2e3) {
            confirmed = true;
            if (mediaRecorder) {
              console.log("%c%s", "color: red; font-size: 20px;", " Silence detected");
              mediaRecorder.stop();
              return;
            }
          }
        }
        window.requestAnimationFrame(processFrame);
      };
      window.requestAnimationFrame(processFrame);
    };
    detectSound();
  };
  let finishedMessages = {};
  let currentMessageId = null;
  let currentUtterance = null;
  const speakSpeechSynthesisHandler = (content) => {
    if ($showCallOverlay()) {
      return new Promise((resolve) => {
        let voices = [];
        const getVoicesLoop = setInterval(
          async () => {
            var _a, _b, _c;
            voices = await speechSynthesis.getVoices();
            if (voices.length > 0) {
              clearInterval(getVoicesLoop);
              const voice = ((_a = voices == null ? void 0 : voices.filter((v) => {
                var _a2, _b2, _c2, _d, _e, _f;
                return v.voiceURI === (((_c2 = (_b2 = (_a2 = $settings()) == null ? void 0 : _a2.audio) == null ? void 0 : _b2.tts) == null ? void 0 : _c2.voice) ?? ((_f = (_e = (_d = $config()) == null ? void 0 : _d.audio) == null ? void 0 : _e.tts) == null ? void 0 : _f.voice));
              })) == null ? void 0 : _a.at(0)) ?? void 0;
              currentUtterance = new SpeechSynthesisUtterance(content);
              currentUtterance.rate = ((_c = (_b = $settings().audio) == null ? void 0 : _b.tts) == null ? void 0 : _c.playbackRate) ?? 1;
              if (voice) {
                currentUtterance.voice = voice;
              }
              speechSynthesis.speak(currentUtterance);
              currentUtterance.onend = async (e) => {
                await new Promise((r) => setTimeout(r, 200));
                resolve(e);
              };
            }
          },
          100
        );
      });
    } else {
      return Promise.resolve();
    }
  };
  const playAudio = (audio) => {
    if ($showCallOverlay()) {
      return new Promise((resolve) => {
        var _a, _b;
        const audioElement = document.getElementById("audioElement");
        if (audioElement) {
          audioElement.src = audio.src;
          audioElement.muted = true;
          audioElement.playbackRate = ((_b = (_a = $settings().audio) == null ? void 0 : _a.tts) == null ? void 0 : _b.playbackRate) ?? 1;
          audioElement.play().then(() => {
            audioElement.muted = false;
          }).catch((error) => {
            console.error(error);
          });
          audioElement.onended = async (e) => {
            await new Promise((r) => setTimeout(r, 100));
            resolve(e);
          };
        }
      });
    } else {
      return Promise.resolve();
    }
  };
  const stopAllAudio = async () => {
    set(assistantSpeaking, false);
    if (chatStreaming) {
      stopResponse()();
    }
    if (currentUtterance) {
      speechSynthesis.cancel();
      currentUtterance = null;
    }
    const audioElement = document.getElementById("audioElement");
    if (audioElement) {
      audioElement.muted = true;
      audioElement.pause();
      audioElement.currentTime = 0;
    }
  };
  let audioAbortController = new AbortController();
  const audioCache = /* @__PURE__ */ new Map();
  const emojiCache = /* @__PURE__ */ new Map();
  const fetchAudio = async (content) => {
    var _a, _b, _c, _d, _e, _f, _g, _h, _i, _j, _k, _l, _m, _n, _o, _p, _q, _r, _s, _t, _u;
    if (!audioCache.has(content)) {
      try {
        if (((_a = $settings()) == null ? void 0 : _a.showEmojiInCall) ?? false) {
          const emoji2 = await generateEmoji(localStorage.token, modelId(), content, chatId2());
          if (emoji2) {
            emojiCache.set(content, emoji2);
          }
        }
        if (((_c = (_b = $settings().audio) == null ? void 0 : _b.tts) == null ? void 0 : _c.engine) === "browser-kokoro") {
          const url = await $TTSWorker().generate({
            text: content,
            voice: ((_f = (_e = (_d = $settings()) == null ? void 0 : _d.audio) == null ? void 0 : _e.tts) == null ? void 0 : _f.voice) ?? ((_i = (_h = (_g = $config()) == null ? void 0 : _g.audio) == null ? void 0 : _h.tts) == null ? void 0 : _i.voice)
          }).catch((error) => {
            console.error(error);
            toast.error(`${error}`);
          });
          if (url) {
            audioCache.set(content, new Audio(url));
          }
        } else if ($config().audio.tts.engine !== "") {
          const res = await synthesizeOpenAISpeech(
            localStorage.token,
            ((_l = (_k = (_j = $settings()) == null ? void 0 : _j.audio) == null ? void 0 : _k.tts) == null ? void 0 : _l.defaultVoice) === $config().audio.tts.voice ? ((_o = (_n = (_m = $settings()) == null ? void 0 : _m.audio) == null ? void 0 : _n.tts) == null ? void 0 : _o.voice) ?? ((_r = (_q = (_p = $config()) == null ? void 0 : _p.audio) == null ? void 0 : _q.tts) == null ? void 0 : _r.voice) : (_u = (_t = (_s = $config()) == null ? void 0 : _s.audio) == null ? void 0 : _t.tts) == null ? void 0 : _u.voice,
            content
          ).catch((error) => {
            console.error(error);
            return null;
          });
          if (res) {
            const blob = await res.blob();
            const blobUrl = URL.createObjectURL(blob);
            audioCache.set(content, new Audio(blobUrl));
          }
        } else {
          audioCache.set(content, true);
        }
      } catch (error) {
        console.error("Error synthesizing speech:", error);
      }
    }
    return audioCache.get(content);
  };
  let messages = {};
  const monitorAndPlayAudio = async (id, signal) => {
    var _a;
    while (!signal.aborted) {
      if (messages[id] && messages[id].length > 0) {
        const content = messages[id].shift();
        if (audioCache.has(content)) {
          if ((((_a = $settings()) == null ? void 0 : _a.showEmojiInCall) ?? false) && emojiCache.has(content)) {
            set(emoji, emojiCache.get(content));
          } else {
            set(emoji, null);
          }
          if ($config().audio.tts.engine !== "") {
            try {
              console.log("%c%s", "color: red; font-size: 20px;", `Playing audio for content: ${content}`);
              const audio = audioCache.get(content);
              await playAudio(audio);
              console.log(`Played audio for content: ${content}`);
              await new Promise((resolve) => setTimeout(resolve, 200));
            } catch (error) {
              console.error("Error playing audio:", error);
            }
          } else {
            await speakSpeechSynthesisHandler(content);
          }
        } else {
          messages[id].unshift(content);
          console.log(`Audio for "${content}" not yet available in the cache, re-queued...`);
          await new Promise((resolve) => setTimeout(resolve, 200));
        }
      } else if (finishedMessages[id] && messages[id] && messages[id].length === 0) {
        set(assistantSpeaking, false);
        break;
      } else {
        await new Promise((resolve) => setTimeout(resolve, 200));
      }
    }
    console.log(`Audio monitoring and playing stopped for message ID ${id}`);
  };
  const chatStartHandler = async (e) => {
    const { id } = e.detail;
    chatStreaming = true;
    if (currentMessageId !== id) {
      console.log(`Received chat start event for message ID ${id}`);
      currentMessageId = id;
      if (audioAbortController) {
        audioAbortController.abort();
      }
      audioAbortController = new AbortController();
      set(assistantSpeaking, true);
      monitorAndPlayAudio(id, audioAbortController.signal);
    }
  };
  const chatEventHandler = async (e) => {
    const { id, content } = e.detail;
    if (currentMessageId === id) {
      console.log(`Received chat event for message ID ${id}: ${content}`);
      try {
        if (messages[id] === void 0) {
          messages[id] = [content];
        } else {
          messages[id].push(content);
        }
        console.log(content);
        fetchAudio(content);
      } catch (error) {
        console.error("Failed to fetch or play audio:", error);
      }
    }
  };
  const chatFinishHandler = async (e) => {
    const { id, content } = e.detail;
    finishedMessages[id] = true;
    chatStreaming = false;
  };
  onMount(async () => {
    const setWakeLock = async () => {
      try {
        wakeLock = await navigator.wakeLock.request("screen");
      } catch (err) {
        console.log(err);
      }
      if (wakeLock) {
        wakeLock.addEventListener("release", () => {
          console.log("Wake Lock released");
        });
      }
    };
    if ("wakeLock" in navigator) {
      await setWakeLock();
      document.addEventListener("visibilitychange", async () => {
        if (wakeLock !== null && document.visibilityState === "visible") {
          await setWakeLock();
        }
      });
    }
    set(model, $models().find((m) => m.id === modelId()));
    startRecording();
    eventTarget().addEventListener("chat:start", chatStartHandler);
    eventTarget().addEventListener("chat", chatEventHandler);
    eventTarget().addEventListener("chat:finish", chatFinishHandler);
    return async () => {
      await stopAllAudio();
      stopAudioStream();
      eventTarget().removeEventListener("chat:start", chatStartHandler);
      eventTarget().removeEventListener("chat", chatEventHandler);
      eventTarget().removeEventListener("chat:finish", chatFinishHandler);
      audioAbortController.abort();
      await tick();
      await stopAllAudio();
      await stopRecordingCallback(false);
      await stopCamera();
    };
  });
  onDestroy(async () => {
    await stopAllAudio();
    await stopRecordingCallback(false);
    await stopCamera();
    await stopAudioStream();
    eventTarget().removeEventListener("chat:start", chatStartHandler);
    eventTarget().removeEventListener("chat", chatEventHandler);
    eventTarget().removeEventListener("chat:finish", chatFinishHandler);
    audioAbortController.abort();
    await tick();
    await stopAllAudio();
  });
  init();
  var fragment = comment();
  var node = first_child(fragment);
  {
    var consequent_9 = ($$anchor2) => {
      var div = root_1$4();
      var node_1 = child(div);
      {
        var consequent_2 = ($$anchor3) => {
          var button = root_2$6();
          var node_2 = child(button);
          {
            var consequent = ($$anchor4) => {
              var div_1 = root_3$4();
              var text2 = child(div_1, true);
              reset(div_1);
              template_effect(() => {
                set_style(div_1, `font-size:${get(rmsLevel) * 100 > 4 ? "4.5" : get(rmsLevel) * 100 > 2 ? "4.25" : get(rmsLevel) * 100 > 1 ? "3.75" : "3.5"}rem;width: 100%; text-align:center;`);
                set_text(text2, get(emoji));
              });
              append($$anchor4, div_1);
            };
            var alternate_1 = ($$anchor4) => {
              var fragment_1 = comment();
              var node_3 = first_child(fragment_1);
              {
                var consequent_1 = ($$anchor5) => {
                  var svg = root_5$3();
                  append($$anchor5, svg);
                };
                var alternate = ($$anchor5) => {
                  var div_2 = root_6$5();
                  template_effect(() => {
                    set_class(div_2, 1, ` ${get(rmsLevel) * 100 > 4 ? " size-[4.5rem]" : get(rmsLevel) * 100 > 2 ? " size-16" : get(rmsLevel) * 100 > 1 ? "size-14" : "size-12"}  transition-all rounded-full bg-cover bg-center bg-no-repeat`);
                    set_style(div_2, (deep_read_state(WEBUI_API_BASE_URL$1), get(model), $i18n(), untrack(() => {
                      var _a;
                      return `background-image: url('${WEBUI_API_BASE_URL$1}/models/model/profile/image?id=${(_a = get(model)) == null ? void 0 : _a.id}&lang=${$i18n().language}&voice=true');`;
                    })));
                  });
                  append($$anchor5, div_2);
                };
                if_block(
                  node_3,
                  ($$render) => {
                    if (get(loading) || get(assistantSpeaking)) $$render(consequent_1);
                    else $$render(alternate, false);
                  },
                  true
                );
              }
              append($$anchor4, fragment_1);
            };
            if_block(node_2, ($$render) => {
              if (get(emoji)) $$render(consequent);
              else $$render(alternate_1, false);
            });
          }
          reset(button);
          event("click", button, () => {
            if (get(assistantSpeaking)) {
              stopAllAudio();
            }
          });
          append($$anchor3, button);
        };
        if_block(node_1, ($$render) => {
          if (get(camera)) $$render(consequent_2);
        });
      }
      var div_3 = sibling(node_1, 2);
      var node_4 = child(div_3);
      {
        var consequent_5 = ($$anchor3) => {
          var button_1 = root_7$3();
          var node_5 = child(button_1);
          {
            var consequent_3 = ($$anchor4) => {
              var div_4 = root_8$2();
              var text_1 = child(div_4, true);
              reset(div_4);
              template_effect(() => {
                set_style(div_4, `font-size:${get(rmsLevel) * 100 > 4 ? "13" : get(rmsLevel) * 100 > 2 ? "12" : get(rmsLevel) * 100 > 1 ? "11.5" : "11"}rem;width:100%;text-align:center;`);
                set_text(text_1, get(emoji));
              });
              append($$anchor4, div_4);
            };
            var alternate_3 = ($$anchor4) => {
              var fragment_2 = comment();
              var node_6 = first_child(fragment_2);
              {
                var consequent_4 = ($$anchor5) => {
                  var svg_1 = root_10$3();
                  append($$anchor5, svg_1);
                };
                var alternate_2 = ($$anchor5) => {
                  var div_5 = root_11$3();
                  template_effect(() => {
                    set_class(div_5, 1, ` ${get(rmsLevel) * 100 > 4 ? " size-52" : get(rmsLevel) * 100 > 2 ? "size-48" : get(rmsLevel) * 100 > 1 ? "size-44" : "size-40"} transition-all rounded-full bg-cover bg-center bg-no-repeat`);
                    set_style(div_5, (deep_read_state(WEBUI_API_BASE_URL$1), get(model), $i18n(), untrack(() => {
                      var _a;
                      return `background-image: url('${WEBUI_API_BASE_URL$1}/models/model/profile/image?id=${(_a = get(model)) == null ? void 0 : _a.id}&lang=${$i18n().language}&voice=true');`;
                    })));
                  });
                  append($$anchor5, div_5);
                };
                if_block(
                  node_6,
                  ($$render) => {
                    if (get(loading) || get(assistantSpeaking)) $$render(consequent_4);
                    else $$render(alternate_2, false);
                  },
                  true
                );
              }
              append($$anchor4, fragment_2);
            };
            if_block(node_5, ($$render) => {
              if (get(emoji)) $$render(consequent_3);
              else $$render(alternate_3, false);
            });
          }
          reset(button_1);
          event("click", button_1, () => {
            if (get(assistantSpeaking)) {
              stopAllAudio();
            }
          });
          append($$anchor3, button_1);
        };
        var alternate_4 = ($$anchor3) => {
          var div_6 = root_12$1();
          var div_7 = sibling(child(div_6), 4);
          var button_2 = child(div_7);
          reset(div_7);
          reset(div_6);
          event("click", button_2, () => {
            stopCamera();
          });
          append($$anchor3, div_6);
        };
        if_block(node_4, ($$render) => {
          if (!get(camera)) $$render(consequent_5);
          else $$render(alternate_4, false);
        });
      }
      reset(div_3);
      var div_8 = sibling(div_3, 2);
      var div_9 = child(div_8);
      var node_7 = child(div_9);
      {
        var consequent_6 = ($$anchor3) => {
          VideoInputMenu($$anchor3, {
            get devices() {
              return get(videoInputDevices);
            },
            $$events: {
              change: async (e) => {
                console.log(e.detail);
                set(selectedVideoInputDeviceId, e.detail);
                await stopVideoStream();
                await startVideoStream();
              }
            },
            children: ($$anchor4, $$slotProps) => {
              var button_3 = root_14$1();
              append($$anchor4, button_3);
            },
            $$slots: { default: true }
          });
        };
        var alternate_5 = ($$anchor3) => {
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Camera"))));
            Tooltip($$anchor3, {
              get content() {
                return get($0);
              },
              children: ($$anchor4, $$slotProps) => {
                var button_4 = root_16();
                event("click", button_4, async () => {
                  await navigator.mediaDevices.getUserMedia({ video: true });
                  startCamera();
                });
                append($$anchor4, button_4);
              },
              $$slots: { default: true }
            });
          }
        };
        if_block(node_7, ($$render) => {
          if (get(camera)) $$render(consequent_6);
          else $$render(alternate_5, false);
        });
      }
      reset(div_9);
      var div_10 = sibling(div_9, 2);
      var button_5 = child(div_10);
      var div_11 = child(button_5);
      var node_8 = child(div_11);
      {
        var consequent_7 = ($$anchor3) => {
          var text_2 = text();
          template_effect(($0) => set_text(text_2, $0), [() => ($i18n(), untrack(() => $i18n().t("Thinking...")))]);
          append($$anchor3, text_2);
        };
        var alternate_7 = ($$anchor3) => {
          var fragment_6 = comment();
          var node_9 = first_child(fragment_6);
          {
            var consequent_8 = ($$anchor4) => {
              var text_3 = text();
              template_effect(($0) => set_text(text_3, $0), [
                () => ($i18n(), untrack(() => $i18n().t("Tap to interrupt")))
              ]);
              append($$anchor4, text_3);
            };
            var alternate_6 = ($$anchor4) => {
              var text_4 = text();
              template_effect(($0) => set_text(text_4, $0), [() => ($i18n(), untrack(() => $i18n().t("Listening...")))]);
              append($$anchor4, text_4);
            };
            if_block(
              node_9,
              ($$render) => {
                if (get(assistantSpeaking)) $$render(consequent_8);
                else $$render(alternate_6, false);
              },
              true
            );
          }
          append($$anchor3, fragment_6);
        };
        if_block(node_8, ($$render) => {
          if (get(loading)) $$render(consequent_7);
          else $$render(alternate_7, false);
        });
      }
      reset(div_11);
      reset(button_5);
      reset(div_10);
      var div_12 = sibling(div_10, 2);
      var button_6 = child(div_12);
      reset(div_12);
      reset(div_8);
      reset(div);
      event("click", button_5, () => {
        if (get(assistantSpeaking)) {
          stopAllAudio();
        }
      });
      event("click", button_6, async () => {
        await stopAudioStream();
        await stopVideoStream();
        console.log(get(audioStream));
        console.log(get(cameraStream));
        showCallOverlay.set(false);
        dispatch("close");
      });
      append($$anchor2, div);
    };
    if_block(node, ($$render) => {
      if ($showCallOverlay()) $$render(consequent_9);
    });
  }
  append($$anchor, fragment);
  pop();
  $$cleanup();
}
var root$4 = from_svg(`<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15"></path></svg>`);
function ArrowsPointingOut($$anchor, $$props) {
  let className = prop($$props, "className", 8, "size-4");
  let strokeWidth = prop($$props, "strokeWidth", 8, "1.5");
  var svg = root$4();
  template_effect(() => {
    set_attribute(svg, "stroke-width", strokeWidth());
    set_class(svg, 0, clsx(className()));
  });
  append($$anchor, svg);
}
var root_2$5 = from_html(`<button class=" bg-none border-none text-xs bg-gray-50 hover:bg-gray-100 dark:bg-gray-850 dark:hover:bg-gray-800 transition rounded-md p-0.5"><!></button>`);
var root_4$2 = from_html(`<button class=" bg-none border-none text-xs bg-gray-50 hover:bg-gray-100 dark:bg-gray-850 dark:hover:bg-gray-800 transition rounded-md p-0.5"><!></button>`);
var root_1$3 = from_html(`<div class="pointer-events-auto z-20 flex justify-between items-center p-2.5 font-primar text-gray-900 dark:text-white"><div class="flex-1 flex items-center justify-between pr-1"><div class="flex items-center space-x-2"><div class="flex items-center gap-0.5 self-center min-w-fit" dir="ltr"><button class="self-center p-1 hover:bg-black/5 dark:hover:bg-white/5 dark:hover:text-white hover:text-black rounded-md transition disabled:cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" class="size-3.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5"></path></svg></button> <div class="text-xs self-center dark:text-gray-100 min-w-fit"> </div> <button class="self-center p-1 hover:bg-black/5 dark:hover:bg-white/5 dark:hover:text-white hover:text-black rounded-md transition disabled:cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" class="size-3.5"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5"></path></svg></button></div></div> <div class="flex items-center gap-1.5"><button class="copy-code-button bg-none border-none text-xs bg-gray-50 hover:bg-gray-100 dark:bg-gray-850 dark:hover:bg-gray-800 transition rounded-md px-1.5 py-0.5"> </button> <!> <!></div></div> <button class="self-center pointer-events-auto p-1 rounded-full bg-white dark:bg-gray-850"><!></button></div>`);
var root_5$2 = from_html(`<div class=" absolute top-0 left-0 right-0 bottom-0 z-10"></div>`);
var root_7$2 = from_html(`<iframe title="Content" class="w-full border-0 h-full rounded-none"></iframe>`);
var root_6$4 = from_html(`<div class="max-w-full w-full h-full"><!></div>`);
var root_10$2 = from_html(`<div class="m-auto font-medium text-xs text-gray-900 dark:text-white"> </div>`);
var root$3 = from_html(`<div class=" w-full h-full relative flex flex-col bg-white dark:bg-gray-850" id="artifacts-container"><div class="w-full h-full flex flex-col flex-1 relative"><!> <!> <div class="flex-1 w-full h-full"><div class=" h-full flex flex-col"><!></div></div></div></div>`);
function Artifacts($$anchor, $$props) {
  push($$props, false);
  const $chatId = () => store_get(chatId, "$chatId", $$stores);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const $settings = () => store_get(settings, "$settings", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const i18n = getContext("i18n");
  const dispatch = createEventDispatcher();
  let overlay = prop($$props, "overlay", 8, false);
  let contents = mutable_source([]);
  let selectedContentIdx = mutable_source(0);
  let copied = mutable_source(false);
  let iframeElement = mutable_source();
  function navigateContent(direction) {
    set(selectedContentIdx, direction === "prev" ? Math.max(get(selectedContentIdx) - 1, 0) : Math.min(get(selectedContentIdx) + 1, get(contents).length - 1));
  }
  const iframeLoadHandler = () => {
    get(iframeElement).contentWindow.addEventListener(
      "click",
      function(e) {
        const target = e.target.closest("a");
        if (target && target.href) {
          e.preventDefault();
          const url = new URL(target.href, get(iframeElement).baseURI);
          if (url.origin === window.location.origin) {
            get(iframeElement).contentWindow.history.pushState(null, "", url.pathname + url.search + url.hash);
          } else {
            console.info("External navigation blocked:", url.href);
          }
        }
      },
      true
    );
    get(iframeElement).contentWindow.addEventListener("mouseenter", function(e) {
      e.preventDefault();
      get(iframeElement).contentWindow.addEventListener("dragstart", (event2) => {
        event2.preventDefault();
      });
    });
  };
  const showFullScreen = () => {
    if (get(iframeElement).requestFullscreen) {
      get(iframeElement).requestFullscreen();
    } else if (get(iframeElement).webkitRequestFullscreen) {
      get(iframeElement).webkitRequestFullscreen();
    } else if (get(iframeElement).msRequestFullscreen) {
      get(iframeElement).msRequestFullscreen();
    }
  };
  const downloadArtifact = () => {
    const blob = new Blob([get(contents)[get(selectedContentIdx)].content], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `artifact-${$chatId()}-${get(selectedContentIdx)}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };
  onMount(() => {
    artifactCode.subscribe((value) => {
      if (get(contents)) {
        const codeIdx = get(contents).findIndex((content) => content.content.includes(value));
        set(selectedContentIdx, codeIdx !== -1 ? codeIdx : 0);
      }
    });
    artifactContents.subscribe((value) => {
      set(contents, value);
      console.log("Artifact contents updated:", get(contents));
      if (get(contents).length === 0) {
        showControls.set(false);
        showArtifacts.set(false);
      }
      set(selectedContentIdx, get(contents) ? get(contents).length - 1 : 0);
    });
  });
  init();
  var div = root$3();
  var div_1 = child(div);
  var node = child(div_1);
  {
    var consequent_1 = ($$anchor2) => {
      var div_2 = root_1$3();
      var div_3 = child(div_2);
      var div_4 = child(div_3);
      var div_5 = child(div_4);
      var button = child(div_5);
      var div_6 = sibling(button, 2);
      var text2 = child(div_6, true);
      reset(div_6);
      var button_1 = sibling(div_6, 2);
      reset(div_5);
      reset(div_4);
      var div_7 = sibling(div_4, 2);
      var button_2 = child(div_7);
      var text_1 = child(button_2, true);
      reset(button_2);
      var node_1 = sibling(button_2, 2);
      {
        let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Download"))));
        Tooltip(node_1, {
          get content() {
            return get($0);
          },
          children: ($$anchor3, $$slotProps) => {
            var button_3 = root_2$5();
            var node_2 = child(button_3);
            Download(node_2, { className: "size-3.5" });
            reset(button_3);
            event("click", button_3, downloadArtifact);
            append($$anchor3, button_3);
          },
          $$slots: { default: true }
        });
      }
      var node_3 = sibling(node_1, 2);
      {
        var consequent = ($$anchor3) => {
          {
            let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Open in full screen"))));
            Tooltip($$anchor3, {
              get content() {
                return get($0);
              },
              children: ($$anchor4, $$slotProps) => {
                var button_4 = root_4$2();
                var node_4 = child(button_4);
                ArrowsPointingOut(node_4, { className: "size-3.5" });
                reset(button_4);
                event("click", button_4, showFullScreen);
                append($$anchor4, button_4);
              },
              $$slots: { default: true }
            });
          }
        };
        if_block(node_3, ($$render) => {
          if (get(contents), get(selectedContentIdx), untrack(() => get(contents)[get(selectedContentIdx)].type === "iframe")) $$render(consequent);
        });
      }
      reset(div_7);
      reset(div_3);
      var button_5 = sibling(div_3, 2);
      var node_5 = child(button_5);
      XMark(node_5, { className: "size-3.5 text-gray-900 dark:text-white" });
      reset(button_5);
      reset(div_2);
      template_effect(
        ($0, $1) => {
          button.disabled = (get(contents), untrack(() => get(contents).length <= 1));
          set_text(text2, $0);
          button_1.disabled = (get(contents), untrack(() => get(contents).length <= 1));
          div_5.dir = div_5.dir;
          set_text(text_1, $1);
        },
        [
          () => ($i18n(), get(selectedContentIdx), get(contents), untrack(() => $i18n().t("Version {{selectedVersion}} of {{totalVersions}}", {
            selectedVersion: get(selectedContentIdx) + 1,
            totalVersions: get(contents).length
          }))),
          () => (get(copied), $i18n(), untrack(() => get(copied) ? $i18n().t("Copied") : $i18n().t("Copy")))
        ]
      );
      event("click", button, () => navigateContent("prev"));
      event("click", button_1, () => navigateContent("next"));
      event("click", button_2, () => {
        copyToClipboard(get(contents)[get(selectedContentIdx)].content);
        set(copied, true);
        setTimeout(
          () => {
            set(copied, false);
          },
          2e3
        );
      });
      event("click", button_5, () => {
        dispatch("close");
        showControls.set(false);
        showArtifacts.set(false);
      });
      append($$anchor2, div_2);
    };
    if_block(node, ($$render) => {
      if (get(contents), untrack(() => get(contents).length > 0)) $$render(consequent_1);
    });
  }
  var node_6 = sibling(node, 2);
  {
    var consequent_2 = ($$anchor2) => {
      var div_8 = root_5$2();
      append($$anchor2, div_8);
    };
    if_block(node_6, ($$render) => {
      if (overlay()) $$render(consequent_2);
    });
  }
  var div_9 = sibling(node_6, 2);
  var div_10 = child(div_9);
  var node_7 = child(div_10);
  {
    var consequent_5 = ($$anchor2) => {
      var div_11 = root_6$4();
      var node_8 = child(div_11);
      {
        var consequent_3 = ($$anchor3) => {
          var iframe = root_7$2();
          bind_this(iframe, ($$value) => set(iframeElement, $$value), () => get(iframeElement));
          template_effect(() => {
            set_attribute(iframe, "srcdoc", (get(contents), get(selectedContentIdx), untrack(() => get(contents)[get(selectedContentIdx)].content)));
            set_attribute(iframe, "sandbox", `allow-scripts allow-downloads${($settings(), untrack(() => {
              var _a;
              return ((_a = $settings()) == null ? void 0 : _a.iframeSandboxAllowForms) ?? false ? " allow-forms" : "";
            })) ?? ""}${($settings(), untrack(() => {
              var _a;
              return ((_a = $settings()) == null ? void 0 : _a.iframeSandboxAllowSameOrigin) ?? false ? " allow-same-origin" : "";
            })) ?? ""}`);
          });
          event("load", iframe, iframeLoadHandler);
          append($$anchor3, iframe);
        };
        var alternate = ($$anchor3) => {
          var fragment_1 = comment();
          var node_9 = first_child(fragment_1);
          {
            var consequent_4 = ($$anchor4) => {
              SVGPanZoom($$anchor4, {
                className: " w-full h-full max-h-full overflow-hidden",
                get svg() {
                  return get(contents), get(selectedContentIdx), untrack(() => get(contents)[get(selectedContentIdx)].content);
                }
              });
            };
            if_block(
              node_9,
              ($$render) => {
                if (get(contents), get(selectedContentIdx), untrack(() => get(contents)[get(selectedContentIdx)].type === "svg")) $$render(consequent_4);
              },
              true
            );
          }
          append($$anchor3, fragment_1);
        };
        if_block(node_8, ($$render) => {
          if (get(contents), get(selectedContentIdx), untrack(() => get(contents)[get(selectedContentIdx)].type === "iframe")) $$render(consequent_3);
          else $$render(alternate, false);
        });
      }
      reset(div_11);
      append($$anchor2, div_11);
    };
    var alternate_1 = ($$anchor2) => {
      var div_12 = root_10$2();
      var text_2 = child(div_12, true);
      reset(div_12);
      template_effect(($0) => set_text(text_2, $0), [
        () => ($i18n(), untrack(() => $i18n().t("No HTML, CSS, or JavaScript content found.")))
      ]);
      append($$anchor2, div_12);
    };
    if_block(node_7, ($$render) => {
      if (get(contents), untrack(() => get(contents).length > 0)) $$render(consequent_5);
      else $$render(alternate_1, false);
    });
  }
  reset(div_10);
  reset(div_9);
  reset(div_1);
  reset(div);
  append($$anchor, div);
  pop();
  $$cleanup();
}
var root_2$4 = from_html(`<div class=" absolute top-0 left-0 right-0 bottom-0 z-10"></div>`);
var root_1$2 = from_html(`<div class="h-full w-full"><div class="pointer-events-auto z-20 flex justify-between items-center py-3 px-2 font-primar text-gray-900 dark:text-white"><div class="flex-1 flex items-center justify-between pl-2"><a class="flex items-center space-x-2 hover:underline" target="_blank" rel="noopener noreferrer"> </a></div> <button class="self-center pointer-events-auto p-1 rounded-full bg-white dark:bg-gray-850"><!></button></div> <div class=" w-full h-full relative"><!> <!></div></div>`);
function Embeds($$anchor, $$props) {
  push($$props, false);
  const $embed = () => store_get(embed, "$embed", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  let overlay = prop($$props, "overlay", 8, false);
  init();
  var fragment = comment();
  var node = first_child(fragment);
  {
    var consequent_1 = ($$anchor2) => {
      var div = root_1$2();
      var div_1 = child(div);
      var div_2 = child(div_1);
      var a = child(div_2);
      var text2 = child(a, true);
      reset(a);
      reset(div_2);
      var button = sibling(div_2, 2);
      var node_1 = child(button);
      XMark(node_1, { className: "size-3.5 text-gray-900 dark:text-white" });
      reset(button);
      reset(div_1);
      var div_3 = sibling(div_1, 2);
      var node_2 = child(div_3);
      {
        var consequent = ($$anchor3) => {
          var div_4 = root_2$4();
          append($$anchor3, div_4);
        };
        if_block(node_2, ($$render) => {
          if (overlay()) $$render(consequent);
        });
      }
      var node_3 = sibling(node_2, 2);
      {
        let $0 = derived_safe_equal(() => ($embed(), untrack(() => {
          var _a;
          return (_a = $embed()) == null ? void 0 : _a.url;
        })));
        FullHeightIframe(node_3, {
          get src() {
            return get($0);
          },
          iframeClassName: "w-full h-full"
        });
      }
      reset(div_3);
      reset(div);
      template_effect(() => {
        set_attribute(a, "href", ($embed(), untrack(() => {
          var _a;
          return (_a = $embed()) == null ? void 0 : _a.url;
        })));
        set_text(text2, ($embed(), untrack(() => {
          var _a;
          return ((_a = $embed()) == null ? void 0 : _a.title) ?? "Embedded Content";
        })));
      });
      event("click", button, () => {
        showControls.set(false);
        showEmbeds.set(false);
        embed.set(null);
      });
      append($$anchor2, div);
    };
    if_block(node, ($$render) => {
      if ($embed()) $$render(consequent_1);
    });
  }
  append($$anchor, fragment);
  pop();
  $$cleanup();
}
var root_4$1 = from_html(`<div class=" h-full max-h-[100dvh] bg-white text-gray-700 dark:bg-black dark:text-gray-300 flex justify-center"><!></div>`);
var root_3$3 = from_html(`<div><!></div>`);
var root_15$1 = from_html(`<div class=" absolute -left-1.5 -right-1.5 -top-0 -bottom-0 z-20 cursor-col-resize bg-transparent"></div>`);
var root_18 = from_html(`<div class="w-full h-full flex justify-center"><!></div>`);
var root_17 = from_html(`<div class="flex max-h-full min-h-full"><div id="controls-container"><!></div></div>`);
var root_13$2 = from_html(`<!> <!>`, 1);
function ChatControls($$anchor, $$props) {
  push($$props, false);
  const $showCallOverlay = () => store_get(showCallOverlay, "$showCallOverlay", $$stores);
  const $showControls = () => store_get(showControls, "$showControls", $$stores);
  const $showOverview = () => store_get(showOverview, "$showOverview", $$stores);
  const $showArtifacts = () => store_get(showArtifacts, "$showArtifacts", $$stores);
  const $showEmbeds = () => store_get(showEmbeds, "$showEmbeds", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  let history = prop($$props, "history", 12);
  let models2 = prop($$props, "models", 24, () => []);
  let chatId2 = prop($$props, "chatId", 8, null);
  let chatFiles = prop($$props, "chatFiles", 28, () => []);
  let params = prop($$props, "params", 28, () => ({}));
  let eventTarget = prop($$props, "eventTarget", 8);
  let submitPrompt = prop($$props, "submitPrompt", 8);
  let stopResponse = prop($$props, "stopResponse", 8);
  let showMessage = prop($$props, "showMessage", 8);
  let files = prop($$props, "files", 12);
  let modelId = prop($$props, "modelId", 8);
  let pane = prop($$props, "pane", 12);
  let mediaQuery;
  let largeScreen = mutable_source(false);
  let dragged = mutable_source(false);
  let minSize = mutable_source(0);
  const openPane = () => {
    if (parseInt(localStorage == null ? void 0 : localStorage.chatControlsSize)) {
      const container = document.getElementById("chat-container");
      let size = Math.floor(parseInt(localStorage == null ? void 0 : localStorage.chatControlsSize) / container.clientWidth * 100);
      pane().resize(size);
    } else {
      pane().resize(get(minSize));
    }
  };
  const handleMediaQuery = async (e) => {
    if (e.matches) {
      set(largeScreen, true);
      if ($showCallOverlay()) {
        showCallOverlay.set(false);
        await tick();
        showCallOverlay.set(true);
      }
    } else {
      set(largeScreen, false);
      if ($showCallOverlay()) {
        showCallOverlay.set(false);
        await tick();
        showCallOverlay.set(true);
      }
      pane(null);
    }
  };
  const onMouseDown = (event2) => {
    set(dragged, true);
  };
  const onMouseUp = (event2) => {
    set(dragged, false);
  };
  onMount(() => {
    mediaQuery = window.matchMedia("(min-width: 1024px)");
    mediaQuery.addEventListener("change", handleMediaQuery);
    handleMediaQuery(mediaQuery);
    const container = document.getElementById("chat-container");
    set(minSize, Math.floor(350 / container.clientWidth * 100));
    const resizeObserver = new ResizeObserver((entries) => {
      for (let entry of entries) {
        const width = entry.contentRect.width;
        const percentage = 350 / width * 100;
        set(minSize, Math.floor(percentage));
        if ($showControls()) {
          if (pane() && pane().isExpanded() && pane().getSize() < get(minSize)) {
            pane().resize(get(minSize));
          } else {
            let size = Math.floor(parseInt(localStorage == null ? void 0 : localStorage.chatControlsSize) / container.clientWidth * 100);
            if (size < get(minSize)) {
              pane().resize(get(minSize));
            }
          }
        }
      }
    });
    resizeObserver.observe(container);
    document.addEventListener("mousedown", onMouseDown);
    document.addEventListener("mouseup", onMouseUp);
  });
  onDestroy(() => {
    showControls.set(false);
    mediaQuery.removeEventListener("change", handleMediaQuery);
    document.removeEventListener("mousedown", onMouseDown);
    document.removeEventListener("mouseup", onMouseUp);
  });
  const closeHandler = () => {
    showControls.set(false);
    showOverview.set(false);
    showArtifacts.set(false);
    showEmbeds.set(false);
    if ($showCallOverlay()) {
      showCallOverlay.set(false);
    }
  };
  legacy_pre_effect(() => deep_read_state(chatId2()), () => {
    if (!chatId2()) {
      closeHandler();
    }
  });
  legacy_pre_effect_reset();
  var $$exports = { openPane };
  init();
  var fragment = comment();
  var node_1 = first_child(fragment);
  {
    var consequent_5 = ($$anchor2) => {
      var fragment_1 = comment();
      var node_2 = first_child(fragment_1);
      {
        var consequent_4 = ($$anchor3) => {
          Drawer($$anchor3, {
            get show() {
              return $showControls();
            },
            onClose: () => {
              showControls.set(false);
            },
            children: ($$anchor4, $$slotProps) => {
              var div = root_3$3();
              var node_3 = child(div);
              {
                var consequent = ($$anchor5) => {
                  var div_1 = root_4$1();
                  var node_4 = child(div_1);
                  CallOverlay(node_4, {
                    get submitPrompt() {
                      return submitPrompt();
                    },
                    get stopResponse() {
                      return stopResponse();
                    },
                    get modelId() {
                      return modelId();
                    },
                    get chatId() {
                      return chatId2();
                    },
                    get eventTarget() {
                      return eventTarget();
                    },
                    get files() {
                      return files();
                    },
                    set files($$value) {
                      files($$value);
                    },
                    $$events: {
                      close: () => {
                        showControls.set(false);
                      }
                    },
                    $$legacy: true
                  });
                  reset(div_1);
                  append($$anchor5, div_1);
                };
                var alternate_3 = ($$anchor5) => {
                  var fragment_3 = comment();
                  var node_5 = first_child(fragment_3);
                  {
                    var consequent_1 = ($$anchor6) => {
                      Embeds($$anchor6, {});
                    };
                    var alternate_2 = ($$anchor6) => {
                      var fragment_5 = comment();
                      var node_6 = first_child(fragment_5);
                      {
                        var consequent_2 = ($$anchor7) => {
                          Artifacts($$anchor7, {
                            get history() {
                              return history();
                            }
                          });
                        };
                        var alternate_1 = ($$anchor7) => {
                          var fragment_7 = comment();
                          var node_7 = first_child(fragment_7);
                          {
                            var consequent_3 = ($$anchor8) => {
                              var fragment_8 = comment();
                              var node_8 = first_child(fragment_8);
                              await_block(node_8, () => __vitePreload(() => import("./jYw9A-wU.js"), true ? __vite__mapDeps([3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,1,33,34,35,36,37,38,39,40,41,42]) : void 0, import.meta.url), null, ($$anchor9, $$source) => {
                                var $$value = derived_safe_equal(() => {
                                  var { default: Overview2 } = get($$source);
                                  return { Overview: Overview2 };
                                });
                                var Overview = derived_safe_equal(() => get($$value).Overview);
                                get(Overview)($$anchor9, {
                                  get history() {
                                    return history();
                                  },
                                  onNodeClick: (e) => {
                                    const node = e.node;
                                    showMessage()(node.data.message, true);
                                  },
                                  onClose: () => {
                                    showControls.set(false);
                                  }
                                });
                              });
                              append($$anchor8, fragment_8);
                            };
                            var alternate = ($$anchor8) => {
                              Controls($$anchor8, {
                                get models() {
                                  return models2();
                                },
                                get chatFiles() {
                                  return chatFiles();
                                },
                                set chatFiles($$value) {
                                  chatFiles($$value);
                                },
                                get params() {
                                  return params();
                                },
                                set params($$value) {
                                  params($$value);
                                },
                                $$events: {
                                  close: () => {
                                    showControls.set(false);
                                  }
                                },
                                $$legacy: true
                              });
                            };
                            if_block(
                              node_7,
                              ($$render) => {
                                if ($showOverview()) $$render(consequent_3);
                                else $$render(alternate, false);
                              },
                              true
                            );
                          }
                          append($$anchor7, fragment_7);
                        };
                        if_block(
                          node_6,
                          ($$render) => {
                            if ($showArtifacts()) $$render(consequent_2);
                            else $$render(alternate_1, false);
                          },
                          true
                        );
                      }
                      append($$anchor6, fragment_5);
                    };
                    if_block(
                      node_5,
                      ($$render) => {
                        if ($showEmbeds()) $$render(consequent_1);
                        else $$render(alternate_2, false);
                      },
                      true
                    );
                  }
                  append($$anchor5, fragment_3);
                };
                if_block(node_3, ($$render) => {
                  if ($showCallOverlay()) $$render(consequent);
                  else $$render(alternate_3, false);
                });
              }
              reset(div);
              template_effect(() => set_class(div, 1, ` ${$showCallOverlay() || $showOverview() || $showArtifacts() || $showEmbeds() ? " h-screen  w-full" : "px-4 py-3"} h-full`));
              append($$anchor4, div);
            },
            $$slots: { default: true }
          });
        };
        if_block(node_2, ($$render) => {
          if ($showControls()) $$render(consequent_4);
        });
      }
      append($$anchor2, fragment_1);
    };
    var alternate_8 = ($$anchor2) => {
      var fragment_11 = root_13$2();
      var node_9 = first_child(fragment_11);
      {
        var consequent_6 = ($$anchor3) => {
          Pane_resizer($$anchor3, {
            class: "relative flex items-center justify-center group border-l border-gray-50 dark:border-gray-850 hover:border-gray-200 dark:hover:border-gray-800  transition z-20",
            id: "controls-resizer",
            children: ($$anchor4, $$slotProps) => {
              var div_2 = root_15$1();
              append($$anchor4, div_2);
            },
            $$slots: { default: true }
          });
        };
        if_block(node_9, ($$render) => {
          if ($showControls()) $$render(consequent_6);
        });
      }
      var node_10 = sibling(node_9, 2);
      Pane(node_10, {
        defaultSize: 0,
        onResize: (size) => {
          if ($showControls() && pane().isExpanded()) {
            if (size < get(minSize)) {
              pane().resize(get(minSize));
            }
            if (size < get(minSize)) {
              localStorage.chatControlsSize = 0;
            } else {
              const container = document.getElementById("chat-container");
              localStorage.chatControlsSize = Math.floor(size / 100 * container.clientWidth);
            }
          }
        },
        onCollapse: () => {
          showControls.set(false);
        },
        collapsible: true,
        class: " z-10 bg-white dark:bg-gray-850",
        get pane() {
          return pane();
        },
        set pane($$value) {
          pane($$value);
        },
        children: ($$anchor3, $$slotProps) => {
          var fragment_13 = comment();
          var node_11 = first_child(fragment_13);
          {
            var consequent_11 = ($$anchor4) => {
              var div_3 = root_17();
              var div_4 = child(div_3);
              var node_12 = child(div_4);
              {
                var consequent_7 = ($$anchor5) => {
                  var div_5 = root_18();
                  var node_13 = child(div_5);
                  CallOverlay(node_13, {
                    get submitPrompt() {
                      return submitPrompt();
                    },
                    get stopResponse() {
                      return stopResponse();
                    },
                    get modelId() {
                      return modelId();
                    },
                    get chatId() {
                      return chatId2();
                    },
                    get eventTarget() {
                      return eventTarget();
                    },
                    get files() {
                      return files();
                    },
                    set files($$value) {
                      files($$value);
                    },
                    $$events: {
                      close: () => {
                        showControls.set(false);
                      }
                    },
                    $$legacy: true
                  });
                  reset(div_5);
                  append($$anchor5, div_5);
                };
                var alternate_7 = ($$anchor5) => {
                  var fragment_14 = comment();
                  var node_14 = first_child(fragment_14);
                  {
                    var consequent_8 = ($$anchor6) => {
                      Embeds($$anchor6, {
                        get overlay() {
                          return get(dragged);
                        }
                      });
                    };
                    var alternate_6 = ($$anchor6) => {
                      var fragment_16 = comment();
                      var node_15 = first_child(fragment_16);
                      {
                        var consequent_9 = ($$anchor7) => {
                          Artifacts($$anchor7, {
                            get history() {
                              return history();
                            },
                            get overlay() {
                              return get(dragged);
                            }
                          });
                        };
                        var alternate_5 = ($$anchor7) => {
                          var fragment_18 = comment();
                          var node_16 = first_child(fragment_18);
                          {
                            var consequent_10 = ($$anchor8) => {
                              var fragment_19 = comment();
                              var node_17 = first_child(fragment_19);
                              await_block(node_17, () => __vitePreload(() => import("./jYw9A-wU.js"), true ? __vite__mapDeps([3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,1,33,34,35,36,37,38,39,40,41,42]) : void 0, import.meta.url), null, ($$anchor9, $$source) => {
                                var $$value = derived_safe_equal(() => {
                                  var { default: Overview2 } = get($$source);
                                  return { Overview: Overview2 };
                                });
                                var Overview = derived_safe_equal(() => get($$value).Overview);
                                get(Overview)($$anchor9, {
                                  get history() {
                                    return history();
                                  },
                                  onNodeClick: (e) => {
                                    var _a, _b;
                                    const node = e.node;
                                    if ((_b = (_a = node == null ? void 0 : node.data) == null ? void 0 : _a.message) == null ? void 0 : _b.favorite) {
                                      history(history().messages[node.data.message.id].favorite = true, true);
                                    } else {
                                      history(history().messages[node.data.message.id].favorite = null, true);
                                    }
                                    showMessage()(node.data.message, true);
                                  },
                                  onClose: () => {
                                    showControls.set(false);
                                  }
                                });
                              });
                              append($$anchor8, fragment_19);
                            };
                            var alternate_4 = ($$anchor8) => {
                              Controls($$anchor8, {
                                get models() {
                                  return models2();
                                },
                                get chatFiles() {
                                  return chatFiles();
                                },
                                set chatFiles($$value) {
                                  chatFiles($$value);
                                },
                                get params() {
                                  return params();
                                },
                                set params($$value) {
                                  params($$value);
                                },
                                $$events: {
                                  close: () => {
                                    showControls.set(false);
                                  }
                                },
                                $$legacy: true
                              });
                            };
                            if_block(
                              node_16,
                              ($$render) => {
                                if ($showOverview()) $$render(consequent_10);
                                else $$render(alternate_4, false);
                              },
                              true
                            );
                          }
                          append($$anchor7, fragment_18);
                        };
                        if_block(
                          node_15,
                          ($$render) => {
                            if ($showArtifacts()) $$render(consequent_9);
                            else $$render(alternate_5, false);
                          },
                          true
                        );
                      }
                      append($$anchor6, fragment_16);
                    };
                    if_block(
                      node_14,
                      ($$render) => {
                        if ($showEmbeds()) $$render(consequent_8);
                        else $$render(alternate_6, false);
                      },
                      true
                    );
                  }
                  append($$anchor5, fragment_14);
                };
                if_block(node_12, ($$render) => {
                  if ($showCallOverlay()) $$render(consequent_7);
                  else $$render(alternate_7, false);
                });
              }
              reset(div_4);
              reset(div_3);
              template_effect(() => set_class(div_4, 1, `w-full ${($showOverview() || $showArtifacts() || $showEmbeds()) && !$showCallOverlay() ? " " : "px-4 py-3 bg-white dark:shadow-lg dark:bg-gray-850 "} z-40 pointer-events-auto overflow-y-auto scrollbar-hidden`));
              append($$anchor4, div_3);
            };
            if_block(node_11, ($$render) => {
              if ($showControls()) $$render(consequent_11);
            });
          }
          append($$anchor3, fragment_13);
        },
        $$slots: { default: true },
        $$legacy: true
      });
      append($$anchor2, fragment_11);
    };
    if_block(node_1, ($$render) => {
      if (!get(largeScreen)) $$render(consequent_5);
      else $$render(alternate_8, false);
    });
  }
  append($$anchor, fragment);
  bind_prop($$props, "openPane", openPane);
  var $$pop = pop($$exports);
  $$cleanup();
  return $$pop;
}
var root_3$2 = from_html(`<span class="font-normal"><!></span>`);
var root_6$3 = from_html(`<span class="invisible"><!></span>`);
var root_7$1 = from_html(`<span class="font-normal"><!></span>`);
var root_10$1 = from_html(`<span class="invisible"><!></span>`);
var root_2$3 = from_html(`<div class="flex text-xs font-medium mb-1 items-center -mr-0.5"><button class="px-1.5 py-1 cursor-pointer select-none basis-3/5"><div class="flex gap-1.5 items-center"> <!></div></button> <button class="px-1.5 py-1 cursor-pointer select-none hidden sm:flex sm:basis-2/5 justify-end"><div class="flex gap-1.5 items-center"> <!></div></button></div>`);
var root_11$2 = from_html(`<div class="text-xs text-gray-500 dark:text-gray-400 text-center px-5 min-h-20 w-full h-full flex justify-center items-center"> </div>`);
var root_13$1 = from_html(`<div> </div>`);
var root_12 = from_html(`<!> <a class=" w-full flex justify-between items-center rounded-lg text-sm py-2 px-3 hover:bg-gray-50 dark:hover:bg-gray-850" draggable="false"><div class="text-ellipsis line-clamp-1 w-full sm:basis-3/5"> </div> <div class="hidden sm:flex sm:basis-2/5 items-center justify-end"><div class=" text-gray-500 dark:text-gray-400 text-xs"> </div></div></a>`, 1);
var root_15 = from_html(`<div class="w-full flex justify-center py-1 text-xs animate-pulse items-center gap-2"><!> <div class=" ">Loading...</div></div>`);
var root_1$1 = from_html(`<!> <div class="text-left text-sm w-full mb-3"><!> <!> <!></div>`, 1);
function ChatList($$anchor, $$props) {
  push($$props, false);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const i18n = getContext("i18n");
  dayjs2.extend(localizedFormat);
  let chats2 = prop($$props, "chats", 24, () => []);
  let chatListLoading = prop($$props, "chatListLoading", 8, false);
  let allChatsLoaded = prop($$props, "allChatsLoaded", 8, false);
  let loadHandler = prop($$props, "loadHandler", 8, null);
  let chatList = mutable_source(null);
  const init$1 = async () => {
    if (chats2().length === 0) {
      set(chatList, []);
    } else {
      set(chatList, chats2().map((chat) => ({ ...chat, time_range: getTimeRange(chat.updated_at) })));
      get(chatList).sort((a, b) => {
        if (get(direction) === "asc") {
          return a[get(orderBy)] > b[get(orderBy)] ? 1 : -1;
        } else {
          return a[get(orderBy)] < b[get(orderBy)] ? 1 : -1;
        }
      });
    }
  };
  const setSortKey = (key2) => {
    if (get(orderBy) === key2) {
      set(direction, get(direction) === "asc" ? "desc" : "asc");
    } else {
      set(orderBy, key2);
      set(direction, "asc");
    }
    init$1();
  };
  let orderBy = mutable_source("updated_at");
  let direction = mutable_source(
    "desc"
    // 'asc' or 'desc'
  );
  legacy_pre_effect(() => deep_read_state(chats2()), () => {
    if (chats2()) {
      init$1();
    }
  });
  legacy_pre_effect_reset();
  init();
  var fragment = comment();
  var node = first_child(fragment);
  {
    var consequent_8 = ($$anchor2) => {
      var fragment_1 = root_1$1();
      var node_1 = first_child(fragment_1);
      {
        var consequent_4 = ($$anchor3) => {
          var div = root_2$3();
          var button = child(div);
          var div_1 = child(button);
          var text2 = child(div_1);
          var node_2 = sibling(text2);
          {
            var consequent_1 = ($$anchor4) => {
              var span = root_3$2();
              var node_3 = child(span);
              {
                var consequent = ($$anchor5) => {
                  ChevronUp($$anchor5, { className: "size-2" });
                };
                var alternate = ($$anchor5) => {
                  ChevronDown($$anchor5, { className: "size-2" });
                };
                if_block(node_3, ($$render) => {
                  if (get(direction) === "asc") $$render(consequent);
                  else $$render(alternate, false);
                });
              }
              reset(span);
              append($$anchor4, span);
            };
            var alternate_1 = ($$anchor4) => {
              var span_1 = root_6$3();
              var node_4 = child(span_1);
              ChevronUp(node_4, { className: "size-2" });
              reset(span_1);
              append($$anchor4, span_1);
            };
            if_block(node_2, ($$render) => {
              if (get(orderBy) === "title") $$render(consequent_1);
              else $$render(alternate_1, false);
            });
          }
          reset(div_1);
          reset(button);
          var button_1 = sibling(button, 2);
          var div_2 = child(button_1);
          var text_1 = child(div_2);
          var node_5 = sibling(text_1);
          {
            var consequent_3 = ($$anchor4) => {
              var span_2 = root_7$1();
              var node_6 = child(span_2);
              {
                var consequent_2 = ($$anchor5) => {
                  ChevronUp($$anchor5, { className: "size-2" });
                };
                var alternate_2 = ($$anchor5) => {
                  ChevronDown($$anchor5, { className: "size-2" });
                };
                if_block(node_6, ($$render) => {
                  if (get(direction) === "asc") $$render(consequent_2);
                  else $$render(alternate_2, false);
                });
              }
              reset(span_2);
              append($$anchor4, span_2);
            };
            var alternate_3 = ($$anchor4) => {
              var span_3 = root_10$1();
              var node_7 = child(span_3);
              ChevronUp(node_7, { className: "size-2" });
              reset(span_3);
              append($$anchor4, span_3);
            };
            if_block(node_5, ($$render) => {
              if (get(orderBy) === "updated_at") $$render(consequent_3);
              else $$render(alternate_3, false);
            });
          }
          reset(div_2);
          reset(button_1);
          reset(div);
          template_effect(
            ($0, $1) => {
              set_text(text2, `${$0 ?? ""} `);
              set_text(text_1, `${$1 ?? ""} `);
            },
            [
              () => ($i18n(), untrack(() => $i18n().t("Title"))),
              () => ($i18n(), untrack(() => $i18n().t("Updated at")))
            ]
          );
          event("click", button, () => setSortKey("title"));
          event("click", button_1, () => setSortKey("updated_at"));
          append($$anchor3, div);
        };
        if_block(node_1, ($$render) => {
          if (get(chatList), untrack(() => get(chatList).length > 0)) $$render(consequent_4);
        });
      }
      var div_3 = sibling(node_1, 2);
      var node_8 = child(div_3);
      {
        var consequent_5 = ($$anchor3) => {
          var div_4 = root_11$2();
          var text_2 = child(div_4, true);
          reset(div_4);
          template_effect(($0) => set_text(text_2, $0), [
            () => ($i18n(), untrack(() => $i18n().t("No chats found")))
          ]);
          append($$anchor3, div_4);
        };
        if_block(node_8, ($$render) => {
          if (get(chatList), untrack(() => get(chatList).length === 0)) $$render(consequent_5);
        });
      }
      var node_9 = sibling(node_8, 2);
      each(node_9, 3, () => get(chatList), (chat) => chat.id, ($$anchor3, chat, idx) => {
        var fragment_6 = root_12();
        var node_10 = first_child(fragment_6);
        {
          var consequent_6 = ($$anchor4) => {
            var div_5 = root_13$1();
            var text_3 = child(div_5, true);
            reset(div_5);
            template_effect(
              ($0) => {
                set_class(div_5, 1, `w-full text-xs text-gray-500 dark:text-gray-500 font-medium ${get(idx) === 0 ? "" : "pt-5"} pb-2 px-2`);
                set_text(text_3, $0);
              },
              [
                () => ($i18n(), get(chat), untrack(() => $i18n().t(get(chat).time_range)))
              ]
            );
            append($$anchor4, div_5);
          };
          if_block(node_10, ($$render) => {
            if (deep_read_state(get(idx)), get(chat), get(chatList), untrack(() => {
              var _a;
              return (get(idx) === 0 || get(idx) > 0 && get(chat).time_range !== get(chatList)[get(idx) - 1].time_range) && ((_a = get(chat)) == null ? void 0 : _a.time_range);
            })) $$render(consequent_6);
          });
        }
        var a_1 = sibling(node_10, 2);
        var div_6 = child(a_1);
        var text_4 = child(div_6, true);
        reset(div_6);
        var div_7 = sibling(div_6, 2);
        var div_8 = child(div_7);
        var text_5 = child(div_8, true);
        reset(div_8);
        reset(div_7);
        reset(a_1);
        template_effect(
          ($0) => {
            set_attribute(a_1, "href", (get(chat), untrack(() => `/c/${get(chat).id}`)));
            set_text(text_4, (get(chat), untrack(() => {
              var _a;
              return (_a = get(chat)) == null ? void 0 : _a.title;
            })));
            set_text(text_5, $0);
          },
          [
            () => (deep_read_state(dayjs2), get(chat), untrack(() => {
              var _a;
              return dayjs2(((_a = get(chat)) == null ? void 0 : _a.updated_at) * 1e3).calendar();
            }))
          ]
        );
        event("click", a_1, () => show = false);
        append($$anchor3, fragment_6);
      });
      var node_11 = sibling(node_9, 2);
      {
        var consequent_7 = ($$anchor3) => {
          Loader($$anchor3, {
            $$events: {
              visible: (e) => {
                if (!chatListLoading()) {
                  loadHandler()();
                }
              }
            },
            children: ($$anchor4, $$slotProps) => {
              var div_9 = root_15();
              var node_12 = child(div_9);
              Spinner(node_12, { className: " size-4" });
              next(2);
              reset(div_9);
              append($$anchor4, div_9);
            },
            $$slots: { default: true }
          });
        };
        if_block(node_11, ($$render) => {
          if (!allChatsLoaded() && loadHandler()) $$render(consequent_7);
        });
      }
      reset(div_3);
      append($$anchor2, fragment_1);
    };
    if_block(node, ($$render) => {
      if (get(chatList)) $$render(consequent_8);
    });
  }
  append($$anchor, fragment);
  pop();
  $$cleanup();
}
var root_5$1 = from_html(`<div class="py-10"><!></div>`);
var root$2 = from_html(`<div><div><!></div></div>`);
function FolderPlaceholder($$anchor, $$props) {
  push($$props, false);
  getContext("i18n");
  let folder = prop($$props, "folder", 8, null);
  let page2 = 1;
  let chats2 = mutable_source(null);
  let chatListLoading = mutable_source(false);
  let allChatsLoaded = mutable_source(false);
  const loadChats = async () => {
    set(chatListLoading, true);
    page2 += 1;
    let newChatList = [];
    newChatList = await getChatListByFolderId(localStorage.token, folder().id, page2).catch((error) => {
      console.error(error);
      return [];
    });
    set(allChatsLoaded, newChatList.length === 0);
    set(chats2, [...get(chats2), ...newChatList]);
    set(chatListLoading, false);
  };
  const setChatList = async () => {
    set(chats2, null);
    page2 = 1;
    set(allChatsLoaded, false);
    set(chatListLoading, false);
    if (folder() && folder().id) {
      const res = await getChatListByFolderId(localStorage.token, folder().id, page2);
      if (res) {
        set(chats2, res);
      } else {
        set(chats2, []);
      }
    } else {
      set(chats2, []);
    }
  };
  legacy_pre_effect(() => deep_read_state(folder()), () => {
    if (folder()) {
      setChatList();
    }
  });
  legacy_pre_effect_reset();
  init();
  var div = root$2();
  var div_1 = child(div);
  var node = child(div_1);
  {
    var alternate_1 = ($$anchor2) => {
      var fragment_1 = comment();
      var node_1 = first_child(fragment_1);
      {
        var consequent_2 = ($$anchor3) => {
          var fragment_2 = comment();
          var node_2 = first_child(fragment_2);
          {
            var consequent_1 = ($$anchor4) => {
              ChatList($$anchor4, {
                get chats() {
                  return get(chats2);
                },
                get chatListLoading() {
                  return get(chatListLoading);
                },
                get allChatsLoaded() {
                  return get(allChatsLoaded);
                },
                loadHandler: loadChats
              });
            };
            var alternate = ($$anchor4) => {
              var div_2 = root_5$1();
              var node_3 = child(div_2);
              Spinner(node_3, {});
              reset(div_2);
              append($$anchor4, div_2);
            };
            if_block(node_2, ($$render) => {
              if (get(chats2) !== null) $$render(consequent_1);
              else $$render(alternate, false);
            });
          }
          append($$anchor3, fragment_2);
        };
        if_block(
          node_1,
          ($$render) => {
            $$render(consequent_2);
          },
          true
        );
      }
      append($$anchor2, fragment_1);
    };
    if_block(node, ($$render) => {
      $$render(alternate_1, false);
    });
  }
  reset(div_1);
  reset(div);
  append($$anchor, div);
  pop();
}
var root_2$2 = from_html(`<div class=" text-sm text-gray-700 dark:text-gray-300 flex-1 line-clamp-3 mb-2"> </div> <div class="flex items-center gap-1.5"><input type="checkbox"/> <div class="text-xs text-gray-500"> </div></div>`, 1);
var root_3$1 = from_html(`<button class=" rounded-full bg-gray-50 dark:bg-gray-800 size-11 flex justify-center items-center"><!></button>`);
var root_6$2 = from_html(`<button class="p-1.5 dark:hover:bg-gray-850 rounded-full touch-auto"><!></button>`);
var root_1 = from_html(`<!> <!> <div class="mb-3 px-6 @md:max-w-3xl justify-between w-full flex relative group items-center"><div class="text-center flex gap-3.5 items-center"><!> <div class="text-3xl line-clamp-1"> </div></div> <div class="flex items-center translate-x-2.5"><!></div></div>`, 1);
function FolderTitle($$anchor, $$props) {
  push($$props, false);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const i18n = getContext("i18n");
  const { saveAs } = fileSaver;
  let folder = prop($$props, "folder", 12, null);
  let onUpdate = prop($$props, "onUpdate", 8, (folderId2) => {
  });
  let onDelete = prop($$props, "onDelete", 8, (folderId2) => {
  });
  let showFolderModal = mutable_source(false);
  let showDeleteConfirm = mutable_source(false);
  let deleteFolderContents = mutable_source(true);
  const updateHandler = async ({ name, meta, data }) => {
    if (name === "") {
      toast.error($i18n().t("Folder name cannot be empty."));
      return;
    }
    const currentName = folder().name;
    name = name.trim();
    folder(folder().name = name, true);
    const res = await updateFolderById(localStorage.token, folder().id, { name, ...meta ? { meta } : {}, ...data ? { data } : {} }).catch((error) => {
      toast.error(`${error}`);
      folder(folder().name = currentName, true);
      return null;
    });
    if (res) {
      folder(folder().name = name, true);
      if (data) {
        folder(folder().data = data, true);
      }
      toast.success($i18n().t("Folder updated successfully"));
      const _folder = await getFolderById(localStorage.token, folder().id).catch((error) => {
        toast.error(`${error}`);
        return null;
      });
      await selectedFolder.set(_folder);
      onUpdate()(_folder);
    }
  };
  const updateIconHandler = async (iconName) => {
    const res = await updateFolderById(localStorage.token, folder().id, { meta: { icon: iconName } }).catch((error) => {
      toast.error(`${error}`);
      return null;
    });
    if (res) {
      folder(folder().meta = { ...folder().meta, icon: iconName }, true);
      toast.success($i18n().t("Folder updated successfully"));
      const _folder = await getFolderById(localStorage.token, folder().id).catch((error) => {
        toast.error(`${error}`);
        return null;
      });
      await selectedFolder.set(_folder);
      onUpdate()(_folder);
    }
  };
  const deleteHandler = async () => {
    const res = await deleteFolderById(localStorage.token, folder().id, get(deleteFolderContents)).catch((error) => {
      toast.error(`${error}`);
      return null;
    });
    if (res) {
      toast.success($i18n().t("Folder deleted successfully"));
      onDelete()(folder());
    }
  };
  const exportHandler = async () => {
    const chats2 = await getChatsByFolderId(localStorage.token, folder().id).catch((error) => {
      toast.error(`${error}`);
      return null;
    });
    if (!chats2) {
      return;
    }
    const blob = new Blob([JSON.stringify(chats2)], { type: "application/json" });
    saveAs(blob, `folder-${folder().name}-export-${Date.now()}.json`);
  };
  init();
  var fragment = comment();
  var node = first_child(fragment);
  {
    var consequent_1 = ($$anchor2) => {
      var fragment_1 = root_1();
      var node_1 = first_child(fragment_1);
      FolderModal(node_1, {
        edit: true,
        get folderId() {
          return deep_read_state(folder()), untrack(() => folder().id);
        },
        onSubmit: updateHandler,
        get show() {
          return get(showFolderModal);
        },
        set show($$value) {
          set(showFolderModal, $$value);
        },
        $$legacy: true
      });
      var node_2 = sibling(node_1, 2);
      {
        let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("Delete folder?"))));
        ConfirmDialog(node_2, {
          get title() {
            return get($0);
          },
          get show() {
            return get(showDeleteConfirm);
          },
          set show($$value) {
            set(showDeleteConfirm, $$value);
          },
          $$events: {
            confirm: () => {
              deleteHandler();
            }
          },
          children: ($$anchor3, $$slotProps) => {
            var fragment_2 = root_2$2();
            var div = first_child(fragment_2);
            var text2 = child(div, true);
            reset(div);
            var div_1 = sibling(div, 2);
            var input = child(div_1);
            remove_input_defaults(input);
            var div_2 = sibling(input, 2);
            var text_1 = child(div_2, true);
            reset(div_2);
            reset(div_1);
            template_effect(
              ($02, $1) => {
                set_text(text2, $02);
                set_text(text_1, $1);
              },
              [
                () => ($i18n(), untrack(() => $i18n().t(`Are you sure you want to delete "{{NAME}}"?`, { NAME: folders[folderId].name }))),
                () => ($i18n(), untrack(() => $i18n().t("Delete all contents inside this folder")))
              ]
            );
            bind_checked(input, () => get(deleteFolderContents), ($$value) => set(deleteFolderContents, $$value));
            append($$anchor3, fragment_2);
          },
          $$slots: { default: true },
          $$legacy: true
        });
      }
      var div_3 = sibling(node_2, 2);
      var div_4 = child(div_3);
      var node_3 = child(div_4);
      EmojiPicker(node_3, {
        onClose: () => {
        },
        onSubmit: (name) => {
          console.log(name);
          updateIconHandler(name);
        },
        children: ($$anchor3, $$slotProps) => {
          var button = root_3$1();
          var node_4 = child(button);
          {
            var consequent = ($$anchor4) => {
              Emoji($$anchor4, {
                className: "size-6",
                get shortCode() {
                  return deep_read_state(folder()), untrack(() => folder().meta.icon);
                }
              });
            };
            var alternate = ($$anchor4) => {
              Folder($$anchor4, { className: "size-4.5", strokeWidth: "2" });
            };
            if_block(node_4, ($$render) => {
              if (deep_read_state(folder()), untrack(() => {
                var _a, _b;
                return (_b = (_a = folder()) == null ? void 0 : _a.meta) == null ? void 0 : _b.icon;
              })) $$render(consequent);
              else $$render(alternate, false);
            });
          }
          reset(button);
          append($$anchor3, button);
        },
        $$slots: { default: true }
      });
      var div_5 = sibling(node_3, 2);
      var text_2 = child(div_5, true);
      reset(div_5);
      reset(div_4);
      var div_6 = sibling(div_4, 2);
      var node_5 = child(div_6);
      FolderMenu(node_5, {
        align: "end",
        onEdit: () => {
          set(showFolderModal, true);
        },
        onDelete: () => {
          set(showDeleteConfirm, true);
        },
        onExport: () => {
          exportHandler();
        },
        children: ($$anchor3, $$slotProps) => {
          var button_1 = root_6$2();
          var node_6 = child(button_1);
          EllipsisHorizontal(node_6, { className: "size-4", strokeWidth: "2.5" });
          reset(button_1);
          event("click", button_1, (e) => {
          });
          append($$anchor3, button_1);
        },
        $$slots: { default: true }
      });
      reset(div_6);
      reset(div_3);
      template_effect(() => set_text(text_2, (deep_read_state(folder()), untrack(() => folder().name))));
      append($$anchor2, fragment_1);
    };
    if_block(node, ($$render) => {
      if (folder()) $$render(consequent_1);
    });
  }
  append($$anchor, fragment);
  pop();
  $$cleanup();
}
var root_2$1 = from_html(`<div class="flex items-center gap-2 text-gray-500 text-base my-2 w-fit"><!> </div>`);
var root_6$1 = from_html(`<span class="line-clamp-1"> </span>`);
var root_9$1 = from_html(`<div class="mt-0.5 px-2 text-sm font-normal text-gray-500 dark:text-gray-400 line-clamp-2 max-w-xl markdown"><!></div>`);
var root_11$1 = from_html(`<a> </a>`);
var root_10 = from_html(`<div class="mt-0.5 text-sm font-normal text-gray-400 dark:text-gray-500">By <!></div>`);
var root_8$1 = from_html(`<!> <!>`, 1);
var root_4 = from_html(`<div class="flex flex-row justify-center gap-3 @sm:gap-3.5 w-fit px-5 max-w-xl"><div class=" text-3xl @sm:text-3xl line-clamp-1 flex items-center"><!></div></div> <div class="flex mt-1 mb-2"><div><!></div></div>`, 1);
var root_13 = from_html(`<div class="mx-auto px-4 md:max-w-3xl md:px-6 font-primary min-h-62"><!></div>`);
var root_14 = from_html(`<div class="mx-auto max-w-2xl font-primary mt-2"><div class="mx-5"><!></div></div>`);
var root$1 = from_html(`<div class="m-auto w-full max-w-6xl px-2 @2xl:px-20 translate-y-6 py-24 text-center"><!> <div class="w-full text-3xl text-gray-800 dark:text-gray-100 text-center flex items-center gap-4 font-primary"><div class="w-full flex flex-col justify-center items-center"><!> <div><!></div></div></div> <!></div>`);
function Placeholder($$anchor, $$props) {
  push($$props, false);
  const $_models = () => store_get(models, "$_models", $$stores);
  const $temporaryChatEnabled = () => store_get(temporaryChatEnabled, "$temporaryChatEnabled", $$stores);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const $selectedFolder = () => store_get(selectedFolder, "$selectedFolder", $$stores);
  const $currentChatPage = () => store_get(currentChatPage, "$currentChatPage", $$stores);
  const $user = () => store_get(user, "$user", $$stores);
  const $config = () => store_get(config, "$config", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const dispatch = createEventDispatcher();
  const i18n = getContext("i18n");
  let createMessagePair = prop($$props, "createMessagePair", 8);
  let stopResponse = prop($$props, "stopResponse", 8);
  let autoScroll = prop($$props, "autoScroll", 12, false);
  let atSelectedModel = prop($$props, "atSelectedModel", 12);
  let selectedModels = prop($$props, "selectedModels", 8);
  let history = prop($$props, "history", 8);
  let prompt = prop($$props, "prompt", 12, "");
  let files = prop($$props, "files", 28, () => []);
  let messageInput = prop($$props, "messageInput", 12, null);
  let selectedToolIds = prop($$props, "selectedToolIds", 28, () => []);
  let selectedFilterIds = prop($$props, "selectedFilterIds", 28, () => []);
  let showCommands = prop($$props, "showCommands", 12, false);
  let imageGenerationEnabled = prop($$props, "imageGenerationEnabled", 12, false);
  let codeInterpreterEnabled = prop($$props, "codeInterpreterEnabled", 12, false);
  let webSearchEnabled = prop($$props, "webSearchEnabled", 12, false);
  let onSelect = prop($$props, "onSelect", 8, (e) => {
  });
  let onChange = prop($$props, "onChange", 8, (e) => {
  });
  let toolServers2 = prop($$props, "toolServers", 24, () => []);
  let models$1 = mutable_source([]);
  let selectedModelIdx = mutable_source(0);
  legacy_pre_effect(() => (deep_read_state(selectedModels()), $_models()), () => {
    set(models$1, selectedModels().map((id) => $_models().find((m) => m.id === id)));
  });
  legacy_pre_effect(() => (deep_read_state(selectedModels()), get(models$1)), () => {
    if (selectedModels().length > 0) {
      set(selectedModelIdx, get(models$1).length - 1);
    }
  });
  legacy_pre_effect_reset();
  init();
  var div = root$1();
  var node = child(div);
  {
    var consequent = ($$anchor2) => {
      {
        let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("This chat won't appear in history and your messages will not be saved."))));
        Tooltip($$anchor2, {
          get content() {
            return get($0);
          },
          className: "w-full flex justify-center mb-0.5",
          placement: "top",
          children: ($$anchor3, $$slotProps) => {
            var div_1 = root_2$1();
            var node_1 = child(div_1);
            EyeSlash(node_1, { strokeWidth: "2.5", className: "size-4" });
            var text2 = sibling(node_1, 1, true);
            reset(div_1);
            template_effect(($02) => set_text(text2, $02), [
              () => ($i18n(), untrack(() => $i18n().t("Temporary Chat")))
            ]);
            append($$anchor3, div_1);
          },
          $$slots: { default: true }
        });
      }
    };
    if_block(node, ($$render) => {
      if ($temporaryChatEnabled()) $$render(consequent);
    });
  }
  var div_2 = sibling(node, 2);
  var div_3 = child(div_2);
  var node_2 = child(div_3);
  {
    var consequent_1 = ($$anchor2) => {
      FolderTitle($$anchor2, {
        get folder() {
          return $selectedFolder();
        },
        onUpdate: async (folder) => {
          await chats.set(await getChatList(localStorage.token, $currentChatPage()));
          currentChatPage.set(1);
        },
        onDelete: async () => {
          await chats.set(await getChatList(localStorage.token, $currentChatPage()));
          currentChatPage.set(1);
          selectedFolder.set(null);
        }
      });
    };
    var alternate_2 = ($$anchor2) => {
      var fragment_2 = root_4();
      var div_4 = first_child(fragment_2);
      var div_5 = child(div_4);
      var node_3 = child(div_5);
      {
        var consequent_2 = ($$anchor3) => {
          {
            let $0 = derived_safe_equal(() => (get(models$1), get(selectedModelIdx), untrack(() => {
              var _a;
              return (_a = get(models$1)[get(selectedModelIdx)]) == null ? void 0 : _a.name;
            })));
            Tooltip($$anchor3, {
              get content() {
                return get($0);
              },
              placement: "top",
              className: " flex items-center ",
              children: ($$anchor4, $$slotProps) => {
                var span = root_6$1();
                var text_1 = child(span, true);
                reset(span);
                template_effect(() => set_text(text_1, (get(models$1), get(selectedModelIdx), untrack(() => {
                  var _a;
                  return (_a = get(models$1)[get(selectedModelIdx)]) == null ? void 0 : _a.name;
                }))));
                append($$anchor4, span);
              },
              $$slots: { default: true }
            });
          }
        };
        var alternate = ($$anchor3) => {
          var text_2 = text();
          template_effect(($0) => set_text(text_2, $0), [
            () => ($i18n(), $user(), untrack(() => {
              var _a;
              return $i18n().t("Hello, {{name}}", { name: (_a = $user()) == null ? void 0 : _a.name });
            }))
          ]);
          append($$anchor3, text_2);
        };
        if_block(node_3, ($$render) => {
          if (get(models$1), get(selectedModelIdx), untrack(() => {
            var _a;
            return (_a = get(models$1)[get(selectedModelIdx)]) == null ? void 0 : _a.name;
          })) $$render(consequent_2);
          else $$render(alternate, false);
        });
      }
      reset(div_5);
      reset(div_4);
      var div_6 = sibling(div_4, 2);
      var div_7 = child(div_6);
      var node_4 = child(div_7);
      {
        var consequent_5 = ($$anchor3) => {
          var fragment_5 = root_8$1();
          var node_5 = first_child(fragment_5);
          {
            let $0 = derived_safe_equal(() => (deep_read_state(marked), deep_read_state(sanitizeResponseContent), get(models$1), get(selectedModelIdx), untrack(() => {
              var _a, _b, _c;
              return marked.parse(sanitizeResponseContent(((_c = (_b = (_a = get(models$1)[get(selectedModelIdx)]) == null ? void 0 : _a.info) == null ? void 0 : _b.meta) == null ? void 0 : _c.description) ?? "").replaceAll("\n", "<br>"));
            })));
            Tooltip(node_5, {
              className: " w-fit",
              get content() {
                return get($0);
              },
              placement: "top",
              children: ($$anchor4, $$slotProps) => {
                var div_8 = root_9$1();
                var node_6 = child(div_8);
                html(node_6, () => (deep_read_state(marked), deep_read_state(sanitizeResponseContent), get(models$1), get(selectedModelIdx), untrack(() => {
                  var _a, _b, _c;
                  return marked.parse(sanitizeResponseContent(((_c = (_b = (_a = get(models$1)[get(selectedModelIdx)]) == null ? void 0 : _a.info) == null ? void 0 : _b.meta) == null ? void 0 : _c.description) ?? "").replaceAll("\n", "<br>"));
                })));
                reset(div_8);
                append($$anchor4, div_8);
              },
              $$slots: { default: true }
            });
          }
          var node_7 = sibling(node_5, 2);
          {
            var consequent_4 = ($$anchor4) => {
              var div_9 = root_10();
              var node_8 = sibling(child(div_9));
              {
                var consequent_3 = ($$anchor5) => {
                  var a = root_11$1();
                  var text_3 = child(a, true);
                  reset(a);
                  template_effect(() => {
                    set_attribute(a, "href", `https://openwebui.com/m/${(get(models$1), get(selectedModelIdx), untrack(() => {
                      var _a, _b, _c;
                      return (_c = (_b = (_a = get(models$1)[get(selectedModelIdx)]) == null ? void 0 : _a.info) == null ? void 0 : _b.meta) == null ? void 0 : _c.user.username;
                    })) ?? ""}`);
                    set_text(text_3, (get(models$1), get(selectedModelIdx), untrack(() => {
                      var _a, _b, _c, _d, _e, _f, _g, _h, _i;
                      return ((_c = (_b = (_a = get(models$1)[get(selectedModelIdx)]) == null ? void 0 : _a.info) == null ? void 0 : _b.meta) == null ? void 0 : _c.user.name) ? (_f = (_e = (_d = get(models$1)[get(selectedModelIdx)]) == null ? void 0 : _d.info) == null ? void 0 : _e.meta) == null ? void 0 : _f.user.name : `@${(_i = (_h = (_g = get(models$1)[get(selectedModelIdx)]) == null ? void 0 : _g.info) == null ? void 0 : _h.meta) == null ? void 0 : _i.user.username}`;
                    })));
                  });
                  append($$anchor5, a);
                };
                var alternate_1 = ($$anchor5) => {
                  var text_4 = text();
                  template_effect(() => set_text(text_4, (get(models$1), get(selectedModelIdx), untrack(() => {
                    var _a, _b, _c;
                    return (_c = (_b = (_a = get(models$1)[get(selectedModelIdx)]) == null ? void 0 : _a.info) == null ? void 0 : _b.meta) == null ? void 0 : _c.user.name;
                  }))));
                  append($$anchor5, text_4);
                };
                if_block(node_8, ($$render) => {
                  if (get(models$1), get(selectedModelIdx), untrack(() => {
                    var _a, _b, _c;
                    return (_c = (_b = (_a = get(models$1)[get(selectedModelIdx)]) == null ? void 0 : _a.info) == null ? void 0 : _b.meta) == null ? void 0 : _c.user.community;
                  })) $$render(consequent_3);
                  else $$render(alternate_1, false);
                });
              }
              reset(div_9);
              append($$anchor4, div_9);
            };
            if_block(node_7, ($$render) => {
              if (get(models$1), get(selectedModelIdx), untrack(() => {
                var _a, _b, _c;
                return (_c = (_b = (_a = get(models$1)[get(selectedModelIdx)]) == null ? void 0 : _a.info) == null ? void 0 : _b.meta) == null ? void 0 : _c.user;
              })) $$render(consequent_4);
            });
          }
          append($$anchor3, fragment_5);
        };
        if_block(node_4, ($$render) => {
          if (get(models$1), get(selectedModelIdx), untrack(() => {
            var _a, _b, _c;
            return ((_c = (_b = (_a = get(models$1)[get(selectedModelIdx)]) == null ? void 0 : _a.info) == null ? void 0 : _b.meta) == null ? void 0 : _c.description) ?? null;
          })) $$render(consequent_5);
        });
      }
      reset(div_7);
      reset(div_6);
      transition(1, div_5, () => fade, () => ({ duration: 100 }));
      transition(1, div_7, () => fade, () => ({ duration: 100, delay: 50 }));
      append($$anchor2, fragment_2);
    };
    if_block(node_2, ($$render) => {
      if ($selectedFolder()) $$render(consequent_1);
      else $$render(alternate_2, false);
    });
  }
  var div_10 = sibling(node_2, 2);
  var node_9 = child(div_10);
  {
    let $0 = derived_safe_equal(() => ($i18n(), untrack(() => $i18n().t("How can I help you today?"))));
    bind_this(
      MessageInput(node_9, {
        get history() {
          return history();
        },
        get selectedModels() {
          return selectedModels();
        },
        get toolServers() {
          return toolServers2();
        },
        get stopResponse() {
          return stopResponse();
        },
        get createMessagePair() {
          return createMessagePair();
        },
        get placeholder() {
          return get($0);
        },
        get onChange() {
          return onChange();
        },
        get files() {
          return files();
        },
        set files($$value) {
          files($$value);
        },
        get prompt() {
          return prompt();
        },
        set prompt($$value) {
          prompt($$value);
        },
        get autoScroll() {
          return autoScroll();
        },
        set autoScroll($$value) {
          autoScroll($$value);
        },
        get selectedToolIds() {
          return selectedToolIds();
        },
        set selectedToolIds($$value) {
          selectedToolIds($$value);
        },
        get selectedFilterIds() {
          return selectedFilterIds();
        },
        set selectedFilterIds($$value) {
          selectedFilterIds($$value);
        },
        get imageGenerationEnabled() {
          return imageGenerationEnabled();
        },
        set imageGenerationEnabled($$value) {
          imageGenerationEnabled($$value);
        },
        get codeInterpreterEnabled() {
          return codeInterpreterEnabled();
        },
        set codeInterpreterEnabled($$value) {
          codeInterpreterEnabled($$value);
        },
        get webSearchEnabled() {
          return webSearchEnabled();
        },
        set webSearchEnabled($$value) {
          webSearchEnabled($$value);
        },
        get atSelectedModel() {
          return atSelectedModel();
        },
        set atSelectedModel($$value) {
          atSelectedModel($$value);
        },
        get showCommands() {
          return showCommands();
        },
        set showCommands($$value) {
          showCommands($$value);
        },
        $$events: {
          upload: (e) => {
            dispatch("upload", e.detail);
          },
          submit: (e) => {
            dispatch("submit", e.detail);
          }
        },
        $$legacy: true
      }),
      ($$value) => messageInput($$value),
      () => messageInput()
    );
  }
  reset(div_10);
  reset(div_3);
  reset(div_2);
  var node_10 = sibling(div_2, 2);
  {
    var consequent_6 = ($$anchor2) => {
      var div_11 = root_13();
      var node_11 = child(div_11);
      FolderPlaceholder(node_11, {
        get folder() {
          return $selectedFolder();
        }
      });
      reset(div_11);
      transition(1, div_11, () => fade, () => ({ duration: 200, delay: 200 }));
      append($$anchor2, div_11);
    };
    var alternate_3 = ($$anchor2) => {
      var div_12 = root_14();
      var div_13 = child(div_12);
      var node_12 = child(div_13);
      {
        let $0 = derived_safe_equal(() => (deep_read_state(atSelectedModel()), get(models$1), get(selectedModelIdx), $config(), untrack(() => {
          var _a, _b, _c, _d, _e, _f, _g;
          return ((_c = (_b = (_a = atSelectedModel()) == null ? void 0 : _a.info) == null ? void 0 : _b.meta) == null ? void 0 : _c.suggestion_prompts) ?? ((_f = (_e = (_d = get(models$1)[get(selectedModelIdx)]) == null ? void 0 : _d.info) == null ? void 0 : _e.meta) == null ? void 0 : _f.suggestion_prompts) ?? ((_g = $config()) == null ? void 0 : _g.default_prompt_suggestions) ?? [];
        })));
        Suggestions(node_12, {
          get suggestionPrompts() {
            return get($0);
          },
          get inputValue() {
            return prompt();
          },
          get onSelect() {
            return onSelect();
          }
        });
      }
      reset(div_13);
      reset(div_12);
      transition(1, div_12, () => fade, () => ({ duration: 200, delay: 200 }));
      append($$anchor2, div_12);
    };
    if_block(node_10, ($$render) => {
      if ($selectedFolder()) $$render(consequent_6);
      else $$render(alternate_3, false);
    });
  }
  reset(div);
  template_effect(() => set_class(div_10, 1, `text-base font-normal @md:max-w-3xl w-full py-3 ${atSelectedModel() ? "mt-2" : ""}`));
  append($$anchor, div);
  pop();
  $$cleanup();
}
var root_3 = from_html(`<div class="absolute top-0 left-0 w-full h-full bg-cover bg-center bg-no-repeat svelte-vhdo11"></div> <div class="absolute top-0 left-0 w-full h-full bg-linear-to-t from-white to-white/85 dark:from-gray-900 dark:to-gray-900/90 z-0 svelte-vhdo11"></div>`, 1);
var root_5 = from_html(`<div class="absolute top-0 left-0 w-full h-full bg-cover bg-center bg-no-repeat svelte-vhdo11"></div> <div class="absolute top-0 left-0 w-full h-full bg-linear-to-t from-white to-white/85 dark:from-gray-900 dark:to-gray-900/90 z-0 svelte-vhdo11"></div>`, 1);
var root_8 = from_html(`<div class=" pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0 max-w-full z-10 scrollbar-hidden svelte-vhdo11" id="messages-container"><div class=" h-full w-full flex flex-col svelte-vhdo11"><!></div></div> <div class=" pb-2 z-10 svelte-vhdo11"><!> <div class="absolute bottom-1 text-xs text-gray-500 text-center line-clamp-1 right-0 left-0 svelte-vhdo11"></div></div>`, 1);
var root_9 = from_html(`<div class="flex items-center h-full svelte-vhdo11"><!></div>`);
var root_7 = from_html(`<!> <div class="flex flex-col flex-auto z-10 w-full @container overflow-auto svelte-vhdo11"><!></div>`, 1);
var root_6 = from_html(`<!> <!>`, 1);
var root_2 = from_html(`<div class="w-full h-full flex flex-col svelte-vhdo11"><!> <!></div>`);
var root_11 = from_html(`<div class=" flex items-center justify-center h-full w-full svelte-vhdo11"><div class="m-auto svelte-vhdo11"><!></div></div>`);
var root = from_html(`<audio id="audioElement" src="" style="display: none;" class="svelte-vhdo11"></audio> <!> <div class="h-screen max-h-[100dvh] w-full flex flex-col svelte-vhdo11" id="chat-container"><!></div>`, 1);
function Chat($$anchor, $$props) {
  push($$props, false);
  const $temporaryChatEnabled = () => store_get(temporaryChatEnabled, "$temporaryChatEnabled", $$stores);
  const $settings = () => store_get(settings, "$settings", $$stores);
  const $tools = () => store_get(tools, "$tools", $$stores);
  const $functions = () => store_get(functions, "$functions", $$stores);
  const $models = () => store_get(models, "$models", $$stores);
  const $chatId = () => store_get(chatId, "$chatId", $$stores);
  const $currentChatPage = () => store_get(currentChatPage, "$currentChatPage", $$stores);
  const $selectedFolder = () => store_get(selectedFolder, "$selectedFolder", $$stores);
  const $audioQueue = () => store_get(audioQueue, "$audioQueue", $$stores);
  const $socket = () => store_get(socket, "$socket", $$stores);
  const $mobile = () => store_get(mobile, "$mobile", $$stores);
  const $i18n = () => store_get(i18n, "$i18n", $$stores);
  const $user = () => store_get(user, "$user", $$stores);
  const $page = () => store_get(page, "$page", $$stores);
  const $config = () => store_get(config, "$config", $$stores);
  const $showCallOverlay = () => store_get(showCallOverlay, "$showCallOverlay", $$stores);
  const $toolServers = () => store_get(toolServers, "$toolServers", $$stores);
  const $chatTitle = () => store_get(chatTitle, "$chatTitle", $$stores);
  const $WEBUI_NAME = () => store_get(WEBUI_NAME, "$WEBUI_NAME", $$stores);
  const [$$stores, $$cleanup] = setup_stores();
  const i18n = getContext("i18n");
  let chatIdProp = prop($$props, "chatIdProp", 8, "");
  let loading = mutable_source(true);
  const eventTarget = new EventTarget();
  let controlPane = mutable_source();
  let controlPaneComponent = mutable_source();
  let messageInput = mutable_source();
  let autoScroll = mutable_source(true);
  let messagesContainerElement = mutable_source();
  let navbarElement = mutable_source();
  let showEventConfirmation = mutable_source(false);
  let eventConfirmationTitle = mutable_source("");
  let eventConfirmationMessage = mutable_source("");
  let eventConfirmationInput = mutable_source(false);
  let eventConfirmationInputPlaceholder = mutable_source("");
  let eventConfirmationInputValue = mutable_source("");
  let eventCallback = mutable_source(null);
  let chatIdUnsubscriber;
  let selectedModels = mutable_source([""]);
  let atSelectedModel = mutable_source();
  let selectedModelIds = mutable_source([]);
  let selectedToolIds = mutable_source([]);
  let selectedFilterIds = mutable_source([]);
  let imageGenerationEnabled = mutable_source(false);
  let webSearchEnabled = mutable_source(false);
  let codeInterpreterEnabled = mutable_source(false);
  let showCommands = mutable_source(false);
  let generating = mutable_source(false);
  let generationController = null;
  let chat = null;
  let history = mutable_source({ messages: {}, currentId: null });
  let taskIds = mutable_source(null);
  let prompt = mutable_source("");
  let chatFiles = mutable_source([]);
  let files = mutable_source([]);
  let params = mutable_source({});
  const navigateHandler = async () => {
    var _a, _b;
    set(loading, true);
    set(prompt, "");
    (_a = get(messageInput)) == null ? void 0 : _a.setText("");
    set(files, []);
    set(selectedToolIds, []);
    set(selectedFilterIds, []);
    set(webSearchEnabled, false);
    set(imageGenerationEnabled, false);
    const storageChatInput = sessionStorage.getItem(`chat-input${chatIdProp() ? `-${chatIdProp()}` : ""}`);
    if (chatIdProp() && await loadChat()) {
      await tick();
      set(loading, false);
      window.setTimeout(() => scrollToBottom(), 0);
      await tick();
      if (storageChatInput) {
        try {
          const input = JSON.parse(storageChatInput);
          if (!$temporaryChatEnabled()) {
            (_b = get(messageInput)) == null ? void 0 : _b.setText(input.prompt);
            set(files, input.files);
            set(selectedToolIds, input.selectedToolIds);
            set(selectedFilterIds, input.selectedFilterIds);
            set(webSearchEnabled, input.webSearchEnabled);
            set(imageGenerationEnabled, input.imageGenerationEnabled);
            set(codeInterpreterEnabled, input.codeInterpreterEnabled);
          }
        } catch (e) {
        }
      } else {
        await setDefaults();
      }
      const chatInput = document.getElementById("chat-input");
      chatInput == null ? void 0 : chatInput.focus();
    } else {
      await goto("/");
    }
  };
  const onSelect = async (e) => {
    var _a;
    const { type, data } = e;
    if (type === "prompt") {
      (_a = get(messageInput)) == null ? void 0 : _a.setText(data, async () => {
        var _a2;
        if (!(((_a2 = $settings()) == null ? void 0 : _a2.insertSuggestionPrompt) ?? false)) {
          await tick();
          submitPrompt(get(prompt));
        }
      });
    }
  };
  const saveSessionSelectedModels = () => {
    const selectedModelsString = JSON.stringify(get(selectedModels));
    if (get(selectedModels).length === 0 || get(selectedModels).length === 1 && get(selectedModels)[0] === "" || sessionStorage.selectedModels === selectedModelsString) {
      return;
    }
    sessionStorage.selectedModels = selectedModelsString;
    console.log("saveSessionSelectedModels", get(selectedModels), sessionStorage.selectedModels);
  };
  let oldSelectedModelIds = mutable_source([""]);
  const onSelectedModelIdsChange = () => {
    resetInput();
    set(oldSelectedModelIds, JSON.parse(JSON.stringify(get(selectedModelIds))));
  };
  const resetInput = () => {
    set(selectedToolIds, []);
    set(selectedFilterIds, []);
    set(webSearchEnabled, false);
    set(imageGenerationEnabled, false);
    set(codeInterpreterEnabled, false);
    if (get(selectedModelIds).filter((id) => id).length > 0) {
      setDefaults();
    }
  };
  const setDefaults = async () => {
    var _a, _b, _c, _d, _e, _f, _g, _h, _i, _j, _k, _l, _m, _n, _o, _p, _q;
    if (!$tools()) {
      tools.set(await getTools(localStorage.token));
    }
    if (!$functions()) {
      functions.set(await getFunctions(localStorage.token));
    }
    if (get(selectedModels).length !== 1 && !get(atSelectedModel)) {
      return;
    }
    const model = get(atSelectedModel) ?? $models().find((m) => m.id === get(selectedModels)[0]);
    if (model) {
      if ((_b = (_a = model == null ? void 0 : model.info) == null ? void 0 : _a.meta) == null ? void 0 : _b.toolIds) {
        set(selectedToolIds, [
          ...new Set([...((_d = (_c = model == null ? void 0 : model.info) == null ? void 0 : _c.meta) == null ? void 0 : _d.toolIds) ?? []].filter((id) => $tools().find((t) => t.id === id)))
        ]);
      }
      if ((_f = (_e = model == null ? void 0 : model.info) == null ? void 0 : _e.meta) == null ? void 0 : _f.defaultFilterIds) {
        set(selectedFilterIds, model.info.meta.defaultFilterIds.filter((id) => {
          var _a2;
          return (_a2 = model == null ? void 0 : model.filters) == null ? void 0 : _a2.find((f) => f.id === id);
        }));
      }
      if ((_h = (_g = model == null ? void 0 : model.info) == null ? void 0 : _g.meta) == null ? void 0 : _h.defaultFeatureIds) {
        if ((_k = (_j = (_i = model.info) == null ? void 0 : _i.meta) == null ? void 0 : _j.capabilities) == null ? void 0 : _k["image_generation"]) {
          set(imageGenerationEnabled, model.info.meta.defaultFeatureIds.includes("image_generation"));
        }
        if ((_n = (_m = (_l = model.info) == null ? void 0 : _l.meta) == null ? void 0 : _m.capabilities) == null ? void 0 : _n["web_search"]) {
          set(webSearchEnabled, model.info.meta.defaultFeatureIds.includes("web_search"));
        }
        if ((_q = (_p = (_o = model.info) == null ? void 0 : _o.meta) == null ? void 0 : _p.capabilities) == null ? void 0 : _q["code_interpreter"]) {
          set(codeInterpreterEnabled, model.info.meta.defaultFeatureIds.includes("code_interpreter"));
        }
      }
    }
  };
  const showMessage = async (message, ignoreSettings = false) => {
    var _a;
    await tick();
    const _chatId = JSON.parse(JSON.stringify($chatId()));
    let _messageId = JSON.parse(JSON.stringify(message.id));
    let messageChildrenIds = [];
    if (_messageId === null) {
      messageChildrenIds = Object.keys(get(history).messages).filter((id) => get(history).messages[id].parentId === null);
    } else {
      messageChildrenIds = get(history).messages[_messageId].childrenIds;
    }
    while (messageChildrenIds.length !== 0) {
      _messageId = messageChildrenIds.at(-1);
      messageChildrenIds = get(history).messages[_messageId].childrenIds;
    }
    mutate(history, get(history).currentId = _messageId);
    await tick();
    await tick();
    await tick();
    if ((((_a = $settings()) == null ? void 0 : _a.scrollOnBranchChange) ?? true) || ignoreSettings) {
      const messageElement = document.getElementById(`message-${message.id}`);
      if (messageElement) {
        messageElement.scrollIntoView({ behavior: "smooth" });
      }
    }
    await tick();
    saveChatHandler(_chatId, get(history));
  };
  const chatEventHandler = async (event2, cb) => {
    var _a, _b;
    console.log(event2);
    if (event2.chat_id === $chatId()) {
      await tick();
      let message = get(history).messages[event2.message_id];
      if (message) {
        const type = ((_a = event2 == null ? void 0 : event2.data) == null ? void 0 : _a.type) ?? null;
        const data = ((_b = event2 == null ? void 0 : event2.data) == null ? void 0 : _b.data) ?? null;
        if (type === "status") {
          if (message == null ? void 0 : message.statusHistory) {
            message.statusHistory.push(data);
          } else {
            message.statusHistory = [data];
          }
        } else if (type === "chat:completion") {
          chatCompletionEventHandler(data, message, event2.chat_id);
        } else if (type === "chat:tasks:cancel") {
          set(taskIds, null);
          const responseMessage = get(history).messages[get(history).currentId];
          for (const messageId of get(history).messages[responseMessage.parentId].childrenIds) {
            mutate(history, get(history).messages[messageId].done = true);
          }
        } else if (type === "chat:message:delta" || type === "message") {
          message.content += data.content;
        } else if (type === "chat:message" || type === "replace") {
          message.content = data.content;
        } else if (type === "chat:message:files" || type === "files") {
          message.files = data.files;
        } else if (type === "chat:message:embeds" || type === "embeds") {
          message.embeds = data.embeds;
        } else if (type === "chat:message:error") {
          message.error = data.error;
        } else if (type === "chat:message:follow_ups") {
          message.followUps = data.follow_ups;
          if (get(autoScroll)) {
            scrollToBottom("smooth");
          }
        } else if (type === "chat:title") {
          chatTitle.set(data);
          currentChatPage.set(1);
          await chats.set(await getChatList(localStorage.token, $currentChatPage()));
        } else if (type === "chat:tags") {
          chat = await getChatById(localStorage.token, $chatId());
          tags.set(await getAllTags(localStorage.token));
        } else if (type === "source" || type === "citation") {
          if ((data == null ? void 0 : data.type) === "code_execution") {
            if (!(message == null ? void 0 : message.code_executions)) {
              message.code_executions = [];
            }
            const existingCodeExecutionIndex = message.code_executions.findIndex((execution) => execution.id === data.id);
            if (existingCodeExecutionIndex !== -1) {
              message.code_executions[existingCodeExecutionIndex] = data;
            } else {
              message.code_executions.push(data);
            }
            message.code_executions = message.code_executions;
          } else {
            if (message == null ? void 0 : message.sources) {
              message.sources.push(data);
            } else {
              message.sources = [data];
            }
          }
        } else if (type === "notification") {
          const toastType = (data == null ? void 0 : data.type) ?? "info";
          const toastContent = (data == null ? void 0 : data.content) ?? "";
          if (toastType === "success") {
            toast.success(toastContent);
          } else if (toastType === "error") {
            toast.error(toastContent);
          } else if (toastType === "warning") {
            toast.warning(toastContent);
          } else {
            toast.info(toastContent);
          }
        } else if (type === "confirmation") {
          set(eventCallback, cb);
          set(eventConfirmationInput, false);
          set(showEventConfirmation, true);
          set(eventConfirmationTitle, data.title);
          set(eventConfirmationMessage, data.message);
        } else if (type === "execute") {
          set(eventCallback, cb);
          try {
            const asyncFunction = new Function(`return (async () => { ${data.code} })()`);
            const result = await asyncFunction();
            if (cb) {
              cb(result);
            }
          } catch (error) {
            console.error("Error executing code:", error);
          }
        } else if (type === "input") {
          set(eventCallback, cb);
          set(eventConfirmationInput, true);
          set(showEventConfirmation, true);
          set(eventConfirmationTitle, data.title);
          set(eventConfirmationMessage, data.message);
          set(eventConfirmationInputPlaceholder, data.placeholder);
          set(eventConfirmationInputValue, (data == null ? void 0 : data.value) ?? "");
        } else {
          console.log("Unknown message type", data);
        }
        mutate(history, get(history).messages[event2.message_id] = message);
      }
    }
  };
  const onMessageHandler = async (event2) => {
    var _a;
    if (event2.origin !== window.origin) {
      return;
    }
    if (event2.data.type === "action:submit") {
      console.debug(event2.data.text);
      if (get(prompt) !== "") {
        await tick();
        submitPrompt(get(prompt));
      }
    }
    if (event2.data.type === "input:prompt") {
      console.debug(event2.data.text);
      const inputElement = document.getElementById("chat-input");
      if (inputElement) {
        (_a = get(messageInput)) == null ? void 0 : _a.setText(event2.data.text);
        inputElement.focus();
      }
    }
    if (event2.data.type === "input:prompt:submit") {
      console.debug(event2.data.text);
      if (event2.data.text !== "") {
        await tick();
        submitPrompt(event2.data.text);
      }
    }
  };
  const savedModelIds = async () => {
    var _a, _b;
    if ($selectedFolder() && get(selectedModels).filter((modelId) => modelId !== "").length > 0 && JSON.stringify((_b = (_a = $selectedFolder()) == null ? void 0 : _a.data) == null ? void 0 : _b.model_ids) !== JSON.stringify(get(selectedModels))) {
      await updateFolderById(localStorage.token, $selectedFolder().id, { data: { model_ids: get(selectedModels) } });
    }
  };
  let pageSubscribe = null;
  let showControlsSubscribe = null;
  let selectedFolderSubscribe = null;
  const stopAudio = () => {
    try {
      speechSynthesis.cancel();
      $audioQueue().stop();
    } catch {
    }
  };
  onMount(async () => {
    var _a, _b, _c;
    set(loading, true);
    console.log("mounted");
    window.addEventListener("message", onMessageHandler);
    (_a = $socket()) == null ? void 0 : _a.on("events", chatEventHandler);
    audioQueue.set(new AudioQueue(document.getElementById("audioElement")));
    pageSubscribe = page.subscribe(async (p) => {
      if (p.url.pathname === "/") {
        await tick();
        initNewChat();
      }
      stopAudio();
    });
    const storageChatInput = sessionStorage.getItem(`chat-input${chatIdProp() ? `-${chatIdProp()}` : ""}`);
    if (!chatIdProp()) {
      set(loading, false);
      await tick();
    }
    if (storageChatInput) {
      set(prompt, "");
      (_b = get(messageInput)) == null ? void 0 : _b.setText("");
      set(files, []);
      set(selectedToolIds, []);
      set(selectedFilterIds, []);
      set(webSearchEnabled, false);
      set(imageGenerationEnabled, false);
      set(codeInterpreterEnabled, false);
      try {
        const input = JSON.parse(storageChatInput);
        if (!$temporaryChatEnabled()) {
          (_c = get(messageInput)) == null ? void 0 : _c.setText(input.prompt);
          set(files, input.files);
          set(selectedToolIds, input.selectedToolIds);
          set(selectedFilterIds, input.selectedFilterIds);
          set(webSearchEnabled, input.webSearchEnabled);
          set(imageGenerationEnabled, input.imageGenerationEnabled);
          set(codeInterpreterEnabled, input.codeInterpreterEnabled);
        }
      } catch (e) {
      }
    }
    showControlsSubscribe = showControls.subscribe(async (value) => {
      if (get(controlPane) && !$mobile()) {
        try {
          if (value) {
            get(controlPaneComponent).openPane();
          } else {
            get(controlPane).collapse();
          }
        } catch (e) {
        }
      }
      if (!value) {
        showCallOverlay.set(false);
        showOverview.set(false);
        showArtifacts.set(false);
        showEmbeds.set(false);
      }
    });
    selectedFolderSubscribe = selectedFolder.subscribe(async (folder) => {
      var _a2;
      if (((_a2 = folder == null ? void 0 : folder.data) == null ? void 0 : _a2.model_ids) && JSON.stringify(get(selectedModels)) !== JSON.stringify(folder.data.model_ids)) {
        set(selectedModels, folder.data.model_ids);
        console.log("Set selectedModels from folder data:", get(selectedModels));
      }
    });
    const chatInput = document.getElementById("chat-input");
    chatInput == null ? void 0 : chatInput.focus();
  });
  onDestroy(() => {
    var _a, _b;
    try {
      pageSubscribe();
      showControlsSubscribe();
      selectedFolderSubscribe();
      chatIdUnsubscriber == null ? void 0 : chatIdUnsubscriber();
      window.removeEventListener("message", onMessageHandler);
      (_a = $socket()) == null ? void 0 : _a.off("events", chatEventHandler);
      (_b = $audioQueue()) == null ? void 0 : _b.destroy();
    } catch (e) {
      console.error(e);
    }
  });
  const uploadGoogleDriveFile = async (fileData) => {
    var _a, _b, _c, _d, _e, _f, _g, _h;
    console.log("Starting uploadGoogleDriveFile with:", {
      id: fileData.id,
      name: fileData.name,
      url: fileData.url,
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!(fileData == null ? void 0 : fileData.id) || !(fileData == null ? void 0 : fileData.name) || !(fileData == null ? void 0 : fileData.url) || !((_a = fileData == null ? void 0 : fileData.headers) == null ? void 0 : _a.Authorization)) {
      throw new Error("Invalid file data provided");
    }
    const tempItemId = v4();
    const fileItem = {
      type: "file",
      file: "",
      id: null,
      url: fileData.url,
      name: fileData.name,
      collection_name: "",
      status: "uploading",
      error: "",
      itemId: tempItemId,
      size: 0
    };
    try {
      set(files, [...get(files), fileItem]);
      console.log("Processing web file with URL:", fileData.url);
      const fetchOptions = {
        headers: { Authorization: fileData.headers.Authorization, Accept: "*/*" },
        method: "GET"
      };
      console.log("Fetching file content from Google Drive...");
      const fileResponse = await fetch(fileData.url, fetchOptions);
      if (!fileResponse.ok) {
        const errorText = await fileResponse.text();
        throw new Error(`Failed to fetch file (${fileResponse.status}): ${errorText}`);
      }
      const contentType = fileResponse.headers.get("content-type") || "application/octet-stream";
      console.log("Response received with content-type:", contentType);
      console.log("Converting response to blob...");
      const fileBlob = await fileResponse.blob();
      if (fileBlob.size === 0) {
        throw new Error("Retrieved file is empty");
      }
      console.log("Blob created:", { size: fileBlob.size, type: fileBlob.type || contentType });
      const file = new File([fileBlob], fileData.name, { type: fileBlob.type || contentType });
      console.log("File object created:", { name: file.name, size: file.size, type: file.type });
      if (file.size === 0) {
        throw new Error("Created file is empty");
      }
      let metadata = null;
      if ((file.type.startsWith("audio/") || file.type.startsWith("video/")) && ((_d = (_c = (_b = $settings()) == null ? void 0 : _b.audio) == null ? void 0 : _c.stt) == null ? void 0 : _d.language)) {
        metadata = { language: (_g = (_f = (_e = $settings()) == null ? void 0 : _e.audio) == null ? void 0 : _f.stt) == null ? void 0 : _g.language };
      }
      console.log("Uploading file to server...");
      const uploadedFile = await uploadFile(localStorage.token, file, metadata);
      if (!uploadedFile) {
        throw new Error("Server returned null response for file upload");
      }
      console.log("File uploaded successfully:", uploadedFile);
      fileItem.status = "uploaded";
      fileItem.file = uploadedFile;
      fileItem.id = uploadedFile.id;
      fileItem.size = file.size;
      fileItem.collection_name = (_h = uploadedFile == null ? void 0 : uploadedFile.meta) == null ? void 0 : _h.collection_name;
      fileItem.url = `${WEBUI_API_BASE_URL}/files/${uploadedFile.id}`;
      set(files, get(files));
      toast.success($i18n().t("File uploaded successfully"));
    } catch (e) {
      console.error("Error uploading file:", e);
      set(files, get(files).filter((f) => f.itemId !== tempItemId));
      toast.error($i18n().t("Error uploading file: {{error}}", { error: e.message || "Unknown error" }));
    }
  };
  const uploadWeb = async (url) => {
    console.log(url);
    const fileItem = {
      type: "text",
      name: url,
      collection_name: "",
      status: "uploading",
      url,
      error: ""
    };
    try {
      set(files, [...get(files), fileItem]);
      const res = await processWeb(localStorage.token, "", url);
      if (res) {
        fileItem.status = "uploaded";
        fileItem.collection_name = res.collection_name;
        fileItem.file = { ...res.file, ...fileItem.file };
        set(files, get(files));
      }
    } catch (e) {
      set(files, get(files).filter((f) => f.name !== url));
      toast.error(JSON.stringify(e));
    }
  };
  const uploadYoutubeTranscription = async (url) => {
    console.log(url);
    const fileItem = {
      type: "text",
      name: url,
      collection_name: "",
      status: "uploading",
      context: "full",
      url,
      error: ""
    };
    try {
      set(files, [...get(files), fileItem]);
      const res = await processYoutubeVideo(localStorage.token, url);
      if (res) {
        fileItem.status = "uploaded";
        fileItem.collection_name = res.collection_name;
        fileItem.file = { ...res.file, ...fileItem.file };
        set(files, get(files));
      }
    } catch (e) {
      set(files, get(files).filter((f) => f.name !== url));
      toast.error(`${e}`);
    }
  };
  const getContents = () => {
    const messages = get(history) ? createMessagesList(get(history), get(history).currentId) : [];
    let contents = [];
    messages.forEach((message) => {
      if ((message == null ? void 0 : message.role) !== "user" && (message == null ? void 0 : message.content)) {
        const {
          codeBlocks,
          html: htmlContent,
          css: cssContent,
          js: jsContent
        } = getCodeBlockContents(message.content);
        if (htmlContent || cssContent || jsContent) {
          const renderedContent = `
                        <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                                        <${""}style>
                                                                body {
                                                                        background-color: white; /* Ensure the iframe has a white background */
                                                                }

                                                                ${cssContent}
                                                        </${""}style>
                        </head>
                        <body>
                            ${htmlContent}

                                                        <${""}script>
                                ${jsContent}
                                                        </${""}script>
                        </body>
                        </html>
                    `;
          contents = [...contents, { type: "iframe", content: renderedContent }];
        } else {
          for (const block2 of codeBlocks) {
            if (block2.lang === "svg" || block2.lang === "xml" && block2.code.includes("<svg")) {
              contents = [...contents, { type: "svg", content: block2.code }];
            }
          }
        }
      }
    });
    artifactContents.set(contents);
  };
  const initNewChat = async () => {
    var _a, _b, _c, _d, _e, _f, _g, _h, _i, _j, _k, _l, _m, _n, _o, _p, _q, _r;
    console.log("initNewChat");
    if (((_a = $user()) == null ? void 0 : _a.role) !== "admin" && ((_d = (_c = (_b = $user()) == null ? void 0 : _b.permissions) == null ? void 0 : _c.chat) == null ? void 0 : _d.temporary_enforced)) {
      await temporaryChatEnabled.set(true);
    }
    if (((_e = $settings()) == null ? void 0 : _e.temporaryChatByDefault) ?? false) {
      if ($temporaryChatEnabled() === false) {
        await temporaryChatEnabled.set(true);
      } else if ($temporaryChatEnabled() === null) {
        await temporaryChatEnabled.set(false);
      }
    }
    const availableModels = $models().filter((m) => {
      var _a2, _b2;
      return !(((_b2 = (_a2 = m == null ? void 0 : m.info) == null ? void 0 : _a2.meta) == null ? void 0 : _b2.hidden) ?? false);
    }).map((m) => m.id);
    if ($page().url.searchParams.get("models") || $page().url.searchParams.get("model")) {
      const urlModels = (_f = $page().url.searchParams.get("models") || $page().url.searchParams.get("model") || "") == null ? void 0 : _f.split(",");
      if (urlModels.length === 1) {
        const m = $models().find((m2) => m2.id === urlModels[0]);
        if (!m) {
          const modelSelectorButton = document.getElementById("model-selector-0-button");
          if (modelSelectorButton) {
            modelSelectorButton.click();
            await tick();
            const modelSelectorInput = document.getElementById("model-search-input");
            if (modelSelectorInput) {
              modelSelectorInput.focus();
              modelSelectorInput.value = urlModels[0];
              modelSelectorInput.dispatchEvent(new Event("input"));
            }
          }
        } else {
          set(selectedModels, urlModels);
        }
      } else {
        set(selectedModels, urlModels);
      }
      set(selectedModels, get(selectedModels).filter((modelId) => $models().map((m) => m.id).includes(modelId)));
    } else {
      if ((_h = (_g = $selectedFolder()) == null ? void 0 : _g.data) == null ? void 0 : _h.model_ids) {
        set(selectedModels, (_j = (_i = $selectedFolder()) == null ? void 0 : _i.data) == null ? void 0 : _j.model_ids);
      } else {
        if (sessionStorage.selectedModels) {
          set(selectedModels, JSON.parse(sessionStorage.selectedModels));
          sessionStorage.removeItem("selectedModels");
        } else {
          if ((_k = $settings()) == null ? void 0 : _k.models) {
            set(selectedModels, (_l = $settings()) == null ? void 0 : _l.models);
          } else if ((_m = $config()) == null ? void 0 : _m.default_models) {
            console.log(((_n = $config()) == null ? void 0 : _n.default_models.split(",")) ?? "");
            set(selectedModels, (_o = $config()) == null ? void 0 : _o.default_models.split(","));
          }
        }
      }
      set(selectedModels, get(selectedModels).filter((modelId) => availableModels.includes(modelId)));
    }
    if (get(selectedModels).length === 0 || get(selectedModels).length === 1 && get(selectedModels)[0] === "") {
      if (availableModels.length > 0) {
        set(selectedModels, [(availableModels == null ? void 0 : availableModels.at(0)) ?? ""]);
      } else {
        set(selectedModels, [""]);
      }
    }
    await showControls.set(false);
    await showCallOverlay.set(false);
    await showOverview.set(false);
    await showArtifacts.set(false);
    if ($page().url.pathname.includes("/c/")) {
      window.history.replaceState(get(history).state, "", `/`);
    }
    set(autoScroll, true);
    resetInput();
    await chatId.set("");
    await chatTitle.set("");
    set(history, { messages: {}, currentId: null });
    set(chatFiles, []);
    set(params, {});
    if ($page().url.searchParams.get("youtube")) {
      uploadYoutubeTranscription(`https://www.youtube.com/watch?v=${$page().url.searchParams.get("youtube")}`);
    }
    if ($page().url.searchParams.get("load-url")) {
      await uploadWeb($page().url.searchParams.get("load-url"));
    }
    if ($page().url.searchParams.get("web-search") === "true") {
      set(webSearchEnabled, true);
    }
    if ($page().url.searchParams.get("image-generation") === "true") {
      set(imageGenerationEnabled, true);
    }
    if ($page().url.searchParams.get("code-interpreter") === "true") {
      set(codeInterpreterEnabled, true);
    }
    if ($page().url.searchParams.get("tools")) {
      set(selectedToolIds, (_p = $page().url.searchParams.get("tools")) == null ? void 0 : _p.split(",").map((id) => id.trim()).filter((id) => id));
    } else if ($page().url.searchParams.get("tool-ids")) {
      set(selectedToolIds, (_q = $page().url.searchParams.get("tool-ids")) == null ? void 0 : _q.split(",").map((id) => id.trim()).filter((id) => id));
    }
    if ($page().url.searchParams.get("call") === "true") {
      showCallOverlay.set(true);
      showControls.set(true);
    }
    if ($page().url.searchParams.get("q")) {
      const q = $page().url.searchParams.get("q") ?? "";
      (_r = get(messageInput)) == null ? void 0 : _r.setText(q);
      if (q) {
        if (($page().url.searchParams.get("submit") ?? "true") === "true") {
          await tick();
          submitPrompt(q);
        }
      }
    }
    set(selectedModels, get(selectedModels).map((modelId) => $models().map((m) => m.id).includes(modelId) ? modelId : ""));
    const chatInput = document.getElementById("chat-input");
    setTimeout(() => chatInput == null ? void 0 : chatInput.focus(), 0);
  };
  const loadChat = async () => {
    var _a, _b, _c, _d;
    chatId.set(chatIdProp());
    if ($temporaryChatEnabled()) {
      temporaryChatEnabled.set(false);
    }
    chat = await getChatById(localStorage.token, $chatId()).catch(async (error) => {
      await goto("/");
      return null;
    });
    if (chat) {
      await getTagsById(localStorage.token, $chatId()).catch(async (error) => {
        return [];
      });
      const chatContent = chat.chat;
      if (chatContent) {
        console.log(chatContent);
        set(selectedModels, ((chatContent == null ? void 0 : chatContent.models) ?? void 0) !== void 0 ? chatContent.models : [chatContent.models ?? ""]);
        if (!(((_a = $user()) == null ? void 0 : _a.role) === "admin" || (((_d = (_c = (_b = $user()) == null ? void 0 : _b.permissions) == null ? void 0 : _c.chat) == null ? void 0 : _d.multiple_models) ?? true))) {
          set(selectedModels, get(selectedModels).length > 0 ? [get(selectedModels)[0]] : [""]);
        }
        set(oldSelectedModelIds, JSON.parse(JSON.stringify(get(selectedModels))));
        set(history, ((chatContent == null ? void 0 : chatContent.history) ?? void 0) !== void 0 ? chatContent.history : convertMessagesToHistory(chatContent.messages));
        chatTitle.set(chatContent.title);
        set(params, (chatContent == null ? void 0 : chatContent.params) ?? {});
        set(chatFiles, (chatContent == null ? void 0 : chatContent.files) ?? []);
        set(autoScroll, true);
        await tick();
        if (get(history).currentId) {
          for (const message of Object.values(get(history).messages)) {
            if (message.role === "assistant") {
              message.done = true;
            }
          }
        }
        const taskRes = await getTaskIdsByChatId(localStorage.token, $chatId()).catch((error) => {
          return null;
        });
        if (taskRes) {
          set(taskIds, taskRes.task_ids);
        }
        await tick();
        return true;
      } else {
        return null;
      }
    }
  };
  const scrollToBottom = async (behavior = "auto") => {
    await tick();
    if (get(messagesContainerElement)) {
      get(messagesContainerElement).scrollTo({ top: get(messagesContainerElement).scrollHeight, behavior });
    }
  };
  const chatCompletedHandler = async (_chatId, modelId, responseMessageId, messages) => {
    var _a;
    const res = await chatCompleted(localStorage.token, {
      model: modelId,
      messages: messages.map((m) => ({
        id: m.id,
        role: m.role,
        content: m.content,
        info: m.info ? m.info : void 0,
        timestamp: m.timestamp,
        ...m.usage ? { usage: m.usage } : {},
        ...m.sources ? { sources: m.sources } : {}
      })),
      filter_ids: get(selectedFilterIds).length > 0 ? get(selectedFilterIds) : void 0,
      model_item: $models().find((m) => m.id === modelId),
      chat_id: _chatId,
      session_id: (_a = $socket()) == null ? void 0 : _a.id,
      id: responseMessageId
    }).catch((error) => {
      toast.error(`${error}`);
      messages.at(-1).error = { content: error };
      return null;
    });
    if (res !== null && res.messages) {
      for (const message of res.messages) {
        if (message == null ? void 0 : message.id) {
          mutate(history, get(history).messages[message.id] = {
            ...get(history).messages[message.id],
            ...get(history).messages[message.id].content !== message.content ? { originalContent: get(history).messages[message.id].content } : {},
            ...message
          });
        }
      }
    }
    await tick();
    if ($chatId() == _chatId) {
      if (!$temporaryChatEnabled()) {
        chat = await updateChatById(localStorage.token, _chatId, {
          models: get(selectedModels),
          messages,
          history: get(history),
          params: get(params),
          files: get(chatFiles)
        });
        currentChatPage.set(1);
        await chats.set(await getChatList(localStorage.token, $currentChatPage()));
      }
    }
    set(taskIds, null);
  };
  const chatActionHandler = async (_chatId, actionId, modelId, responseMessageId, event2 = null) => {
    var _a;
    const messages = createMessagesList(get(history), responseMessageId);
    const res = await chatAction(localStorage.token, actionId, {
      model: modelId,
      messages: messages.map((m) => ({
        id: m.id,
        role: m.role,
        content: m.content,
        info: m.info ? m.info : void 0,
        timestamp: m.timestamp,
        ...m.sources ? { sources: m.sources } : {}
      })),
      ...event2 ? { event: event2 } : {},
      model_item: $models().find((m) => m.id === modelId),
      chat_id: _chatId,
      session_id: (_a = $socket()) == null ? void 0 : _a.id,
      id: responseMessageId
    }).catch((error) => {
      toast.error(`${error}`);
      messages.at(-1).error = { content: error };
      return null;
    });
    if (res !== null && res.messages) {
      for (const message of res.messages) {
        mutate(history, get(history).messages[message.id] = {
          ...get(history).messages[message.id],
          ...get(history).messages[message.id].content !== message.content ? { originalContent: get(history).messages[message.id].content } : {},
          ...message
        });
      }
    }
    if ($chatId() == _chatId) {
      if (!$temporaryChatEnabled()) {
        chat = await updateChatById(localStorage.token, _chatId, {
          models: get(selectedModels),
          messages,
          history: get(history),
          params: get(params),
          files: get(chatFiles)
        });
        currentChatPage.set(1);
        await chats.set(await getChatList(localStorage.token, $currentChatPage()));
      }
    }
  };
  const getChatEventEmitter = async (modelId, chatId2 = "") => {
    return setInterval(
      () => {
        var _a;
        (_a = $socket()) == null ? void 0 : _a.emit("usage", { action: "chat", model: modelId, chat_id: chatId2 });
      },
      1e3
    );
  };
  const createMessagePair = async (userPrompt) => {
    var _a;
    (_a = get(messageInput)) == null ? void 0 : _a.setText("");
    if (get(selectedModels).length === 0) {
      toast.error($i18n().t("Model not selected"));
    } else {
      const modelId = get(selectedModels)[0];
      const model = $models().filter((m) => m.id === modelId).at(0);
      const messages = createMessagesList(get(history), get(history).currentId);
      const parentMessage = messages.length !== 0 ? messages.at(-1) : null;
      const userMessageId = v4();
      const responseMessageId = v4();
      const userMessage = {
        id: userMessageId,
        parentId: parentMessage ? parentMessage.id : null,
        childrenIds: [responseMessageId],
        role: "user",
        content: userPrompt ? userPrompt : `[PROMPT] ${userMessageId}`,
        timestamp: Math.floor(Date.now() / 1e3)
      };
      const responseMessage = {
        id: responseMessageId,
        parentId: userMessageId,
        childrenIds: [],
        role: "assistant",
        content: `[RESPONSE] ${responseMessageId}`,
        done: true,
        model: modelId,
        modelName: model.name ?? model.id,
        modelIdx: 0,
        timestamp: Math.floor(Date.now() / 1e3)
      };
      if (parentMessage) {
        parentMessage.childrenIds.push(userMessageId);
        mutate(history, get(history).messages[parentMessage.id] = parentMessage);
      }
      mutate(history, get(history).messages[userMessageId] = userMessage);
      mutate(history, get(history).messages[responseMessageId] = responseMessage);
      mutate(history, get(history).currentId = responseMessageId);
      await tick();
      if (get(autoScroll)) {
        scrollToBottom();
      }
      if (messages.length === 0) {
        await initChatHandler(get(history));
      } else {
        await saveChatHandler($chatId(), get(history));
      }
    }
  };
  const addMessages = async ({ modelId, parentId, messages }) => {
    const model = $models().filter((m) => m.id === modelId).at(0);
    let parentMessage = get(history).messages[parentId];
    let currentParentId = parentMessage ? parentMessage.id : null;
    for (const message of messages) {
      let messageId = v4();
      if (message.role === "user") {
        const userMessage = {
          id: messageId,
          parentId: currentParentId,
          childrenIds: [],
          timestamp: Math.floor(Date.now() / 1e3),
          ...message
        };
        if (parentMessage) {
          parentMessage.childrenIds.push(messageId);
          mutate(history, get(history).messages[parentMessage.id] = parentMessage);
        }
        mutate(history, get(history).messages[messageId] = userMessage);
        parentMessage = userMessage;
        currentParentId = messageId;
      } else {
        const responseMessage = {
          id: messageId,
          parentId: currentParentId,
          childrenIds: [],
          done: true,
          model: model.id,
          modelName: model.name ?? model.id,
          modelIdx: 0,
          timestamp: Math.floor(Date.now() / 1e3),
          ...message
        };
        if (parentMessage) {
          parentMessage.childrenIds.push(messageId);
          mutate(history, get(history).messages[parentMessage.id] = parentMessage);
        }
        mutate(history, get(history).messages[messageId] = responseMessage);
        parentMessage = responseMessage;
        currentParentId = messageId;
      }
    }
    mutate(history, get(history).currentId = currentParentId);
    await tick();
    if (get(autoScroll)) {
      scrollToBottom();
    }
    if (messages.length === 0) {
      await initChatHandler(get(history));
    } else {
      await saveChatHandler($chatId(), get(history));
    }
  };
  const chatCompletionEventHandler = async (data, message, chatId2) => {
    var _a, _b, _c, _d, _e, _f, _g, _h, _i, _j, _k, _l, _m, _n, _o, _p, _q, _r, _s;
    const {
      id,
      done,
      choices,
      content,
      sources,
      selected_model_id,
      error,
      usage
    } = data;
    if (error) {
      await handleOpenAIError(error, message);
    }
    if (sources && !(message == null ? void 0 : message.sources)) {
      message.sources = sources;
    }
    if (choices) {
      if ((_b = (_a = choices[0]) == null ? void 0 : _a.message) == null ? void 0 : _b.content) {
        message.content += (_d = (_c = choices[0]) == null ? void 0 : _c.message) == null ? void 0 : _d.content;
      } else {
        let value = ((_f = (_e = choices[0]) == null ? void 0 : _e.delta) == null ? void 0 : _f.content) ?? "";
        if (message.content == "" && value == "\n") {
          console.log("Empty response");
        } else {
          message.content += value;
          if (navigator.vibrate && (((_g = $settings()) == null ? void 0 : _g.hapticFeedback) ?? false)) {
            navigator.vibrate(5);
          }
          const messageContentParts = getMessageContentParts(removeAllDetails(message.content), ((_j = (_i = (_h = $config()) == null ? void 0 : _h.audio) == null ? void 0 : _i.tts) == null ? void 0 : _j.split_on) ?? "punctuation");
          messageContentParts.pop();
          if (messageContentParts.length > 0 && messageContentParts[messageContentParts.length - 1] !== message.lastSentence) {
            message.lastSentence = messageContentParts[messageContentParts.length - 1];
            eventTarget.dispatchEvent(new CustomEvent("chat", {
              detail: {
                id: message.id,
                content: messageContentParts[messageContentParts.length - 1]
              }
            }));
          }
        }
      }
    }
    if (content) {
      message.content = content;
      if (navigator.vibrate && (((_k = $settings()) == null ? void 0 : _k.hapticFeedback) ?? false)) {
        navigator.vibrate(5);
      }
      const messageContentParts = getMessageContentParts(removeAllDetails(message.content), ((_n = (_m = (_l = $config()) == null ? void 0 : _l.audio) == null ? void 0 : _m.tts) == null ? void 0 : _n.split_on) ?? "punctuation");
      messageContentParts.pop();
      if (messageContentParts.length > 0 && messageContentParts[messageContentParts.length - 1] !== message.lastSentence) {
        message.lastSentence = messageContentParts[messageContentParts.length - 1];
        eventTarget.dispatchEvent(new CustomEvent("chat", {
          detail: {
            id: message.id,
            content: messageContentParts[messageContentParts.length - 1]
          }
        }));
      }
    }
    if (selected_model_id) {
      message.selectedModelId = selected_model_id;
      message.arena = true;
    }
    if (usage) {
      message.usage = usage;
    }
    mutate(history, get(history).messages[message.id] = message);
    if (done) {
      message.done = true;
      if ($settings().responseAutoCopy) {
        copyToClipboard(message.content);
      }
      if ($settings().responseAutoPlayback && !$showCallOverlay()) {
        await tick();
        (_o = document.getElementById(`speak-button-${message.id}`)) == null ? void 0 : _o.click();
      }
      let lastMessageContentPart = ((_s = getMessageContentParts(removeAllDetails(message.content), ((_r = (_q = (_p = $config()) == null ? void 0 : _p.audio) == null ? void 0 : _q.tts) == null ? void 0 : _r.split_on) ?? "punctuation")) == null ? void 0 : _s.at(-1)) ?? "";
      if (lastMessageContentPart) {
        eventTarget.dispatchEvent(new CustomEvent("chat", { detail: { id: message.id, content: lastMessageContentPart } }));
      }
      eventTarget.dispatchEvent(new CustomEvent("chat:finish", { detail: { id: message.id, content: message.content } }));
      mutate(history, get(history).messages[message.id] = message);
      await tick();
      if (get(autoScroll)) {
        scrollToBottom();
      }
      await chatCompletedHandler(chatId2, message.model, message.id, createMessagesList(get(history), message.id));
    }
    console.log(data);
    await tick();
    if (get(autoScroll)) {
      scrollToBottom();
    }
  };
  const submitPrompt = async (userPrompt, { _raw = false } = {}) => {
    var _a, _b, _c, _d, _e, _f, _g, _h, _i;
    console.log("submitPrompt", userPrompt, $chatId());
    const _selectedModels = get(selectedModels).map((modelId) => $models().map((m) => m.id).includes(modelId) ? modelId : "");
    if (JSON.stringify(get(selectedModels)) !== JSON.stringify(_selectedModels)) {
      set(selectedModels, _selectedModels);
    }
    if (userPrompt === "" && get(files).length === 0) {
      toast.error($i18n().t("Please enter a prompt"));
      return;
    }
    if (get(selectedModels).includes("")) {
      toast.error($i18n().t("Model not selected"));
      return;
    }
    if (get(files).length > 0 && get(files).filter((file) => file.type !== "image" && file.status === "uploading").length > 0) {
      toast.error($i18n().t(`Oops! There are files still uploading. Please wait for the upload to complete.`));
      return;
    }
    if ((((_b = (_a = $config()) == null ? void 0 : _a.file) == null ? void 0 : _b.max_count) ?? null) !== null && get(files).length + get(chatFiles).length > ((_d = (_c = $config()) == null ? void 0 : _c.file) == null ? void 0 : _d.max_count)) {
      toast.error($i18n().t(`You can only chat with a maximum of {{maxCount}} file(s) at a time.`, { maxCount: (_f = (_e = $config()) == null ? void 0 : _e.file) == null ? void 0 : _f.max_count }));
      return;
    }
    if ((_g = get(history)) == null ? void 0 : _g.currentId) {
      const lastMessage = get(history).messages[get(history).currentId];
      if (lastMessage.done != true) {
        return;
      }
      if (lastMessage.error && !lastMessage.content) {
        toast.error($i18n().t(`Oops! There was an error in the previous response.`));
        return;
      }
    }
    (_h = get(messageInput)) == null ? void 0 : _h.setText("");
    set(prompt, "");
    const messages = createMessagesList(get(history), get(history).currentId);
    const _files = JSON.parse(JSON.stringify(get(files)));
    get(chatFiles).push(..._files.filter((item) => [
      "doc",
      "text",
      "file",
      "note",
      "chat",
      "folder",
      "collection"
    ].includes(item.type)));
    set(chatFiles, get(chatFiles).filter(
      // Remove duplicates
      (item, index2, array) => array.findIndex((i) => JSON.stringify(i) === JSON.stringify(item)) === index2
    ));
    set(files, []);
    (_i = get(messageInput)) == null ? void 0 : _i.setText("");
    let userMessageId = v4();
    let userMessage = {
      id: userMessageId,
      parentId: messages.length !== 0 ? messages.at(-1).id : null,
      childrenIds: [],
      role: "user",
      content: userPrompt,
      files: _files.length > 0 ? _files : void 0,
      timestamp: Math.floor(Date.now() / 1e3),
      // Unix epoch
      models: get(selectedModels)
    };
    mutate(history, get(history).messages[userMessageId] = userMessage);
    mutate(history, get(history).currentId = userMessageId);
    if (messages.length !== 0) {
      get(history).messages[messages.at(-1).id].childrenIds.push(userMessageId);
    }
    const chatInput = document.getElementById("chat-input");
    chatInput == null ? void 0 : chatInput.focus();
    saveSessionSelectedModels();
    await sendMessage(get(history), userMessageId, { newChat: true });
  };
  const sendMessage = async (_history, parentId, {
    messages = null,
    modelId = null,
    modelIdx = null,
    newChat = false
  } = {}) => {
    if (get(autoScroll)) {
      scrollToBottom();
    }
    let _chatId = JSON.parse(JSON.stringify($chatId()));
    _history = JSON.parse(JSON.stringify(_history));
    const responseMessageIds = {};
    let selectedModelIds2 = modelId ? [modelId] : get(atSelectedModel) !== void 0 ? [get(atSelectedModel).id] : get(selectedModels);
    for (const [_modelIdx, modelId2] of selectedModelIds2.entries()) {
      const model = $models().filter((m) => m.id === modelId2).at(0);
      if (model) {
        let responseMessageId = v4();
        let responseMessage = {
          parentId,
          id: responseMessageId,
          childrenIds: [],
          role: "assistant",
          content: "",
          model: model.id,
          modelName: model.name ?? model.id,
          modelIdx: modelIdx ? modelIdx : _modelIdx,
          timestamp: Math.floor(Date.now() / 1e3)
          // Unix epoch
        };
        mutate(history, get(history).messages[responseMessageId] = responseMessage);
        mutate(history, get(history).currentId = responseMessageId);
        if (parentId !== null && get(history).messages[parentId]) {
          mutate(history, get(history).messages[parentId].childrenIds = [
            ...get(history).messages[parentId].childrenIds,
            responseMessageId
          ]);
        }
        responseMessageIds[`${modelId2}-${modelIdx ? modelIdx : _modelIdx}`] = responseMessageId;
      }
    }
    set(history, get(history));
    if (newChat && _history.messages[_history.currentId].parentId === null) {
      _chatId = await initChatHandler(_history);
    }
    await tick();
    _history = JSON.parse(JSON.stringify(get(history)));
    await saveChatHandler(_chatId, _history);
    await Promise.all(selectedModelIds2.map(async (modelId2, _modelIdx) => {
      var _a, _b, _c;
      console.log("modelId", modelId2);
      const model = $models().filter((m) => m.id === modelId2).at(0);
      if (model) {
        const hasImages = createMessagesList(_history, parentId).some((message) => {
          var _a2;
          return (_a2 = message.files) == null ? void 0 : _a2.some((file) => file.type === "image");
        });
        if (hasImages && !(((_c = (_b = (_a = model.info) == null ? void 0 : _a.meta) == null ? void 0 : _b.capabilities) == null ? void 0 : _c.vision) ?? true)) {
          toast.error($i18n().t("Model {{modelName}} is not vision capable", { modelName: model.name ?? model.id }));
        }
        let responseMessageId = responseMessageIds[`${modelId2}-${modelIdx ? modelIdx : _modelIdx}`];
        const chatEventEmitter = await getChatEventEmitter(model.id, _chatId);
        scrollToBottom();
        await sendMessageSocket(
          model,
          messages && messages.length > 0 ? messages : createMessagesList(_history, responseMessageId),
          _history,
          responseMessageId
        );
        if (chatEventEmitter) clearInterval(chatEventEmitter);
      } else {
        toast.error($i18n().t(`Model {{modelId}} not found`, { modelId: modelId2 }));
      }
    }));
    currentChatPage.set(1);
    chats.set(await getChatList(localStorage.token, $currentChatPage()));
  };
  const getFeatures = () => {
    var _a, _b, _c, _d, _e, _f, _g, _h, _i, _j, _k, _l, _m, _n, _o, _p, _q, _r, _s, _t, _u, _v, _w, _x;
    let features = {};
    if ((_a = $config()) == null ? void 0 : _a.features) features = {
      voice: $showCallOverlay(),
      image_generation: ((_c = (_b = $config()) == null ? void 0 : _b.features) == null ? void 0 : _c.enable_image_generation) && (((_d = $user()) == null ? void 0 : _d.role) === "admin" || ((_g = (_f = (_e = $user()) == null ? void 0 : _e.permissions) == null ? void 0 : _f.features) == null ? void 0 : _g.image_generation)) ? get(imageGenerationEnabled) : false,
      code_interpreter: ((_i = (_h = $config()) == null ? void 0 : _h.features) == null ? void 0 : _i.enable_code_interpreter) && (((_j = $user()) == null ? void 0 : _j.role) === "admin" || ((_m = (_l = (_k = $user()) == null ? void 0 : _k.permissions) == null ? void 0 : _l.features) == null ? void 0 : _m.code_interpreter)) ? get(codeInterpreterEnabled) : false,
      web_search: ((_o = (_n = $config()) == null ? void 0 : _n.features) == null ? void 0 : _o.enable_web_search) && (((_p = $user()) == null ? void 0 : _p.role) === "admin" || ((_s = (_r = (_q = $user()) == null ? void 0 : _q.permissions) == null ? void 0 : _r.features) == null ? void 0 : _s.web_search)) ? get(webSearchEnabled) : false
    };
    const currentModels = ((_t = get(atSelectedModel)) == null ? void 0 : _t.id) ? [get(atSelectedModel).id] : get(selectedModels);
    if (currentModels.filter((model) => {
      var _a2, _b2, _c2, _d2;
      return ((_d2 = (_c2 = (_b2 = (_a2 = $models().find((m) => m.id === model)) == null ? void 0 : _a2.info) == null ? void 0 : _b2.meta) == null ? void 0 : _c2.capabilities) == null ? void 0 : _d2.web_search) ?? true;
    }).length === currentModels.length) {
      if (((_v = (_u = $config()) == null ? void 0 : _u.features) == null ? void 0 : _v.enable_web_search) && (((_w = $settings()) == null ? void 0 : _w.webSearch) ?? false) === "always") {
        features = { ...features, web_search: true };
      }
    }
    if (((_x = $settings()) == null ? void 0 : _x.memory) ?? false) {
      features = { ...features, memory: true };
    }
    return features;
  };
  const sendMessageSocket = async (model, _messages, _history, responseMessageId, _chatId) => {
    var _a, _b, _c, _d, _e, _f, _g, _h, _i, _j, _k, _l, _m, _n, _o, _p, _q, _r, _s, _t, _u, _v, _w, _x, _y, _z;
    const responseMessage = _history.messages[responseMessageId];
    const userMessage = _history.messages[responseMessage.parentId];
    const chatMessageFiles = _messages.filter((message) => message.files).flatMap((message) => message.files);
    set(chatFiles, get(chatFiles).filter((item) => {
      const fileExists = chatMessageFiles.some((messageFile) => messageFile.id === item.id);
      return fileExists;
    }));
    let files2 = JSON.parse(JSON.stringify(get(chatFiles)));
    files2.push(...((userMessage == null ? void 0 : userMessage.files) ?? []).filter((item) => ["doc", "text", "file", "note", "chat", "collection"].includes(item.type)));
    files2 = files2.filter((item, index2, array) => array.findIndex((i) => JSON.stringify(i) === JSON.stringify(item)) === index2);
    scrollToBottom();
    eventTarget.dispatchEvent(new CustomEvent("chat:start", { detail: { id: responseMessageId } }));
    await tick();
    let userLocation;
    if ((_a = $settings()) == null ? void 0 : _a.userLocation) {
      userLocation = await getAndUpdateUserLocation(localStorage.token).catch((err) => {
        console.error(err);
        return void 0;
      });
    }
    const stream = ((_c = (_b = model == null ? void 0 : model.info) == null ? void 0 : _b.params) == null ? void 0 : _c.stream_response) ?? ((_e = (_d = $settings()) == null ? void 0 : _d.params) == null ? void 0 : _e.stream_response) ?? ((_f = get(params)) == null ? void 0 : _f.stream_response) ?? true;
    let messages = [
      ((_g = get(params)) == null ? void 0 : _g.system) || $settings().system ? {
        role: "system",
        content: `${((_h = get(params)) == null ? void 0 : _h.system) ?? ((_i = $settings()) == null ? void 0 : _i.system) ?? ""}`
      } : void 0,
      ..._messages.map((message) => ({ ...message, content: processDetails(message.content) }))
    ].filter((message) => message);
    messages = messages.map((message, idx, arr) => {
      var _a2, _b2, _c2;
      return {
        role: message.role,
        ...((_a2 = message.files) == null ? void 0 : _a2.filter((file) => file.type === "image").length) > 0 && message.role === "user" ? {
          content: [
            {
              type: "text",
              text: ((_b2 = message == null ? void 0 : message.merged) == null ? void 0 : _b2.content) ?? message.content
            },
            ...message.files.filter((file) => file.type === "image").map((file) => ({ type: "image_url", image_url: { url: file.url } }))
          ]
        } : { content: ((_c2 = message == null ? void 0 : message.merged) == null ? void 0 : _c2.content) ?? message.content }
      };
    }).filter((message) => {
      var _a2;
      return (message == null ? void 0 : message.role) === "user" || ((_a2 = message == null ? void 0 : message.content) == null ? void 0 : _a2.trim());
    });
    const toolIds = [];
    const toolServerIds = [];
    for (const toolId of get(selectedToolIds)) {
      if (toolId.startsWith("direct_server:")) {
        let serverId = toolId.replace("direct_server:", "");
        if (!isNaN(parseInt(serverId))) {
          toolServerIds.push(parseInt(serverId));
        } else {
          toolServerIds.push(serverId);
        }
      } else {
        toolIds.push(toolId);
      }
    }
    const res = await generateOpenAIChatCompletion(
      localStorage.token,
      {
        stream,
        model: model.id,
        messages,
        params: {
          ...(_j = $settings()) == null ? void 0 : _j.params,
          ...get(params),
          stop: ((_k = get(params)) == null ? void 0 : _k.stop) ?? ((_m = (_l = $settings()) == null ? void 0 : _l.params) == null ? void 0 : _m.stop) ?? void 0 ? (((_n = get(params)) == null ? void 0 : _n.stop.split(",").map((token2) => token2.trim())) ?? $settings().params.stop).map((str) => decodeURIComponent(JSON.parse('"' + str.replace(/\"/g, '\\"') + '"'))) : void 0
        },
        files: ((files2 == null ? void 0 : files2.length) ?? 0) > 0 ? files2 : void 0,
        filter_ids: get(selectedFilterIds).length > 0 ? get(selectedFilterIds) : void 0,
        tool_ids: toolIds.length > 0 ? toolIds : void 0,
        tool_servers: ($toolServers() ?? []).filter((server, idx) => toolServerIds.includes(idx) || toolServerIds.includes(server == null ? void 0 : server.id)),
        features: getFeatures(),
        variables: {
          ...getPromptVariables((_o = $user()) == null ? void 0 : _o.name, ((_p = $settings()) == null ? void 0 : _p.userLocation) ? userLocation : void 0)
        },
        model_item: $models().find((m) => m.id === model.id),
        session_id: (_q = $socket()) == null ? void 0 : _q.id,
        chat_id: $chatId(),
        id: responseMessageId,
        background_tasks: {
          ...!$temporaryChatEnabled() && (messages.length == 1 || messages.length == 2 && ((_r = messages.at(0)) == null ? void 0 : _r.role) === "system" && ((_s = messages.at(1)) == null ? void 0 : _s.role) === "user") && (get(selectedModels)[0] === model.id || get(atSelectedModel) !== void 0) ? {
            title_generation: ((_u = (_t = $settings()) == null ? void 0 : _t.title) == null ? void 0 : _u.auto) ?? true,
            tags_generation: ((_v = $settings()) == null ? void 0 : _v.autoTags) ?? true
          } : {},
          follow_up_generation: ((_w = $settings()) == null ? void 0 : _w.autoFollowUps) ?? true
        },
        ...stream && (((_z = (_y = (_x = model.info) == null ? void 0 : _x.meta) == null ? void 0 : _y.capabilities) == null ? void 0 : _z.usage) ?? false) ? { stream_options: { include_usage: true } } : {}
      },
      `${WEBUI_BASE_URL}/api`
    ).catch(async (error) => {
      var _a2;
      console.log(error);
      let errorMessage = error;
      if ((_a2 = error == null ? void 0 : error.error) == null ? void 0 : _a2.message) {
        errorMessage = error.error.message;
      } else if (error == null ? void 0 : error.message) {
        errorMessage = error.message;
      }
      if (typeof errorMessage === "object") {
        errorMessage = $i18n().t(`Uh-oh! There was an issue with the response.`);
      }
      toast.error(`${errorMessage}`);
      responseMessage.error = { content: error };
      responseMessage.done = true;
      mutate(history, get(history).messages[responseMessageId] = responseMessage);
      mutate(history, get(history).currentId = responseMessageId);
      return null;
    });
    if (res) {
      if (res.error) {
        await handleOpenAIError(res.error, responseMessage);
      } else {
        if (get(taskIds)) {
          get(taskIds).push(res.task_id);
        } else {
          set(taskIds, [res.task_id]);
        }
      }
    }
    await tick();
    scrollToBottom();
  };
  const handleOpenAIError = async (error, responseMessage) => {
    let errorMessage = "";
    let innerError;
    if (error) {
      innerError = error;
    }
    console.error(innerError);
    if ("detail" in innerError) {
      toast.error(innerError.detail);
      errorMessage = innerError.detail;
    } else if ("error" in innerError) {
      if ("message" in innerError.error) {
        toast.error(innerError.error.message);
        errorMessage = innerError.error.message;
      } else {
        toast.error(innerError.error);
        errorMessage = innerError.error;
      }
    } else if ("message" in innerError) {
      toast.error(innerError.message);
      errorMessage = innerError.message;
    }
    responseMessage.error = {
      content: $i18n().t(`Uh-oh! There was an issue with the response.`) + "\n" + errorMessage
    };
    responseMessage.done = true;
    if (responseMessage.statusHistory) {
      responseMessage.statusHistory = responseMessage.statusHistory.filter((status) => status.action !== "knowledge_search");
    }
    mutate(history, get(history).messages[responseMessage.id] = responseMessage);
  };
  const stopResponse = async () => {
    if (get(taskIds)) {
      for (const taskId of get(taskIds)) {
        await stopTask(localStorage.token, taskId).catch((error) => {
          toast.error(`${error}`);
          return null;
        });
      }
      set(taskIds, null);
      const responseMessage = get(history).messages[get(history).currentId];
      for (const messageId of get(history).messages[responseMessage.parentId].childrenIds) {
        mutate(history, get(history).messages[messageId].done = true);
      }
      mutate(history, get(history).messages[get(history).currentId] = responseMessage);
      if (get(autoScroll)) {
        scrollToBottom();
      }
    }
    if (get(generating)) {
      set(generating, false);
      generationController == null ? void 0 : generationController.abort();
      generationController = null;
    }
  };
  const submitMessage = async (parentId, prompt2) => {
    let userPrompt = prompt2;
    let userMessageId = v4();
    let userMessage = {
      id: userMessageId,
      parentId,
      childrenIds: [],
      role: "user",
      content: userPrompt,
      models: get(selectedModels),
      timestamp: Math.floor(Date.now() / 1e3)
      // Unix epoch
    };
    if (parentId !== null) {
      mutate(history, get(history).messages[parentId].childrenIds = [
        ...get(history).messages[parentId].childrenIds,
        userMessageId
      ]);
    }
    mutate(history, get(history).messages[userMessageId] = userMessage);
    mutate(history, get(history).currentId = userMessageId);
    await tick();
    if (get(autoScroll)) {
      scrollToBottom();
    }
    await sendMessage(get(history), userMessageId);
  };
  const regenerateResponse = async (message, suggestionPrompt = null) => {
    console.log("regenerateResponse");
    if (get(history).currentId) {
      let userMessage = get(history).messages[message.parentId];
      if (get(autoScroll)) {
        scrollToBottom();
      }
      await sendMessage(get(history), userMessage.id, {
        ...suggestionPrompt ? {
          messages: [
            ...createMessagesList(get(history), message.id),
            { role: "user", content: suggestionPrompt }
          ]
        } : {},
        ...((userMessage == null ? void 0 : userMessage.models) ?? [...get(selectedModels)]).length > 1 ? {
          // If multiple models are selected, use the model from the message
          modelId: message.model,
          modelIdx: message.modelIdx
        } : {}
      });
    }
  };
  const continueResponse = async () => {
    console.log("continueResponse");
    JSON.parse(JSON.stringify($chatId()));
    if (get(history).currentId && get(history).messages[get(history).currentId].done == true) {
      const responseMessage = get(history).messages[get(history).currentId];
      responseMessage.done = false;
      await tick();
      const model = $models().filter((m) => m.id === ((responseMessage == null ? void 0 : responseMessage.selectedModelId) ?? responseMessage.model)).at(0);
      if (model) {
        await sendMessageSocket(model, createMessagesList(get(history), responseMessage.id), get(history), responseMessage.id);
      }
    }
  };
  const mergeResponses = async (messageId, responses, _chatId) => {
    console.log("mergeResponses", messageId, responses);
    const message = get(history).messages[messageId];
    const mergedResponse = { status: true, content: "" };
    message.merged = mergedResponse;
    mutate(history, get(history).messages[messageId] = message);
    try {
      set(generating, true);
      const [res, controller] = await generateMoACompletion(localStorage.token, message.model, get(history).messages[message.parentId].content, responses);
      if (res && res.ok && res.body && get(generating)) {
        generationController = controller;
        const textStream = await createOpenAITextStream(res.body, $settings().splitLargeChunks);
        for await (const update of textStream) {
          const { value, done, sources, error, usage } = update;
          if (error || done) {
            set(generating, false);
            generationController = null;
            break;
          }
          if (mergedResponse.content == "" && value == "\n") {
            continue;
          } else {
            mergedResponse.content += value;
            mutate(history, get(history).messages[messageId] = message);
          }
          if (get(autoScroll)) {
            scrollToBottom();
          }
        }
        await saveChatHandler(_chatId, get(history));
      } else {
        console.error(res);
      }
    } catch (e) {
      console.error(e);
    }
  };
  const initChatHandler = async (history2) => {
    var _a, _b;
    let _chatId = $chatId();
    if (!$temporaryChatEnabled()) {
      chat = await createNewChat(
        localStorage.token,
        {
          id: _chatId,
          title: $i18n().t("New Chat"),
          models: get(selectedModels),
          system: $settings().system ?? void 0,
          params: get(params),
          history: history2,
          messages: createMessagesList(history2, history2.currentId),
          tags: [],
          timestamp: Date.now()
        },
        (_a = $selectedFolder()) == null ? void 0 : _a.id
      );
      _chatId = chat.id;
      await chatId.set(_chatId);
      window.history.replaceState(history2.state, "", `/c/${_chatId}`);
      await tick();
      await chats.set(await getChatList(localStorage.token, $currentChatPage()));
      currentChatPage.set(1);
      selectedFolder.set(null);
    } else {
      _chatId = `local:${(_b = $socket()) == null ? void 0 : _b.id}`;
      await chatId.set(_chatId);
    }
    await tick();
    return _chatId;
  };
  const saveChatHandler = async (_chatId, history2) => {
    if ($chatId() == _chatId) {
      if (!$temporaryChatEnabled()) {
        chat = await updateChatById(localStorage.token, _chatId, {
          models: get(selectedModels),
          history: history2,
          messages: createMessagesList(history2, history2.currentId),
          params: get(params),
          files: get(chatFiles)
        });
        currentChatPage.set(1);
        await chats.set(await getChatList(localStorage.token, $currentChatPage()));
      }
    }
  };
  const MAX_DRAFT_LENGTH = 5e3;
  let saveDraftTimeout = null;
  const saveDraft = async (draft, chatId2 = null) => {
    if (saveDraftTimeout) {
      clearTimeout(saveDraftTimeout);
    }
    if (draft.prompt !== null && draft.prompt.length < MAX_DRAFT_LENGTH) {
      saveDraftTimeout = setTimeout(
        async () => {
          await sessionStorage.setItem(`chat-input${chatId2 ? `-${chatId2}` : ""}`, JSON.stringify(draft));
        },
        500
      );
    } else {
      sessionStorage.removeItem(`chat-input${chatId2 ? `-${chatId2}` : ""}`);
    }
  };
  const clearDraft = async (chatId2 = null) => {
    if (saveDraftTimeout) {
      clearTimeout(saveDraftTimeout);
    }
    await sessionStorage.removeItem(`chat-input${chatId2 ? `-${chatId2}` : ""}`);
  };
  const moveChatHandler = async (chatId2, folderId2) => {
    if (chatId2 && folderId2) {
      const res = await updateChatFolderIdById(localStorage.token, chatId2, folderId2).catch((error) => {
        toast.error(`${error}`);
        return null;
      });
      if (res) {
        currentChatPage.set(1);
        await chats.set(await getChatList(localStorage.token, $currentChatPage()));
        await pinnedChats.set(await getPinnedChatList(localStorage.token));
        toast.success($i18n().t("Chat moved successfully"));
      }
    } else {
      toast.error($i18n().t("Failed to move chat"));
    }
  };
  legacy_pre_effect(() => (get(atSelectedModel), get(selectedModels)), () => {
    if (get(atSelectedModel) !== void 0) {
      set(selectedModelIds, [get(atSelectedModel).id]);
    } else {
      set(selectedModelIds, get(selectedModels));
    }
  });
  legacy_pre_effect(() => deep_read_state(chatIdProp()), () => {
    if (chatIdProp()) {
      navigateHandler();
    }
  });
  legacy_pre_effect(() => (get(selectedModels), deep_read_state(chatIdProp())), () => {
    if (get(selectedModels) && chatIdProp() !== "") {
      saveSessionSelectedModels();
    }
  });
  legacy_pre_effect(() => (get(selectedModelIds), get(oldSelectedModelIds)), () => {
    if (JSON.stringify(get(selectedModelIds)) !== JSON.stringify(get(oldSelectedModelIds))) {
      onSelectedModelIdsChange();
    }
  });
  legacy_pre_effect(() => get(selectedModels), () => {
    if (get(selectedModels) !== null) {
      savedModelIds();
    }
  });
  legacy_pre_effect(() => (get(history), artifactContents), () => {
    if (get(history)) {
      getContents();
    } else {
      artifactContents.set([]);
    }
  });
  legacy_pre_effect_reset();
  init();
  var fragment = root();
  head("vhdo11", ($$anchor2) => {
    deferred_template_effect(
      ($0) => {
        $document.title = `
                ${$0 ?? ""}
        `;
      },
      [
        () => ($settings(), $chatTitle(), $WEBUI_NAME(), untrack(() => $settings().showChatTitleInTab !== false && $chatTitle() ? `${$chatTitle().length > 30 ? `${$chatTitle().slice(0, 30)}...` : $chatTitle()}  ${$WEBUI_NAME()}` : `${$WEBUI_NAME()}`))
      ]
    );
  });
  var node = sibling(first_child(fragment), 2);
  ConfirmDialog(node, {
    get title() {
      return get(eventConfirmationTitle);
    },
    get message() {
      return get(eventConfirmationMessage);
    },
    get input() {
      return get(eventConfirmationInput);
    },
    get inputPlaceholder() {
      return get(eventConfirmationInputPlaceholder);
    },
    get inputValue() {
      return get(eventConfirmationInputValue);
    },
    get show() {
      return get(showEventConfirmation);
    },
    set show($$value) {
      set(showEventConfirmation, $$value);
    },
    $$events: {
      confirm: (e) => {
        if (e.detail) {
          get(eventCallback)(e.detail);
        } else {
          get(eventCallback)(true);
        }
      },
      cancel: () => {
        get(eventCallback)(false);
      }
    },
    $$legacy: true
  });
  var div = sibling(node, 2);
  var node_1 = child(div);
  {
    var consequent_3 = ($$anchor2) => {
      var div_1 = root_2();
      var node_2 = child(div_1);
      {
        var consequent = ($$anchor3) => {
          var fragment_1 = root_3();
          var div_2 = first_child(fragment_1);
          next(2);
          template_effect(() => set_style(div_2, `background-image: url(${($selectedFolder(), untrack(() => {
            var _a, _b;
            return (_b = (_a = $selectedFolder()) == null ? void 0 : _a.meta) == null ? void 0 : _b.background_image_url;
          })) ?? ""})  `));
          append($$anchor3, fragment_1);
        };
        var alternate = ($$anchor3) => {
          var fragment_2 = comment();
          var node_3 = first_child(fragment_2);
          {
            var consequent_1 = ($$anchor4) => {
              var fragment_3 = root_5();
              var div_3 = first_child(fragment_3);
              next(2);
              template_effect(() => set_style(div_3, `background-image: url(${($settings(), $config(), untrack(() => {
                var _a, _b, _c;
                return ((_a = $settings()) == null ? void 0 : _a.backgroundImageUrl) ?? ((_c = (_b = $config()) == null ? void 0 : _b.license_metadata) == null ? void 0 : _c.background_image_url);
              })) ?? ""})  `));
              append($$anchor4, fragment_3);
            };
            if_block(
              node_3,
              ($$render) => {
                if ($settings(), $config(), untrack(() => {
                  var _a, _b, _c;
                  return ((_a = $settings()) == null ? void 0 : _a.backgroundImageUrl) ?? ((_c = (_b = $config()) == null ? void 0 : _b.license_metadata) == null ? void 0 : _c.background_image_url) ?? null;
                })) $$render(consequent_1);
              },
              true
            );
          }
          append($$anchor3, fragment_2);
        };
        if_block(node_2, ($$render) => {
          if ($selectedFolder(), untrack(() => {
            var _a, _b;
            return $selectedFolder() && ((_b = (_a = $selectedFolder()) == null ? void 0 : _a.meta) == null ? void 0 : _b.background_image_url);
          })) $$render(consequent);
          else $$render(alternate, false);
        });
      }
      var node_4 = sibling(node_2, 2);
      Pane_group(node_4, {
        direction: "horizontal",
        class: "w-full h-full",
        children: ($$anchor3, $$slotProps) => {
          var fragment_4 = root_6();
          var node_5 = first_child(fragment_4);
          Pane(node_5, {
            defaultSize: 50,
            minSize: 30,
            class: "h-full flex relative max-w-full flex-col",
            children: ($$anchor4, $$slotProps2) => {
              var fragment_5 = root_7();
              var node_6 = first_child(fragment_5);
              {
                let $0 = derived_safe_equal(() => ($chatId(), $chatTitle(), get(selectedModels), $settings(), get(params), get(history), untrack(() => ({
                  id: $chatId(),
                  chat: {
                    title: $chatTitle(),
                    models: get(selectedModels),
                    system: $settings().system ?? void 0,
                    params: get(params),
                    history: get(history),
                    timestamp: Date.now()
                  }
                }))));
                let $1 = derived_safe_equal(() => (get(history), untrack(() => !!get(history).currentId)));
                bind_this(
                  Navbar(node_6, {
                    get chat() {
                      return get($0);
                    },
                    get history() {
                      return get(history);
                    },
                    get title() {
                      return $chatTitle();
                    },
                    get shareEnabled() {
                      return get($1);
                    },
                    initNewChat,
                    archiveChatHandler: () => {
                    },
                    moveChatHandler,
                    onSaveTempChat: async () => {
                      var _a, _b;
                      try {
                        if (!((_a = get(history)) == null ? void 0 : _a.currentId) || !Object.keys(get(history).messages).length) {
                          toast.error($i18n().t("No conversation to save"));
                          return;
                        }
                        const messages = createMessagesList(get(history), get(history).currentId);
                        const title = ((_b = messages.find((m) => m.role === "user")) == null ? void 0 : _b.content) ?? $i18n().t("New Chat");
                        const savedChat = await createNewChat(
                          localStorage.token,
                          {
                            id: v4(),
                            title: title.length > 50 ? `${title.slice(0, 50)}...` : title,
                            models: get(selectedModels),
                            history: get(history),
                            messages,
                            timestamp: Date.now()
                          },
                          null
                        );
                        if (savedChat) {
                          temporaryChatEnabled.set(false);
                          chatId.set(savedChat.id);
                          chats.set(await getChatList(localStorage.token, $currentChatPage()));
                          await goto(`/c/${savedChat.id}`);
                          toast.success($i18n().t("Conversation saved successfully"));
                        }
                      } catch (error) {
                        console.error("Error saving conversation:", error);
                        toast.error($i18n().t("Failed to save conversation"));
                      }
                    },
                    get selectedModels() {
                      return get(selectedModels);
                    },
                    set selectedModels($$value) {
                      set(selectedModels, $$value);
                    },
                    $$legacy: true
                  }),
                  ($$value) => set(navbarElement, $$value),
                  () => get(navbarElement)
                );
              }
              var div_4 = sibling(node_6, 2);
              var node_7 = child(div_4);
              {
                var consequent_2 = ($$anchor5) => {
                  var fragment_6 = root_8();
                  var div_5 = first_child(fragment_6);
                  var div_6 = child(div_5);
                  var node_8 = child(div_6);
                  {
                    let $0 = derived_safe_equal(() => (get(files), untrack(() => get(files).length > 0)));
                    Messages(node_8, {
                      get chatId() {
                        return $chatId();
                      },
                      setInputText: (text2) => {
                        var _a;
                        (_a = get(messageInput)) == null ? void 0 : _a.setText(text2);
                      },
                      get selectedModels() {
                        return get(selectedModels);
                      },
                      get atSelectedModel() {
                        return get(atSelectedModel);
                      },
                      sendMessage,
                      showMessage,
                      submitMessage,
                      continueResponse,
                      regenerateResponse,
                      mergeResponses,
                      chatActionHandler,
                      addMessages,
                      topPadding: true,
                      get bottomPadding() {
                        return get($0);
                      },
                      onSelect,
                      get history() {
                        return get(history);
                      },
                      set history($$value) {
                        set(history, $$value);
                      },
                      get autoScroll() {
                        return get(autoScroll);
                      },
                      set autoScroll($$value) {
                        set(autoScroll, $$value);
                      },
                      get prompt() {
                        return get(prompt);
                      },
                      set prompt($$value) {
                        set(prompt, $$value);
                      },
                      $$legacy: true
                    });
                  }
                  reset(div_6);
                  reset(div_5);
                  bind_this(div_5, ($$value) => set(messagesContainerElement, $$value), () => get(messagesContainerElement));
                  var div_7 = sibling(div_5, 2);
                  var node_9 = child(div_7);
                  bind_this(
                    MessageInput(node_9, {
                      get history() {
                        return get(history);
                      },
                      get taskIds() {
                        return get(taskIds);
                      },
                      get selectedModels() {
                        return get(selectedModels);
                      },
                      get toolServers() {
                        return $toolServers();
                      },
                      get generating() {
                        return get(generating);
                      },
                      stopResponse,
                      createMessagePair,
                      onChange: (data) => {
                        if (!$temporaryChatEnabled()) {
                          saveDraft(data, $chatId());
                        }
                      },
                      get files() {
                        return get(files);
                      },
                      set files($$value) {
                        set(files, $$value);
                      },
                      get prompt() {
                        return get(prompt);
                      },
                      set prompt($$value) {
                        set(prompt, $$value);
                      },
                      get autoScroll() {
                        return get(autoScroll);
                      },
                      set autoScroll($$value) {
                        set(autoScroll, $$value);
                      },
                      get selectedToolIds() {
                        return get(selectedToolIds);
                      },
                      set selectedToolIds($$value) {
                        set(selectedToolIds, $$value);
                      },
                      get selectedFilterIds() {
                        return get(selectedFilterIds);
                      },
                      set selectedFilterIds($$value) {
                        set(selectedFilterIds, $$value);
                      },
                      get imageGenerationEnabled() {
                        return get(imageGenerationEnabled);
                      },
                      set imageGenerationEnabled($$value) {
                        set(imageGenerationEnabled, $$value);
                      },
                      get codeInterpreterEnabled() {
                        return get(codeInterpreterEnabled);
                      },
                      set codeInterpreterEnabled($$value) {
                        set(codeInterpreterEnabled, $$value);
                      },
                      get webSearchEnabled() {
                        return get(webSearchEnabled);
                      },
                      set webSearchEnabled($$value) {
                        set(webSearchEnabled, $$value);
                      },
                      get atSelectedModel() {
                        return get(atSelectedModel);
                      },
                      set atSelectedModel($$value) {
                        set(atSelectedModel, $$value);
                      },
                      get showCommands() {
                        return get(showCommands);
                      },
                      set showCommands($$value) {
                        set(showCommands, $$value);
                      },
                      $$events: {
                        upload: async (e) => {
                          const { type, data } = e.detail;
                          if (type === "web") {
                            await uploadWeb(data);
                          } else if (type === "youtube") {
                            await uploadYoutubeTranscription(data);
                          } else if (type === "google-drive") {
                            await uploadGoogleDriveFile(data);
                          }
                        },
                        submit: async (e) => {
                          clearDraft();
                          if (e.detail || get(files).length > 0) {
                            await tick();
                            submitPrompt(e.detail.replaceAll("\n\n", "\n"));
                          }
                        }
                      },
                      $$legacy: true
                    }),
                    ($$value) => set(messageInput, $$value),
                    () => get(messageInput)
                  );
                  next(2);
                  reset(div_7);
                  event("scroll", div_5, (e) => {
                    set(autoScroll, get(messagesContainerElement).scrollHeight - get(messagesContainerElement).scrollTop <= get(messagesContainerElement).clientHeight + 5);
                  });
                  append($$anchor5, fragment_6);
                };
                var alternate_1 = ($$anchor5) => {
                  var div_8 = root_9();
                  var node_10 = child(div_8);
                  Placeholder(node_10, {
                    get history() {
                      return get(history);
                    },
                    get selectedModels() {
                      return get(selectedModels);
                    },
                    get toolServers() {
                      return $toolServers();
                    },
                    stopResponse,
                    createMessagePair,
                    onSelect,
                    onChange: (data) => {
                      if (!$temporaryChatEnabled()) {
                        saveDraft(data);
                      }
                    },
                    get messageInput() {
                      return get(messageInput);
                    },
                    set messageInput($$value) {
                      set(messageInput, $$value);
                    },
                    get files() {
                      return get(files);
                    },
                    set files($$value) {
                      set(files, $$value);
                    },
                    get prompt() {
                      return get(prompt);
                    },
                    set prompt($$value) {
                      set(prompt, $$value);
                    },
                    get autoScroll() {
                      return get(autoScroll);
                    },
                    set autoScroll($$value) {
                      set(autoScroll, $$value);
                    },
                    get selectedToolIds() {
                      return get(selectedToolIds);
                    },
                    set selectedToolIds($$value) {
                      set(selectedToolIds, $$value);
                    },
                    get selectedFilterIds() {
                      return get(selectedFilterIds);
                    },
                    set selectedFilterIds($$value) {
                      set(selectedFilterIds, $$value);
                    },
                    get imageGenerationEnabled() {
                      return get(imageGenerationEnabled);
                    },
                    set imageGenerationEnabled($$value) {
                      set(imageGenerationEnabled, $$value);
                    },
                    get codeInterpreterEnabled() {
                      return get(codeInterpreterEnabled);
                    },
                    set codeInterpreterEnabled($$value) {
                      set(codeInterpreterEnabled, $$value);
                    },
                    get webSearchEnabled() {
                      return get(webSearchEnabled);
                    },
                    set webSearchEnabled($$value) {
                      set(webSearchEnabled, $$value);
                    },
                    get atSelectedModel() {
                      return get(atSelectedModel);
                    },
                    set atSelectedModel($$value) {
                      set(atSelectedModel, $$value);
                    },
                    get showCommands() {
                      return get(showCommands);
                    },
                    set showCommands($$value) {
                      set(showCommands, $$value);
                    },
                    $$events: {
                      upload: async (e) => {
                        const { type, data } = e.detail;
                        if (type === "web") {
                          await uploadWeb(data);
                        } else if (type === "youtube") {
                          await uploadYoutubeTranscription(data);
                        }
                      },
                      submit: async (e) => {
                        clearDraft();
                        if (e.detail || get(files).length > 0) {
                          await tick();
                          submitPrompt(e.detail.replaceAll("\n\n", "\n"));
                        }
                      }
                    },
                    $$legacy: true
                  });
                  reset(div_8);
                  append($$anchor5, div_8);
                };
                if_block(node_7, ($$render) => {
                  if ($settings(), $selectedFolder(), deep_read_state(createMessagesList), get(history), untrack(() => {
                    var _a;
                    return ((_a = $settings()) == null ? void 0 : _a.landingPageMode) === "chat" && !$selectedFolder() || createMessagesList(get(history), get(history).currentId).length > 0;
                  })) $$render(consequent_2);
                  else $$render(alternate_1, false);
                });
              }
              reset(div_4);
              append($$anchor4, fragment_5);
            },
            $$slots: { default: true }
          });
          var node_11 = sibling(node_5, 2);
          {
            let $0 = derived_safe_equal(() => (get(selectedModelIds), untrack(() => {
              var _a;
              return ((_a = get(selectedModelIds)) == null ? void 0 : _a.at(0)) ?? null;
            })));
            let $1 = derived_safe_equal(() => (get(selectedModelIds), $models(), untrack(() => get(selectedModelIds).reduce(
              (a, e, i, arr) => {
                const model = $models().find((m) => m.id === e);
                if (model) {
                  return [...a, model];
                }
                return a;
              },
              []
            ))));
            bind_this(
              ChatControls(node_11, {
                get chatId() {
                  return $chatId();
                },
                get modelId() {
                  return get($0);
                },
                get models() {
                  return get($1);
                },
                submitPrompt,
                stopResponse,
                showMessage,
                get eventTarget() {
                  return eventTarget;
                },
                get history() {
                  return get(history);
                },
                set history($$value) {
                  set(history, $$value);
                },
                get chatFiles() {
                  return get(chatFiles);
                },
                set chatFiles($$value) {
                  set(chatFiles, $$value);
                },
                get params() {
                  return get(params);
                },
                set params($$value) {
                  set(params, $$value);
                },
                get files() {
                  return get(files);
                },
                set files($$value) {
                  set(files, $$value);
                },
                get pane() {
                  return get(controlPane);
                },
                set pane($$value) {
                  set(controlPane, $$value);
                },
                $$legacy: true
              }),
              ($$value) => set(controlPaneComponent, $$value),
              () => get(controlPaneComponent)
            );
          }
          append($$anchor3, fragment_4);
        },
        $$slots: { default: true }
      });
      reset(div_1);
      transition(1, div_1, () => fade, () => ({ duration: 50 }));
      append($$anchor2, div_1);
    };
    var alternate_2 = ($$anchor2) => {
      var fragment_7 = comment();
      var node_12 = first_child(fragment_7);
      {
        var consequent_4 = ($$anchor3) => {
          var div_9 = root_11();
          var div_10 = child(div_9);
          var node_13 = child(div_10);
          Spinner(node_13, { className: "size-5" });
          reset(div_10);
          reset(div_9);
          append($$anchor3, div_9);
        };
        if_block(
          node_12,
          ($$render) => {
            if (get(loading)) $$render(consequent_4);
          },
          true
        );
      }
      append($$anchor2, fragment_7);
    };
    if_block(node_1, ($$render) => {
      if (!get(loading)) $$render(consequent_3);
      else $$render(alternate_2, false);
    });
  }
  reset(div);
  append($$anchor, fragment);
  pop();
  $$cleanup();
}
export {
  Chat as C
};
